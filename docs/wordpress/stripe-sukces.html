<!-- Strona podziękowania po płatności – wklej do WordPress jako nowa strona -->
<!-- Adres strony: /sukces/ (Settings → Permalinks – slug: sukces) -->
<!-- Wymaga: stripe-shop z endpointem /api/license/deliver -->
<div id="imprezja-sukces" style="max-width: 600px; margin: 60px auto; padding: 40px; text-align: center;">
    <h1 style="color: #27ae60; margin-bottom: 20px;">Dziękujemy za zakup!</h1>
    <p style="font-size: 1.1rem; color: #333; line-height: 1.6;">
        Płatność została pomyślnie zrealizowana. Aby otrzymać klucz licencyjny na e-mail, podaj <strong>Machine ID</strong> z programu.
    </p>
    <p style="color: #666; font-size: 0.95rem; margin-bottom: 24px;">
        Machine ID znajdziesz w programie Imprezja Quiz na ekranie aktywacji (przy braku licencji).
    </p>

    <div id="imprezja-no-session" style="display: none; background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 16px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
        <strong>Nie wykryto sesji płatności.</strong> Jeśli właśnie zapłaciłeś, kliknij „Odśwież stronę” – adres URL powinien się zaktualizować.
        <p style="margin: 12px 0 0 0;">
            <button type="button" onclick="location.reload()" style="padding: 10px 20px; background: #856404; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">Odśwież stronę</button>
        </p>
    </div>

    <div id="imprezja-form-container" style="text-align: center; background: #f8f9fa; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
        <form id="imprezja-machine-form" style="text-align: left; max-width: 400px; margin: 0 auto;">
            <label for="imprezja-machine-id" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Machine ID</label>
            <input type="text" id="imprezja-machine-id" name="machine_id" placeholder="np. a1b2c3d4e5f6g7h8" required
                   style="width: 100%; padding: 12px; font-family: monospace; font-size: 1rem; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
            <p id="imprezja-form-error" style="color: #c0392b; margin-top: 8px; display: none;"></p>
            <div style="text-align: center; margin-top: 16px;">
                <button type="submit" id="imprezja-submit-btn" style="padding: 12px 24px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                    Wyślij klucz na e-mail
                </button>
            </div>
        </form>
    </div>

    <div id="imprezja-success-msg" style="display: none; color: #27ae60; font-size: 1.1rem; margin-bottom: 24px;">
        Klucz licencyjny został wysłany na Twój adres e-mail. Sprawdź skrzynkę (również spam).
    </div>

    <p style="color: #666; margin-top: 24px;">
        W razie pytań skontaktuj się z nami.
    </p>
    <p style="margin-top: 32px;">
        <a href="/" style="display: inline-block; padding: 12px 24px; background: #0073aa; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">Wróć na stronę główną</a>
    </p>
</div>

<script>
(function() {
    const STRIPE_API_URL = 'https://imprezja-quiz-1-0-2-beta.onrender.com';

    function getSessionId() {
        const params = new URLSearchParams(window.location.search);
        return params.get('session_id') || '';
    }

    const sessionId = getSessionId();
    const noSessionEl = document.getElementById('imprezja-no-session');
    const formContainer = document.getElementById('imprezja-form-container');
    const successMsg = document.getElementById('imprezja-success-msg');
    const form = document.getElementById('imprezja-machine-form');
    const errorEl = document.getElementById('imprezja-form-error');
    const submitBtn = document.getElementById('imprezja-submit-btn');

    if (!sessionId) {
        noSessionEl.style.display = 'block';
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.6';
        submitBtn.style.cursor = 'not-allowed';
    }

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!sessionId) return;
        const machineId = document.getElementById('imprezja-machine-id').value.trim();
        if (!machineId) return;

        errorEl.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Wysyłanie...';

        try {
            const res = await fetch(STRIPE_API_URL + '/api/license/deliver', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId, machine_id: machineId })
            });
            const data = await res.json();

            if (res.ok && data.success) {
                formContainer.style.display = 'none';
                noSessionEl.style.display = 'none';
                successMsg.style.display = 'block';
            } else {
                errorEl.textContent = data.error || 'Wystąpił błąd. Spróbuj ponownie lub skontaktuj się z nami.';
                errorEl.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Wyślij klucz na e-mail';
            }
        } catch (err) {
            errorEl.textContent = 'Błąd połączenia. Sprawdź internet i spróbuj ponownie.';
            errorEl.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Wyślij klucz na e-mail';
        }
    });
})();
</script>
