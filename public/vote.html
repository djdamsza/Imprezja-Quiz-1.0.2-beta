<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Imprezja Quiz - Głosowanie</title>
    <link rel="icon" href="data:,">
    <link rel="manifest" href="/manifest.json">
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/profanity-filter.js"></script>
    <!-- Fonty lokalne – aplikacja działa bez internetu (sieć Wi‑Fi wystarczy) -->
    <style>
        /* === ZMIENNE === */
        :root {
            --bg-dark: radial-gradient(circle at center, #1a1a2e, #000);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-gold: #f1c40f;
            --accent-orange: #e67e22;
            --text-white: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.7);

            --color-A: #3498db;
            --color-B: #e74c3c;
            --color-C: #f1c40f;
            --color-D: #2ecc71;
            --color-E: #9b59b6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            /* Wymuś ignorowanie ustawień dostępności systemu - zapobiega powiększaniu czcionek */
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
        }
        
        /* Wymuś ignorowanie ustawień dostępności dla wszystkich elementów tekstowych */
        *, *::before, *::after {
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
        }
        
        /* Wymuś poziomą orientację dla wszystkich elementów odpowiedzi */
        .answer-btn,
        .answer-btn *,
        .answer-letter,
        .answer-text {
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            direction: ltr !important;
            unicode-bidi: normal !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            height: 100vh; 
            height: 100dvh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
            position: fixed;
            top: 0;
            left: 0;
            /* Wymuś ignorowanie ustawień dostępności */
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
        }
        /* Animowane tło (jak na screen.html) */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            z-index: -1;
            background: 
                radial-gradient(ellipse 70% 50% at 30% 30%, rgba(45, 55, 90, 0.85) 0%, transparent 55%),
                radial-gradient(ellipse 60% 70% at 70% 70%, rgba(80, 40, 100, 0.6) 0%, transparent 50%),
                radial-gradient(ellipse 80% 40% at 50% 20%, rgba(30, 60, 100, 0.5) 0%, transparent 45%),
                radial-gradient(ellipse 50% 80% at 10% 60%, rgba(100, 50, 80, 0.4) 0%, transparent 50%);
            animation: bgGradientFlow 12s ease-in-out infinite;
            pointer-events: none;
        }
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(125deg, 
                transparent 0%, 
                rgba(241, 196, 15, 0.03) 25%, 
                transparent 50%,
                rgba(52, 152, 219, 0.04) 75%,
                transparent 100%);
            background-size: 400% 400%;
            animation: bgShimmer 15s linear infinite;
            pointer-events: none;
        }
        @keyframes bgGradientFlow {
            0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); }
            25% { transform: translate(-8%, -5%) scale(1.08) rotate(1deg); }
            50% { transform: translate(5%, 8%) scale(0.95) rotate(-0.5deg); }
            75% { transform: translate(-4%, 4%) scale(1.05) rotate(0.8deg); }
        }
        @keyframes bgShimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            width: 100%;
            height: 100%;
            max-width: 100%;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch;
        }

        /* === NAGŁÓWEK Z TIMEREM (jak na screen.html) === */
        .voting-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            gap: 15px;
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* WAŻNE: Podczas dogrywki wymuś wyśrodkowanie header-question */
        #voting-screen.playoff-mode .voting-header,
        .playoff-mode .voting-header,
        #voting-screen:has(.playoff-ui) .voting-header {
            justify-content: center !important;
        }
        
        /* Podczas dogrywki ukryj timer badge aby nie przesuwał elementów */
        #voting-screen.playoff-mode .header-timer,
        .playoff-mode .header-timer,
        #voting-screen:has(.playoff-ui) .header-timer {
            display: none !important;
            width: 0 !important;
            min-width: 0 !important;
        }
        
        .header-timer {
            flex-shrink: 0;
            width: 72px;
            min-width: 72px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-question {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-width: 0;
            padding: 0 10px;
            width: 100%;
            /* Wymuś ignorowanie ustawień dostępności */
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
        }
        
        /* WAŻNE: Wymuś wyśrodkowanie dla header-question podczas dogrywki */
        #voting-screen.playoff-mode .header-question,
        .playoff-mode .header-question,
        #voting-screen:has(.playoff-ui) .header-question {
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
            width: 100% !important;
        }
        
        /* WAŻNE: Upewnij się że header-question wyśrodkowuje question-text podczas dogrywki */
        #voting-screen.playoff-mode .header-question #question-text,
        .playoff-mode .header-question #question-text,
        #voting-screen:has(.playoff-ui) .header-question #question-text {
            margin: 0 auto !important;
            text-align: center !important;
            width: 100% !important;
        }
        
        /* WAŻNE: Ukryj wszystkie pseudo-elementy które mogą tworzyć kropki na wszystkich stronach */
        .header-timer::before,
        .header-timer::after,
        .header-question::before,
        .header-question::after,
        #timer-badge::before,
        #timer-badge::after,
        .question-text::before,
        .question-text::after,
        /* Ekran logowania */
        #login-screen::before,
        #login-screen::after,
        .logo::before,
        .logo::after,
        .subtitle::before,
        .subtitle::after,
        .input-group::before,
        .input-group::after,
        /* Ekran oczekiwania */
        #waiting-screen::before,
        #waiting-screen::after,
        .intro-title::before,
        .intro-title::after,
        .waiting-icon::before,
        .waiting-icon::after,
        .waiting-text::before,
        .waiting-text::after,
        .waiting-subtitle::before,
        .waiting-subtitle::after,
        .player-info::before,
        .player-info::after,
        .player-name::before,
        .player-name::after,
        .player-score::before,
        .player-score::after,
        /* Ekran wyboru drużyny */
        #team-selection-screen::before,
        #team-selection-screen::after,
        .team-selection-title::before,
        .team-selection-title::after,
        .team-btn::before,
        .team-btn::after,
        /* Ekran głosowania */
        #voting-screen::before,
        #voting-screen::after,
        .voting-header::before,
        .voting-header::after,
        /* Ekran rankingu */
        #leaderboard-screen::before,
        #leaderboard-screen::after,
        .leaderboard-title::before,
        .leaderboard-title::after,
        .leaderboard-list::before,
        .leaderboard-list::after,
        .leaderboard-item::before,
        .leaderboard-item::after,
        .rank::before,
        .rank::after,
        .player-nick::before,
        .player-nick::after,
        .player-score-lb::before,
        .player-score-lb::after,
        /* Ekran podium */
        #podium-screen::before,
        #podium-screen::after,
        .podium-title::before,
        .podium-title::after,
        .podium-waiting::before,
        .podium-waiting::after,
        .podium-place::before,
        .podium-place::after,
        .podium-nick::before,
        .podium-nick::after,
        .podium-score::before,
        .podium-score::after,
        /* Kontener główny */
        .container::before,
        .container::after {
            display: none !important;
            content: '' !important;
        }
        
        /* === TIMER BADGE (w nagłówku) – stała szerokość, żeby treść pytania się nie przesuwała === */
        #timer-badge {
            background: rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.3);
            color: var(--accent-gold);
            padding: 8px 12px;
            border-radius: 50px;
            font-weight: 800;
            font-size: clamp(0.9rem, 3vw, 1.2rem) !important;
            backdrop-filter: blur(5px);
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            white-space: nowrap;
            width: 64px;
            min-width: 64px;
            box-sizing: border-box;
            text-align: center;
            /* Wymuś ignorowanie ustawień dostępności */
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
        }
        
        #timer-badge #time-left {
            color: var(--accent-gold);
            transition: color 0.3s;
            font-size: inherit !important;
            /* Wymuś ignorowanie ustawień dostępności */
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
        }
        
        #timer-badge #time-left.warning {
            color: #e74c3c;
        }
        
        /* Responsywność nagłówka */
        @media (max-width: 400px) {
            .voting-header {
                padding: 10px;
                gap: 10px;
            }
            .header-timer {
                width: 64px;
                min-width: 64px;
            }
            .header-question {
                min-width: 0;
            }
            #timer-badge {
                font-size: clamp(0.8rem, 2.5vw, 1rem);
                padding: 6px 10px;
                width: 56px;
                min-width: 56px;
            }
        }

        /* === EKRAN LOGOWANIA === */
        #login-screen {
            display: block; /* Domyślnie widoczny - zostanie ukryty po rejestracji */
            text-align: center;
            animation: fadeIn 0.5s;
        }

        .logo {
            font-size: clamp(1.8rem, 8vw, 3rem);
            font-weight: 900;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
            background: -webkit-linear-gradient(#f1c40f, #e67e22);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: none;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .subtitle {
            font-size: clamp(1rem, 4vw, 1.4rem);
            margin-bottom: 30px;
            opacity: 0.9;
            color: rgba(255,255,255,0.8);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
        }

        .profanity-warning {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            padding: 10px 20px;
            background: rgba(231, 76, 60, 0.95);
            color: white;
            border-radius: 8px;
            font-size: clamp(0.85rem, 3vw, 1rem);
            font-weight: 700;
            text-align: center;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.5);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        input[type="text"] {
            width: 100%;
            padding: 18px;
            font-size: clamp(1rem, 4vw, 1.3rem);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        input[type="text"]::placeholder {
            color: rgba(255,255,255,0.5);
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #f1c40f;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.4);
        }

        .btn {
            width: 100%;
            padding: 18px;
            font-size: clamp(1rem, 4vw, 1.3rem);
            font-weight: 700;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f1c40f, #e67e22);
            color: #000;
        }

        .btn-primary:active {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* === EKRAN OCZEKIWANIA === */
        #waiting-screen {
            display: none;
            text-align: center;
            animation: fadeIn 0.5s;
        }

        .intro-title {
            font-size: clamp(1.5rem, 6vw, 4rem);
            font-weight: 900;
            background: -webkit-linear-gradient(#f1c40f, #e67e22);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
            animation: titlePulse 3s ease-in-out infinite;
            text-transform: uppercase;
            letter-spacing: clamp(2px, 1vw, 5px);
            padding: 0 15px;
            text-align: center;
        }

        @keyframes titlePulse {
            0%, 100% {
                transform: scale(1);
                filter: brightness(1);
            }
            50% {
                transform: scale(1.08);
                filter: brightness(1.3);
            }
        }

        /* === PRZEJŚCIA EKRANÓW === */
        .container.screen-transition > [id$="-screen"] {
            transition: opacity 0.35s ease-out, transform 0.35s ease-out;
        }
        .container.screen-transition > [id$="-screen"]:not(.screen-visible) {
            opacity: 0;
            transform: translateY(12px);
            pointer-events: none;
        }
        .container.screen-transition > [id$="-screen"].screen-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* === Cienie pod napisami (delikatne) === */
        .logo, .intro-title, .waiting-text, .player-name, .question-text,
        .header-question #question-text, .voting-header .question-text {
            text-shadow: 0 1px 2px rgba(0,0,0,0.4), 0 2px 6px rgba(0,0,0,0.25);
        }
        .subtitle, .waiting-subtitle, .player-info h3 {
            text-shadow: 0 1px 3px rgba(0,0,0,0.35);
        }

        /* === Przyciski odpowiedzi – wyjeżdżają po kolei === */
        .answers-grid .answer-btn {
            animation: answerSlideIn 0.45s ease-out backwards;
        }
        .answers-grid .answer-btn:nth-child(1) { animation-delay: 0.05s; }
        .answers-grid .answer-btn:nth-child(2) { animation-delay: 0.12s; }
        .answers-grid .answer-btn:nth-child(3) { animation-delay: 0.19s; }
        .answers-grid .answer-btn:nth-child(4) { animation-delay: 0.26s; }
        .answers-grid .answer-btn:nth-child(5) { animation-delay: 0.33s; }
        .answers-grid .answer-btn:nth-child(6) { animation-delay: 0.40s; }
        .answers-grid .answer-btn:nth-child(n+7) { animation-delay: 0.47s; }
        @keyframes answerSlideIn {
            from {
                opacity: 0;
                transform: translateY(24px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* === Grafika w pytaniu – wejście === */
        #hero-image-container.hero-reveal {
            animation: heroReveal 0.5s ease-out;
        }
        #hero-image-container.hero-reveal #hero-image {
            animation: heroImageReveal 0.55s ease-out 0.05s backwards;
        }
        @keyframes heroReveal {
            from {
                opacity: 0;
                transform: scale(0.96);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes heroImageReveal {
            from {
                opacity: 0;
                transform: scale(0.92);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* === Zegar – pulsowanie przy 5 sekundach i mniej === */
        #timer-badge.timer-urgent {
            animation: timerPulse 0.8s ease-in-out infinite;
        }
        #timer-badge.timer-urgent #time-left {
            color: #ff6b6b !important;
        }
        @keyframes timerPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
            50% { transform: scale(1.12); box-shadow: 0 0 20px rgba(231, 76, 60, 0.6); }
        }

        /* === Treść pytania – animacja „wpisywania” (ujawnienie) === */
        .question-text.question-reveal {
            animation: questionReveal 0.55s ease-out;
        }
        @keyframes questionReveal {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .waiting-icon {
            width: 200px;
            height: 200px;
            margin: 0 auto 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .waiting-text {
            font-size: clamp(1.2rem, 5vw, 1.8rem);
            font-weight: 700;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
            color: #f1c40f;
        }

        .waiting-subtitle {
            font-size: clamp(0.9rem, 3.5vw, 1.2rem);
            opacity: 0.7;
            color: rgba(255,255,255,0.7);
        }

        .player-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .player-info h3 {
            font-size: clamp(0.85rem, 3vw, 1rem);
            margin-bottom: 8px;
            opacity: 0.7;
            color: rgba(255,255,255,0.7);
        }

        .player-name {
            font-size: 1.8rem;
            font-weight: 900;
            color: white;
            margin-bottom: 10px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
        }

        .player-score {
            font-size: clamp(1.8rem, 7vw, 3rem);
            font-weight: 900;
            background: -webkit-linear-gradient(#f1c40f, #e67e22);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* === EKRAN WYBORU DRUŻYNY === */
        #team-selection-screen {
            display: none;
            text-align: center;
            animation: fadeIn 0.5s;
            width: 100%;
            min-height: 100%;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        .team-selection-title {
            font-size: clamp(1.2rem, 5vw, 1.8rem);
            margin-bottom: 20px;
            font-weight: 700;
            text-align: center;
            padding: 0 15px;
        }

        .team-btn {
            margin: 15px auto;
            padding: 20px;
            font-size: clamp(1rem, 4vw, 1.3rem);
            font-weight: 700;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            width: 80%;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
            background: linear-gradient(135deg, #f1c40f, #e67e22);
            color: #000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: all 0.3s;
            white-space: normal;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .team-btn:active {
            transform: scale(0.98);
        }
        
        .team-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        }

        /* === EKRAN GŁOSOWANIA === */
        #voting-screen {
            display: none;
            animation: fadeIn 0.5s;
            height: 100%;
            width: 100%;
            max-width: 100%;
            flex-direction: column;
            position: relative;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        .eliminated-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 20px;
        }
        .eliminated-message {
            font-size: clamp(1.5rem, 5vw, 2.2rem);
            font-weight: 900;
            color: #e74c3c;
            text-align: center;
            margin-bottom: 10px;
        }
        .eliminated-sub {
            font-size: clamp(0.9rem, 3vw, 1.1rem);
            color: rgba(255,255,255,0.8);
            text-align: center;
        }

        .estimation-ui {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
            min-height: 0;
            flex: 1;
        }
        .estimation-ui input[type="range"] {
            width: 100%;
            height: 48px;
            accent-color: var(--accent-gold);
            box-sizing: border-box;
        }
        .estimation-ui input[type="number"] {
            width: 100%;
            max-width: 200px;
            padding: 16px;
            font-size: 1.5rem;
            text-align: center;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.3);
            color: var(--text-white);
            box-sizing: border-box;
        }
        .estimation-ui .est-submit-btn {
            align-self: center;
            padding: 18px 48px;
            font-size: 1.2rem;
            font-weight: 800;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-orange));
            color: #000;
        }

        /* Statki: zawartość od góry (bez wyśrodkowania pionowego) */
        #voting-screen.ships-mode {
            display: flex !important;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
            min-height: 0;
            padding: 0;
        }
        #voting-screen.ships-mode .answers-grid {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            flex: 1 1 0;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .ships-game-container {
            width: 100%;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 16px;
            padding: 10px;
            min-height: 0;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .ships-board-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: auto;
            flex: 0 0 auto;
            flex-shrink: 0;
            min-height: 0;
        }

        #voting-screen.ships-mode .ships-board-table {
            margin-left: auto;
            margin-right: auto;
        }
        
        .ships-stats-container {
            width: 100%;
            max-width: 600px;
            flex: 0 0 auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            /* Na telefonie: przewijanie, na TV: ucięcie ale pokaż maksymalnie dużo */
            max-height: calc(100vh - 400px); /* Pozostaw miejsce na planszę i nagłówek */
        }
        
        /* Na większych ekranach (TV) - ogranicz wysokość tabeli */
        @media (min-width: 1024px) {
            .ships-stats-container {
                max-height: 50vh;
            }
        }

        .ships-board-table {
            border-collapse: collapse;
            border: 2px solid #0066cc;
            background: #000;
        }

        .ships-board-table th,
        .ships-board-table td {
            border: 1px solid #0066cc;
            text-align: center;
            vertical-align: middle;
            transition: all 0.2s;
        }

        .ships-board-table .ships-cell:hover {
            background: #003366 !important;
            box-shadow: inset 0 0 10px #00aaff;
        }

        .ships-board-table .ships-hit {
            background: #22aa44 !important;
            box-shadow: 0 0 15px #22aa44;
            animation: shipsHitPop 0.3s ease-out;
        }

        .ships-board-table .ships-miss {
            background: #667788 !important;
            opacity: 0.7;
        }

        @keyframes shipsHitPop {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .ships-controls {
            display: flex;
            gap: 15px;
            width: 100%;
            max-width: 400px;
            justify-content: center;
        }

        .ships-next-turn-btn,
        .ships-end-btn {
            flex: 1;
            padding: 15px;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 8px;
            border: 2px solid;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ships-next-turn-btn {
            background: #0066cc;
            border-color: #00aaff;
            color: #fff;
        }

        .ships-next-turn-btn:hover {
            background: #0088ff;
            box-shadow: 0 0 20px #00aaff;
        }

        .ships-end-btn {
            background: #cc0000;
            border-color: #ff0044;
            color: #fff;
        }

        .ships-end-btn:hover {
            background: #ff0000;
            box-shadow: 0 0 20px #ff0044;
        }

        .open-question-ui {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 20px;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }
        .open-question-ui input[type="text"] {
            width: 100%;
            max-width: 100%;
            padding: 18px;
            font-size: clamp(1.1rem, 4vw, 1.3rem);
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.3);
            color: var(--text-white);
            text-align: center;
            box-sizing: border-box;
        }
        .open-question-ui .open-submit-btn {
            align-self: center;
            width: 25%;
            min-width: 120px;
            padding: 18px 48px;
            font-size: 1.2rem;
            font-weight: 800;
            border-radius: 12px;
            background: #2e7d32;
            color: white;
            text-align: center;
        }
        .letter-question-ui {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            gap: 15px;
        }
        
        .letter-question-ui .letter-submit-btn {
            align-self: center;
            padding: 18px 48px;
            font-size: 1.2rem;
            font-weight: 800;
            border-radius: 12px;
            background: #2e7d32;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            text-align: center;
            width: auto;
            max-width: 300px;
            min-width: 120px;
        }
        
        /* WAŻNE: Podczas dogrywki ukryj przycisk "Wyślij" z pytania z literą */
        .playoff-mode .letter-question-ui,
        .playoff-mode .letter-submit-btn {
            display: none !important;
        }
        .letter-question-ui .letter-submit-btn:hover:not(.answer-locked) {
            background: #388e3c;
            transform: scale(1.02);
        }
        .letter-question-ui .letter-submit-btn:active:not(.answer-locked) {
            transform: scale(0.98);
        }
        .letter-question-ui .letter-submit-btn.answer-locked {
            background: #1b5e20;
            color: rgba(255,255,255,0.9);
            cursor: default;
        }
        .letter-sent-msg {
            display: none;
            text-align: center;
            color: #2e7d32;
            font-weight: 700;
            font-size: 1rem;
            margin-top: 10px;
        }
        .playoff-ui { 
            display: flex !important; 
            flex-direction: row !important; 
            gap: 20px !important; 
            justify-content: center !important; 
            align-items: center !important; 
            flex-wrap: nowrap !important; 
            padding: 20px !important; 
            width: 100% !important;
            max-width: 100% !important;
        }
        .playoff-ui .answer-btn { 
            padding: 25px 40px !important; 
            font-size: clamp(1.2rem, 5vw, 1.8rem) !important; 
            font-weight: 800 !important; 
            border-radius: 15px !important; 
            min-width: 120px !important; 
            flex: 0 1 auto !important;
            cursor: pointer !important;
            border: none !important;
            transition: all 0.3s !important;
            max-width: 45% !important;
            width: auto !important;
            pointer-events: auto !important;
            z-index: 100 !important;
            position: relative !important;
        }
        
        /* WAŻNE: Upewnij się że przyciski dogrywki nie są zablokowane przez answer-locked */
        .playoff-ui .answer-btn.answer-locked {
            pointer-events: none !important;
        }
        
        /* Domyślnie przyciski dogrywki są klikalne */
        .playoff-ui .answer-btn:not(.answer-locked) {
            pointer-events: auto !important;
        }
        .playoff-ui .answer-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .playoff-ui .answer-btn:active {
            transform: scale(0.98);
        }
        @media (max-width: 380px) {
            .playoff-ui { 
                gap: 16px !important; 
                padding: 16px !important; 
                flex-direction: row !important;
            }
            .playoff-ui .answer-btn { 
                padding: 20px 30px !important; 
                min-width: 100px !important; 
            }
        }
        /* Dla WSZYSTKICH rozmiarów ekranu - wymuś poziomą orientację */
        @media (min-width: 0px) {
            .playoff-ui {
                flex-direction: row !important;
                flex-wrap: nowrap !important;
            }
            .playoff-ui .answer-btn {
                flex: 0 1 auto !important;
                max-width: 45% !important;
            }
        }
        .answers-grid.playoff-mode { 
            display: flex !important; 
            justify-content: center !important; 
            align-items: center !important; 
            padding: 20px !important; 
            flex-direction: row !important;
            width: 100% !important;
            max-width: 100% !important;
            pointer-events: auto !important;
            z-index: 100 !important;
            position: relative !important;
            min-height: 200px !important;
        }
        .answers-grid.playoff-mode .playoff-ui { 
            margin: 0 auto !important; 
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: nowrap !important;
            width: auto !important;
            max-width: 100% !important;
            gap: 20px !important;
        }
        
        /* Wzmocnij reguły dla WSZYSTKICH rozmiarów ekranu - wymuś poziomą orientację */
        @media screen and (min-width: 0px) {
            .playoff-ui {
                flex-direction: row !important;
                flex-wrap: nowrap !important;
            }
            .answers-grid.playoff-mode {
                display: flex !important;
                flex-direction: row !important;
            }
            .answers-grid.playoff-mode .playoff-ui {
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                display: flex !important;
            }
        }
        
        /* WAŻNE: Ukryj wszystkie pseudo-elementy ::before i ::after dla przycisków dogrywki */
        .playoff-btn-tak::before,
        .playoff-btn-tak::after,
        .playoff-btn-nie::before,
        .playoff-btn-nie::after,
        .answer-btn.playoff-btn-tak::before,
        .answer-btn.playoff-btn-tak::after,
        .answer-btn.playoff-btn-nie::before,
        .answer-btn.playoff-btn-nie::after,
        [data-playoff-btn="true"]::before,
        [data-playoff-btn="true"]::after,
        .playoff-ui .answer-btn::before,
        .playoff-ui .answer-btn::after,
        .answers-grid.playoff-mode .answer-btn::before,
        .answers-grid.playoff-mode .answer-btn::after {
            display: none !important;
            content: '' !important;
            height: 0 !important;
            width: 0 !important;
            position: absolute !important;
            top: -9999px !important;
            left: -9999px !important;
            opacity: 0 !important;
            visibility: hidden !important;
            background: none !important;
            box-shadow: none !important;
        }
        .playoff-btn-tak { 
            background: #2196f3 !important; 
            color: white !important; 
            text-align: center !important;
            position: relative !important;
        }
        .playoff-btn-tak .answer-letter,
        .playoff-btn-tak .answer-text {
            display: none !important;
        }
        .playoff-btn-nie { 
            background: #e74c3c !important; 
            color: white !important; 
            text-align: center !important;
            position: relative !important;
        }
        .playoff-btn-nie .answer-letter,
        .playoff-btn-nie .answer-text {
            display: none !important;
        }
        
        /* Słowo wybrane do dogrywki - styl jak normalne pytania */
        /* Słowo wybrane do dogrywki - styl jak normalne pytania - WYMUSZONE !important */
        .playoff-word {
            font-size: clamp(1rem, 4vw, 1.3rem) !important;
            font-weight: 700 !important;
            color: white !important;
            text-align: center !important;
            margin: 0 auto 10px auto !important;
            line-height: 1.35 !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            width: 100% !important;
            max-width: 100% !important;
            display: block !important;
            text-transform: none !important;
            letter-spacing: normal !important;
        }
        
        /* Napis DOGRYWKA - przywróć złoty gradient i animację pulsowania */
        .playoff-title-pulse {
            font-size: clamp(1.5rem, 6vw, 3rem) !important;
            font-weight: 900 !important;
            background: -webkit-linear-gradient(#f1c40f, #e67e22) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            text-transform: uppercase !important;
            letter-spacing: clamp(2px, 1vw, 5px) !important;
            text-align: center !important;
            animation: titlePulse 3s ease-in-out infinite !important;
            margin: 0 auto 20px auto !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            width: 100% !important;
            max-width: 100% !important;
            display: block !important;
        }
        
        /* Ukryj wszystkie pseudo-elementy które mogą tworzyć kropki w elementach dogrywki */
        .playoff-word::before,
        .playoff-word::after,
        .playoff-title-pulse::before,
        .playoff-title-pulse::after {
            display: none !important;
            content: '' !important;
        }
        
        /* Wyniki dogrywki na telefonie - ulepszone style z cieniami, ramkami i gradientami */
        .vote-results-playoff {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Poziomy pasek wyników dogrywki (jak na screen.html) - ulepszony z !important */
        .playoff-screen-grid,
        .playoff-ui .playoff-screen-grid,
        .answers-grid .playoff-screen-grid,
        .answers-grid.playoff-mode .playoff-screen-grid {
            display: flex !important;
            width: 100% !important;
            max-width: 100% !important;
            min-height: 140px !important;
            border-radius: 20px !important;
            overflow: hidden !important;
            box-shadow: 0 12px 40px rgba(0,0,0,0.5), 
                        0 4px 12px rgba(0,0,0,0.3),
                        inset 0 1px 0 rgba(255,255,255,0.1) !important;
            flex-shrink: 0 !important;
            border: 2px solid rgba(255,255,255,0.15) !important;
            backdrop-filter: blur(10px) !important;
            background: rgba(0,0,0,0.2) !important;
            margin: 0 auto !important;
        }
        
        .playoff-card,
        .playoff-screen-grid .playoff-card {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 24px 20px !important;
            flex: 1 !important;
            min-width: 0 !important;
            min-height: 120px !important;
            position: relative !important;
            transition: all 0.3s ease !important;
            border-right: 2px solid rgba(255,255,255,0.1) !important;
        }
        
        .playoff-card:last-child,
        .playoff-screen-grid .playoff-card:last-child {
            border-right: none !important;
        }
        
        .playoff-card::before,
        .playoff-screen-grid .playoff-card::before {
            content: '' !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0)) !important;
            opacity: 0 !important;
            transition: opacity 0.3s ease !important;
            pointer-events: none !important;
        }
        
        .playoff-card:hover::before,
        .playoff-screen-grid .playoff-card:hover::before {
            opacity: 1 !important;
        }
        
        .playoff-tak,
        .playoff-card.playoff-tak,
        .playoff-screen-grid .playoff-card.playoff-tak {
            background: linear-gradient(135deg, #1976d2, #2196f3, #42a5f5) !important;
            color: #fff !important;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.2),
                        0 4px 20px rgba(33, 150, 243, 0.4) !important;
        }
        
        .playoff-nie,
        .playoff-card.playoff-nie,
        .playoff-screen-grid .playoff-card.playoff-nie {
            background: linear-gradient(135deg, #c62828, #e74c3c, #ef5350) !important;
            color: #fff !important;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.2),
                        0 4px 20px rgba(231, 76, 60, 0.4) !important;
        }
        
        .playoff-label,
        .playoff-card .playoff-label,
        .playoff-screen-grid .playoff-label {
            font-size: clamp(1.5rem, 4vw, 2.5rem) !important;
            font-weight: 900 !important;
            margin-bottom: 6px !important;
            text-shadow: 0 3px 10px rgba(0,0,0,0.5),
                         0 1px 3px rgba(0,0,0,0.8) !important;
            letter-spacing: 1px !important;
            text-transform: uppercase !important;
            color: #fff !important;
        }
        
        .playoff-pct,
        .playoff-card .playoff-pct,
        .playoff-screen-grid .playoff-pct {
            font-size: clamp(1.4rem, 3.5vw, 2.2rem) !important;
            font-weight: 800 !important;
            margin-top: 4px !important;
            text-shadow: 0 2px 8px rgba(0,0,0,0.6),
                         0 1px 2px rgba(0,0,0,0.8) !important;
            color: #fff !important;
        }
        
        .playoff-count,
        .playoff-card .playoff-count,
        .playoff-screen-grid .playoff-count {
            font-size: clamp(1rem, 2.5vw, 1.4rem) !important;
            opacity: 0.95 !important;
            margin-top: 4px !important;
            text-shadow: 0 2px 6px rgba(0,0,0,0.5) !important;
            font-weight: 600 !important;
            color: #fff !important;
        }
        
        /* Prezentacja wyników na telefonie (OPEN / ESTIMATION) */
        .vote-results-word-cloud { display: flex; flex-wrap: wrap; gap: 10px 16px; justify-content: center; align-items: center; padding: 20px; }
        .vote-results-word-cloud .word-tag { color: #fff; font-weight: 800; text-shadow: 0 2px 6px rgba(0,0,0,0.5); }
        .vote-results-estimation-box { 
            background: rgba(255,255,255,0.1); 
            border-radius: 16px; 
            padding: 24px; 
            text-align: center; 
            width: 100%; 
            max-width: 100%; 
            box-sizing: border-box; 
            border: 2px solid rgba(255,255,255,0.2); 
        }
        .vote-results-estimation-box .correct-label { 
            font-size: clamp(0.9rem, 2.5vw, 1.1rem); 
            color: rgba(255,255,255,0.85); 
            margin-bottom: 16px; 
        }
        .vote-results-estimation-box .correct-value { 
            font-size: clamp(1.8rem, 5vw, 2.8rem); 
            font-weight: 900; 
            color: #2ecc71; 
            margin-bottom: 16px; 
        }
        .vote-results-estimation-box .stats-row { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px 12px; 
            justify-content: center; 
        }
        .vote-results-estimation-box .stat-tag { 
            background: rgba(255,255,255,0.15); 
            padding: 6px 12px; 
            border-radius: 16px; 
            font-size: clamp(0.85rem, 2.2vw, 1rem); 
            font-weight: 700; 
        }
        
        /* Wykres poziomy dla estymacji */
        .estimation-chart-container {
            width: 100%;
            padding: 20px 0;
        }
        .estimation-chart {
            position: relative;
            width: 100%;
            margin: 30px 0 20px 0;
        }
        .estimation-chart-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            font-weight: 700;
            color: rgba(255,255,255,0.9);
        }
        .estimation-chart-track {
            position: relative;
            width: 100%;
            height: 200px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 10px;
            box-sizing: border-box;
        }
        .estimation-chart-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, rgba(255,255,255,0.3), rgba(255,255,255,0.5), rgba(255,255,255,0.3));
            transform: translateY(-50%);
            border-radius: 2px;
        }
        .estimation-bar {
            position: absolute;
            bottom: 50%;
            width: 8px;
            min-width: 4px;
            background: linear-gradient(to top, #3498db, #2980b9);
            border-radius: 4px 4px 0 0;
            transform: translateX(-50%);
            transition: all 0.3s;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4);
        }
        .estimation-bar:hover {
            transform: translateX(-50%) scaleX(1.5);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.6);
        }
        .estimation-bar-value {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: clamp(0.75rem, 2vw, 0.9rem);
            font-weight: 700;
            color: rgba(255,255,255,0.9);
            white-space: nowrap;
            margin-bottom: 4px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .estimation-bar-count {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: clamp(0.7rem, 1.8vw, 0.85rem);
            font-weight: 600;
            color: rgba(255,255,255,0.8);
            white-space: nowrap;
            margin-top: 4px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .estimation-correct-marker {
            position: absolute;
            top: 50%;
            width: 4px;
            height: 30px;
            background: #2ecc71;
            transform: translate(-50%, -50%);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.8);
            z-index: 10;
        }
        .estimation-correct-marker::before {
            content: '✓';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            color: #2ecc71;
            font-size: 1.2rem;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .vote-results-quiz { display: contents; }

        .question-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 14px 16px;
            border-radius: 14px;
            margin-bottom: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
            overflow-y: hidden;
        }
        
        /* Gdy brak obrazka - ukryj question-header całkowicie (nie zajmuje miejsca) */
        #voting-screen.no-image .question-header {
            display: none;
        }
        
        /* Dla dogrywki - całkowicie ukryj question-header z obrazkiem */
        #voting-screen.playoff-mode .question-header,
        .playoff-mode .question-header,
        #voting-screen:has(.playoff-ui) .question-header {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            max-height: 0 !important;
            overflow: hidden !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        /* Upewnij się że question-text jest widoczny podczas dogrywki */
        #voting-screen.playoff-mode #question-text,
        .playoff-mode #question-text,
        #voting-screen:has(.playoff-ui) #question-text {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            height: auto !important;
            max-height: none !important;
            overflow: visible !important;
            position: static !important;
            left: auto !important;
        }
        
        /* Upewnij się że playoff-title-pulse jest widoczny */
        .playoff-title-pulse {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Dla dogrywki - ukryj hero-image-container */
        #voting-screen.playoff-mode #hero-image-container,
        .playoff-mode #hero-image-container,
        #voting-screen:has(.playoff-ui) #hero-image-container {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            max-height: 0 !important;
            overflow: hidden !important;
        }
        
        #voting-screen.playoff-mode #hero-image,
        .playoff-mode #hero-image,
        #voting-screen:has(.playoff-ui) #hero-image {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            width: 0 !important;
            height: 0 !important;
            src: '' !important;
        }
        
        /* Ukryj question-header podczas dogrywki */
        #voting-screen.playoff-mode .question-header,
        .playoff-mode .question-header,
        #voting-screen:has(.playoff-ui) .question-header {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            max-height: 0 !important;
            overflow: hidden !important;
            position: absolute !important;
            left: -9999px !important;
        }

        /* OBRAZEK W PYTANIU – bez nakładek, czysty obraz */
        #hero-image-container { 
            display: none; 
            width: 100%; 
            margin-bottom: 15px; 
            border-radius: 10px; 
            overflow: hidden; 
        }
        
        #hero-image { 
            width: 100%; 
            height: auto; 
            display: block; 
            object-fit: contain; 
            max-height: 220px; 
        }

        .question-text {
            font-size: clamp(1rem, 4vw, 1.3rem) !important;
            font-weight: 700;
            line-height: 1.35;
            color: white;
            margin: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: none;
            max-width: 100%;
            width: 100%;
            text-align: center;
            /* Wymuś ignorowanie ustawień dostępności */
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
        }
        
        /* WAŻNE: Wymuś wyśrodkowanie dla question-text podczas dogrywki - wyższy priorytet niż style pytań otwartych */
        #voting-screen.playoff-mode #question-text,
        .playoff-mode #question-text,
        #voting-screen:has(.playoff-ui) #question-text,
        #question-text[data-playoff-active="true"] {
            text-align: center !important;
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 auto !important;
            display: block !important;
        }
        
        /* WAŻNE: Wymuś wyśrodkowanie dla elementów dogrywki wewnątrz question-text */
        #question-text[data-playoff-active="true"] .playoff-word,
        #question-text[data-playoff-active="true"] .playoff-title-pulse,
        .playoff-mode #question-text .playoff-word,
        .playoff-mode #question-text .playoff-title-pulse {
            text-align: center !important;
            width: 100% !important;
            max-width: 100% !important;
            margin-left: auto !important;
            margin-right: auto !important;
            display: block !important;
        }
        
        /* Obsługa wieloliniowych pytań */
        .question-text.multi-line {
            line-height: 1.4;
        }
        
        .question-text.two-lines {
            font-size: clamp(0.95rem, 3.8vw, 1.25rem) !important;
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
        }
        
        .question-text.three-lines {
            font-size: clamp(0.9rem, 3.5vw, 1.15rem) !important;
            line-height: 1.5;
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
        }
        
        /* Gdy brak obrazka - większy tekst pytania */
        #voting-screen.no-image .question-text {
            font-size: clamp(1.2rem, 5vw, 1.6rem) !important;
            margin-bottom: 30px;
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
        }

        /* === UJEDNOLICONY UKŁAD ODPOWIEDZI === */
        .answers-grid {
            display: grid;
            gap: 12px;
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            align-content: start;
            box-sizing: border-box;
            width: 100%;
            /* Automatyczny układ responsywny - 2 kolumny gdy jest miejsce, 1 gdy tekst jest długi */
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 200px), 1fr));
        }
        
        /* Dla 2 odpowiedzi - zawsze obok siebie jeśli szerokość pozwala */
        .answers-grid:has(.answer-btn:nth-child(2):last-child) {
            grid-template-columns: repeat(2, 1fr);
        }
        
        /* Dla 3-4 odpowiedzi - 2 kolumny */
        .answers-grid:has(.answer-btn:nth-child(3):last-child),
        .answers-grid:has(.answer-btn:nth-child(4):last-child) {
            grid-template-columns: repeat(2, 1fr);
        }
        
        /* Dla 5+ odpowiedzi - automatycznie dostosowuje się do szerokości */
        .answers-grid:has(.answer-btn:nth-child(5)) {
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 180px), 1fr));
        }
        
        /* Gdy brak obrazka - lepsze wykorzystanie przestrzeni */
        #voting-screen.no-image .answers-grid {
            align-content: center;
            gap: 15px;
            padding: 20px 15px;
        }

        /* Tryb listy - tylko gdy jest więcej niż 4 odpowiedzi i tekst jest bardzo długi */
        .answers-grid.list-mode {
            grid-template-columns: 1fr;
        }
        
        /* Responsywność - na bardzo małych ekranach zawsze 1 kolumna */
        @media (max-width: 360px) {
            .answers-grid {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Pytania muzyczne - specjalny układ */
        #voting-screen.music-mode {
            display: flex;
            flex-direction: column;
        }
        
        /* Pytania muzyczne - grafika w górnej części */
        #voting-screen.music-mode #hero-image-container {
            display: block !important;
            flex: 0 0 auto;
            max-height: 35vh;
            margin-bottom: 20px;
            order: 1;
        }
        
        #voting-screen.music-mode #hero-image {
            max-height: 35vh;
            object-fit: contain;
        }
        
        /* Pytania muzyczne - nagłówek pytania */
        #voting-screen.music-mode .question-header {
            flex: 0 0 auto;
            order: 0;
        }
        
        /* Pytania muzyczne - kafelki w dolnej części ekranu */
        #voting-screen.music-mode .answers-grid {
            flex: 1 1 auto;
            min-height: 0;
            /* WAŻNE: Zawsze użyj układu 2 kolumny dla pytań muzycznych (jak QUIZ) */
            grid-template-columns: 1fr 1fr !important;
            gap: 15px;
            padding: 15px;
            align-content: start;
            order: 2;
            overflow-y: auto;
        }
        
        /* Dla pytań muzycznych z 2 odpowiedziami - zawsze obok siebie */
        #voting-screen.music-mode .answers-grid:has(.answer-btn:nth-child(2):last-child) {
            grid-template-columns: repeat(2, 1fr) !important;
        }
        
        /* WAŻNE: Dla pytań muzycznych z więcej niż 2 odpowiedziami - również układ 2 kolumny */
        #voting-screen.music-mode .answers-grid:has(.answer-btn:nth-child(3)),
        #voting-screen.music-mode .answers-grid:has(.answer-btn:nth-child(4)),
        #voting-screen.music-mode .answers-grid:has(.answer-btn:nth-child(5)) {
            grid-template-columns: 1fr 1fr !important;
        }
        
        /* Pytania muzyczne - używają tego samego stylu co inne pytania (ujednolicone) */
        #voting-screen.music-mode .answer-btn {
            min-height: 80px;
            padding: 15px;
            font-size: clamp(0.9rem, 3.5vw, 1.1rem) !important;
        }
        
        #voting-screen.music-mode .answer-text {
            font-size: clamp(0.85rem, 3vw, 1.1rem) !important;
        }
        
        /* Estymacja, pytanie otwarte i wyniki – blok na całą szerokość siatki, wyśrodkowana zawartość */
        .answers-grid .estimation-ui,
        .answers-grid .open-question-ui,
        .answers-grid .letter-question-ui,
        .answers-grid .vote-results-word-cloud,
        .answers-grid .vote-results-estimation-box,
        .answers-grid .vote-results-quiz {
            grid-column: 1 / -1;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* WAŻNE: Nadpisz style dla open-question-ui gdy jest dogrywka - wymuś poziomą orientację dla playoff-ui */
        .answers-grid.playoff-mode .open-question-ui {
            display: none !important; /* Ukryj open-question-ui podczas dogrywki */
        }
        
        .answers-grid.playoff-mode .playoff-ui {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: nowrap !important;
            gap: 20px !important;
            justify-content: center !important;
            align-items: center !important;
            padding: 20px !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        .answers-grid:has(.vote-results-word-cloud),
        .answers-grid:has(.vote-results-estimation-box),
        .answers-grid:has(.vote-results-quiz) {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* HOT_OR_NOT - układ obrazków na telefonie */
        .hot-or-not-mode #hero-image-container {
            display: none !important;
        }
        
        /* BATTLE BAR dla HOT_OR_NOT na vote.html */
        #hot-battle-bar-container {
            position: fixed;
            bottom: 20px;
            left: 5%;
            width: 90%;
            height: 60px;
            background: linear-gradient(to right, #c0392b, #e74c3c);
            border-radius: 50px;
            overflow: hidden;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7), inset 0 5px 10px rgba(0,0,0,0.3);
            border: 4px solid rgba(255, 255, 255, 0.2);
            z-index: 50;
        }
        
        #hot-battle-bar-fill {
            height: 100%;
            width: 50%;
            background: linear-gradient(to right, #2980b9, #3498db);
            transition: width 0.5s ease-out;
            position: relative;
            border-right: 2px solid rgba(255,255,255,0.8);
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
        }
        
        .hot-battle-score {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            font-weight: 900;
            z-index: 20;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            color: #fff;
        }
        
        .hot-score-a {
            left: 20px;
        }
        
        .hot-score-b {
            right: 20px;
        }
        
        .hot-or-not-grid {
            display: grid;
            width: 100%;
            gap: 10px;
            flex: 1;
            min-height: 0;
            padding: 5px;
            box-sizing: border-box;
        }
        
        .hot-or-not-grid.layout-horizontal {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr;
            gap: 8px;
            padding: 5px;
            align-items: stretch;
            max-height: min(70vh, 500px);
            min-height: 200px;
            overflow: hidden;
        }
        
        .hot-or-not-grid.layout-vertical {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 10px;
            padding: 5px;
            max-height: min(85vh, 700px);
            min-height: 200px;
            overflow: hidden;
        }
        
        .hot-or-not-grid.layout-mixed {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr;
            gap: 10px;
            padding: 5px;
            align-items: stretch;
        }
        
        /* Na telefonie - sprawdź orientację zdjęć przed wymuszeniem układu pionowego */
        /* Jeśli oba zdjęcia są pionowe, pokaż je obok siebie nawet na telefonie */
        @media (max-width: 768px) {
            /* Domyślnie układ pionowy na telefonie, ale layout-horizontal (dla zdjęć pionowych) pozostaje obok siebie */
            .hot-or-not-grid.layout-vertical {
                grid-template-columns: 1fr !important;
                grid-template-rows: 1fr 1fr !important;
            }
            .hot-or-not-grid.layout-mixed {
                grid-template-columns: 1fr !important;
                grid-template-rows: 1fr 1fr !important;
            }
            /* Layout horizontal (zdjęcia pionowe obok siebie) pozostaje bez zmian */
        }
        @media (orientation: portrait) {
            /* Podobnie dla orientacji pionowej urządzenia */
            .hot-or-not-grid.layout-vertical {
                grid-template-columns: 1fr !important;
                grid-template-rows: 1fr 1fr !important;
            }
            .hot-or-not-grid.layout-mixed {
                grid-template-columns: 1fr !important;
                grid-template-rows: 1fr 1fr !important;
            }
        }
        
        /* layout-mixed ma aspect-ratio 1/1 w .hot-image-wrapper poniżej */
        
        .hot-image-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s;
            min-height: 0;
            height: 100%;
            flex: 1 1 auto;
        }
        
        .hot-image-card:active {
            transform: scale(0.98);
        }
        
        .hot-image-card.answer-selected {
            border-color: #f1c40f;
            border-width: 3px;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.5);
        }
        
        .hot-image-card.answer-locked {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .hot-image-wrapper {
            flex: 1 1 auto;
            display: block;
            overflow: hidden;
            position: relative;
            min-height: 0;
            aspect-ratio: 4 / 3;
            width: 100%;
            max-height: min(50vh, 360px);
        }
        
        /* Obrazki poziome (landscape) – mieszczą się na ekranie, obok siebie */
        .hot-or-not-grid.layout-horizontal .hot-image-wrapper {
            aspect-ratio: 16 / 10;
            flex: 1 1 auto;
            min-height: 0;
            max-height: min(45vh, 320px);
        }
        .hot-or-not-grid.layout-horizontal .hot-image-wrapper img {
            object-fit: contain;
            max-height: 100%;
            width: 100%;
        }
        .hot-or-not-grid.layout-horizontal .hot-image-answer {
            padding: 6px 8px;
            font-size: clamp(0.7rem, 2.2vw, 0.9rem);
            flex-shrink: 0;
            line-height: 1.2;
            max-height: 2.6em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        /* Więcej miejsca na obrazki w HOT OR NOT – maksymalnie zwarty nagłówek */
        .hot-or-not-mode .voting-header {
            padding: 8px 10px;
            flex-shrink: 0;
        }
        .hot-or-not-mode .question-header {
            padding: 8px 10px;
            margin-bottom: 5px;
            flex-shrink: 0;
        }
        
        /* Obrazki pionowe (portrait) – maksymalnie duże, pokaż całe */
        .hot-or-not-grid.layout-vertical .hot-image-wrapper {
            aspect-ratio: unset;
            flex: 1 1 auto;
            min-height: 0;
            max-height: 100%;
        }
        .hot-or-not-grid.layout-vertical .hot-image-wrapper img {
            object-fit: contain;
            max-height: 100%;
        }
        
        /* Mieszane (jeden pion, drugi poziom) – maksymalnie duże */
        .hot-or-not-grid.layout-mixed .hot-image-wrapper {
            aspect-ratio: unset;
            flex: 1 1 auto;
            min-height: 0;
            max-height: 100%;
        }
        .hot-or-not-grid.layout-mixed .hot-image-wrapper img {
            object-fit: contain;
            max-height: 100%;
        }
        
        .hot-image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* Ukryj fallback "Brak obrazka" gdy obrazek jest załadowany */
        .hot-image-wrapper:has(img[src]:not([src=""])) > div {
            display: none !important;
        }
        
        .hot-image-label {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: clamp(0.9rem, 3.5vw, 1.2rem) !important;
            font-weight: 900;
            text-transform: uppercase;
            z-index: 10;
            backdrop-filter: blur(8px);
            /* Wymuś ignorowanie ustawień dostępności */
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
        }
        
        .hot-card-a .hot-image-label {
            background: rgba(52, 152, 219, 0.9);
        }
        
        .hot-card-b .hot-image-label {
            background: rgba(231, 76, 60, 0.9);
        }
        
        .hot-image-answer {
            padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            text-align: center;
            font-size: clamp(0.9rem, 3.5vw, 1.2rem) !important;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            /* Wymuś ignorowanie ustawień dostępności */
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
        }

        /* Animacja tła przycisków (jak na screen – gradient flow w kolorze przycisku) */
        @keyframes answerBtnFlow {
            0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; }
            25% { transform: translate(-3%, -2%) scale(1.06) rotate(0.5deg); opacity: 0.95; }
            50% { transform: translate(2%, 3%) scale(0.97) rotate(-0.3deg); opacity: 1; }
            75% { transform: translate(-2%, 2%) scale(1.03) rotate(0.4deg); opacity: 0.98; }
        }
        @keyframes answerBtnShimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* === UJEDNOLICONY STYL PRZYCISKÓW ODPOWIEDZI === */
        .answer-btn {
            padding: 15px;
            font-size: clamp(0.9rem, 3.5vw, 1.1rem) !important;
            font-weight: 700;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            display: flex !important;
            flex-direction: row !important;
            align-items: center;
            flex-wrap: nowrap;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(15px);
            background: linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
            border: 1px solid rgba(255,255,255,0.12);
            min-height: 70px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            /* Wymuś ignorowanie ustawień dostępności */
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
            /* Wymuś poziomą orientację tekstu */
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            direction: ltr !important;
            box-shadow: 0 6px 22px rgba(0,0,0,0.45);
        }
        .answer-btn .answer-letter,
        .answer-btn .answer-text { position: relative; z-index: 1; }
        
        /* Gdy brak obrazka - większe przyciski (zachowaj spójność) */
        #voting-screen.no-image .answer-btn {
            padding: 20px;
            min-height: 90px;
            font-size: clamp(1rem, 4vw, 1.3rem) !important;
        }
        
        #voting-screen.no-image .answer-text {
            font-size: clamp(0.95rem, 3.8vw, 1.25rem) !important;
        }

        .answer-btn:active {
            transform: scale(0.98);
        }

        /* Warstwa animowana (pasek + gradient w kolorze przycisku) */
        .answer-btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
            z-index: 0;
            border-radius: inherit;
            pointer-events: none;
        }
        .ans-a::before {
            background: linear-gradient(to bottom, var(--color-A) 0, var(--color-A) 6px, transparent 6px),
                radial-gradient(ellipse 70% 50% at 30% 30%, rgba(52, 152, 219, 0.45) 0%, transparent 55%),
                radial-gradient(ellipse 60% 70% at 70% 70%, rgba(52, 152, 219, 0.28) 0%, transparent 50%);
            animation: answerBtnFlow 10s ease-in-out infinite;
            box-shadow: inset 0 0 30px rgba(52, 152, 219, 0.08);
        }
        .ans-b::before {
            background: linear-gradient(to bottom, var(--color-B) 0, var(--color-B) 6px, transparent 6px),
                radial-gradient(ellipse 70% 50% at 30% 30%, rgba(231, 76, 60, 0.45) 0%, transparent 55%),
                radial-gradient(ellipse 60% 70% at 70% 70%, rgba(231, 76, 60, 0.28) 0%, transparent 50%);
            animation: answerBtnFlow 10s ease-in-out infinite;
            box-shadow: inset 0 0 30px rgba(231, 76, 60, 0.08);
        }
        .ans-c::before {
            background: linear-gradient(to bottom, var(--color-C) 0, var(--color-C) 6px, transparent 6px),
                radial-gradient(ellipse 70% 50% at 30% 30%, rgba(241, 196, 15, 0.45) 0%, transparent 55%),
                radial-gradient(ellipse 60% 70% at 70% 70%, rgba(241, 196, 15, 0.28) 0%, transparent 50%);
            animation: answerBtnFlow 10s ease-in-out infinite;
            box-shadow: inset 0 0 30px rgba(241, 196, 15, 0.08);
        }
        .ans-d::before {
            background: linear-gradient(to bottom, var(--color-D) 0, var(--color-D) 6px, transparent 6px),
                radial-gradient(ellipse 70% 50% at 30% 30%, rgba(46, 204, 113, 0.45) 0%, transparent 55%),
                radial-gradient(ellipse 60% 70% at 70% 70%, rgba(46, 204, 113, 0.28) 0%, transparent 50%);
            animation: answerBtnFlow 10s ease-in-out infinite;
            box-shadow: inset 0 0 30px rgba(46, 204, 113, 0.08);
        }
        .ans-e::before {
            background: linear-gradient(to bottom, var(--color-E) 0, var(--color-E) 6px, transparent 6px),
                radial-gradient(ellipse 70% 50% at 30% 30%, rgba(155, 89, 182, 0.45) 0%, transparent 55%),
                radial-gradient(ellipse 60% 70% at 70% 70%, rgba(155, 89, 182, 0.28) 0%, transparent 50%);
            animation: answerBtnFlow 10s ease-in-out infinite;
            box-shadow: inset 0 0 30px rgba(155, 89, 182, 0.08);
        }
        /* Cień przycisku w kolorze odpowiedzi */
        .ans-a { box-shadow: 0 6px 22px rgba(0,0,0,0.45), 0 0 28px -4px rgba(52, 152, 219, 0.5); }
        .ans-b { box-shadow: 0 6px 22px rgba(0,0,0,0.45), 0 0 28px -4px rgba(231, 76, 60, 0.5); }
        .ans-c { box-shadow: 0 6px 22px rgba(0,0,0,0.45), 0 0 28px -4px rgba(241, 196, 15, 0.5); }
        .ans-d { box-shadow: 0 6px 22px rgba(0,0,0,0.45), 0 0 28px -4px rgba(46, 204, 113, 0.5); }
        .ans-e { box-shadow: 0 6px 22px rgba(0,0,0,0.45), 0 0 28px -4px rgba(155, 89, 182, 0.5); }

        .answer-letter {
            width: clamp(40px, 10vw, 50px);
            height: clamp(40px, 10vw, 50px);
            border-radius: 10px;
            display: flex !important;
            flex-direction: row !important;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: clamp(1rem, 3.5vw, 1.4rem) !important;
            margin-right: 15px;
            background: rgba(0,0,0,0.3);
            flex-shrink: 0;
            /* Wymuś ignorowanie ustawień dostępności */
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
            /* Wymuś poziomą orientację tekstu */
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            direction: ltr !important;
            white-space: nowrap !important;
        }

        /* Kolory liter */
        .ans-a .answer-letter { color: var(--color-A); text-shadow: 0 0 10px var(--color-A); }
        .ans-b .answer-letter { color: var(--color-B); text-shadow: 0 0 10px var(--color-B); }
        .ans-c .answer-letter { color: var(--color-C); text-shadow: 0 0 10px var(--color-C); }
        .ans-d .answer-letter { color: var(--color-D); text-shadow: 0 0 10px var(--color-D); }
        .ans-e .answer-letter { color: var(--color-E); text-shadow: 0 0 10px var(--color-E); }

        .answer-text {
            flex: 1;
            font-weight: 700;
            color: white;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: none;
            min-width: 0;
            /* Wymuś ignorowanie ustawień dostępności i zapobiegnij pionowemu wyświetlaniu */
            -webkit-text-size-adjust: none !important;
            -moz-text-size-adjust: none !important;
            -ms-text-size-adjust: none !important;
            text-size-adjust: none !important;
            white-space: normal !important;
            display: block !important;
            /* Wymuś poziomą orientację tekstu - zapobiega wyświetlaniu każdej litery w osobnej linii */
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            direction: ltr !important;
            /* Dopasuj rozmiar czcionki do szerokości - użyj clamp z vw */
            font-size: clamp(0.85rem, 3vw, 1.1rem) !important;
            /* Zawijaj długie odpowiedzi na wiele linii */
            word-break: break-word;
            overflow-wrap: anywhere;
        }

        .answer-selected {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(241, 196, 15, 0.6);
            border: 3px solid #f1c40f !important;
        }

        .answer-selected::after {
            content: '✓';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2rem;
            font-weight: 900;
            color: #f1c40f;
        }

        .answer-locked {
            opacity: 0.6;
            pointer-events: none;
        }

        /* === EKRAN RANKINGU === */
        #leaderboard-screen {
            display: none;
            animation: fadeIn 0.5s;
        }

        .leaderboard-title {
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            font-weight: 900;
            text-align: center;
            margin-bottom: 25px;
            background: -webkit-linear-gradient(#f1c40f, #e67e22);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .leaderboard-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            max-height: 60vh;
            overflow-y: auto;
            margin: 0 auto;
            max-width: 600px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            font-weight: 600;
            border-left: 5px solid rgba(241, 196, 15, 0.5);
            min-width: 0;
            overflow: hidden;
        }

        .leaderboard-item:last-child {
            margin-bottom: 0;
        }

        /* Team Battle - wyniki drużyn na telefonie */
        .team-score-card-vote {
            padding: 25px 30px;
            border-radius: 15px;
            text-align: center;
            min-width: 140px;
            max-width: 200px;
            flex: 1;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.2);
        }
        /* Usuń krople (pseudo-elementy) z kart wyników drużyn */
        .team-score-card-vote::before,
        .team-score-card-vote::after,
        .team-score-name-vote::before,
        .team-score-name-vote::after,
        .team-score-value-vote::before,
        .team-score-value-vote::after,
        .team-a-card-vote::before,
        .team-a-card-vote::after,
        .team-b-card-vote::before,
        .team-b-card-vote::after,
        #vote-team-score-display::before,
        #vote-team-score-display::after {
            display: none !important;
            content: '' !important;
        }
        .team-a-card-vote {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-color: #2980b9;
        }
        .team-b-card-vote {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-color: #c0392b;
        }
        .team-score-name-vote {
            font-size: clamp(1rem, 4vw, 1.3rem);
            font-weight: 900;
            color: white;
            margin-bottom: 12px;
            text-transform: uppercase;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        .team-score-value-vote {
            font-size: clamp(2rem, 8vw, 3rem);
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 12px rgba(0,0,0,0.6);
        }

        .rank {
            width: clamp(35px, 8vw, 40px);
            height: clamp(35px, 8vw, 40px);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            margin-right: 15px;
            font-size: clamp(1rem, 3vw, 1.3rem);
            flex-shrink: 0;
        }

        .rank-1 {
            background: linear-gradient(135deg, #f39c12, #f1c40f);
            border: 2px solid #fff;
            color: #000;
            font-size: 1.5rem;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.6);
        }

        .rank-2 {
            background: linear-gradient(135deg, #7f8c8d, #bdc3c7);
            border: 2px solid #fff;
            color: #000;
            box-shadow: 0 0 20px rgba(189, 195, 199, 0.4);
        }

        .rank-3 {
            background: linear-gradient(135deg, #8c5620, #cd7f32);
            border: 2px solid #fff;
            color: white;
            box-shadow: 0 0 20px rgba(205, 127, 50, 0.4);
        }

        .player-nick {
            flex: 1;
            font-size: clamp(1rem, 4vw, 1.3rem);
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
            min-width: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-score-lb {
            font-size: clamp(1rem, 4vw, 1.4rem);
            font-weight: 900;
            color: #f1c40f;
        }

        /* === EKRAN PODZIĘKOWAŃ === */
        #thanks-screen {
            display: none;
            text-align: center;
            animation: fadeIn 0.5s;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 40px 20px;
            height: 100%;
            max-height: 100dvh;
            box-sizing: border-box;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: relative;
        }
        
        .thanks-title {
            font-size: clamp(2rem, 8vw, 4rem);
            font-weight: 900;
            margin-bottom: 30px;
            text-align: center;
            background: -webkit-linear-gradient(#f1c40f, #e67e22);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }
        
        .thanks-content {
            font-size: clamp(1.2rem, 5vw, 2rem);
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 30px;
            line-height: 1.6;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .thanks-image-container img {
            max-width: 90vw;
            max-height: 60vh;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            object-fit: contain;
        }

        /* === EKRAN PODIUM === */
        #podium-screen {
            display: none;
            text-align: center;
            animation: fadeIn 0.5s;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 8px 12px;
            height: 100%;
            max-height: 100dvh;
            box-sizing: border-box;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            width: 100%;
            position: relative;
        }
        
        /* Upewnij się że kontener podium-screen jest widoczny gdy jest aktywny */
        #podium-screen[style*="display: flex"],
        #podium-screen[style*="display:block"] {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        @media (max-height: 700px) {
            #podium-screen .podium-title { font-size: clamp(1rem, 4vw, 1.4rem); margin-bottom: 8px; }
            #podium-screen .podium-place { padding: 10px 14px; margin-bottom: 8px; }
            #podium-screen .podium-place h2 { font-size: 0.85rem; margin-bottom: 4px; }
            #podium-screen .podium-nick { font-size: clamp(0.85rem, 3vw, 1.1rem); }
            #podium-screen .podium-score { font-size: clamp(0.9rem, 3.5vw, 1.2rem); }
            #podium-screen .player-info { padding: 10px; margin-bottom: 8px; }
            #podium-screen .podium-waiting { margin-bottom: 8px; font-size: 0.9rem; }
        }

        .podium-title {
            font-size: clamp(1.3rem, 5vw, 2rem);
            font-weight: 900;
            margin-bottom: 20px;
            text-align: center;
            background: -webkit-linear-gradient(#f1c40f, #e67e22);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .podium-waiting {
            font-size: clamp(1rem, 4vw, 1.4rem);
            color: rgba(255,255,255,0.7);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .podium-place {
            background: rgba(255, 255, 255, 0.05);
            padding: 22px;
            border-radius: 20px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
            visibility: hidden;
            opacity: 0;
            min-height: 100px;
            width: 100%;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }

        .podium-place.revealed {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            animation: revealPlace 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        
        /* Wymuś widoczność miejsc w trybie drużynowym - bardziej agresywne podejście */
        #podium-screen .podium-place.revealed {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Dodatkowe wymuszenie dla konkretnych miejsc */
        #podium-1.revealed,
        #podium-2.revealed,
        #podium-3.revealed {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        @keyframes revealPlace {
            0% { 
                opacity: 0; 
                transform: scale(0.8) translateY(30px); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        .podium-place h2 {
            font-size: clamp(1rem, 4vw, 1.3rem);
            margin-bottom: 10px;
            color: rgba(255,255,255,0.7);
        }

        .podium-nick {
            font-size: clamp(1rem, 4vw, 1.6rem);
            font-weight: 900;
            margin-bottom: 5px;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        .podium-score {
            font-size: clamp(1.2rem, 5vw, 2rem);
            font-weight: 900;
        }

        .place-1 {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.2), rgba(241, 196, 15, 0.2));
            border: 3px solid #f1c40f;
            box-shadow: 0 0 40px rgba(241, 196, 15, 0.4);
        }

        .place-1 .podium-score {
            background: -webkit-linear-gradient(#f1c40f, #e67e22);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .place-2 {
            background: linear-gradient(135deg, rgba(127, 140, 141, 0.2), rgba(189, 195, 199, 0.2));
            border: 3px solid #bdc3c7;
            box-shadow: 0 0 40px rgba(189, 195, 199, 0.3);
        }

        .place-2 .podium-score {
            color: #bdc3c7;
        }

        .place-3 {
            background: linear-gradient(135deg, rgba(140, 86, 32, 0.2), rgba(205, 127, 50, 0.2));
            border: 3px solid #cd7f32;
            box-shadow: 0 0 40px rgba(205, 127, 50, 0.3);
        }

        .place-3 .podium-score {
            color: #cd7f32;
        }

        /* Animacje */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .spinner {
            border: 4px solid rgba(241, 196, 15, 0.3);
            border-top: 4px solid #f1c40f;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Baner braku połączenia z serwerem */
        #connection-lost-banner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: #fff;
            padding: 12px 16px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 0.95rem;
        }
        #connection-lost-banner.show { display: block; }
        #connection-lost-banner .retry-btn {
            margin-left: 12px;
            padding: 6px 14px;
            background: rgba(255,255,255,0.25);
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 6px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
        }
        #connection-lost-banner .retry-btn:hover { background: rgba(255,255,255,0.4); }
    </style>
</head>
<body>
    <!-- Baner: brak połączenia z serwerem (zamiast alertu) -->
    <div id="connection-lost-banner" role="alert">
        Brak połączenia z serwerem.
        <button type="button" class="retry-btn" id="connection-retry-btn">Ponów</button>
    </div>

    <div class="container">
        <!-- EKRAN LOGOWANIA -->
        <div id="login-screen">
            <div class="logo">🎮 Imprezja Quiz</div>
            <div class="subtitle">Wpisz swoje imię</div>
            
            <div class="input-group">
                <input type="text" id="nick-input" placeholder="Twoje imię..." maxlength="20" autocomplete="off">
                <div id="nick-empty-warning" class="profanity-warning" style="display: none;">Wpisz swoje imię!</div>
                <div id="nick-warning" class="profanity-warning" style="display: none;">NICK NIEDOSTĘPNY</div>
            </div>
            <button class="btn btn-primary" id="join-game-btn" onclick="if(typeof window.registerPlayer==='function'){window.registerPlayer();}">DOŁĄCZ DO GRY</button>
        </div>

        <!-- EKRAN OCZEKIWANIA -->
        <div id="waiting-screen">
            <div class="intro-title" id="intro-title">Imprezja Quiz</div>
            
            <!-- Kody QR – przekaż dalej dostęp do gry (gdy admin włączył opcję) -->
            <div id="qr-on-phones-waiting" style="display: none; margin: 20px 0;">
                <div style="text-align: center;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">📱 Przekaż dalej dostęp do gry</h3>
                    <div style="display: flex; flex-direction: row; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: flex-start;">
                        <div id="notv-wifi-block-waiting" style="width: 100%; max-width: 220px; display: none;">
                            <h4 style="margin-bottom: 8px; font-size: 0.9rem;">📶 WiFi</h4>
                            <div id="notv-wifi-qr-waiting" style="background: white; padding: 10px; border-radius: 8px; display: inline-block;"></div>
                            <div id="notv-wifi-ssid-waiting" style="margin-top: 8px; font-size: 0.85rem; font-weight: bold;"></div>
                        </div>
                        <div id="notv-local-block-waiting" style="width: 100%; max-width: 220px; display: none;">
                            <h4 style="margin-bottom: 8px; font-size: 0.9rem;">🎮 Gra (Wi‑Fi)</h4>
                            <div id="notv-local-qr-waiting" style="background: white; padding: 10px; border-radius: 8px; display: inline-block;"></div>
                        </div>
                        <div id="notv-tunnel-block-waiting" style="width: 100%; max-width: 220px; display: none;">
                            <h4 style="margin-bottom: 8px; font-size: 0.9rem;">🌐 Gra (sieć komórkowa)</h4>
                            <div id="notv-tunnel-qr-waiting" style="background: white; padding: 10px; border-radius: 8px; display: inline-block;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="waiting-icon" id="waiting-icon">👥📺</div>
            <div class="waiting-text" id="waiting-text">Czekaj na rozpoczęcie zabawy!</div>
            <div class="waiting-subtitle" id="waiting-subtitle">Obserwuj ekran główny</div>
            
            <div class="player-info">
                <h3>Twoje imię:</h3>
                <div class="player-name" id="display-nick">---</div>
                <div class="player-score" id="display-score">0 pkt</div>
            </div>
            
            <div class="spinner"></div>
        </div>

        <!-- EKRAN WYBORU DRUŻYNY -->
        <div id="team-selection-screen">
            <div class="team-selection-title">Wybierz swoją drużynę</div>
            <button id="team-a-btn" class="btn team-btn" onclick="selectTeam('A')">Drużyna A</button>
            <button id="team-b-btn" class="btn team-btn" onclick="selectTeam('B')">Drużyna B</button>
        </div>

        <!-- EKRAN GŁOSOWANIA -->
        <div id="voting-screen">
            <!-- Nagłówek z timerem i pytaniem -->
            <div class="voting-header">
                <div class="header-timer">
                    <div id="timer-badge">⏱ <span id="time-left">30</span></div>
                </div>
                <div class="header-question">
                    <div class="question-text" id="question-text">Pytanie...</div>
                </div>
            </div>
            
            <div class="question-header">
                <!-- Obrazek -->
                <div id="hero-image-container">
                    <img id="hero-image" src="" alt="Obrazek pytania">
                </div>
            </div>
            <div class="answers-grid" id="answers-grid"></div>
            
            <!-- BATTLE BAR dla HOT_OR_NOT -->
            <div id="hot-battle-bar-container">
                <div class="hot-battle-score hot-score-a" id="hot-score-val-a">0%</div>
                <div id="hot-battle-bar-fill"></div>
                <div class="hot-battle-score hot-score-b" id="hot-score-val-b">0%</div>
            </div>
            
            <!-- Overlay gdy gracz jest wyeliminowany -->
            <!-- WAŻNE: Overlay nie powinien blokować dogrywki - z-index niższy niż przyciski -->
            <div id="eliminated-overlay" class="eliminated-overlay" style="display: none; z-index: 40;">
                <div class="eliminated-message">💀 Jesteś wyeliminowany</div>
                <div class="eliminated-sub">Zła odpowiedź – do końca rundy nie zdobywasz punktów.</div>
            </div>
        </div>

        <!-- EKRAN RANKINGU -->
        <div id="leaderboard-screen">
            <div class="leaderboard-title">🏆 TOP 10</div>
            <div class="leaderboard-list" id="leaderboard-list"></div>
            
            <!-- Wynik drużynowy (Team Battle) – pokazywany zamiast TOP 10 gdy teamBattleMode === true -->
            <div id="vote-team-score-display" style="display:none; margin-top: 30px; text-align: center;">
                <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin: 0 auto; max-width: 600px;">
                    <div class="team-score-card-vote team-a-card-vote">
                        <div class="team-score-name-vote" id="vote-team-name-a">Team A</div>
                        <div class="team-score-value-vote" id="vote-team-score-a">0</div>
                    </div>
                    <div class="team-score-card-vote team-b-card-vote">
                        <div class="team-score-name-vote" id="vote-team-name-b">Team B</div>
                        <div class="team-score-value-vote" id="vote-team-score-b">0</div>
                    </div>
                </div>
            </div>
            
            <div class="player-info" style="margin-top: 25px; text-align: center;">
                <h3>Twój wynik:</h3>
                <div class="player-name" id="lb-nick">---</div>
                <div class="player-score" id="lb-score">0 pkt</div>
            </div>
        </div>

        <!-- EKRAN PODZIĘKOWAŃ -->
        <div id="thanks-screen">
            <div class="thanks-title" id="thanks-title">🎉 Dziękuję za udział w zabawie</div>
            <div class="thanks-content" id="thanks-content"></div>
            <div class="thanks-image-container" id="thanks-image-container" style="display: none; margin-top: 30px; text-align: center;">
                <img id="thanks-image" src="" alt="Podziękowania" style="max-width: 90vw; max-height: 60vh; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            </div>
        </div>

        <!-- EKRAN PODIUM -->
        <div id="podium-screen">
            <div class="podium-title" id="podium-title-header" style="display: block !important; visibility: visible !important; opacity: 1 !important; text-align: center !important; font-size: clamp(1.3rem, 5vw, 2rem) !important; font-weight: 900 !important; margin-bottom: 20px !important; background: -webkit-linear-gradient(#f1c40f, #e67e22) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important;">🏆 PODIUM</div>
            <div class="podium-waiting" id="podium-waiting">Obserwuj ekran główny...</div>
            
            <!-- Miejsce gracza (zawsze widoczne) -->
            <div class="player-info" style="margin-bottom: 20px;">
                <h3>Twój wynik końcowy:</h3>
                <div class="player-name" id="podium-my-nick">---</div>
                <div class="player-score" id="podium-my-score">0 pkt</div>
            </div>
            
            <!-- Miejsca podium (pokazywane stopniowo: 3 -> 2 -> 1) -->
            <div id="podium-3" class="podium-place place-3">
                <h2>🥉 3. MIEJSCE</h2>
                <div class="podium-nick" id="nick-3">---</div>
                <div class="podium-score" id="score-3">0 pkt</div>
            </div>
            
            <div id="podium-2" class="podium-place place-2">
                <h2>🥈 2. MIEJSCE</h2>
                <div class="podium-nick" id="nick-2">---</div>
                <div class="podium-score" id="score-2">0 pkt</div>
            </div>
            
            <div id="podium-1" class="podium-place place-1">
                <h2>🥇 1. MIEJSCE</h2>
                <div class="podium-nick" id="nick-1">---</div>
                <div class="podium-score" id="score-1">0 pkt</div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let playerNick = '';
        let playerScore = 0;
        let currentQuestionId = null;
        let hasAnswered = false;
        let playerAnswerIndex = null; // Przechowuj indeks odpowiedzi gracza
        let currentPodiumStep = -1;
        let quizTitle = 'Imprezja Quiz';
        let wakeLock = null;
        let timerInterval = null;
        let playerTeam = null;
        let currentGameState = null;
        let playerEliminated = false;

        console.log('🎮 Aplikacja gracza uruchomiona');
        
        // Inicjalizacja - pokaż ekran logowania jeśli gracz nie jest zarejestrowany
        window.addEventListener('DOMContentLoaded', () => {
            console.log('📱 DOM załadowany - sprawdzam stan gracza');
            
            // Dodaj event listener dla przycisku "DOŁĄCZ DO GRY" (backup dla onclick)
            const joinBtn = document.getElementById('join-game-btn');
            if (joinBtn) {
                joinBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('🔘 Kliknięto przycisk DOŁĄCZ DO GRY');
                    if (typeof window.registerPlayer === 'function') {
                        window.registerPlayer();
                    } else {
                        console.error('❌ window.registerPlayer nie jest funkcją!');
                        // Funkcja jeszcze się nie załadowała - poczekaj chwilę
                        setTimeout(() => {
                            if (typeof window.registerPlayer === 'function') {
                                window.registerPlayer();
                            } else {
                                console.error('❌ window.registerPlayer nadal nie jest dostępna po oczekiwaniu');
                            }
                        }, 100);
                    }
                });
                // Nadpisz onclick aby używał window.registerPlayer
                joinBtn.onclick = function(e) {
                    e.preventDefault();
                    if (typeof window.registerPlayer === 'function') {
                        window.registerPlayer();
                    } else {
                        // Funkcja jeszcze się nie załadowała - poczekaj chwilę
                        setTimeout(() => {
                            if (typeof window.registerPlayer === 'function') {
                                window.registerPlayer();
                            }
                        }, 100);
                    }
                };
                console.log('✅ Event listener dodany do przycisku DOŁĄCZ DO GRY');
            } else {
                console.warn('⚠️ Nie znaleziono przycisku join-game-btn');
            }
            
            try {
                const savedNick = localStorage.getItem('voteBattle_nick');
                if (!savedNick || savedNick.trim() === '') {
                    // Brak zapisanego nicku - pokaż ekran logowania
                    const loginScreen = document.getElementById('login-screen');
                    if (loginScreen) {
                        loginScreen.style.display = 'block';
                        console.log('✅ Pokazuję ekran logowania');
                    }
                } else {
                    // Jest zapisany nick - ukryj ekran logowania (zostanie pokazany po reconnect)
                    const loginScreen = document.getElementById('login-screen');
                    if (loginScreen) {
                        loginScreen.style.display = 'none';
                        console.log('✅ Ukrywam ekran logowania - gracz ma zapisany nick:', savedNick);
                    }
                }
            } catch (e) {
                console.warn('Błąd przy inicjalizacji:', e);
                // W przypadku błędu pokaż ekran logowania
                const loginScreen = document.getElementById('login-screen');
                if (loginScreen) loginScreen.style.display = 'block';
            }
        });

        // === FULLSCREEN (automatyczny po logowaniu) ===
        function requestFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(e => console.log('Fullscreen error:', e));
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        // === WAKE LOCK (ekran nie gaśnie; wymaga HTTPS lub localhost) ===
        async function requestWakeLock() {
            if (!('wakeLock' in navigator) || document.visibilityState !== 'visible') return;
            try {
                if (wakeLock) {
                    try { await wakeLock.release(); } catch (e) {}
                    wakeLock = null;
                }
                wakeLock = await navigator.wakeLock.request('screen');
                wakeLock.addEventListener('release', () => { wakeLock = null; });
            } catch (err) {
                if (window.isSecureContext === false) console.warn('Wake Lock: wymaga HTTPS lub localhost');
            }
        }
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                requestWakeLock();
                if (playerNick && socket.connected) socket.emit('request_state');
            }
        });
        function requestWakeLockOnce() {
            requestWakeLock();
            document.removeEventListener('click', requestWakeLockOnce);
            document.removeEventListener('touchstart', requestWakeLockOnce);
        }
        document.addEventListener('click', requestWakeLockOnce, { once: true });
        document.addEventListener('touchstart', requestWakeLockOnce, { once: true });

        // === POŁĄCZENIE ===
        const connectionBanner = document.getElementById('connection-lost-banner');
        const connectionRetryBtn = document.getElementById('connection-retry-btn');
        function showConnectionLost() {
            if (connectionBanner) connectionBanner.classList.add('show');
        }
        function hideConnectionLost() {
            if (connectionBanner) connectionBanner.classList.remove('show');
        }
        if (connectionRetryBtn) {
            connectionRetryBtn.addEventListener('click', () => {
                hideConnectionLost();
                if (socket && !socket.connected) socket.connect();
            });
        }

        socket.on('connect', () => {
            console.log('✅ Połączono z serwerem, socket.id:', socket.id);
            hideConnectionLost();

            // Automatyczna rejestracja przy reconnect jeśli gracz był wcześniej zarejestrowany
            try {
                const savedNick = localStorage.getItem('voteBattle_nick');
                const savedTeam = localStorage.getItem('voteBattle_team');
                
                if (savedNick && savedNick.trim() !== '') {
                    console.log('🔄 Automatyczna rejestracja przy reconnect:', savedNick);
                    playerNick = savedNick;
                    if (savedTeam) {
                        playerTeam = savedTeam;
                        // Wyślij informację o drużynie do serwera
                        socket.emit('player_join_team', savedTeam);
                    }
                    // Zarejestruj gracza ponownie
                    registerPlayer(savedNick);
                } else {
                    // Jeśli nie ma zapisanego nicku, pokaż ekran logowania
                    console.log('📱 Brak zapisanego nicku - pokazuję ekran logowania');
                    const loginScreen = document.getElementById('login-screen');
                    if (loginScreen) loginScreen.style.display = 'block';
                }
            } catch (e) {
                console.warn('Nie można odczytać z localStorage:', e);
            }
            
            // Poproś o aktualny stan gry po połączeniu
            socket.emit('request_state');
        });
        
        socket.on('disconnect', () => {
            console.log('❌ Rozłączono z serwerem');
            showConnectionLost();
        });

        socket.on('connect_error', (error) => {
            console.error('❌ Błąd połączenia:', error);
            showConnectionLost();
        });
        
        // Obsługa kodów QR „przekaż dalej dostęp” – WiFi, gra lokalna, tunel
        socket.on('qr_codes_on_phones', (data) => {
            console.log('📱 Otrzymano kody QR (przekaż dalej dostęp)');
            const wifiBlock = document.getElementById('notv-wifi-block-waiting');
            const localBlock = document.getElementById('notv-local-block-waiting');
            const tunnelBlock = document.getElementById('notv-tunnel-block-waiting');
            if (wifiBlock) wifiBlock.style.display = data.wifiQR ? 'block' : 'none';
            if (localBlock) localBlock.style.display = data.localGameQR ? 'block' : 'none';
            if (tunnelBlock) tunnelBlock.style.display = data.tunnelQR ? 'block' : 'none';
            if (data.wifiQR) {
                const c = document.getElementById('notv-wifi-qr-waiting');
                if (c) c.innerHTML = `<img src="${data.wifiQR.qrCode}" alt="QR WiFi" style="max-width: 200px; height: auto;">`;
                const s = document.getElementById('notv-wifi-ssid-waiting');
                if (s) s.textContent = data.wifiSSID || '';
            }
            if (data.localGameQR) {
                const c = document.getElementById('notv-local-qr-waiting');
                if (c) c.innerHTML = `<img src="${data.localGameQR.qrCode}" alt="QR Gra Wi‑Fi" style="max-width: 200px; height: auto;">`;
            }
            if (data.tunnelQR) {
                const c = document.getElementById('notv-tunnel-qr-waiting');
                if (c) c.innerHTML = `<img src="${data.tunnelQR.qrCode}" alt="QR Tunel" style="max-width: 200px; height: auto;">`;
            }
        });
        
        socket.on('show_qr_on_phones_disabled', () => {
            const qrContainer = document.getElementById('qr-on-phones-waiting');
            const waitingIcon = document.getElementById('waiting-icon');
            const waitingText = document.getElementById('waiting-text');
            const waitingSubtitle = document.getElementById('waiting-subtitle');
            
            if (qrContainer) qrContainer.style.display = 'none';
            if (waitingIcon) waitingIcon.style.display = 'block';
            if (waitingText) waitingText.textContent = 'Czekaj na rozpoczęcie zabawy!';
            if (waitingSubtitle) waitingSubtitle.textContent = 'Obserwuj ekran główny';
        });
        
        // Poproś serwer o aktualny stan (jeśli serwer tego nie obsługuje, użyj update_state który jest wysyłany automatycznie)

        socket.on('disconnect', () => {
            console.log('❌ Rozłączono z serwerem');
            showConnectionLost();
        });

        // === REJESTRACJA GRACZA ===
        // Funkcja globalna dla przycisku onclick
        function registerPlayer(nickToUse = null) {
            const input = document.getElementById('nick-input');
            const nick = nickToUse || (input ? input.value.trim() : '');
            
            const emptyWarn = document.getElementById('nick-empty-warning');
            const nickWarn = document.getElementById('nick-warning');
            if (emptyWarn) emptyWarn.style.display = 'none';
            if (nickWarn) nickWarn.style.display = 'none';

            if (!nick || nick.trim() === '') {
                if (emptyWarn) emptyWarn.style.display = 'block';
                return;
            }

            const trimmedNick = nick.trim();

            // Sprawdź czy nick zawiera niecenzuralne słowa
            if (window.ProfanityFilter?.containsProfanity(trimmedNick)) {
                if (nickWarn) {
                    nickWarn.textContent = 'Nick zawiera nieodpowiednie słowa. Wybierz inny nick.';
                    nickWarn.style.display = 'block';
                }
                if (input) input.value = '';
                return;
            }
            
            // Sprawdź czy socket jest połączony
            if (!socket || !socket.connected) {
                console.error('❌ Socket nie jest połączony - nie można zarejestrować gracza');
                showConnectionLost();
                return;
            }
            
            playerNick = trimmedNick;
            playerScore = 0;
            // Nie resetuj drużyny jeśli rejestrujemy ponownie (zachowaj z localStorage)
            if (!nickToUse) {
                // Sprawdź czy gracz ma zapisaną drużynę w localStorage
                try {
                    const savedTeam = localStorage.getItem('voteBattle_team');
                    playerTeam = savedTeam || null;
                } catch (e) {
                    playerTeam = null;
                }
            }
            
            // Zapisz nick w localStorage dla automatycznej rejestracji przy reconnect
            try {
                localStorage.setItem('voteBattle_nick', trimmedNick);
                if (playerTeam) {
                    localStorage.setItem('voteBattle_team', playerTeam);
                }
            } catch (e) {
                console.warn('Nie można zapisać do localStorage:', e);
            }
            
            console.log('👤 Wysyłam rejestrację gracza:', trimmedNick, nickToUse ? '(auto-reconnect)' : '', 'socket.connected:', socket.connected);
            
            // Wyślij rejestrację do serwera
            socket.emit('register_player', trimmedNick);
            
            // Wyczyść pole input jeśli nie jest auto-reconnect
            if (!nickToUse && input) {
                input.value = '';
            }
            
            // Aktywuj fullscreen i wake lock
            requestFullscreen();
            requestWakeLock();
            
            // Poproś o aktualny stan gry (serwer powinien odpowiedzieć update_state)
            socket.emit('request_state');
        }
        
        // Upewnij się że funkcja jest dostępna globalnie dla onclick i innych wywołań
        // Nadpisz tymczasową funkcję właściwą implementacją
        window.registerPlayer = registerPlayer;
        
        // Upewnij się że przycisk onclick również działa
        const joinBtnOnClick = document.getElementById('join-game-btn');
        if (joinBtnOnClick) {
            joinBtnOnClick.onclick = function(e) {
                e.preventDefault();
                window.registerPlayer();
            };
        }

        // Obsługa Enter w polu imienia
        document.getElementById('nick-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') registerPlayer();
        });

        // Inicjalizacja filtra niecenzuralnych słów dla pola nick
        const nickInput = document.getElementById('nick-input');
        const nickWarning = document.getElementById('nick-warning');
        if (nickInput) {
            // Poczekaj na załadowanie skryptu filtra
            const initNickFilter = () => {
                if (window.ProfanityFilter) {
                    window.ProfanityFilter.setupProfanityFilter(
                        nickInput,
                        () => {
                            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                        },
                        nickWarning,
                        'NICK NIEDOSTĘPNY'
                    );
                } else {
                    // Spróbuj ponownie po krótkim czasie
                    setTimeout(initNickFilter, 100);
                }
            };
            initNickFilter();
        }

        // === TIMER ===
        // Lokalne odliczanie (serwer nie broadcastuje co sekundę) – używamy questionStartTime+duration z serwera lub początkowego timeLeft
        function startTimer(seconds) {
            clearInterval(timerInterval);
            const display = document.getElementById('time-left');
            const timerBadge = document.getElementById('timer-badge');
            if (!display || !timerBadge) return;
            
            const sec = Math.max(0, Math.floor(seconds));
            display.textContent = sec;
            timerBadge.style.display = 'block';
            
            if (sec <= 0) return;
            
            const startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const left = Math.max(0, sec - elapsed);
                updateTimerFromServer(left);
                if (left <= 0) clearInterval(timerInterval);
            }, 500);
        }
        
        // Funkcja do aktualizacji timera z wartością serwera
        function updateTimerFromServer(timeLeft) {
            const display = document.getElementById('time-left');
            const timerBadge = document.getElementById('timer-badge');
            
            if (!display || !timerBadge) return;
            
            const time = Math.max(0, Math.floor(timeLeft));
            display.textContent = time;
            
            if (time <= 5) {
                display.classList.add('warning');
                timerBadge.classList.add('timer-urgent');
            } else {
                display.classList.remove('warning');
                timerBadge.classList.remove('timer-urgent');
            }
            
            if (time <= 0) {
                // Blokada głosowania po czasie
                document.querySelectorAll('.answer-btn').forEach(btn => {
                    btn.classList.add('answer-locked');
                });
            }
        }

        function stopTimer() {
            clearInterval(timerInterval);
            const tb = document.getElementById('timer-badge');
            if (tb) {
                tb.style.display = 'none';
                tb.classList.remove('timer-urgent');
            }
        }

        function triggerHeroReveal() {
            const c = document.getElementById('hero-image-container');
            if (!c) return;
            c.classList.remove('hero-reveal');
            void c.offsetHeight;
            c.classList.add('hero-reveal');
            setTimeout(function() { c.classList.remove('hero-reveal'); }, 600);
        }

        function triggerQuestionReveal() {
            const el = document.getElementById('question-text');
            if (!el) return;
            el.classList.remove('question-reveal');
            void el.offsetHeight;
            el.classList.add('question-reveal');
        }

        // === AKTUALIZACJA STANU GRY ===
        socket.on('update_state', (state) => {
            console.log('📡 Stan gry:', state.type, 'showStats:', state.showStats, 'showCorrect:', state.showCorrect, 'teamBattleMode:', state.teamBattleMode, 'playerNick:', playerNick, 'playerTeam:', playerTeam);
            
            // Zapisz aktualny stan gry
            currentGameState = state;
            playerEliminated = !!(state.eliminatedMap && state.eliminatedMap[socket.id]);
            
            // WAŻNE: Jeśli dogrywka jest aktywna, natychmiast ukryj wszystkie obrazy i upewnij się że dogrywka jest wyświetlona
            console.log('🎤 Wczesne sprawdzenie dogrywki:', {
                playoffExists: !!state.playoff,
                playoffActive: !!(state.playoff && state.playoff.active),
                playerNick: playerNick
            });
            
            if (state.playoff && state.playoff.active && playerNick) {
                console.log('🎤 ✅ WCZESNE WYKRYCIE DOGRYWKI - natychmiast ustawiam słowo i napis DOGRYWKA i ukrywam obrazy');
                
                // WAŻNE: Ustaw słowo dogrywki i napis "DOGRYWKA" NAJPIERW, przed wszystkimi innymi operacjami
                const qTextElEarly = document.getElementById('question-text');
                if (qTextElEarly && state.playoff && state.playoff.word) {
                    const playoffWord = state.playoff.word || '';
                    console.log('📝 [WCZESNE] Ustawiam słowo i napis DOGRYWKA natychmiast, słowo:', playoffWord);
                    qTextElEarly.innerHTML = `
                        <div class="playoff-word" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 10px auto !important; font-size: clamp(1rem, 4vw, 1.3rem) !important; font-weight: 700 !important; color: white !important;">${playoffWord}</div>
                        <div class="playoff-title-pulse" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 20px auto !important;">🎤 DOGRYWKA</div>
                    `;
                    qTextElEarly.style.setProperty('display', 'block', 'important');
                    qTextElEarly.style.setProperty('visibility', 'visible', 'important');
                    qTextElEarly.style.setProperty('opacity', '1', 'important');
                    qTextElEarly.style.setProperty('height', 'auto', 'important');
                    qTextElEarly.style.setProperty('max-height', 'none', 'important');
                    qTextElEarly.style.setProperty('text-align', 'center', 'important');
                    qTextElEarly.style.setProperty('width', '100%', 'important');
                    qTextElEarly.setAttribute('data-playoff-active', 'true');
                    
                    // Upewnij się że voting-header jest widoczny i wyśrodkowany
                    const votingHeaderEarly = document.querySelector('.voting-header');
                    if (votingHeaderEarly) {
                        votingHeaderEarly.style.setProperty('display', 'flex', 'important');
                        votingHeaderEarly.style.setProperty('visibility', 'visible', 'important');
                        votingHeaderEarly.style.setProperty('opacity', '1', 'important');
                        votingHeaderEarly.style.setProperty('justify-content', 'center', 'important');
                    }
                    
                    // Ukryj timer badge
                    const timerBadgeEarly = document.getElementById('timer-badge');
                    if (timerBadgeEarly) {
                        timerBadgeEarly.style.setProperty('display', 'none', 'important');
                    }
                    const headerTimerEarly = document.querySelector('.header-timer');
                    if (headerTimerEarly) {
                        headerTimerEarly.style.setProperty('display', 'none', 'important');
                    }
                }
                
                const heroContainer = document.getElementById('hero-image-container');
                const heroImg = document.getElementById('hero-image');
                const questionHeader = document.querySelector('.question-header');
                const votingScreen = document.getElementById('voting-screen');
                
                if (heroContainer) {
                    heroContainer.style.setProperty('display', 'none', 'important');
                    heroContainer.style.setProperty('visibility', 'hidden', 'important');
                    heroContainer.style.setProperty('opacity', '0', 'important');
                    heroContainer.style.setProperty('height', '0', 'important');
                    heroContainer.style.setProperty('width', '0', 'important');
                    heroContainer.style.setProperty('position', 'absolute', 'important');
                    heroContainer.style.setProperty('left', '-9999px', 'important');
                }
                if (heroImg) {
                    heroImg.src = '';
                    heroImg.style.setProperty('display', 'none', 'important');
                    heroImg.removeAttribute('src');
                }
                if (questionHeader) {
                    questionHeader.style.setProperty('display', 'none', 'important');
                    questionHeader.style.setProperty('visibility', 'hidden', 'important');
                    questionHeader.style.setProperty('opacity', '0', 'important');
                    questionHeader.style.setProperty('height', '0', 'important');
                    questionHeader.style.setProperty('position', 'absolute', 'important');
                    questionHeader.style.setProperty('left', '-9999px', 'important');
                }
                if (votingScreen) {
                    votingScreen.classList.add('no-image');
                    votingScreen.classList.add('playoff-mode');
                }
            }
            
            // WAŻNE: Jeśli gracz jest zarejestrowany (playerNick jest ustawiony), ukryj ekran logowania
            if (playerNick) {
                const loginScreen = document.getElementById('login-screen');
                if (loginScreen && loginScreen.style.display !== 'none') {
                    console.log('✅ Ukrywam ekran logowania - gracz jest zarejestrowany:', playerNick);
                    loginScreen.style.display = 'none';
                }
            }
            
            // WAŻNE: Gdy tryb drużynowy jest aktywowany, wyczyść localStorage jeśli gracz nie ma drużyny na serwerze
            if (state.teamBattleMode && playerNick) {
                // Sprawdź czy gracz ma drużynę na serwerze (w state.players lub przez socket)
                // Jeśli nie ma, wyczyść localStorage i playerTeam
                const hasTeamOnServer = playerTeam && (state.teams?.A?.name || state.teams?.B?.name);
                
                // Jeśli gracz ma zapisaną drużynę w localStorage, ale serwer zresetował drużyny,
                // wyczyść localStorage i wymuś ponowny wybór
                if (playerTeam && !hasTeamOnServer) {
                    console.log('🔄 Tryb drużynowy aktywowany - resetuję zapisaną drużynę gracza');
                    playerTeam = null;
                    try {
                        localStorage.removeItem('voteBattle_team');
                    } catch (e) {
                        console.warn('Nie można usunąć drużyny z localStorage:', e);
                    }
                }
            }
            
            // Aktualizuj wyniki drużyn jeśli ekran leaderboard jest widoczny i tryb drużynowy jest aktywny
            if (state.teamBattleMode && state.teams) {
                const leaderboardScreen = document.getElementById('leaderboard-screen');
                if (leaderboardScreen && leaderboardScreen.style.display !== 'none') {
                    const scoreA = (state.teams.A && state.teams.A.score != null) ? state.teams.A.score : 0;
                    const scoreB = (state.teams.B && state.teams.B.score != null) ? state.teams.B.score : 0;
                    const nameA = (state.teams.A && state.teams.A.name) ? state.teams.A.name : 'Team A';
                    const nameB = (state.teams.B && state.teams.B.name) ? state.teams.B.name : 'Team B';
                    const countA = (state.teams.A && state.teams.A.playerCount != null) ? state.teams.A.playerCount : 0;
                    const countB = (state.teams.B && state.teams.B.playerCount != null) ? state.teams.B.playerCount : 0;
                    
                    const elScoreA = document.getElementById('vote-team-score-a');
                    const elScoreB = document.getElementById('vote-team-score-b');
                    const elNameA = document.getElementById('vote-team-name-a');
                    const elNameB = document.getElementById('vote-team-name-b');
                    
                    if (elScoreA) elScoreA.textContent = scoreA;
                    if (elScoreB) elScoreB.textContent = scoreB;
                    if (elNameA) elNameA.textContent = nameA;
                    if (elNameB) elNameB.textContent = nameB;
                }
            }
            
            // Zaktualizuj nazwę quizu
            if (state.quizTitle) {
                quizTitle = state.quizTitle;
                document.getElementById('intro-title').textContent = quizTitle;
            }
            
            // EKRAN WYBORU DRUŻYNY - pokazuj tylko jeśli gracz jest zarejestrowany i nie ma drużyny
            if (state.type === 'TEAM_SELECTION' && playerNick && !playerTeam) {
                console.log('🎯 Otrzymano TEAM_SELECTION - pokazuję ekran wyboru drużyn');
                showTeamSelectionScreen();
                return;
            }
            
            // Jeśli gracz jest zarejestrowany, nie ma drużyny i tryb drużynowy jest aktywny - pokaż wybór drużyny
            if (playerNick && !playerTeam && state.teamBattleMode && state.type !== 'TEAM_SELECTION') {
                console.log('🎯 Wykryto teamBattleMode bez drużyny - pokazuję ekran wyboru drużyn');
                showTeamSelectionScreen();
                return;
            }
            
            // Dogrywka TAK/NIE – zawsze priorytet gdy aktywna
            console.log('🎤 Sprawdzam dogrywkę:', {
                playerNick: playerNick,
                stateType: state.type,
                playoffExists: !!state.playoff,
                playoffActive: !!(state.playoff && state.playoff.active),
                showStats: state.showStats,
                showCorrect: state.showCorrect
            });
            
            if (playerNick && (state.type === 'GAME' || state.type === 'GAME_STATS') && state.playoff && state.playoff.active) {
                // Nowa dogrywka (inne słowo) = reset flagi, żeby można było zagłosować ponownie
                const newPlayoffWord = state.playoff.word || '';
                if (newPlayoffWord !== lastPlayoffWord) {
                    playoffVoted = false;
                    lastPlayoffWord = newPlayoffWord;
                    lastPlayoffQuestionId = state.activeQuestion?.id ?? null;
                    console.log('🎤 Nowa dogrywka – reset playoffVoted, słowo:', newPlayoffWord);
                }
                
                console.log('🎤 ✅ WARUNEK DOGRYWKI SPEŁNIONY - sprawdzam czy pokazać głosowanie czy wyniki');
                console.log('🎤 Dogrywka aktywna - showStats:', state.showStats, 'showCorrect:', state.showCorrect, 'playoff:', state.playoff, 'playoffVoted:', playoffVoted);
                
                // WAŻNE: Jeśli gracz już oddał głos w tej dogrywce, pokaż wyniki zamiast przycisków
                if (playoffVoted) {
                    console.log('📊 Gracz już oddał głos - pokazuję/zaktualizuję wyniki dogrywki');
                    showScreen('voting');
                    const grid = document.getElementById('answers-grid');
                    if (grid) {
                        grid.classList.remove('list-mode', 'hot-or-not-grid');
                        grid.classList.add('playoff-mode');
                        
                        const p = state.playoff;
                        const totalP = (p.stats.A || 0) + (p.stats.B || 0);
                        const wA = totalP > 0 ? Math.round((p.stats.A || 0) / totalP * 100) : 50;
                        const pctA = totalP > 0 ? Math.round((p.stats.A || 0) / totalP * 100) : 0;
                        const pctB = totalP > 0 ? Math.round((p.stats.B || 0) / totalP * 100) : 0;
                        
                        // Sprawdź czy już istnieje kontener z wynikami
                        let playoffContainer = grid.querySelector('.playoff-ui');
                        if (!playoffContainer) {
                            grid.innerHTML = '';
                            playoffContainer = document.createElement('div');
                            playoffContainer.className = 'playoff-ui';
                            playoffContainer.style.cssText = 'display: flex !important; flex-direction: row !important; gap: 0 !important; justify-content: center !important; align-items: stretch !important; flex-wrap: nowrap !important; padding: 0 !important; width: 100% !important; max-width: 100% !important; margin: 0 auto !important;';
                            grid.appendChild(playoffContainer);
                        }
                        
                        // Zaktualizuj lub utwórz pasek wyników z pełnymi stylami inline
                        playoffContainer.innerHTML = `
                            <div class="playoff-screen-grid" id="playoff-results-grid" style="display: flex !important; width: 100% !important; max-width: 100% !important; min-height: 140px !important; border-radius: 20px !important; overflow: hidden !important; box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1) !important; border: 2px solid rgba(255,255,255,0.15) !important; backdrop-filter: blur(10px) !important; background: rgba(0,0,0,0.2) !important; margin: 0 auto !important;">
                                <div class="playoff-card playoff-tak" id="playoff-card-tak" style="flex:${wA} !important; display: flex !important; flex-direction: column !important; align-items: center !important; justify-content: center !important; padding: 24px 20px !important; min-height: 120px !important; position: relative !important; background: linear-gradient(135deg, #1976d2, #2196f3, #42a5f5) !important; color: #fff !important; box-shadow: inset 0 2px 10px rgba(0,0,0,0.2), 0 4px 20px rgba(33, 150, 243, 0.4) !important; border-right: 2px solid rgba(255,255,255,0.1) !important;">
                                    <div class="playoff-label" id="playoff-label-tak" style="font-size: clamp(1.5rem, 4vw, 2.5rem) !important; font-weight: 900 !important; margin-bottom: 6px !important; text-shadow: 0 3px 10px rgba(0,0,0,0.5), 0 1px 3px rgba(0,0,0,0.8) !important; letter-spacing: 1px !important; text-transform: uppercase !important; color: #fff !important;">TAK</div>
                                    <div class="playoff-pct" id="playoff-pct-tak" style="font-size: clamp(1.4rem, 3.5vw, 2.2rem) !important; font-weight: 800 !important; margin-top: 4px !important; text-shadow: 0 2px 8px rgba(0,0,0,0.6), 0 1px 2px rgba(0,0,0,0.8) !important; color: #fff !important;">${pctA}%</div>
                                    <div class="playoff-count" id="playoff-count-tak" style="font-size: clamp(1rem, 2.5vw, 1.4rem) !important; opacity: 0.95 !important; margin-top: 4px !important; text-shadow: 0 2px 6px rgba(0,0,0,0.5) !important; font-weight: 600 !important; color: #fff !important;">${p.stats.A || 0} głosów</div>
                                </div>
                                <div class="playoff-card playoff-nie" id="playoff-card-nie" style="flex:${100-wA} !important; display: flex !important; flex-direction: column !important; align-items: center !important; justify-content: center !important; padding: 24px 20px !important; min-height: 120px !important; position: relative !important; background: linear-gradient(135deg, #c62828, #e74c3c, #ef5350) !important; color: #fff !important; box-shadow: inset 0 2px 10px rgba(0,0,0,0.2), 0 4px 20px rgba(231, 76, 60, 0.4) !important;">
                                    <div class="playoff-label" id="playoff-label-nie" style="font-size: clamp(1.5rem, 4vw, 2.5rem) !important; font-weight: 900 !important; margin-bottom: 6px !important; text-shadow: 0 3px 10px rgba(0,0,0,0.5), 0 1px 3px rgba(0,0,0,0.8) !important; letter-spacing: 1px !important; text-transform: uppercase !important; color: #fff !important;">NIE</div>
                                    <div class="playoff-pct" id="playoff-pct-nie" style="font-size: clamp(1.4rem, 3.5vw, 2.2rem) !important; font-weight: 800 !important; margin-top: 4px !important; text-shadow: 0 2px 8px rgba(0,0,0,0.6), 0 1px 2px rgba(0,0,0,0.8) !important; color: #fff !important;">${pctB}%</div>
                                    <div class="playoff-count" id="playoff-count-nie" style="font-size: clamp(1rem, 2.5vw, 1.4rem) !important; opacity: 0.95 !important; margin-top: 4px !important; text-shadow: 0 2px 6px rgba(0,0,0,0.5) !important; font-weight: 600 !important; color: #fff !important;">${p.stats.B || 0} głosów</div>
                                </div>
                            </div>
                        `;
                        
                        // WAŻNE: Wymuś style jeszcze raz przez setProperty aby upewnić się że są zastosowane
                        setTimeout(() => {
                            const gridEl = document.getElementById('playoff-results-grid');
                            const cardTak = document.getElementById('playoff-card-tak');
                            const cardNie = document.getElementById('playoff-card-nie');
                            
                            if (gridEl) {
                                gridEl.style.setProperty('box-shadow', '0 12px 40px rgba(0,0,0,0.5), 0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1)', 'important');
                                gridEl.style.setProperty('border', '2px solid rgba(255,255,255,0.15)', 'important');
                                gridEl.style.setProperty('backdrop-filter', 'blur(10px)', 'important');
                            }
                            
                            if (cardTak) {
                                cardTak.style.setProperty('background', 'linear-gradient(135deg, #1976d2, #2196f3, #42a5f5)', 'important');
                                cardTak.style.setProperty('box-shadow', 'inset 0 2px 10px rgba(0,0,0,0.2), 0 4px 20px rgba(33, 150, 243, 0.4)', 'important');
                            }
                            
                            if (cardNie) {
                                cardNie.style.setProperty('background', 'linear-gradient(135deg, #c62828, #e74c3c, #ef5350)', 'important');
                                cardNie.style.setProperty('box-shadow', 'inset 0 2px 10px rgba(0,0,0,0.2), 0 4px 20px rgba(231, 76, 60, 0.4)', 'important');
                            }
                        }, 100);
                        
                        grid.style.setProperty('display', 'flex', 'important');
                        grid.style.setProperty('flex-direction', 'row', 'important');
                        grid.style.setProperty('justify-content', 'center', 'important');
                        grid.style.setProperty('align-items', 'center', 'important');
                        grid.style.setProperty('width', '100%', 'important');
                        grid.style.setProperty('max-width', '100%', 'important');
                    }
                    
                    // Ustaw tekst dogrywki
                    const qTextEl = document.getElementById('question-text');
                    if (qTextEl && state.playoff && state.playoff.word) {
                        const playoffWord = state.playoff.word || '';
                        qTextEl.innerHTML = `
                            <div class="playoff-word" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 10px auto !important; font-size: clamp(1rem, 4vw, 1.3rem) !important; font-weight: 700 !important; color: white !important;">${playoffWord}</div>
                            <div class="playoff-title-pulse" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 20px auto !important;">🎤 DOGRYWKA</div>
                        `;
                        qTextEl.setAttribute('data-playoff-active', 'true');
                    }
                    return;
                }
                
                // WAŻNE: Gdy dogrywka jest aktywna i gracz jeszcze nie oddał głosu, pokazuj ekran głosowania TAK/NIE
                console.log('🗳️ ========== WYWOŁUJĘ showPlayoffScreen (dogrywka aktywna - gracz jeszcze nie oddał głosu) ==========');
                console.log('🗳️ Pokazuję ekran głosowania dogrywki, playoff:', state.playoff);
                showPlayoffScreen(state.playoff);
                console.log('🗳️ ========== PO WYWOŁANIU showPlayoffScreen ==========');
                return;
            } else {
                // Dogrywka nie jest aktywna - usuń atrybut data-playoff-active jeśli istnieje
                const qTextEl = document.getElementById('question-text');
                if (qTextEl && qTextEl.getAttribute('data-playoff-active') === 'true') {
                    qTextEl.removeAttribute('data-playoff-active');
                }
            }
            
            if (state.type === 'IDLE' || state.type === 'INTRO') {
                if (playerNick) {
                    // Ukryj ekran logowania jeśli jeszcze jest widoczny
                    const loginScreen = document.getElementById('login-screen');
                    if (loginScreen) loginScreen.style.display = 'none';
                    
                    // Jeśli tryb drużynowy i gracz nie ma drużyny, pokaż wybór drużyny
                    if (state.teamBattleMode && !playerTeam) {
                        console.log('🎯 IDLE/INTRO z teamBattleMode - pokazuję ekran wyboru drużyn');
                        showTeamSelectionScreen();
                    } else {
                        console.log('✅ Pokazuję ekran waiting po rejestracji');
                        showScreen('waiting');
                        updatePlayerInfo();
                        
                        // Gdy admin włączył „Pokaż QR na telefonach” – pokaż kody do przekazania dalej
                        if (state.showQROnPhones) {
                            document.getElementById('qr-on-phones-waiting').style.display = 'block';
                            document.getElementById('waiting-icon').style.display = 'none';
                            document.getElementById('waiting-text').textContent = 'Czekaj na rozpoczęcie zabawy!';
                            document.getElementById('waiting-subtitle').textContent = 'Przekaż dalej dostęp do gry';
                            socket.emit('request_qr_codes_on_phones');
                        } else {
                            document.getElementById('qr-on-phones-waiting').style.display = 'none';
                            document.getElementById('waiting-icon').style.display = 'block';
                            document.getElementById('waiting-text').textContent = 'Czekaj na rozpoczęcie zabawy!';
                            document.getElementById('waiting-subtitle').textContent = 'Obserwuj ekran główny';
                        }
                    }
                } else {
                    // Jeśli gracz nie jest zarejestrowany, pokaż ekran logowania
                    const loginScreen = document.getElementById('login-screen');
                    if (loginScreen) loginScreen.style.display = 'block';
                }
            }
            else if (state.type === 'LEADERBOARD') {
                if (playerNick) {
                    // W trybie drużynowym pokaż wyniki drużyn, w przeciwnym razie TOP 10
                    if (state.teamBattleMode && state.teams) {
                        showLeaderboard(null); // Przekaż null aby funkcja użyła state.teams z currentGameState
                    } else {
                        showLeaderboard(state.leaderboard);
                    }
                }
                return;
            }
            else if (state.type === 'THANKS') {
                showThanksScreen(state.thanksScreen, state.quizTitle);
                return;
            }
            else if (state.type === 'PODIUM') {
                if (playerNick) {
                    console.log('🥇 Otrzymano PODIUM:', state.winners, 'krok:', state.podiumStep);
                    showPodiumScreen(state.winners, state.podiumStep);
                }
                return;
            }
            else if (state.type === 'GAME' || state.type === 'GAME_STATS') {
                if (!playerNick) return;
                
                // Utrzymuj ekran włączony podczas rozgrywki
                requestWakeLock();
                
                // Jeśli tryb drużynowy i gracz nie ma drużyny, pokaż wybór drużyny
                if (state.teamBattleMode && !playerTeam) {
                    showTeamSelectionScreen();
                    return;
                }
                
                if (state.type === 'GAME') {
                    // WAŻNE: Sprawdź czy to dogrywka PRZED wywołaniem showVotingScreen
                    const isPlayoffActive = state.playoff && state.playoff.active;
                    if (isPlayoffActive) {
                        // To jest dogrywka - użyj showPlayoffScreen zamiast showVotingScreen
                        console.log('🎤 Wykryto dogrywkę w GAME - używam showPlayoffScreen');
                        showPlayoffScreen(state.playoff);
                        return;
                    }
                    
                    const q = state.activeQuestion;
                    if (q) {
                        // WAŻNE: Sprawdź ponownie czy dogrywka nie została aktywowana między sprawdzeniami
                        if (state.playoff && state.playoff.active) {
                            console.log('🎤 Dogrywka aktywna podczas renderowania pytania - przełączam na dogrywkę');
                            showPlayoffScreen(state.playoff);
                            return;
                        }
                        // WAŻNE: Sprawdź czy pytanie ma ID - jeśli nie, użyj activeQuestionIndex jako fallback
                        const questionId = q.id !== undefined && q.id !== null ? q.id : `q_${state.activeQuestionIndex || 0}`;
                        if (questionId !== currentQuestionId) {
                            console.log('📝 Nowe pytanie wykryte:', { 
                                questionId, 
                                currentQuestionId, 
                                qId: q.id, 
                                activeQuestionIndex: state.activeQuestionIndex,
                                type: q.type 
                            });
                            currentQuestionId = questionId;
                            // WAŻNE: Resetuj hasAnswered dla nowego pytania - sprawdź localStorage
                            const answeredKey = `voteBattle_answered_${questionId}`;
                            
                            // DEBUG: Sprawdź wszystkie klucze localStorage związane z odpowiedziami
                            const allAnswerKeys = [];
                            try {
                                for (let i = 0; i < localStorage.length; i++) {
                                    const key = localStorage.key(i);
                                    if (key && key.startsWith('voteBattle_answered_')) {
                                        allAnswerKeys.push({ key, value: localStorage.getItem(key) });
                                    }
                                }
                            } catch (e) {
                                console.warn('Błąd przy sprawdzaniu localStorage:', e);
                            }
                            
                            console.log('🔍 DEBUG - Sprawdzanie hasAnswered dla nowego pytania:', {
                                questionId: questionId,
                                currentQuestionId: currentQuestionId,
                                answeredKey: answeredKey,
                                localStorageValue: localStorage.getItem(answeredKey),
                                allAnswerKeys: allAnswerKeys,
                                hasAnsweredBefore: hasAnswered
                            });
                            
                            hasAnswered = localStorage.getItem(answeredKey) === 'true';
                            
                            console.log('🔍 DEBUG - hasAnswered po sprawdzeniu localStorage:', {
                                hasAnswered: hasAnswered,
                                answeredKey: answeredKey,
                                localStorageValue: localStorage.getItem(answeredKey)
                            });
                            
                            if (hasAnswered) {
                                console.log('✅ Gracz już zagłosował na to pytanie (z localStorage)');
                                // Przywróć indeks odpowiedzi gracza
                                const savedIndex = localStorage.getItem(`${answeredKey}_index`);
                                if (savedIndex !== null) {
                                    playerAnswerIndex = parseInt(savedIndex, 10);
                                }
                            } else {
                                // WAŻNE: Resetuj hasAnswered i playerAnswerIndex dla nowego pytania
                                hasAnswered = false;
                                playerAnswerIndex = null;
                                console.log('🔄 Nowe pytanie - resetuję hasAnswered i playerAnswerIndex');
                            }
                            // Sprawdź ponownie czy dogrywka nie została aktywowana przed wywołaniem showVotingScreen
                            if (!(state.playoff && state.playoff.active)) {
                                showVotingScreen(q, state.timeLeft || 30);
                            } else {
                                console.log('🎤 Dogrywka aktywna - pomijam showVotingScreen dla pytania', questionId);
                                showPlayoffScreen(state.playoff);
                            }
                        } else {
                            // LETTER: gdy litery właśnie przyszły (gameStarted=true), przeładuj widok żeby pokazać pola na odpowiedź
                            const letterJustStarted = q.type === 'LETTER' && state.letterGame && state.letterGame.questionId === questionId && state.letterGame.gameStarted === true;
                            if (letterJustStarted) {
                                console.log('📝 [LETTER] To samo pytanie, ale gameStarted=true – przeładowuję widok (pola na litery)');
                                showVotingScreen(q, state.timeLeft || 30);
                            } else {
                                console.log('📝 To samo pytanie - pomijam showVotingScreen:', { 
                                    questionId, 
                                    currentQuestionId, 
                                    qId: q.id 
                                });
                            }
                        }
                        
                        // Zawsze aktualizuj timer z wartością serwera (dla synchronizacji)
                        if (state.timeLeft !== undefined && state.timeLeft !== null && q.type !== 'SHIPS') {
                            updateTimerFromServer(state.timeLeft);
                        }
                        updateEliminatedOverlay();
                    } else {
                        console.log('⚠️ Brak aktywnego pytania w stanie GAME');
                    }
                } else {
                    updateEliminatedOverlay();
                    // Sprawdź czy to dogrywka - jeśli tak, ZAWSZE pokazuj ekran głosowania TAK/NIE
                    const isPlayoff = state.playoff && state.playoff.active;
                    const wasPlayoffActive = currentGameState && currentGameState.playoff && currentGameState.playoff.active;
                    
                    // Wykryj zakończenie dogrywki (była aktywna, teraz nie)
                    if (wasPlayoffActive && !isPlayoff) {
                        lastPlayoffWord = '';
                        lastPlayoffQuestionId = null;
                        if (state.activeQuestion && state.activeQuestion.type === 'LETTER') {
                            console.log('🎤 Dogrywka zakończona – powrót do chmury słów dla LETTER');
                            currentQuestionId = null;
                        }
                    }
                    
                    if (isPlayoff) {
                        // Dogrywka aktywna - ZAWSZE pokazuj ekran głosowania, ignoruj showStats
                        console.log('🎤 GAME_STATS z dogrywką - ZAWSZE pokazuję ekran głosowania TAK/NIE (ignoruję showStats)');
                        showPlayoffScreen(state.playoff);
                        return;
                    }
                    
                    if (state.activeQuestion && (state.showStats || state.showCorrect)) {
                        showScreen('voting');
                        // WAŻNE: Sprawdź czy pytanie ma ID - jeśli nie, użyj activeQuestionIndex jako fallback
                        const questionId = state.activeQuestion.id !== undefined && state.activeQuestion.id !== null 
                            ? state.activeQuestion.id 
                            : `q_${state.activeQuestionIndex || 0}`;
                        if (currentQuestionId !== questionId) {
                            currentQuestionId = questionId;
                            // Sprawdź ponownie czy dogrywka nie została aktywowana
                            const playoffStillActive = currentGameState && currentGameState.playoff && currentGameState.playoff.active;
                            if (!playoffStillActive) {
                                // WAŻNE: Dla pytań otwartych - upewnij się że grafika jest widoczna podczas pokazywania statystyk
                                if (state.activeQuestion.type === 'OPEN') {
                                    const heroContainer = document.getElementById('hero-image-container');
                                    const heroImg = document.getElementById('hero-image');
                                    const questionHeader = document.querySelector('.question-header');
                                    const imgSrc = (state.activeQuestion.imageSmall || state.activeQuestion.image || state.activeQuestion.media || '').trim();
                                    if (imgSrc && heroContainer && heroImg) {
                                        console.log('📊 [GAME_STATS] OPEN - Utrzymuję widoczność grafiki podczas pokazywania statystyk');
                                        const src = (imgSrc.startsWith('/') || imgSrc.startsWith('http')) ? imgSrc : '/uploads/' + imgSrc;
                                        heroContainer.style.display = 'block';
                                        heroContainer.style.visibility = 'visible';
                                        heroContainer.style.opacity = '1';
                                        heroContainer.style.height = 'auto';
                                        heroContainer.style.width = 'auto';
                                        heroContainer.style.position = 'static';
                                        heroContainer.style.left = 'auto';
                                        heroImg.src = src;
                                        if (questionHeader) {
                                            questionHeader.style.display = 'block';
                                            questionHeader.style.visibility = 'visible';
                                            questionHeader.style.opacity = '1';
                                            questionHeader.style.height = 'auto';
                                            questionHeader.style.position = 'static';
                                            questionHeader.style.left = 'auto';
                                        }
                                        document.getElementById('voting-screen').classList.remove('no-image');
                                    }
                                }
                                updateQuestionDisplay(state.activeQuestion);
                            }
                        }
                        renderVoteResults(state);
                    }
                }
            }
            else if (state.type === 'GAME_STATS' || state.showStats || state.showCorrect) {
                stopTimer();
            }
        });

        // === WYŚWIETLANIE EKRANÓW (z efektem przejścia) ===
        function showScreen(screenName) {
            console.log('🖥️  Przełączam na ekran:', screenName);
            const container = document.querySelector('.container');
            if (container) container.classList.add('screen-transition');
            
            const screens = ['login', 'waiting', 'voting', 'leaderboard', 'podium', 'team-selection', 'thanks'];
            screens.forEach(name => {
                const el = document.getElementById(name + '-screen');
                if (el) {
                    el.classList.remove('screen-visible');
                    el.style.display = 'none';
                }
            });
            
            const activeScreen = document.getElementById(screenName + '-screen');
            if (activeScreen) {
                if (screenName === 'podium') {
                    activeScreen.style.display = 'flex';
                    activeScreen.style.flexDirection = 'column';
                    activeScreen.style.justifyContent = 'flex-start';
                    activeScreen.style.alignItems = 'center';
                } else if (screenName === 'team-selection') {
                    activeScreen.style.display = 'flex';
                    if (container) container.style.display = 'flex';
                } else if (screenName === 'voting' || screenName === 'podium') {
                    activeScreen.style.display = 'flex';
                } else {
                    activeScreen.style.display = 'block';
                }
                requestAnimationFrame(() => {
                    activeScreen.classList.add('screen-visible');
                });
            }

            if (screenName !== 'voting') {
                stopTimer();
            }
        }

        // === AKTUALIZACJA INFORMACJI O GRACZU ===
        function updatePlayerInfo() {
            document.getElementById('display-nick').textContent = playerNick;
            document.getElementById('display-score').textContent = playerScore + ' pkt';
        }

        let playoffVoted = false;
        let lastPlayoffWord = '';
        let lastPlayoffQuestionId = null;
        
        // Funkcja do wyświetlania wyników dogrywki po oddaniu głosu (przeniesiona poza showPlayoffScreen aby uniknąć wielokrotnego definiowania)
        function showPlayoffResultsAfterVote() {
            if (!currentGameState || !currentGameState.playoff || !currentGameState.playoff.active) {
                return;
            }
            
            const p = currentGameState.playoff;
            const totalP = (p.stats.A || 0) + (p.stats.B || 0);
            const wA = totalP > 0 ? Math.round((p.stats.A || 0) / totalP * 100) : 50;
            const pctA = totalP > 0 ? Math.round((p.stats.A || 0) / totalP * 100) : 0;
            const pctB = totalP > 0 ? Math.round((p.stats.B || 0) / totalP * 100) : 0;
            
            // Zamień przyciski na pasek wyników
            const playoffContainer = document.querySelector('.playoff-ui');
            if (playoffContainer) {
                playoffContainer.innerHTML = `
                    <div class="playoff-screen-grid" id="playoff-results-after-vote" style="display: flex !important; width: 100% !important; max-width: 100% !important; min-height: 140px !important; border-radius: 20px !important; overflow: hidden !important; box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1) !important; border: 2px solid rgba(255,255,255,0.15) !important; backdrop-filter: blur(10px) !important; background: rgba(0,0,0,0.2) !important; margin: 0 auto !important;">
                        <div class="playoff-card playoff-tak" id="playoff-card-tak-after" style="flex:${wA} !important; display: flex !important; flex-direction: column !important; align-items: center !important; justify-content: center !important; padding: 24px 20px !important; min-height: 120px !important; position: relative !important; background: linear-gradient(135deg, #1976d2, #2196f3, #42a5f5) !important; color: #fff !important; box-shadow: inset 0 2px 10px rgba(0,0,0,0.2), 0 4px 20px rgba(33, 150, 243, 0.4) !important; border-right: 2px solid rgba(255,255,255,0.1) !important;">
                            <div class="playoff-label" id="playoff-label-tak-after" style="font-size: clamp(1.5rem, 4vw, 2.5rem) !important; font-weight: 900 !important; margin-bottom: 6px !important; text-shadow: 0 3px 10px rgba(0,0,0,0.5), 0 1px 3px rgba(0,0,0,0.8) !important; letter-spacing: 1px !important; text-transform: uppercase !important; color: #fff !important;">TAK</div>
                            <div class="playoff-pct" id="playoff-pct-tak-after" style="font-size: clamp(1.4rem, 3.5vw, 2.2rem) !important; font-weight: 800 !important; margin-top: 4px !important; text-shadow: 0 2px 8px rgba(0,0,0,0.6), 0 1px 2px rgba(0,0,0,0.8) !important; color: #fff !important;">${pctA}%</div>
                            <div class="playoff-count" id="playoff-count-tak-after" style="font-size: clamp(1rem, 2.5vw, 1.4rem) !important; opacity: 0.95 !important; margin-top: 4px !important; text-shadow: 0 2px 6px rgba(0,0,0,0.5) !important; font-weight: 600 !important; color: #fff !important;">${p.stats.A || 0} głosów</div>
                        </div>
                        <div class="playoff-card playoff-nie" id="playoff-card-nie-after" style="flex:${100-wA} !important; display: flex !important; flex-direction: column !important; align-items: center !important; justify-content: center !important; padding: 24px 20px !important; min-height: 120px !important; position: relative !important; background: linear-gradient(135deg, #c62828, #e74c3c, #ef5350) !important; color: #fff !important; box-shadow: inset 0 2px 10px rgba(0,0,0,0.2), 0 4px 20px rgba(231, 76, 60, 0.4) !important;">
                            <div class="playoff-label" id="playoff-label-nie-after" style="font-size: clamp(1.5rem, 4vw, 2.5rem) !important; font-weight: 900 !important; margin-bottom: 6px !important; text-shadow: 0 3px 10px rgba(0,0,0,0.5), 0 1px 3px rgba(0,0,0,0.8) !important; letter-spacing: 1px !important; text-transform: uppercase !important; color: #fff !important;">NIE</div>
                            <div class="playoff-pct" id="playoff-pct-nie-after" style="font-size: clamp(1.4rem, 3.5vw, 2.2rem) !important; font-weight: 800 !important; margin-top: 4px !important; text-shadow: 0 2px 8px rgba(0,0,0,0.6), 0 1px 2px rgba(0,0,0,0.8) !important; color: #fff !important;">${pctB}%</div>
                            <div class="playoff-count" id="playoff-count-nie-after" style="font-size: clamp(1rem, 2.5vw, 1.4rem) !important; opacity: 0.95 !important; margin-top: 4px !important; text-shadow: 0 2px 6px rgba(0,0,0,0.5) !important; font-weight: 600 !important; color: #fff !important;">${p.stats.B || 0} głosów</div>
                        </div>
                    </div>
                `;
                
                // WAŻNE: Wymuś style jeszcze raz przez setProperty aby upewnić się że są zastosowane
                setTimeout(() => {
                    const gridElAfter = document.getElementById('playoff-results-after-vote');
                    const cardTakAfter = document.getElementById('playoff-card-tak-after');
                    const cardNieAfter = document.getElementById('playoff-card-nie-after');
                    
                    if (gridElAfter) {
                        gridElAfter.style.setProperty('box-shadow', '0 12px 40px rgba(0,0,0,0.5), 0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1)', 'important');
                        gridElAfter.style.setProperty('border', '2px solid rgba(255,255,255,0.15)', 'important');
                        gridElAfter.style.setProperty('backdrop-filter', 'blur(10px)', 'important');
                    }
                    
                    if (cardTakAfter) {
                        cardTakAfter.style.setProperty('background', 'linear-gradient(135deg, #1976d2, #2196f3, #42a5f5)', 'important');
                        cardTakAfter.style.setProperty('box-shadow', 'inset 0 2px 10px rgba(0,0,0,0.2), 0 4px 20px rgba(33, 150, 243, 0.4)', 'important');
                    }
                    
                    if (cardNieAfter) {
                        cardNieAfter.style.setProperty('background', 'linear-gradient(135deg, #c62828, #e74c3c, #ef5350)', 'important');
                        cardNieAfter.style.setProperty('box-shadow', 'inset 0 2px 10px rgba(0,0,0,0.2), 0 4px 20px rgba(231, 76, 60, 0.4)', 'important');
                    }
                }, 100);
                console.log('📊 Wyniki dogrywki wyświetlone po oddaniu głosu:', {
                    tak: p.stats.A || 0,
                    nie: p.stats.B || 0,
                    pctA: pctA,
                    pctB: pctB
                });
            }
        }
        
        function showPlayoffScreen(playoff) {
            console.log('🎤 ========== showPlayoffScreen START ==========');
            console.log('🎤 showPlayoffScreen wywołane:', {
                playoff: playoff,
                playoffVoted: playoffVoted,
                lastPlayoffWord: lastPlayoffWord,
                playoffActive: playoff?.active,
                playoffWord: playoff?.word
            });
            console.log('🎤 Stack trace:', new Error().stack);
            
            // Resetuj flagę głosowania jeśli to nowa dogrywka (nowe słowo lub nowe pytanie)
            const currentQId = currentGameState?.activeQuestion?.id;
            if (playoff.word !== lastPlayoffWord || currentQId !== lastPlayoffQuestionId) { 
                console.log('🔄 Nowa dogrywka - resetuję flagę głosowania');
                playoffVoted = false; 
                lastPlayoffWord = playoff.word || '';
                lastPlayoffQuestionId = currentQId;
            }
            showScreen('voting');
            document.getElementById('timer-badge').style.display = 'none';
            
            // WAŻNE: Ustaw słowo dogrywki i napis DOGRYWKA NAJPIERW, przed ukrywaniem obrazków
            // To zapewni że są widoczne od razu w miejscu pytania - styl jak normalne pytania
            const qTextElEarly = document.getElementById('question-text');
            if (qTextElEarly && playoff && playoff.word) {
                const playoffWord = playoff.word || '';
                console.log('📝 [0] Ustawiam słowo dogrywki i napis DOGRYWKA NAJPIERW (przed ukrywaniem obrazków), słowo:', playoffWord);
                qTextElEarly.innerHTML = `
                    <div class="playoff-word" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 10px auto !important; font-size: clamp(1rem, 4vw, 1.3rem) !important; font-weight: 700 !important; color: white !important;">${playoffWord}</div>
                    <div class="playoff-title-pulse" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 20px auto !important;">🎤 DOGRYWKA</div>
                `;
                qTextElEarly.style.setProperty('display', 'block', 'important');
                qTextElEarly.style.setProperty('visibility', 'visible', 'important');
                qTextElEarly.style.setProperty('opacity', '1', 'important');
                qTextElEarly.style.setProperty('text-align', 'center', 'important');
                qTextElEarly.style.setProperty('width', '100%', 'important');
                qTextElEarly.setAttribute('data-playoff-active', 'true');
            }
            
            // UKRYJ CAŁY question-header (zawiera hero-image-container) - WAŻNE dla dogrywki - użyj !important
            const questionHeader = document.querySelector('.question-header');
            console.log('🖼️ questionHeader znaleziony:', !!questionHeader, questionHeader ? questionHeader.style.display : 'brak');
            if (questionHeader) {
                console.log('🖼️ Ukrywam question-header');
                questionHeader.style.setProperty('display', 'none', 'important');
                questionHeader.style.setProperty('visibility', 'hidden', 'important');
                questionHeader.style.setProperty('opacity', '0', 'important');
                questionHeader.style.setProperty('height', '0', 'important');
                questionHeader.style.setProperty('margin', '0', 'important');
                questionHeader.style.setProperty('padding', '0', 'important');
                questionHeader.style.setProperty('max-height', '0', 'important');
                questionHeader.style.setProperty('overflow', 'hidden', 'important');
                questionHeader.style.setProperty('position', 'absolute', 'important');
                questionHeader.style.setProperty('left', '-9999px', 'important');
                console.log('🖼️ question-header po ukryciu:', window.getComputedStyle(questionHeader).display, window.getComputedStyle(questionHeader).visibility);
            } else {
                console.warn('⚠️ question-header NIE ZNALEZIONY!');
            }
            
            // UKRYJ OBRAZEK HERO - wymuś ukrycie (ważne dla dogrywki) - użyj !important
            const heroContainer = document.getElementById('hero-image-container');
            const heroImg = document.getElementById('hero-image');
            console.log('🖼️ heroContainer znaleziony:', !!heroContainer, heroContainer ? heroContainer.style.display : 'brak');
            console.log('🖼️ heroImg znaleziony:', !!heroImg, heroImg ? heroImg.src : 'brak');
            if (heroContainer) {
                console.log('🖼️ Ukrywam heroContainer, przed:', window.getComputedStyle(heroContainer).display);
                heroContainer.style.setProperty('display', 'none', 'important');
                heroContainer.style.setProperty('visibility', 'hidden', 'important');
                heroContainer.style.setProperty('opacity', '0', 'important');
                heroContainer.style.setProperty('height', '0', 'important');
                heroContainer.style.setProperty('margin', '0', 'important');
                heroContainer.style.setProperty('padding', '0', 'important');
                heroContainer.style.setProperty('max-height', '0', 'important');
                heroContainer.style.setProperty('overflow', 'hidden', 'important');
                heroContainer.style.setProperty('width', '0', 'important');
                heroContainer.style.setProperty('position', 'absolute', 'important');
                heroContainer.style.setProperty('left', '-9999px', 'important');
                console.log('🖼️ heroContainer po ukryciu:', window.getComputedStyle(heroContainer).display, window.getComputedStyle(heroContainer).visibility, window.getComputedStyle(heroContainer).width);
            } else {
                console.warn('⚠️ heroContainer NIE ZNALEZIONY!');
            }
            if (heroImg) {
                console.log('🖼️ Ukrywam heroImg, przed src:', heroImg.src);
                heroImg.src = '';
                heroImg.style.setProperty('display', 'none', 'important');
                heroImg.style.setProperty('visibility', 'hidden', 'important');
                heroImg.style.setProperty('opacity', '0', 'important');
                heroImg.style.setProperty('width', '0', 'important');
                heroImg.style.setProperty('height', '0', 'important');
                heroImg.style.setProperty('max-width', '0', 'important');
                heroImg.style.setProperty('max-height', '0', 'important');
                heroImg.removeAttribute('src');
                console.log('🖼️ heroImg po ukryciu:', window.getComputedStyle(heroImg).display, heroImg.src);
            } else {
                console.warn('⚠️ heroImg NIE ZNALEZIONY!');
            }
            
            // Ukryj również obrazek jeśli jest w voting-screen
            const votingScreenEl = document.getElementById('voting-screen');
            console.log('🖼️ votingScreenEl znaleziony:', !!votingScreenEl);
            if (votingScreenEl) {
                console.log('🖼️ Dodaję klasy do voting-screen:', 'no-image', 'playoff-mode');
                votingScreenEl.classList.add('no-image');
                votingScreenEl.classList.remove('has-image');
                votingScreenEl.classList.remove('hot-or-not-mode');
                votingScreenEl.classList.add('playoff-mode');
                // WAŻNE: Upewnij się że voting-screen nie blokuje kliknięć
                votingScreenEl.style.pointerEvents = 'auto';
                console.log('🖼️ voting-screen klasy:', votingScreenEl.className);
            } else {
                console.warn('⚠️ voting-screen NIE ZNALEZIONY!');
            }
            
            // WAŻNE: Ukryj overlay eliminacji podczas dogrywki (dogrywka jest dostępna dla wszystkich)
            const eliminatedOverlay = document.getElementById('eliminated-overlay');
            if (eliminatedOverlay) {
                eliminatedOverlay.style.display = 'none';
                eliminatedOverlay.style.pointerEvents = 'none';
            }
            
            // Wyświetl słowo wybrane do dogrywki i napis DOGRYWKA w miejscu pytania (question-text w voting-header)
            const qTextEl = document.getElementById('question-text');
            console.log('📝 [4] qTextEl znaleziony:', !!qTextEl, qTextEl ? 'innerHTML przed:' + qTextEl.innerHTML.substring(0, 50) : 'brak');
            if (qTextEl) {
                const playoffWord = playoff.word || '';
                console.log('📝 [4] Ustawiam tekst dogrywki, słowo:', playoffWord);
                // Wyświetl słowo wybrane przez admina i napis DOGRYWKA - styl jak normalne pytania - WYMUSZONE style inline
                qTextEl.innerHTML = `
                    <div class="playoff-word" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 10px auto !important; font-size: clamp(1rem, 4vw, 1.3rem) !important; font-weight: 700 !important; color: white !important;">${playoffWord}</div>
                    <div class="playoff-title-pulse" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 20px auto !important;">🎤 DOGRYWKA</div>
                `;
                qTextEl.classList.remove('multi-line', 'two-lines', 'three-lines');
                // Upewnij się że question-text jest widoczny i wyśrodkowany - użyj !important i wymuś widoczność
                qTextEl.style.setProperty('display', 'block', 'important');
                qTextEl.style.setProperty('visibility', 'visible', 'important');
                qTextEl.style.setProperty('opacity', '1', 'important');
                qTextEl.style.setProperty('height', 'auto', 'important');
                qTextEl.style.setProperty('max-height', 'none', 'important');
                qTextEl.style.setProperty('overflow', 'visible', 'important');
                qTextEl.style.setProperty('position', 'static', 'important');
                qTextEl.style.setProperty('left', 'auto', 'important');
                qTextEl.style.setProperty('text-align', 'center', 'important');
                qTextEl.style.setProperty('width', '100%', 'important');
                // Blokuj nadpisanie przez inne funkcje
                qTextEl.setAttribute('data-playoff-active', 'true');
                console.log('📝 [4] qTextEl po ustawieniu:', {
                    innerHTML: qTextEl.innerHTML.substring(0, 200),
                    fullInnerHTML: qTextEl.innerHTML,
                    display: window.getComputedStyle(qTextEl).display,
                    visibility: window.getComputedStyle(qTextEl).visibility,
                    opacity: window.getComputedStyle(qTextEl).opacity,
                    height: window.getComputedStyle(qTextEl).height,
                    dataAttr: qTextEl.getAttribute('data-playoff-active'),
                    hasPlayoffWord: qTextEl.querySelector('.playoff-word') !== null,
                    hasPlayoffTitle: qTextEl.querySelector('.playoff-title-pulse') !== null
                });
            } else {
                console.error('❌ [4] qTextEl NIE ZNALEZIONY!');
            }
            
            // Upewnij się że voting-header jest widoczny i wyśrodkowany (zawiera question-text)
            const votingHeader = document.querySelector('.voting-header');
            console.log('📝 [5] votingHeader znaleziony:', !!votingHeader);
            if (votingHeader) {
                votingHeader.style.setProperty('display', 'flex', 'important');
                votingHeader.style.setProperty('visibility', 'visible', 'important');
                votingHeader.style.setProperty('opacity', '1', 'important');
                votingHeader.style.setProperty('height', 'auto', 'important');
                votingHeader.style.setProperty('max-height', 'none', 'important');
                // WAŻNE: Podczas dogrywki wymuś wyśrodkowanie zamiast space-between
                votingHeader.style.setProperty('justify-content', 'center', 'important');
                votingHeader.style.setProperty('align-items', 'center', 'important');
                console.log('📝 [5] voting-header po ustawieniu:', {
                    display: window.getComputedStyle(votingHeader).display,
                    visibility: window.getComputedStyle(votingHeader).visibility,
                    opacity: window.getComputedStyle(votingHeader).opacity
                });
            } else {
                console.warn('⚠️ [5] voting-header NIE ZNALEZIONY!');
            }
            
            // Upewnij się że header-question jest wyśrodkowany i wymuś style inline
            const headerQuestion = document.querySelector('.header-question');
            if (headerQuestion) {
                headerQuestion.style.setProperty('justify-content', 'center', 'important');
                headerQuestion.style.setProperty('align-items', 'center', 'important');
                headerQuestion.style.setProperty('text-align', 'center', 'important');
                headerQuestion.style.setProperty('width', '100%', 'important');
                headerQuestion.style.setProperty('flex', '1', 'important');
                headerQuestion.style.setProperty('display', 'flex', 'important');
                console.log('📝 [5] header-question po ustawieniu:', {
                    justifyContent: window.getComputedStyle(headerQuestion).justifyContent,
                    alignItems: window.getComputedStyle(headerQuestion).alignItems,
                    textAlign: window.getComputedStyle(headerQuestion).textAlign,
                    width: window.getComputedStyle(headerQuestion).width
                });
            }
            
            // WAŻNE: Upewnij się że question-text wewnątrz header-question jest wyśrodkowany
            const qTextInHeader = headerQuestion ? headerQuestion.querySelector('#question-text') : null;
            if (qTextInHeader) {
                qTextInHeader.style.setProperty('text-align', 'center', 'important');
                qTextInHeader.style.setProperty('width', '100%', 'important');
                qTextInHeader.style.setProperty('margin', '0 auto', 'important');
                qTextInHeader.style.setProperty('display', 'block', 'important');
            }
            
            const grid = document.getElementById('answers-grid');
            console.log('🎤 answers-grid element:', grid, 'exists:', !!grid);
            if (!grid) {
                console.error('❌ Nie znaleziono answers-grid');
                return;
            }
            
            console.log('🎤 Przed modyfikacją grid:', {
                innerHTML: grid.innerHTML.substring(0, 100),
                classList: Array.from(grid.classList),
                display: window.getComputedStyle(grid).display,
                flexDirection: window.getComputedStyle(grid).flexDirection
            });
            
            console.log('📦 [5] Grid przed zmianami:', {
                className: grid.className,
                innerHTML: grid.innerHTML.substring(0, 100),
                computedDisplay: window.getComputedStyle(grid).display,
                computedFlexDirection: window.getComputedStyle(grid).flexDirection
            });
            
            // WAŻNE: Wyczyść całą zawartość grid PRZED zmianą klas
            grid.innerHTML = '';
            
            grid.classList.remove('list-mode', 'hot-or-not-grid');
            grid.classList.add('playoff-mode');
            
            // WAŻNE: Usuń klasę open-question-ui jeśli istnieje i wymuś poziomą orientację
            grid.classList.remove('open-question-mode');
            
            // WAŻNE: Upewnij się że grid i przyciski są klikalne - wymuś style inline
            grid.style.pointerEvents = 'auto';
            grid.style.setProperty('display', 'flex', 'important');
            grid.style.setProperty('flex-direction', 'row', 'important');
            grid.style.setProperty('justify-content', 'center', 'important');
            grid.style.setProperty('align-items', 'center', 'important');
            grid.style.setProperty('width', '100%', 'important');
            grid.style.setProperty('max-width', '100%', 'important');
            grid.style.setProperty('padding', '20px', 'important');
            console.log('📦 [5] Grid po zmianach:', {
                className: grid.className,
                computedDisplay: window.getComputedStyle(grid).display,
                computedFlexDirection: window.getComputedStyle(grid).flexDirection,
                inlineDisplay: grid.style.display,
                inlineFlexDirection: grid.style.flexDirection
            });
            
            console.log('🎤 Po modyfikacji grid:', {
                classList: Array.from(grid.classList),
                display: grid.style.display,
                flexDirection: grid.style.flexDirection,
                computedDisplay: window.getComputedStyle(grid).display,
                computedFlexDirection: window.getComputedStyle(grid).flexDirection
            });
            
            
            // Funkcja do wysłania głosu dogrywki
            function sendPlayoffVote(idx) {
                console.log('🗳️ Głosowanie dogrywka:', idx === 0 ? 'TAK' : 'NIE', 'playoffVoted:', playoffVoted, 'socket.connected:', socket.connected);
                if (playoffVoted) {
                    console.warn('⚠️ Już zagłosowano - pomijam');
                    return;
                }
                if (!socket || !socket.connected) {
                    console.error('❌ Socket nie jest połączony - nie można wysłać głosu');
                    showConnectionLost();
                    return;
                }
                playoffVoted = true;
                console.log('📤 Wysyłam głos do serwera:', { index: idx, team: playerTeam, socketId: socket.id });
                socket.emit('send_answer', { index: idx, team: playerTeam });
                console.log('✅ Głos wysłany do serwera');
                
                // Wyłącz przyciski
                const takBtn = document.getElementById('playoff-tak');
                const nieBtn = document.getElementById('playoff-nie');
                if (takBtn) {
                    takBtn.disabled = true;
                    takBtn.classList.add('answer-locked');
                    takBtn.style.opacity = '0.6';
                    takBtn.style.cursor = 'not-allowed';
                    takBtn.style.pointerEvents = 'none';
                }
                if (nieBtn) {
                    nieBtn.disabled = true;
                    nieBtn.classList.add('answer-locked');
                    nieBtn.style.opacity = '0.6';
                    nieBtn.style.cursor = 'not-allowed';
                    nieBtn.style.pointerEvents = 'none';
                }
                
                // WAŻNE: Po oddaniu głosu pokaż wyniki (poczekaj chwilę na aktualizację stanu)
                setTimeout(() => {
                    showPlayoffResultsAfterVote();
                }, 300);
                
                // UWAGA: Ostrzeżenie "Już zagłosowano" jest normalne - handler jest wywoływany wielokrotnie
                // (capture i bubble phase), ale głos jest wysyłany tylko raz dzięki flagi playoffVoted
            }
            
            // Funkcja pomocnicza do dodania handlera z wieloma metodami
            function addClickHandler(btn, idx, name) {
                console.log('🎤 addClickHandler wywołane dla:', name, 'button:', btn, 'exists:', !!btn, 'inDOM:', document.contains(btn));
                
                if (!btn) {
                    console.error('❌ addClickHandler: przycisk nie istnieje!');
                    return;
                }
                
                // Metoda 1: addEventListener w capture phase
                btn.addEventListener('click', function handler1(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('🔵 ✅ Kliknięto ' + name + ' (addEventListener capture) - WYSYŁAM GŁOS');
                    sendPlayoffVote(idx);
                    return false;
                }, true);
                
                // Metoda 2: addEventListener w bubble phase
                btn.addEventListener('click', function handler2(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔵 ✅ Kliknięto ' + name + ' (addEventListener bubble) - WYSYŁAM GŁOS');
                    sendPlayoffVote(idx);
                    return false;
                }, false);
                
                // Metoda 3: onclick jako backup
                btn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔵 ✅ onclick ' + name + ' - WYSYŁAM GŁOS');
                    sendPlayoffVote(idx);
                    return false;
                };
                
                // Metoda 4: touchstart dla urządzeń dotykowych
                btn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔵 ✅ touchstart ' + name + ' - WYSYŁAM GŁOS');
                    sendPlayoffVote(idx);
                    return false;
                }, { passive: false });
                
                // Metoda 5: touchend jako backup
                btn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔵 ✅ touchend ' + name + ' - WYSYŁAM GŁOS');
                    sendPlayoffVote(idx);
                    return false;
                }, { passive: false });
                
                console.log('🎤 Handlery przypisane do przycisku', name, ':', {
                    hasOnclick: !!btn.onclick,
                    eventListeners: 'dodane (click capture, click bubble, touchstart, touchend)'
                });
            }
            
            // Utwórz kontener playoff-ui z wymuszonymi stylami inline - WYŚRODKOWANY
            console.log('🎤 Tworzę kontener playoff-ui');
            const playoffContainer = document.createElement('div');
            playoffContainer.className = 'playoff-ui';
            // WAŻNE: width: auto zamiast 100% aby przyciski były wyśrodkowane jako grupa
            playoffContainer.style.cssText = 'display: flex !important; flex-direction: row !important; gap: 20px !important; justify-content: center !important; align-items: center !important; flex-wrap: nowrap !important; padding: 20px !important; width: auto !important; max-width: 100% !important; margin: 0 auto !important;';
            
            console.log('🎤 Kontener playoff-ui utworzony:', {
                className: playoffContainer.className,
                style: playoffContainer.style.cssText,
                computedDisplay: window.getComputedStyle(playoffContainer).display,
                computedFlexDirection: window.getComputedStyle(playoffContainer).flexDirection
            });
            
            const takBtn = document.createElement('button');
            takBtn.type = 'button';
            takBtn.className = 'answer-btn playoff-btn-tak';
            takBtn.id = 'playoff-tak';
            takBtn.textContent = 'TAK';
            // WAŻNE: Usuń wszystkie pseudo-elementy i style związane z answer-letter
            // WAŻNE: Usuń wszystkie pseudo-elementy i style związane z answer-letter
            // Ustaw max-width na mniejszą wartość aby przyciski były wyśrodkowane jako grupa
            takBtn.style.cssText = 'padding: 25px 40px !important; font-size: clamp(1.2rem, 5vw, 1.8rem) !important; font-weight: 800 !important; border-radius: 15px !important; min-width: 120px !important; flex: 0 1 auto !important; cursor: pointer !important; border: none !important; max-width: 200px !important; width: auto !important; pointer-events: auto !important; background: #2196f3 !important; color: white !important; text-align: center !important; position: relative !important;';
            // WAŻNE: Ukryj pseudo-elementy bezpośrednio w JavaScript
            takBtn.setAttribute('data-playoff-btn', 'true');
            // Usuń wszystkie dzieci które mogą być dodane przez CSS (answer-letter, answer-text)
            takBtn.innerHTML = 'TAK';
            
            const nieBtn = document.createElement('button');
            nieBtn.type = 'button';
            nieBtn.className = 'answer-btn playoff-btn-nie';
            nieBtn.id = 'playoff-nie';
            nieBtn.textContent = 'NIE';
            // WAŻNE: Usuń wszystkie pseudo-elementy i style związane z answer-letter
            // Ustaw max-width na mniejszą wartość aby przyciski były wyśrodkowane jako grupa
            nieBtn.style.cssText = 'padding: 25px 40px !important; font-size: clamp(1.2rem, 5vw, 1.8rem) !important; font-weight: 800 !important; border-radius: 15px !important; min-width: 120px !important; flex: 0 1 auto !important; cursor: pointer !important; border: none !important; max-width: 200px !important; width: auto !important; pointer-events: auto !important; background: #e74c3c !important; color: white !important; text-align: center !important; position: relative !important;';
            // WAŻNE: Ukryj pseudo-elementy bezpośrednio w JavaScript
            nieBtn.setAttribute('data-playoff-btn', 'true');
            // Usuń wszystkie dzieci które mogą być dodane przez CSS (answer-letter, answer-text)
            nieBtn.innerHTML = 'NIE';
            
            console.log('🎤 Przyciski utworzone:', {
                takBtn: { id: takBtn.id, className: takBtn.className, textContent: takBtn.textContent, style: takBtn.style.cssText.substring(0, 100) },
                nieBtn: { id: nieBtn.id, className: nieBtn.className, textContent: nieBtn.textContent, style: nieBtn.style.cssText.substring(0, 100) }
            });
            
            // Dodaj handlery BEZPOŚREDNIO do przycisków przed dodaniem do DOM
            console.log('🎤 Przypisuję handlery do przycisków');
            addClickHandler(takBtn, 0, 'TAK');
            addClickHandler(nieBtn, 1, 'NIE');
            
            playoffContainer.appendChild(takBtn);
            playoffContainer.appendChild(nieBtn);
            grid.appendChild(playoffContainer);
            
            // WAŻNE: Upewnij się że grid jest widoczny i ma odpowiednie style po dodaniu przycisków
            grid.style.setProperty('display', 'flex', 'important');
            grid.style.setProperty('flex-direction', 'row', 'important');
            grid.style.setProperty('justify-content', 'center', 'important');
            grid.style.setProperty('align-items', 'center', 'important');
            grid.style.setProperty('width', '100%', 'important');
            grid.style.setProperty('max-width', '100%', 'important');
            
            console.log('🎤 Po dodaniu do DOM:', {
                gridInnerHTML: grid.innerHTML.substring(0, 200),
                playoffContainerInDOM: document.contains(playoffContainer),
                takBtnInDOM: document.contains(takBtn),
                nieBtnInDOM: document.contains(nieBtn),
                computedPlayoffDisplay: window.getComputedStyle(playoffContainer).display,
                computedPlayoffFlexDirection: window.getComputedStyle(playoffContainer).flexDirection,
                computedTakDisplay: window.getComputedStyle(takBtn).display,
                computedNieDisplay: window.getComputedStyle(nieBtn).display,
                computedGridDisplay: window.getComputedStyle(grid).display,
                computedGridFlexDirection: window.getComputedStyle(grid).flexDirection
            });
            
            console.log('✅ [6] Przyciski dogrywki utworzone z poziomą orientacją i handlerami');
            console.log('📦 [6] Grid po dodaniu przycisków:', grid.innerHTML.substring(0, 300));
            
            // Sprawdź stan po chwili (po renderowaniu)
            setTimeout(() => {
                const playoffContainerCheck = document.querySelector('.playoff-ui');
                const takBtnCheck = document.getElementById('playoff-tak');
                const nieBtnCheck = document.getElementById('playoff-nie');
                const heroContainerCheck = document.getElementById('hero-image-container');
                const qTextCheck = document.getElementById('question-text');
                
                console.log('🔍 [7] SPRAWDZENIE PO 100ms:');
                console.log('🔍 [7] playoffContainer:', {
                    exists: !!playoffContainerCheck,
                    display: playoffContainerCheck ? window.getComputedStyle(playoffContainerCheck).display : 'brak',
                    flexDirection: playoffContainerCheck ? window.getComputedStyle(playoffContainerCheck).flexDirection : 'brak'
                });
                console.log('🔍 [7] takBtn:', {
                    exists: !!takBtnCheck,
                    display: takBtnCheck ? window.getComputedStyle(takBtnCheck).display : 'brak',
                    flex: takBtnCheck ? window.getComputedStyle(takBtnCheck).flex : 'brak'
                });
                console.log('🔍 [7] nieBtn:', {
                    exists: !!nieBtnCheck,
                    display: nieBtnCheck ? window.getComputedStyle(nieBtnCheck).display : 'brak',
                    flex: nieBtnCheck ? window.getComputedStyle(nieBtnCheck).flex : 'brak'
                });
                console.log('🔍 [7] heroContainer:', {
                    exists: !!heroContainerCheck,
                    display: heroContainerCheck ? window.getComputedStyle(heroContainerCheck).display : 'brak',
                    visibility: heroContainerCheck ? window.getComputedStyle(heroContainerCheck).visibility : 'brak'
                });
                console.log('🔍 [7] qText:', {
                    exists: !!qTextCheck,
                    innerHTML: qTextCheck ? qTextCheck.innerHTML.substring(0, 200) : 'brak',
                    fullInnerHTML: qTextCheck ? qTextCheck.innerHTML : 'brak',
                    dataAttr: qTextCheck ? qTextCheck.getAttribute('data-playoff-active') : 'brak',
                    hasPlayoffWord: qTextCheck ? qTextCheck.querySelector('.playoff-word') !== null : false,
                    hasPlayoffTitle: qTextCheck ? qTextCheck.querySelector('.playoff-title-pulse') !== null : false,
                    display: qTextCheck ? window.getComputedStyle(qTextCheck).display : 'brak',
                    visibility: qTextCheck ? window.getComputedStyle(qTextCheck).visibility : 'brak',
                    opacity: qTextCheck ? window.getComputedStyle(qTextCheck).opacity : 'brak'
                });
            }, 100);
            
            // WAŻNE: Upewnij się że tekst dogrywki jest nadal ustawiony i wyśrodkowany po zakończeniu funkcji
            setTimeout(() => {
                const qTextFinal = document.getElementById('question-text');
                const headerQuestionFinal = document.querySelector('.header-question');
                if (qTextFinal && playoff && playoff.word) {
                    const hasPlayoffAttr = qTextFinal.getAttribute('data-playoff-active') === 'true';
                    const hasPlayoffWord = qTextFinal.querySelector('.playoff-word') !== null;
                    const hasPlayoffTitle = qTextFinal.querySelector('.playoff-title-pulse') !== null;
                    
                    if (!hasPlayoffAttr || !hasPlayoffWord || !hasPlayoffTitle) {
                        console.warn('⚠️ [FINAL CHECK] Tekst dogrywki został nadpisany! Przywracam...');
                        const playoffWord = playoff.word || '';
                        qTextFinal.innerHTML = `
                            <div class="playoff-word" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 10px auto !important; font-size: clamp(1rem, 4vw, 1.3rem) !important; font-weight: 700 !important; color: white !important;">${playoffWord}</div>
                            <div class="playoff-title-pulse" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 20px auto !important;">🎤 DOGRYWKA</div>
                        `;
                        qTextFinal.setAttribute('data-playoff-active', 'true');
                        qTextFinal.style.setProperty('display', 'block', 'important');
                        qTextFinal.style.setProperty('visibility', 'visible', 'important');
                        qTextFinal.style.setProperty('opacity', '1', 'important');
                        qTextFinal.style.setProperty('text-align', 'center', 'important');
                        qTextFinal.style.setProperty('width', '100%', 'important');
                        qTextFinal.style.setProperty('margin', '0 auto', 'important');
                    } else {
                        // Upewnij się że style wyśrodkowania są nadal ustawione
                        qTextFinal.style.setProperty('text-align', 'center', 'important');
                        qTextFinal.style.setProperty('width', '100%', 'important');
                        qTextFinal.style.setProperty('margin', '0 auto', 'important');
                        console.log('✅ [FINAL CHECK] Tekst dogrywki jest poprawnie ustawiony');
                    }
                    
                    // Upewnij się że header-question jest wyśrodkowany
                    if (headerQuestionFinal) {
                        headerQuestionFinal.style.setProperty('justify-content', 'center', 'important');
                        headerQuestionFinal.style.setProperty('align-items', 'center', 'important');
                        headerQuestionFinal.style.setProperty('text-align', 'center', 'important');
                        headerQuestionFinal.style.setProperty('width', '100%', 'important');
                    }
                }
            }, 200);
            
            console.log('🎤 ========== KONIEC showPlayoffScreen ==========');
        }

        function updateQuestionDisplay(q) {
            console.log('🎤 updateQuestionDisplay wywołane:', {
                question: q ? q.question : 'brak',
                questionType: q ? q.type : 'brak',
                playoffExists: !!(currentGameState && currentGameState.playoff),
                playoffActive: !!(currentGameState && currentGameState.playoff && currentGameState.playoff.active)
            });
            
            // NIE aktualizuj display jeśli jest aktywna dogrywka
            if (currentGameState && currentGameState.playoff && currentGameState.playoff.active) {
                console.log('🎤 ✅ Dogrywka aktywna - pomijam updateQuestionDisplay i wymuszam ukrycie obrazka');
                // WAŻNE: Upewnij się że obrazek jest ukryty podczas dogrywki - użyj !important przez style
                const heroContainer = document.getElementById('hero-image-container');
                const heroImg = document.getElementById('hero-image');
                const questionHeader = document.querySelector('.question-header');
                const votingScreen = document.getElementById('voting-screen');
                
                if (heroContainer) {
                    heroContainer.style.setProperty('display', 'none', 'important');
                    heroContainer.style.setProperty('visibility', 'hidden', 'important');
                    heroContainer.style.setProperty('opacity', '0', 'important');
                    heroContainer.style.setProperty('height', '0', 'important');
                    heroContainer.style.setProperty('width', '0', 'important');
                    heroContainer.style.setProperty('position', 'absolute', 'important');
                    heroContainer.style.setProperty('left', '-9999px', 'important');
                    heroContainer.style.setProperty('margin', '0', 'important');
                    heroContainer.style.setProperty('padding', '0', 'important');
                    heroContainer.style.setProperty('max-height', '0', 'important');
                    heroContainer.style.setProperty('overflow', 'hidden', 'important');
                }
                if (heroImg) {
                    heroImg.src = '';
                    heroImg.style.setProperty('display', 'none', 'important');
                    heroImg.style.setProperty('visibility', 'hidden', 'important');
                    heroImg.style.setProperty('opacity', '0', 'important');
                    heroImg.style.setProperty('width', '0', 'important');
                    heroImg.style.setProperty('height', '0', 'important');
                    heroImg.style.setProperty('max-width', '0', 'important');
                    heroImg.style.setProperty('max-height', '0', 'important');
                    heroImg.removeAttribute('src');
                }
                if (questionHeader) {
                    questionHeader.style.setProperty('display', 'none', 'important');
                    questionHeader.style.setProperty('visibility', 'hidden', 'important');
                    questionHeader.style.setProperty('opacity', '0', 'important');
                    questionHeader.style.setProperty('height', '0', 'important');
                    questionHeader.style.setProperty('position', 'absolute', 'important');
                    questionHeader.style.setProperty('left', '-9999px', 'important');
                    questionHeader.style.setProperty('margin', '0', 'important');
                    questionHeader.style.setProperty('padding', '0', 'important');
                    questionHeader.style.setProperty('max-height', '0', 'important');
                    questionHeader.style.setProperty('overflow', 'hidden', 'important');
                }
                if (votingScreen) {
                    votingScreen.classList.add('no-image');
                    votingScreen.classList.add('playoff-mode');
                }
                // Wywołaj showPlayoffScreen aby upewnić się że dogrywka jest wyświetlona
                if (currentGameState.playoff) {
                    showPlayoffScreen(currentGameState.playoff);
                }
                return;
            }
            
            const qTextEl = document.getElementById('question-text');
            // WAŻNE: NIE nadpisuj question-text jeśli dogrywka jest aktywna lub ma atrybut data-playoff-active
            const isPlayoffActive = currentGameState && currentGameState.playoff && currentGameState.playoff.active;
            const hasPlayoffAttr = qTextEl && qTextEl.getAttribute('data-playoff-active') === 'true';
            console.log('📝 updateQuestionDisplay - isPlayoffActive:', isPlayoffActive, 'hasPlayoffAttr:', hasPlayoffAttr);
            if (qTextEl && q && !isPlayoffActive && !hasPlayoffAttr) {
                console.log('📝 updateQuestionDisplay - nadpisuję tekst pytania:', q.question);
                qTextEl.textContent = q.question || 'Pytanie...';
                qTextEl.removeAttribute('data-playoff-active');
            } else {
                console.log('📝 updateQuestionDisplay - POMIJAM nadpisanie (dogrywka aktywna lub atrybut)');
                // Jeśli dogrywka jest aktywna, upewnij się że słowo dogrywki i napis DOGRYWKA są ustawione - styl jak normalne pytania
                if (isPlayoffActive && qTextEl && qTextEl.getAttribute('data-playoff-active') !== 'true') {
                    const playoffWord = currentGameState.playoff?.word || '';
                    console.log('📝 updateQuestionDisplay - Przywracam słowo dogrywki i napis DOGRYWKA:', playoffWord);
                    qTextEl.innerHTML = `
                        <div class="playoff-word" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 10px auto !important; font-size: clamp(1rem, 4vw, 1.3rem) !important; font-weight: 700 !important; color: white !important;">${playoffWord}</div>
                        <div class="playoff-title-pulse" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 20px auto !important;">🎤 DOGRYWKA</div>
                    `;
                    qTextEl.style.setProperty('text-align', 'center', 'important');
                    qTextEl.style.setProperty('width', '100%', 'important');
                    qTextEl.setAttribute('data-playoff-active', 'true');
                }
            }
            
            const heroContainer = document.getElementById('hero-image-container');
            const heroImg = document.getElementById('hero-image');
            if (!heroContainer || !heroImg) return;
            
            // WAŻNE: Dla pytań otwartych - grafika powinna być widoczna podczas wpisywania odpowiedzi i pokazywania statystyk
            // Grafika znika dopiero gdy zaczyna się dogrywka (sprawdzenie wyżej)
            if (q && q.type === 'OPEN' && !isPlayoffActive) {
                const imgSrc = (q.imageSmall || q.image || q.media || '').trim();
                if (imgSrc) {
                    const src = (imgSrc.startsWith('/') || imgSrc.startsWith('http')) ? imgSrc : '/uploads/' + imgSrc;
                    console.log('📊 updateQuestionDisplay OPEN - Utrzymuję widoczność grafiki:', src);
                    heroContainer.style.display = 'block';
                    heroContainer.style.visibility = 'visible';
                    heroContainer.style.opacity = '1';
                    heroContainer.style.height = 'auto';
                    heroContainer.style.width = 'auto';
                    heroContainer.style.position = 'static';
                    heroContainer.style.left = 'auto';
                    heroImg.src = src;
                    triggerHeroReveal();
                    const questionHeader = document.querySelector('.question-header');
                    if (questionHeader) {
                        questionHeader.style.display = 'block';
                        questionHeader.style.visibility = 'visible';
                        questionHeader.style.opacity = '1';
                        questionHeader.style.height = 'auto';
                        questionHeader.style.position = 'static';
                        questionHeader.style.left = 'auto';
                    }
                    document.getElementById('voting-screen').classList.remove('no-image');
                } else {
                    heroContainer.style.display = 'none';
                    heroImg.src = '';
                    document.getElementById('voting-screen').classList.add('no-image');
                }
            } else {
                // Dla innych typów pytań - standardowa logika
                const imgSrc = (q.imageSmall || q.image || q.media || '').trim();
                if (imgSrc) {
                    const src = (imgSrc.startsWith('/') || imgSrc.startsWith('http')) ? imgSrc : '/uploads/' + imgSrc;
                    heroContainer.style.display = 'block';
                    heroImg.src = src;
                    triggerHeroReveal();
                    document.getElementById('voting-screen').classList.remove('no-image');
                } else {
                    heroContainer.style.display = 'none';
                    heroImg.src = '';
                    document.getElementById('voting-screen').classList.add('no-image');
                }
            }
        }

        function renderVoteResults(state) {
            console.log('📊 ========== renderVoteResults START ==========');
            console.log('📊 Parametry:', {
                hasPlayoff: !!state.playoff,
                playoffActive: state.playoff?.active,
                showStats: state.showStats,
                showCorrect: state.showCorrect,
                activeQuestion: state.activeQuestion?.type
            });
            
            document.getElementById('timer-badge').style.display = 'none';
            const grid = document.getElementById('answers-grid');
            if (!grid) {
                console.error('❌ renderVoteResults - grid nie znaleziony!');
                return;
            }
            
            // WAŻNE: Jeśli dogrywka jest aktywna, ZAWSZE pokazuj ekran głosowania, nie wyniki
            // Wyniki dogrywki będą pokazane dopiero gdy dogrywka zostanie zakończona przez admina
            if (state.playoff && state.playoff.active) {
                console.log('🎤 renderVoteResults - Dogrywka aktywna - przełączam na ekran głosowania (ignoruję showStats)');
                showPlayoffScreen(state.playoff);
                return;
            }
            
            // Ukryj battle bar domyślnie (zostanie pokazany tylko dla HOT_OR_NOT gdy showStats)
            const battleBar = document.getElementById('hot-battle-bar-container');
            if (battleBar) {
                battleBar.style.display = 'none';
            }
            
            grid.classList.remove('playoff-mode', 'list-mode');
            const votingScreenEl = document.getElementById('voting-screen');
            if (votingScreenEl) {
                votingScreenEl.classList.remove('playoff-mode');
            }
            
            // Wyniki dogrywki - pokaż rozkład głosów TAK/NIE (tylko gdy dogrywka NIE jest aktywna i NIE pokazujemy statystyk dla pytań LETTER/OPEN)
            // UWAGA: Ten kod nie powinien być osiągany gdy dogrywka jest aktywna (sprawdzenie wyżej)
            // Dla pytań LETTER/OPEN: pokazuj chmurę słów gdy showStats, a dogrywkę tylko gdy jest aktywna
            const q = state.activeQuestion;
            const isLetterOrOpen = q && (q.type === 'LETTER' || q.type === 'OPEN');
            // WAŻNE: Nie pokazuj wyników dogrywki dla pytań OPEN/LETTER gdy showStats jest true - pokaż chmurę słów
            if (state.playoff && !state.playoff.active && (state.showStats || state.showCorrect) && !isLetterOrOpen) {
                console.log('📊 renderVoteResults - Renderuję wyniki dogrywki (dogrywka zakończona)');
                // WAŻNE: Ukryj obrazek podczas pokazywania wyników dogrywki
                const heroContainer = document.getElementById('hero-image-container');
                const heroImg = document.getElementById('hero-image');
                const questionHeader = document.querySelector('.question-header');
                if (heroContainer) {
                    heroContainer.style.display = 'none';
                    heroContainer.style.visibility = 'hidden';
                    heroContainer.style.opacity = '0';
                    heroContainer.style.height = '0';
                    heroContainer.style.width = '0';
                    heroContainer.style.position = 'absolute';
                    heroContainer.style.left = '-9999px';
                }
                if (heroImg) {
                    heroImg.src = '';
                    heroImg.style.display = 'none';
                    heroImg.removeAttribute('src');
                }
                if (questionHeader) {
                    questionHeader.style.display = 'none';
                    questionHeader.style.visibility = 'hidden';
                    questionHeader.style.opacity = '0';
                    questionHeader.style.height = '0';
                    questionHeader.style.position = 'absolute';
                    questionHeader.style.left = '-9999px';
                }
                
                // Upewnij się że voting-screen ma klasę playoff-mode
                const votingScreenEl = document.getElementById('voting-screen');
                if (votingScreenEl) {
                    votingScreenEl.classList.add('playoff-mode');
                    votingScreenEl.classList.add('no-image');
                }
                const p = state.playoff;
                const totalP = (p.stats.A || 0) + (p.stats.B || 0);
                const wA = totalP > 0 ? Math.round((p.stats.A || 0) / totalP * 100) : 50;
                const pctA = totalP > 0 ? Math.round((p.stats.A || 0) / totalP * 100) : 0;
                const pctB = totalP > 0 ? Math.round((p.stats.B || 0) / totalP * 100) : 0;
                grid.innerHTML = `
                    <div class="playoff-screen-grid" id="playoff-results-render" style="display: flex !important; width: 100% !important; max-width: 100% !important; min-height: 140px !important; border-radius: 20px !important; overflow: hidden !important; box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1) !important; border: 2px solid rgba(255,255,255,0.15) !important; backdrop-filter: blur(10px) !important; background: rgba(0,0,0,0.2) !important; margin: 0 auto !important;">
                        <div class="playoff-card playoff-tak" id="playoff-card-tak-render" style="flex:${wA} !important; display: flex !important; flex-direction: column !important; align-items: center !important; justify-content: center !important; padding: 24px 20px !important; min-height: 120px !important; position: relative !important; background: linear-gradient(135deg, #1976d2, #2196f3, #42a5f5) !important; color: #fff !important; box-shadow: inset 0 2px 10px rgba(0,0,0,0.2), 0 4px 20px rgba(33, 150, 243, 0.4) !important; border-right: 2px solid rgba(255,255,255,0.1) !important;">
                            <div class="playoff-label" id="playoff-label-tak-render" style="font-size: clamp(1.5rem, 4vw, 2.5rem) !important; font-weight: 900 !important; margin-bottom: 6px !important; text-shadow: 0 3px 10px rgba(0,0,0,0.5), 0 1px 3px rgba(0,0,0,0.8) !important; letter-spacing: 1px !important; text-transform: uppercase !important; color: #fff !important;">TAK</div>
                            <div class="playoff-pct" id="playoff-pct-tak-render" style="font-size: clamp(1.4rem, 3.5vw, 2.2rem) !important; font-weight: 800 !important; margin-top: 4px !important; text-shadow: 0 2px 8px rgba(0,0,0,0.6), 0 1px 2px rgba(0,0,0,0.8) !important; color: #fff !important;">${pctA}%</div>
                            <div class="playoff-count" id="playoff-count-tak-render" style="font-size: clamp(1rem, 2.5vw, 1.4rem) !important; opacity: 0.95 !important; margin-top: 4px !important; text-shadow: 0 2px 6px rgba(0,0,0,0.5) !important; font-weight: 600 !important; color: #fff !important;">${p.stats.A || 0} głosów</div>
                        </div>
                        <div class="playoff-card playoff-nie" id="playoff-card-nie-render" style="flex:${100-wA} !important; display: flex !important; flex-direction: column !important; align-items: center !important; justify-content: center !important; padding: 24px 20px !important; min-height: 120px !important; position: relative !important; background: linear-gradient(135deg, #c62828, #e74c3c, #ef5350) !important; color: #fff !important; box-shadow: inset 0 2px 10px rgba(0,0,0,0.2), 0 4px 20px rgba(231, 76, 60, 0.4) !important;">
                            <div class="playoff-label" id="playoff-label-nie-render" style="font-size: clamp(1.5rem, 4vw, 2.5rem) !important; font-weight: 900 !important; margin-bottom: 6px !important; text-shadow: 0 3px 10px rgba(0,0,0,0.5), 0 1px 3px rgba(0,0,0,0.8) !important; letter-spacing: 1px !important; text-transform: uppercase !important; color: #fff !important;">NIE</div>
                            <div class="playoff-pct" id="playoff-pct-nie-render" style="font-size: clamp(1.4rem, 3.5vw, 2.2rem) !important; font-weight: 800 !important; margin-top: 4px !important; text-shadow: 0 2px 8px rgba(0,0,0,0.6), 0 1px 2px rgba(0,0,0,0.8) !important; color: #fff !important;">${pctB}%</div>
                            <div class="playoff-count" id="playoff-count-nie-render" style="font-size: clamp(1rem, 2.5vw, 1.4rem) !important; opacity: 0.95 !important; margin-top: 4px !important; text-shadow: 0 2px 6px rgba(0,0,0,0.5) !important; font-weight: 600 !important; color: #fff !important;">${p.stats.B || 0} głosów</div>
                        </div>
                    </div>
                `;
                
                // WAŻNE: Wymuś style jeszcze raz przez setProperty aby upewnić się że są zastosowane
                setTimeout(() => {
                    const gridEl = document.getElementById('playoff-results-render');
                    const cardTak = document.getElementById('playoff-card-tak-render');
                    const cardNie = document.getElementById('playoff-card-nie-render');
                    
                    if (gridEl) {
                        gridEl.style.setProperty('box-shadow', '0 12px 40px rgba(0,0,0,0.5), 0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1)', 'important');
                        gridEl.style.setProperty('border', '2px solid rgba(255,255,255,0.15)', 'important');
                        gridEl.style.setProperty('backdrop-filter', 'blur(10px)', 'important');
                    }
                    
                    if (cardTak) {
                        cardTak.style.setProperty('background', 'linear-gradient(135deg, #1976d2, #2196f3, #42a5f5)', 'important');
                        cardTak.style.setProperty('box-shadow', 'inset 0 2px 10px rgba(0,0,0,0.2), 0 4px 20px rgba(33, 150, 243, 0.4)', 'important');
                    }
                    
                    if (cardNie) {
                        cardNie.style.setProperty('background', 'linear-gradient(135deg, #c62828, #e74c3c, #ef5350)', 'important');
                        cardNie.style.setProperty('box-shadow', 'inset 0 2px 10px rgba(0,0,0,0.2), 0 4px 20px rgba(231, 76, 60, 0.4)', 'important');
                    }
                }, 100);
                console.log('📊 renderVoteResults - Wyniki dogrywki wyrenderowane:', {
                    tak: p.stats.A || 0,
                    nie: p.stats.B || 0,
                    gridInnerHTML: grid.innerHTML.substring(0, 200)
                });
                console.log('📊 ========== renderVoteResults END (dogrywka) ==========');
                return;
            }
            
            // q jest już zadeklarowane wcześniej (linia 4309) - nie deklaruj ponownie
            if (!q) return;
            const letters = ['A','B','C','D','E'];
            const colors = ['ans-a','ans-b','ans-c','ans-d','ans-e'];
            const stats = state.stats || {};
            const total = Object.values(stats).reduce(function(s, n) { return s + n; }, 0);

            if (q.type === 'OPEN' || q.type === 'LETTER') {
                // Dla OPEN/LETTER: chmura słów po wciśnięciu Statystyk (na telefonach też)
                // WAŻNE: Pokazuj chmurę słów nawet gdy istnieje dogrywka (ale nie jest aktywna)
                // Dogrywkę pokazuj tylko gdy jest aktywna (playoff.active === true)
                const heroContainer = document.getElementById('hero-image-container');
                const heroImg = document.getElementById('hero-image');
                const questionHeader = document.querySelector('.question-header');
                const isPlayoffActive = state.playoff && state.playoff.active;
                const hasPlayoffButNotActive = state.playoff && !state.playoff.active;
                if (q.type === 'OPEN' && heroContainer && heroImg && heroImg.src && heroImg.src.trim() !== '' && !isPlayoffActive) {
                    heroContainer.style.display = 'block';
                    heroContainer.style.visibility = 'visible';
                    heroContainer.style.opacity = '1';
                    heroContainer.style.height = 'auto';
                    heroContainer.style.width = 'auto';
                    heroContainer.style.position = 'static';
                    heroContainer.style.left = 'auto';
                    if (questionHeader) {
                        questionHeader.style.display = 'block';
                        questionHeader.style.visibility = 'visible';
                        questionHeader.style.opacity = '1';
                        questionHeader.style.height = 'auto';
                        questionHeader.style.position = 'static';
                        questionHeader.style.left = 'auto';
                    }
                    document.getElementById('voting-screen').classList.remove('no-image');
                }
                
                // Wyświetl chmurę słów (OPEN i LETTER) jeśli są dane
                // WAŻNE: Pokazuj chmurę słów nawet gdy istnieje dogrywka (ale nie jest aktywna)
                // Dogrywkę pokazuj tylko gdy jest aktywna (playoff.active === true)
                if (state.openCloud && state.openCloud.length > 0 && !isPlayoffActive) {
                    const maxCount = Math.max(...state.openCloud.map(x => x.count), 1);
                    function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
                    grid.innerHTML = '<div class="vote-results-word-cloud">' + state.openCloud.map(item => {
                        const size = Math.max(14, Math.min(48, 14 + (item.count / maxCount) * 34));
                        return '<span class="word-tag" style="font-size:' + size + 'px">' + esc(item.word) + (item.count > 1 ? ' (' + item.count + ')' : '') + '</span>';
                    }).join(' ') + '</div>';
                } else if (!isPlayoffActive) {
                    grid.innerHTML = '<div class="vote-results-word-cloud" style="text-align:center;padding:40px;color:rgba(255,255,255,0.7);">' +
                        '<div style="font-size:clamp(1rem,3vw,1.2rem);margin-bottom:10px;">Brak odpowiedzi</div>' +
                        '<div style="font-size:clamp(0.85rem,2.5vw,1rem);opacity:0.8;">Gracze jeszcze nie odpowiedzieli</div>' +
                        '</div>';
                }
                // Jeśli dogrywka jest aktywna, nie pokazuj nic tutaj (dogrywka jest obsługiwana wyżej)
            } else if (q.type === 'ESTIMATION') {
                const estStats = state.estimationStats || [];
                const minRange = q.min !== undefined && q.min !== null ? Number(q.min) : 0;
                const maxRange = q.max !== undefined && q.max !== null ? Number(q.max) : 100;
                const correctVal = state.estimationCorrectValue != null ? state.estimationCorrectValue : (q.correctValue != null ? Number(q.correctValue) : null);
                
                let html = '<div class="vote-results-estimation-box">';
                
                if (state.showStats || state.showCorrect) {
                    if (estStats.length > 0) {
                        const estTotal = estStats.reduce((s, x) => s + x.count, 0);
                        const maxCount = Math.max(...estStats.map(x => x.count), 1);
                        
                        // Grupuj odpowiedzi w przedziały 5% zakresu (dokładność do 5%)
                        const range = maxRange - minRange;
                        const bucketSize = Math.max(1, range * 0.05); // 5% zakresu
                        const buckets = new Map();
                        
                        estStats.forEach(item => {
                            // Normalizuj wartość do zakresu [0, range], potem grupuj w przedziały 5%
                            const normalizedValue = item.value - minRange;
                            const bucketIndex = Math.round(normalizedValue / bucketSize);
                            const bucketValue = minRange + (bucketIndex * bucketSize);
                            
                            if (!buckets.has(bucketValue)) {
                                buckets.set(bucketValue, { value: bucketValue, count: 0 });
                            }
                            buckets.get(bucketValue).count += item.count;
                        });
                        
                        const sortedBuckets = Array.from(buckets.values()).sort((a, b) => a.value - b.value);
                        const maxBucketCount = Math.max(...sortedBuckets.map(b => b.count), 1);
                        
                        html += '<div class="estimation-chart-container">';
                        
                        if (state.showCorrect && correctVal !== null && !Number.isNaN(correctVal)) {
                            html += '<div class="correct-label">Poprawna odpowiedź: <strong>' + correctVal + '</strong></div>';
                        } else {
                            html += '<div class="correct-label">Odpowiedzi graczy</div>';
                        }
                        
                        // Wykres poziomy
                        html += '<div class="estimation-chart">';
                        html += '<div class="estimation-chart-labels">';
                        html += '<span class="chart-label-min">' + minRange + '</span>';
                        html += '<span class="chart-label-max">' + maxRange + '</span>';
                        html += '</div>';
                        
                        html += '<div class="estimation-chart-track">';
                        
                        // Linia pozioma (suwak)
                        html += '<div class="estimation-chart-line"></div>';
                        
                        // Prawidłowa odpowiedź - marker
                        if (state.showCorrect && correctVal !== null && !Number.isNaN(correctVal) && correctVal >= minRange && correctVal <= maxRange) {
                            const correctPos = ((correctVal - minRange) / range) * 100;
                            html += '<div class="estimation-correct-marker" style="left: ' + correctPos + '%;"></div>';
                        }
                        
                        // Słupki dla każdego przedziału
                        sortedBuckets.forEach(bucket => {
                            // Oblicz pozycję względem zakresu [minRange, maxRange]
                            let pos = 0;
                            if (range > 0) {
                                pos = ((bucket.value - minRange) / range) * 100;
                            }
                            // Ogranicz pozycję do zakresu [0, 100]
                            pos = Math.max(0, Math.min(100, pos));
                            
                            const height = Math.max(20, (bucket.count / maxBucketCount) * 150); // Min 20px, max 150px
                            const pct = estTotal > 0 ? Math.round((bucket.count / estTotal) * 100) : 0;
                            
                            // Zaokrąglij wartość do czytelności
                            const displayValue = Math.round(bucket.value * 10) / 10;
                            
                            html += '<div class="estimation-bar" style="left: ' + pos + '%; height: ' + height + 'px;" title="' + displayValue + ': ' + bucket.count + ' (' + pct + '%)">';
                            html += '<div class="estimation-bar-value">' + displayValue + '</div>';
                            html += '<div class="estimation-bar-count">' + bucket.count + '</div>';
                            html += '</div>';
                        });
                        
                        html += '</div>'; // estimation-chart-track
                        html += '</div>'; // estimation-chart
                        html += '</div>'; // estimation-chart-container
                    } else {
                        html += '<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px;">Brak odpowiedzi</div>';
                    }
                }
                html += '</div>';
                grid.innerHTML = html;
            } else if (q.type === 'HOT_OR_NOT' && q.answers) {
                // HOT_OR_NOT - specjalny układ z obrazkami dla wyników
                const correctAnswers = Array.isArray(q.correct) ? q.correct : (q.correct !== undefined && q.correct !== null && q.correct !== -1 ? [q.correct] : []);
                const imageASrc = q.imageSmallA || q.imageA || '';
                const imageBSrc = q.imageSmallB || q.imageB || '';
                const statsA = stats['A'] || 0;
                const statsB = stats['B'] || 0;
                const totalHot = statsA + statsB;
                const pctA = totalHot > 0 ? Math.round(statsA / totalHot * 100) : 0;
                const pctB = totalHot > 0 ? Math.round(statsB / totalHot * 100) : 0;
                const isACorrect = correctAnswers.includes(0);
                const isBCorrect = correctAnswers.includes(1);
                
                // Przygotuj ścieżki obrazków
                let fullImageASrc = imageASrc && imageASrc.trim() !== '' ? imageASrc.trim() : '';
                let fullImageBSrc = imageBSrc && imageBSrc.trim() !== '' ? imageBSrc.trim() : '';
                
                if (fullImageASrc && !fullImageASrc.startsWith('/') && !fullImageASrc.startsWith('http')) {
                    fullImageASrc = '/uploads/' + fullImageASrc;
                }
                if (fullImageBSrc && !fullImageBSrc.startsWith('/') && !fullImageBSrc.startsWith('http')) {
                    fullImageBSrc = '/uploads/' + fullImageBSrc;
                }
                
                // Użyj tego samego układu co podczas głosowania
                grid.classList.add('hot-or-not-grid', 'layout-horizontal');
                const votingScreen = document.getElementById('voting-screen');
                if (votingScreen) {
                    votingScreen.classList.add('hot-or-not-mode');
                }
                
                const cardAClass = 'hot-image-card hot-card-a' + (state.showCorrect && isACorrect ? ' answer-selected' : '') + ' answer-locked';
                const cardBClass = 'hot-image-card hot-card-b' + (state.showCorrect && isBCorrect ? ' answer-selected' : '') + ' answer-locked';
                
                const imgAHTML = fullImageASrc ? `<img src="${fullImageASrc}" alt="Opcja A" style="width:100%;height:100%;object-fit:contain;">` : '<div class="no-image-placeholder" style="display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; color: rgba(255,255,255,0.5); font-size: clamp(0.9rem, 3vw, 1.2rem); position: absolute; top: 0; left: 0;">Brak obrazka</div>';
                const imgBHTML = fullImageBSrc ? `<img src="${fullImageBSrc}" alt="Opcja B" style="width:100%;height:100%;object-fit:contain;">` : '<div class="no-image-placeholder" style="display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; color: rgba(255,255,255,0.5); font-size: clamp(0.9rem, 3vw, 1.2rem); position: absolute; top: 0; left: 0;">Brak obrazka</div>';
                
                let html = '';
                html += `<div class="${cardAClass}" style="pointer-events:none;">`;
                html += '<div class="hot-image-label">A</div>';
                html += '<div class="hot-image-wrapper">' + imgAHTML + '</div>';
                html += '<div class="hot-image-answer">' + (q.answers[0] || 'Opcja A') + '</div>';
                html += '</div>';
                
                html += `<div class="${cardBClass}" style="pointer-events:none;">`;
                html += '<div class="hot-image-label">B</div>';
                html += '<div class="hot-image-wrapper">' + imgBHTML + '</div>';
                html += '<div class="hot-image-answer">' + (q.answers[1] || 'Opcja B') + '</div>';
                html += '</div>';
                
                grid.innerHTML = html;
                
                // WAŻNE: Jeśli showStats jest true, pokaż battle bar zamiast tekstu w odpowiedziach
                const battleBar = document.getElementById('hot-battle-bar-container');
                if (state.showStats && battleBar) {
                    battleBar.style.display = 'block';
                    updateHotBattleBar(statsA, statsB);
                } else if (battleBar && q.type === 'HOT_OR_NOT') {
                    // Ukryj battle bar tylko dla HOT_OR_NOT jeśli showStats jest false
                    battleBar.style.display = 'none';
                }
            } else if ((q.type === 'QUIZ' || q.type === 'MUSIC' || q.type === 'VOTE' || q.type === 'VOTE_IMG') && q.answers) {
                const correctAnswers = Array.isArray(q.correct) ? q.correct : (q.correct !== undefined && q.correct !== null && q.correct !== -1 ? [q.correct] : []);
                const limit = (q.type === 'VOTE' || q.type === 'VOTE_IMG') ? 2 : Math.min(5, q.answers.filter(Boolean).length);
                // WAŻNE: Zachowaj układ poziomy (2 kolumny) tak jak podczas głosowania
                grid.classList.remove('list-mode');
                // WAŻNE: Dla pytań muzycznych upewnij się że voting-screen ma klasę music-mode
                const votingScreen = document.getElementById('voting-screen');
                if (q.type === 'MUSIC' && votingScreen) {
                    votingScreen.classList.add('music-mode');
                    grid.style.gridTemplateColumns = '1fr 1fr';
                } else {
                    if (votingScreen) votingScreen.classList.remove('music-mode');
                    grid.style.gridTemplateColumns = '1fr 1fr';
                }
                let html = '';
                for (let i = 0; i < limit && i < (q.answers.length || 0); i++) {
                    if (!q.answers[i]) continue;
                    const isCorrect = correctAnswers.includes(i);
                    const isPlayerAnswer = playerAnswerIndex === i; // Sprawdź czy to odpowiedź gracza
                    const count = stats[letters[i]] || 0;
                    // WAŻNE: Nie pokazuj procentów - tylko liczbę głosów
                    // Zaznacz odpowiedź gracza lub poprawną odpowiedź
                    let cls = 'answer-btn ' + colors[i];
                    if (state.showCorrect && isCorrect) {
                        cls += ' answer-selected';
                    } else if (isPlayerAnswer && !state.showCorrect) {
                        // Pokaż odpowiedź gracza nawet gdy nie pokazujemy poprawnej odpowiedzi
                        cls += ' answer-selected';
                    }
                    // WAŻNE: Nie dodawaj answer-locked - przyciski mają pozostać widoczne (jak na screen.html)
                    // Usuń pointer-events:none aby przyciski były widoczne (choć nie klikalne)
                    html += '<button type="button" class="' + cls + '">';
                    html += '<div class="answer-letter">' + letters[i] + '</div>';
                    html += '<div class="answer-text">' + (q.answers[i] || '') + '</div>';
                    // WAŻNE: Dla VOTE_IMG i VOTE nie pokazuj liczby głosów w przycisku gdy showStats (battle bar pokaże wyniki)
                    if (state.showStats && total > 0 && q.type !== 'VOTE' && q.type !== 'VOTE_IMG') {
                        html += '<div style="margin-left:auto;font-weight:800;color:rgba(255,255,255,0.9);">' + count + '</div>';
                    }
                    html += '</button>';
                }
                grid.innerHTML = html;
                
                // WAŻNE: Dla VOTE_IMG i VOTE pokaż battle bar gdy showStats jest true
                if ((q.type === 'VOTE' || q.type === 'VOTE_IMG') && state.showStats) {
                    const statsA = stats['A'] || 0;
                    const statsB = stats['B'] || 0;
                    const battleBar = document.getElementById('hot-battle-bar-container');
                    if (battleBar) {
                        battleBar.style.display = 'block';
                        updateHotBattleBar(statsA, statsB);
                    }
                }
            }
        }
        
        // Funkcja do aktualizacji battle bar dla HOT_OR_NOT
        function updateHotBattleBar(statsA, statsB) {
            const battleBarFill = document.getElementById('hot-battle-bar-fill');
            const scoreA = document.getElementById('hot-score-val-a');
            const scoreB = document.getElementById('hot-score-val-b');
            
            if (!battleBarFill || !scoreA || !scoreB) return;
            
            const total = statsA + statsB;
            const percA = total > 0 ? Math.round((statsA / total) * 100) : 50;
            
            battleBarFill.style.width = percA + '%';
            scoreA.textContent = percA + '%';
            scoreB.textContent = (100 - percA) + '%';
        }

        // === EKRAN GŁOSOWANIA ===
        function showVotingScreen(question, timeLeft) {
            // NIE pokazuj showVotingScreen jeśli jest aktywna dogrywka
            if (currentGameState && currentGameState.playoff && currentGameState.playoff.active) {
                console.log('🎤 Dogrywka aktywna - pomijam showVotingScreen, wywołuję showPlayoffScreen zamiast');
                // WAŻNE: Ustaw słowo dogrywki przed wywołaniem showPlayoffScreen
                const qTextElEarly = document.getElementById('question-text');
                if (qTextElEarly && currentGameState.playoff && currentGameState.playoff.word) {
                    const playoffWord = currentGameState.playoff.word || '';
                    qTextElEarly.innerHTML = `
                        <div class="playoff-word" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 10px auto !important; font-size: clamp(1rem, 4vw, 1.3rem) !important; font-weight: 700 !important; color: white !important;">${playoffWord}</div>
                        <div class="playoff-title-pulse" style="text-align: center !important; width: 100% !important; display: block !important; margin: 0 auto 20px auto !important;">🎤 DOGRYWKA</div>
                    `;
                    qTextElEarly.setAttribute('data-playoff-active', 'true');
                }
                // Wywołaj showPlayoffScreen zamiast showVotingScreen
                showPlayoffScreen(currentGameState.playoff);
                return;
            }
            
            // WAŻNE: Resetuj hasAnswered dla nowego pytania (sprawdź czy questionId się zmienił)
            const questionId = question.id !== undefined && question.id !== null ? question.id : `q_${Date.now()}`;
            
            console.log('🔍 DEBUG showVotingScreen - sprawdzanie questionId:', {
                questionId: questionId,
                currentQuestionId: currentQuestionId,
                questionIdChanged: questionId !== currentQuestionId,
                questionType: question.type,
                questionQuestion: question.question?.substring(0, 50)
            });
            
            if (questionId !== currentQuestionId) {
                console.log('🔄 Nowe pytanie w showVotingScreen - resetuję hasAnswered, questionId:', questionId, 'currentQuestionId:', currentQuestionId);
                // WAŻNE: Zaktualizuj currentQuestionId PRZED sprawdzeniem localStorage
                currentQuestionId = questionId;
                const answeredKey = `voteBattle_answered_${questionId}`;
                
                // DEBUG: Sprawdź wszystkie klucze localStorage przed sprawdzeniem
                const allAnswerKeysBefore = [];
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('voteBattle_answered_')) {
                            allAnswerKeysBefore.push({ key, value: localStorage.getItem(key) });
                        }
                    }
                } catch (e) {
                    console.warn('Błąd przy sprawdzaniu localStorage:', e);
                }
                
                console.log('🔍 DEBUG showVotingScreen - localStorage przed sprawdzeniem:', {
                    answeredKey: answeredKey,
                    localStorageValue: localStorage.getItem(answeredKey),
                    allAnswerKeys: allAnswerKeysBefore
                });
                
                hasAnswered = localStorage.getItem(answeredKey) === 'true';
                
                console.log('🔍 DEBUG showVotingScreen - hasAnswered po sprawdzeniu:', {
                    hasAnswered: hasAnswered,
                    answeredKey: answeredKey,
                    localStorageValue: localStorage.getItem(answeredKey)
                });
                
                if (!hasAnswered) {
                    playerAnswerIndex = null;
                    console.log('✅ Nowe pytanie - gracz jeszcze nie zagłosował, hasAnswered:', hasAnswered);
                } else {
                    // Przywróć indeks odpowiedzi gracza jeśli już zagłosował
                    const savedIndex = localStorage.getItem(`${answeredKey}_index`);
                    if (savedIndex !== null) {
                        playerAnswerIndex = parseInt(savedIndex, 10);
                    }
                    console.log('✅ Nowe pytanie - gracz już zagłosował, przywracam indeks:', playerAnswerIndex);
                }
            } else {
                // To samo pytanie - sprawdź czy gracz już zagłosował
                console.log('🔍 DEBUG showVotingScreen - to samo pytanie, sprawdzam localStorage');
                const answeredKey = `voteBattle_answered_${questionId}`;
                hasAnswered = localStorage.getItem(answeredKey) === 'true';
                
                console.log('🔍 DEBUG showVotingScreen - to samo pytanie, hasAnswered:', {
                    hasAnswered: hasAnswered,
                    answeredKey: answeredKey,
                    localStorageValue: localStorage.getItem(answeredKey)
                });
                
                if (hasAnswered) {
                    const savedIndex = localStorage.getItem(`${answeredKey}_index`);
                    if (savedIndex !== null) {
                        playerAnswerIndex = parseInt(savedIndex, 10);
                    }
                } else {
                    playerAnswerIndex = null;
                }
            }
            
            // Resetuj flagę dogrywki gdy zaczyna się normalne pytanie
            playoffVoted = false;
            lastPlayoffWord = '';
            lastPlayoffQuestionId = null;
            
            showScreen('voting');

            const heroContainer = document.getElementById('hero-image-container');
            const heroImg = document.getElementById('hero-image');
            const votingScreen = document.getElementById('voting-screen');
            const grid = document.getElementById('answers-grid');
            // Reset klas na voting-screen i grid – zapobiega „wkręcaniu się” starych stylów
            if (votingScreen) {
                votingScreen.classList.remove('playoff-mode', 'no-image', 'ships-mode', 'hot-or-not-mode', 'music-mode');
            }
            if (grid) {
                grid.classList.remove('playoff-mode', 'list-mode', 'hot-or-not-grid', 'ships-mode', 'layout-horizontal', 'layout-vertical');
                grid.innerHTML = '';
                grid.style.pointerEvents = '';
                grid.style.cursor = '';
                grid.style.removeProperty('width');
                grid.style.removeProperty('height');
                grid.style.removeProperty('min-height');
                grid.style.removeProperty('max-height');
            }
            // Reset hero/grafiki – usuń inline !important z poprzedniego stanu (np. dogrywka), żeby grafika znów ładowała się na telefonach
            if (heroContainer) {
                heroContainer.style.removeProperty('display');
                heroContainer.style.removeProperty('visibility');
                heroContainer.style.removeProperty('opacity');
                heroContainer.style.removeProperty('height');
                heroContainer.style.removeProperty('width');
                heroContainer.style.removeProperty('position');
                heroContainer.style.removeProperty('left');
                heroContainer.style.removeProperty('margin');
                heroContainer.style.removeProperty('padding');
                heroContainer.style.removeProperty('max-height');
                heroContainer.style.removeProperty('overflow');
            }
            if (heroImg) {
                heroImg.style.removeProperty('display');
            }
            const questionHeader = document.querySelector('.question-header');
            if (questionHeader) {
                questionHeader.style.removeProperty('display');
                questionHeader.style.removeProperty('visibility');
                questionHeader.style.removeProperty('opacity');
                questionHeader.style.removeProperty('height');
                questionHeader.style.removeProperty('position');
                questionHeader.style.removeProperty('left');
            }
            
            // Ukryj battle bar domyślnie (zostanie pokazany tylko dla HOT_OR_NOT gdy showStats)
            const battleBar = document.getElementById('hot-battle-bar-container');
            if (battleBar) {
                battleBar.style.display = 'none';
            }
            
                // HOT_OR_NOT - specjalny układ z dwoma obrazkami
            if (question.type === 'HOT_OR_NOT') {
                heroContainer.style.display = 'none';
                votingScreen.classList.remove('no-image');
                votingScreen.classList.add('hot-or-not-mode');
                
                // Formatowanie pytania z obsługą wieloliniowych pytań
                const qTextEl = document.getElementById('question-text');
                const rawText = question.question || 'Pytanie...';
                
                // Reset klas wieloliniowych
                qTextEl.classList.remove('multi-line', 'two-lines', 'three-lines');
                
                // Dzielenie tekstu pytania na 2-3 linie dla dłuższych pytań
                if(rawText.length > 0 && !rawText.includes('<br>')) {
                    const textLength = rawText.length;
                    let formattedText = rawText;
                    
                    // Dla bardzo długich pytań (>100 znaków) - 3 linie
                    if(textLength > 100) {
                        const third1 = Math.floor(textLength / 3);
                        const third2 = Math.floor(textLength * 2 / 3);
                        
                        const space1 = rawText.lastIndexOf(' ', third1);
                        const space2 = rawText.lastIndexOf(' ', third2);
                        const space3 = rawText.indexOf(' ', third2);
                        
                        let split1 = space1 > 0 ? space1 : third1;
                        let split2 = space2 > split1 ? space2 : (space3 > split1 ? space3 : third2);
                        
                        if(split1 > 0 && split2 > split1) {
                            formattedText = rawText.substring(0, split1) + '<br>' + 
                                           rawText.substring(split1 + 1, split2) + '<br>' + 
                                           rawText.substring(split2 + 1);
                            qTextEl.classList.add('multi-line', 'three-lines');
                        } else if(split1 > 0) {
                            formattedText = rawText.substring(0, split1) + '<br>' + rawText.substring(split1 + 1);
                            qTextEl.classList.add('multi-line', 'two-lines');
                        }
                    }
                    // Dla średnich pytań (60-100 znaków) - 2 linie
                    else if(textLength > 60) {
                        const mid = Math.floor(textLength / 2);
                        const leftSpace = rawText.lastIndexOf(' ', mid);
                        const rightSpace = rawText.indexOf(' ', mid);
                        let splitIdx = -1;
                        
                        if(leftSpace === -1) splitIdx = rightSpace;
                        else if(rightSpace === -1) splitIdx = leftSpace;
                        else splitIdx = (mid - leftSpace < rightSpace - mid) ? leftSpace : rightSpace;

                        if(splitIdx !== -1 && splitIdx > 0) {
                            formattedText = rawText.substring(0, splitIdx) + '<br>' + rawText.substring(splitIdx + 1);
                            qTextEl.classList.add('multi-line', 'two-lines');
                        }
                    }
                    
                    qTextEl.innerHTML = formattedText;
                } else if(rawText.includes('<br>')) {
                    // Jeśli już ma <br>, zachowaj ale dodaj klasę
                    qTextEl.innerHTML = rawText;
                    const lineCount = (rawText.match(/<br>/g) || []).length + 1;
                    if(lineCount >= 3) {
                        qTextEl.classList.add('multi-line', 'three-lines');
                    } else if(lineCount === 2) {
                        qTextEl.classList.add('multi-line', 'two-lines');
                    }
                } else {
                    qTextEl.innerText = rawText;
                }
                
                // Do wykrywania orientacji: pełne obrazki (imageA/imageB), żeby nie brać miniatur w portrait
                const orientASrc = question.imageA || question.imageSmallA || '';
                const orientBSrc = question.imageB || question.imageSmallB || '';
                // Do wyświetlania: miniatury na telefonie (imageSmall), fallback do pełnych
                const imageASrc = question.imageSmallA || question.imageA || '';
                const imageBSrc = question.imageSmallB || question.imageB || '';
                
                console.log('🖼️ HOT_OR_NOT vote.html - imageSmallA:', question.imageSmallA, 'imageA:', question.imageA);
                console.log('🖼️ HOT_OR_NOT vote.html - imageSmallB:', question.imageSmallB, 'imageB:', question.imageB);
                const answers = question.answers || [];
                
                // Funkcja do wykrywania orientacji obrazka (bardziej precyzyjna)
                function detectImageOrientation(imageSrc, callback) {
                    if(!imageSrc || imageSrc.trim() === '') {
                        callback('square');
                        return;
                    }
                    const img = new Image();
                    img.onload = function() {
                        const ratio = img.width / img.height;
                        // Pionowe: wysokość > szerokość (ratio < 1)
                        if(ratio < 0.9) callback('portrait');
                        // Poziome: szerokość > wysokość (ratio > 1)
                        else if(ratio > 1.1) callback('landscape');
                        // Kwadratowe: prawie równe (0.9 <= ratio <= 1.1)
                        else callback('square');
                    };
                    img.onerror = () => {
                        console.warn('⚠️ vote.html - Nie można załadować obrazka do wykrycia orientacji:', imageSrc);
                        callback('square');
                    };
                    const fullSrc = imageSrc.startsWith('/') || imageSrc.startsWith('http') ? imageSrc : '/uploads/' + imageSrc;
                    img.src = fullSrc;
                }
                
                // Wykryj orientację i ustaw układ (użyj orientASrc/orientBSrc = pełne obrazki)
                detectImageOrientation(orientASrc, (orientA) => {
                    detectImageOrientation(orientBSrc, (orientB) => {
                        let layout = 'horizontal';
                        
                        console.log('🖼️ HOT_OR_NOT vote.html - orientacje:', { orientA, orientB });
                        
                        // WAŻNE: Gdy oba zdjęcia są pionowe → układ poziomy (obok siebie)
                        if(orientA === 'portrait' && orientB === 'portrait') {
                            layout = 'horizontal';
                        }
                        // Jeśli oba są poziome → układ pionowy (jeden pod drugim)
                        else if(orientA === 'landscape' && orientB === 'landscape') {
                            layout = 'vertical';
                        }
                        // Mieszane (jeden pionowy, drugi poziomy) → układ mieszany/kwadratowy
                        else if((orientA === 'portrait' && orientB === 'landscape') ||
                                (orientA === 'landscape' && orientB === 'portrait')) {
                            layout = 'mixed';
                        }
                        // Jeśli jeden jest kwadratowy, użyj orientacji drugiego
                        else if(orientA === 'square' && orientB !== 'square') {
                            layout = orientB === 'portrait' ? 'horizontal' : 'vertical';
                        }
                        else if(orientB === 'square' && orientA !== 'square') {
                            layout = orientA === 'portrait' ? 'horizontal' : 'vertical';
                        }
                        // Oba kwadratowe → układ pionowy (jeden pod drugim, domyślny)
                        else {
                            layout = 'vertical';
                        }
                        
                        // Na telefonie lub w orientacji pionowej urządzenia - sprawdź czy nie są oba pionowe
                        const isNarrow = typeof window !== 'undefined' && window.innerWidth <= 768;
                        const isPortrait = typeof window !== 'undefined' && window.matchMedia('(orientation: portrait)').matches;
                        // Jeśli oba zdjęcia są pionowe, zostaw layout horizontal (obok siebie) nawet na telefonie
                        // W przeciwnym razie wymuś układ pionowy na telefonie
                        if ((isNarrow || isPortrait) && layout !== 'horizontal') {
                            layout = 'vertical';
                        }
                        
                        console.log('🖼️ HOT_OR_NOT vote.html - wybrany layout:', layout);
                        grid.classList.add('hot-or-not-grid', `layout-${layout}`);
                        
                        // Popraw ścieżki obrazków
                        let fullImageASrc = (imageASrc && imageASrc.trim() !== '') ? imageASrc.trim() : '';
                        let fullImageBSrc = (imageBSrc && imageBSrc.trim() !== '') ? imageBSrc.trim() : '';
                        
                        console.log('🖼️ HOT_OR_NOT vote.html - surowe ścieżki:', {
                            'imageASrc': imageASrc,
                            'imageBSrc': imageBSrc,
                            'question.imageSmallA': question.imageSmallA,
                            'question.imageA': question.imageA,
                            'question.imageSmallB': question.imageSmallB,
                            'question.imageB': question.imageB
                        });
                        
                        if(fullImageASrc && fullImageASrc.trim() !== '') {
                            if (!fullImageASrc.startsWith('/') && !fullImageASrc.startsWith('http')) {
                                fullImageASrc = '/uploads/' + fullImageASrc;
                            } else if (fullImageASrc.startsWith('/uploads/')) {
                                console.log('✅ vote.html imageA już ma prefiks /uploads/:', fullImageASrc);
                            }
                        }
                        if(fullImageBSrc && fullImageBSrc.trim() !== '') {
                            if (!fullImageBSrc.startsWith('/') && !fullImageBSrc.startsWith('http')) {
                                fullImageBSrc = '/uploads/' + fullImageBSrc;
                            } else if (fullImageBSrc.startsWith('/uploads/')) {
                                console.log('✅ vote.html imageB już ma prefiks /uploads/:', fullImageBSrc);
                            }
                        }
                        
                        console.log('🖼️ HOT_OR_NOT vote.html - finalne ścieżki:', {
                            'A': fullImageASrc,
                            'B': fullImageBSrc,
                            'A empty': !fullImageASrc || fullImageASrc.trim() === '',
                            'B empty': !fullImageBSrc || fullImageBSrc.trim() === '',
                            'A startsWith /uploads/': fullImageASrc ? fullImageASrc.startsWith('/uploads/') : false,
                            'B startsWith /uploads/': fullImageBSrc ? fullImageBSrc.startsWith('/uploads/') : false
                        });
                        
                        // Renderuj obrazki - tylko img, bez dodatkowych divów obok
                        const imgAHTML = fullImageASrc && fullImageASrc.trim() !== '' ? 
                            `<img src="${fullImageASrc}" alt="Opcja A" onerror="console.error('❌ Błąd ładowania obrazka A:', this.src); this.style.display='none'; const parent = this.parentElement; if(parent && !parent.querySelector('.no-image-placeholder')) { const placeholder = document.createElement('div'); placeholder.className = 'no-image-placeholder'; placeholder.style.cssText = 'display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; color: rgba(255,255,255,0.5); font-size: clamp(0.9rem, 3vw, 1.2rem); position: absolute; top: 0; left: 0;'; placeholder.textContent = 'Brak obrazka'; parent.appendChild(placeholder); }" onload="console.log('✅ Obrazek A załadowany:', this.src); const placeholder = this.parentElement?.querySelector('.no-image-placeholder'); if(placeholder) placeholder.remove();">` : 
                            `<div class="no-image-placeholder" style="display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; color: rgba(255,255,255,0.5); font-size: clamp(0.9rem, 3vw, 1.2rem); position: absolute; top: 0; left: 0;">Brak obrazka</div>`;
                        
                        const imgBHTML = fullImageBSrc && fullImageBSrc.trim() !== '' ? 
                            `<img src="${fullImageBSrc}" alt="Opcja B" onerror="console.error('❌ Błąd ładowania obrazka B:', this.src); this.style.display='none'; const parent = this.parentElement; if(parent && !parent.querySelector('.no-image-placeholder')) { const placeholder = document.createElement('div'); placeholder.className = 'no-image-placeholder'; placeholder.style.cssText = 'display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; color: rgba(255,255,255,0.5); font-size: clamp(0.9rem, 3vw, 1.2rem); position: absolute; top: 0; left: 0;'; placeholder.textContent = 'Brak obrazka'; parent.appendChild(placeholder); }" onload="console.log('✅ Obrazek B załadowany:', this.src); const placeholder = this.parentElement?.querySelector('.no-image-placeholder'); if(placeholder) placeholder.remove();">` : 
                            `<div class="no-image-placeholder" style="display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; color: rgba(255,255,255,0.5); font-size: clamp(0.9rem, 3vw, 1.2rem); position: absolute; top: 0; left: 0;">Brak obrazka</div>`;
                        
                        const cardA = document.createElement('div');
                        cardA.className = 'hot-image-card hot-card-a';
                        // WAŻNE: Upewnij się że karta nie jest zablokowana
                        cardA.classList.remove('answer-locked');
                        cardA.style.pointerEvents = '';
                        cardA.style.cursor = 'pointer';
                        cardA.innerHTML = `
                            <div class="hot-image-label">A</div>
                            <div class="hot-image-wrapper">
                                ${imgAHTML}
                            </div>
                            <div class="hot-image-answer">${answers[0] || 'Opcja A'}</div>
                        `;
                        cardA.onclick = () => sendAnswer(0, cardA);
                        
                        const cardB = document.createElement('div');
                        cardB.className = 'hot-image-card hot-card-b';
                        // WAŻNE: Upewnij się że karta nie jest zablokowana
                        cardB.classList.remove('answer-locked');
                        cardB.style.pointerEvents = '';
                        cardB.style.cursor = 'pointer';
                        cardB.innerHTML = `
                            <div class="hot-image-label">B</div>
                            <div class="hot-image-wrapper">
                                ${imgBHTML}
                            </div>
                            <div class="hot-image-answer">${answers[1] || 'Opcja B'}</div>
                        `;
                        cardB.onclick = () => sendAnswer(1, cardB);
                        
                        grid.appendChild(cardA);
                        grid.appendChild(cardB);
                    });
                });
            } else if (question.type === 'ESTIMATION') {
                // Szacowanie – gracz wpisuje liczbę (suwak + pole); opcjonalnie z obrazkiem
                votingScreen.classList.remove('hot-or-not-mode');
                let imgSrc = (question.imageSmall && question.imageSmall.trim() !== '') ? question.imageSmall : (question.image && question.image.trim() !== '') ? question.image : (question.media && question.media.trim() !== '') ? question.media : '';
                if (imgSrc && imgSrc.trim() !== '') {
                    if (!imgSrc.startsWith('/') && !imgSrc.startsWith('http')) imgSrc = '/uploads/' + imgSrc;
                    heroContainer.style.setProperty('display', 'block', 'important');
                    heroContainer.style.setProperty('visibility', 'visible', 'important');
                    heroContainer.style.setProperty('opacity', '1', 'important');
                    heroContainer.style.setProperty('height', 'auto', 'important');
                    heroContainer.style.setProperty('width', 'auto', 'important');
                    heroContainer.style.setProperty('position', 'static', 'important');
                    heroContainer.style.setProperty('left', 'auto', 'important');
                    // Wymuś przeładowanie obrazka (dodaj timestamp aby uniknąć cache)
                    const imgUrl = new URL(imgSrc, window.location.origin);
                    imgUrl.searchParams.set('_t', Date.now());
                    heroImg.onerror = function() {
                        console.warn('⚠️ Nie można załadować obrazka dla ESTIMATION:', imgSrc);
                        // Spróbuj bez cache bustera
                        heroImg.src = imgSrc;
                    };
                    heroImg.onload = function() {
                        heroImg.onerror = null; // Usuń handler po załadowaniu
                    };
                    heroImg.src = imgUrl.toString();
                    votingScreen.classList.remove('no-image');
                } else {
                    heroContainer.style.display = 'none';
                    heroImg.src = '';
                    votingScreen.classList.add('no-image');
                }
                const qTextEl = document.getElementById('question-text');
                // WAŻNE: NIE nadpisuj question-text jeśli dogrywka jest aktywna
                const isPlayoffActive = currentGameState && currentGameState.playoff && currentGameState.playoff.active;
                const hasPlayoffAttr = qTextEl && qTextEl.getAttribute('data-playoff-active') === 'true';
                if (!isPlayoffActive && !hasPlayoffAttr) {
                    qTextEl.innerHTML = (question.question || 'Wpisz liczbę...').replace(/\n/g, '<br>');
                } else {
                    console.log('📝 showVotingScreen ESTIMATION - POMIJAM nadpisanie (dogrywka aktywna)');
                }
                qTextEl.classList.remove('multi-line', 'two-lines', 'three-lines');
                const min = Number(question.min) || 0;
                const max = Number(question.max) ?? 100;
                const mid = Math.round((min + max) / 2);
                const step = (max - min) <= 200 ? 1 : Math.max(1, Math.floor((max - min) / 200));
                grid.classList.remove('list-mode', 'hot-or-not-grid');
                grid.innerHTML = `
                    <div class="estimation-ui">
                        <input type="range" id="estimation-slider" min="${min}" max="${max}" step="${step}" value="${mid}">
                        <input type="number" id="estimation-number" min="${min}" max="${max}" value="${mid}" inputmode="numeric">
                        <button type="button" class="answer-btn est-submit-btn" id="estimation-submit">Potwierdź</button>
                    </div>
                `;
                const slider = document.getElementById('estimation-slider');
                const numberInput = document.getElementById('estimation-number');
                const submitBtn = document.getElementById('estimation-submit');
                
                // WAŻNE: Upewnij się że pola nie są zablokowane
                if (slider) {
                    slider.removeAttribute('disabled');
                    slider.style.pointerEvents = '';
                }
                if (numberInput) {
                    numberInput.removeAttribute('readonly');
                    numberInput.disabled = false;
                    numberInput.style.pointerEvents = '';
                }
                if (submitBtn) {
                    submitBtn.classList.remove('answer-locked');
                    submitBtn.disabled = false;
                    submitBtn.style.pointerEvents = '';
                    submitBtn.style.cursor = 'pointer';
                }
                
                function syncFromSlider() { numberInput.value = slider.value; }
                function syncFromNumber() {
                    let v = parseFloat(numberInput.value);
                    if (!Number.isNaN(v)) { v = Math.max(min, Math.min(max, v)); numberInput.value = v; slider.value = v; }
                }
                slider.addEventListener('input', syncFromSlider);
                numberInput.addEventListener('input', syncFromNumber);
                numberInput.addEventListener('change', syncFromNumber);
                submitBtn.onclick = () => {
                    const v = parseFloat(numberInput.value);
                    if (!Number.isNaN(v) && v >= min && v <= max) sendEstimationAnswer(v);
                };
            } else if (question.type === 'OPEN') {
                // WAŻNE: Sprawdź czy dogrywka nie jest aktywna - jeśli tak, nie pokazuj pytania otwartego
                console.log('🎤 showVotingScreen dla OPEN - sprawdzam dogrywkę:', {
                    currentGameStateExists: !!currentGameState,
                    playoffExists: !!(currentGameState && currentGameState.playoff),
                    playoffActive: !!(currentGameState && currentGameState.playoff && currentGameState.playoff.active)
                });
                
                if (currentGameState && currentGameState.playoff && currentGameState.playoff.active) {
                    console.log('🎤 ✅ Dogrywka aktywna podczas showVotingScreen dla OPEN - pomijam renderowanie pytania otwartego, wywołuję showPlayoffScreen');
                    // UKRYJ OBRAZEK NATYCHMIAST - nawet jeśli został już ustawiony
                    if (heroContainer) {
                        heroContainer.style.setProperty('display', 'none', 'important');
                        heroContainer.style.setProperty('visibility', 'hidden', 'important');
                        heroContainer.style.setProperty('opacity', '0', 'important');
                        heroContainer.style.setProperty('height', '0', 'important');
                        heroContainer.style.setProperty('width', '0', 'important');
                        heroContainer.style.setProperty('position', 'absolute', 'important');
                        heroContainer.style.setProperty('left', '-9999px', 'important');
                    }
                    if (heroImg) {
                        heroImg.src = '';
                        heroImg.style.setProperty('display', 'none', 'important');
                        heroImg.removeAttribute('src');
                    }
                    const questionHeader = document.querySelector('.question-header');
                    if (questionHeader) {
                        questionHeader.style.setProperty('display', 'none', 'important');
                        questionHeader.style.setProperty('visibility', 'hidden', 'important');
                        questionHeader.style.setProperty('opacity', '0', 'important');
                        questionHeader.style.setProperty('height', '0', 'important');
                        questionHeader.style.setProperty('position', 'absolute', 'important');
                        questionHeader.style.setProperty('left', '-9999px', 'important');
                    }
                    votingScreen.classList.add('no-image');
                    votingScreen.classList.add('playoff-mode');
                    // Wywołaj showPlayoffScreen zamiast renderować pytanie otwarte
                    showPlayoffScreen(currentGameState.playoff);
                    return;
                }
                
                // Pytanie otwarte – gracz wpisuje tekst (np. gatunek muzyki); opcjonalnie z obrazkiem
                votingScreen.classList.remove('hot-or-not-mode');
                let imgSrc = (question.imageSmall && question.imageSmall.trim() !== '') ? question.imageSmall : (question.image && question.image.trim() !== '') ? question.image : (question.media && question.media.trim() !== '') ? question.media : '';
                if (imgSrc && imgSrc.trim() !== '') {
                    if (!imgSrc.startsWith('/') && !imgSrc.startsWith('http')) imgSrc = '/uploads/' + imgSrc;
                    heroContainer.style.display = 'block';
                    heroImg.src = imgSrc;
                    votingScreen.classList.remove('no-image');
                } else {
                    heroContainer.style.display = 'none';
                    heroImg.src = '';
                    votingScreen.classList.add('no-image');
                }
                // WAŻNE: NIE renderuj pytania otwartego jeśli dogrywka jest aktywna (powinno być już obsłużone wyżej, ale na wszelki wypadek)
                if (currentGameState && currentGameState.playoff && currentGameState.playoff.active) {
                    console.log('🎤 Dogrywka aktywna - pomijam renderowanie open-question-ui');
                    return;
                }
                
                const qTextEl = document.getElementById('question-text');
                // WAŻNE: NIE nadpisuj question-text jeśli dogrywka jest aktywna lub ma atrybut data-playoff-active
                const isPlayoffActive = currentGameState && currentGameState.playoff && currentGameState.playoff.active;
                const hasPlayoffAttr = qTextEl && qTextEl.getAttribute('data-playoff-active') === 'true';
                console.log('📝 showVotingScreen OPEN - isPlayoffActive:', isPlayoffActive, 'hasPlayoffAttr:', hasPlayoffAttr);
                if (!isPlayoffActive && !hasPlayoffAttr) {
                    console.log('📝 showVotingScreen OPEN - nadpisuję tekst pytania:', question.question);
                    qTextEl.innerHTML = (question.question || 'Wpisz odpowiedź...').replace(/\n/g, '<br>');
                    qTextEl.classList.remove('multi-line', 'two-lines', 'three-lines');
                    qTextEl.removeAttribute('data-playoff-active');
                } else {
                    console.log('📝 showVotingScreen OPEN - POMIJAM nadpisanie (dogrywka aktywna lub atrybut)');
                    // Jeśli dogrywka jest aktywna, upewnij się że słowo dogrywki i napis DOGRYWKA są ustawione - styl jak normalne pytania
                    if (isPlayoffActive && qTextEl && qTextEl.getAttribute('data-playoff-active') !== 'true') {
                        const playoffWord = currentGameState.playoff?.word || '';
                        console.log('📝 showVotingScreen OPEN - Przywracam słowo dogrywki i napis DOGRYWKA:', playoffWord);
                        qTextEl.innerHTML = `
                            <div class="playoff-word" style="text-align: center; width: 100%; display: block; margin: 0 auto 10px auto;">${playoffWord}</div>
                            <div class="playoff-title-pulse" style="text-align: center; width: 100%; display: block; margin: 0 auto;">🎤 DOGRYWKA</div>
                        `;
                        qTextEl.style.setProperty('text-align', 'center', 'important');
                        qTextEl.style.setProperty('width', '100%', 'important');
                        qTextEl.setAttribute('data-playoff-active', 'true');
                    }
                }
                grid.classList.remove('list-mode', 'hot-or-not-grid', 'playoff-mode');
                grid.innerHTML = `
                    <div class="open-question-ui">
                        <div style="position: relative;">
                            <input type="text" id="open-answer-input" placeholder="np. rock, techno..." maxlength="80" autocomplete="off">
                            <div id="open-answer-warning" class="profanity-warning" style="display: none;">Niedozwolone słowo</div>
                        </div>
                        <button type="button" class="answer-btn open-submit-btn" id="open-submit">Wyślij</button>
                    </div>
                `;
                const openInput = document.getElementById('open-answer-input');
                const openSubmit = document.getElementById('open-submit');
                const openAnswerWarning = document.getElementById('open-answer-warning');
                
                // WAŻNE: Upewnij się że pola nie są zablokowane
                if (openInput) {
                    openInput.removeAttribute('readonly');
                    openInput.disabled = false;
                    openInput.style.pointerEvents = '';
                }
                if (openSubmit) {
                    openSubmit.classList.remove('answer-locked');
                    openSubmit.disabled = false;
                    openSubmit.style.pointerEvents = '';
                    openSubmit.style.cursor = 'pointer';
                }
                
                // Inicjalizacja filtra niecenzuralnych słów dla pola odpowiedzi otwartej
                if (openInput) {
                    const initOpenFilter = () => {
                        if (window.ProfanityFilter) {
                            window.ProfanityFilter.setupProfanityFilter(
                                openInput,
                                () => {
                                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                                },
                                openAnswerWarning,
                                'Niedozwolone słowo'
                            );
                        } else {
                            setTimeout(initOpenFilter, 100);
                        }
                    };
                    initOpenFilter();
                }
                
                openSubmit.onclick = () => {
                    const t = (openInput && openInput.value) ? openInput.value.trim() : '';
                    if (t) sendOpenAnswer(t);
                };
                openInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') openSubmit.click(); });
            } else if (question.type === 'LETTER') {
                // Pytanie z literą – gracz wpisuje wyraz zaczynający się na przypisaną literę
                // WAŻNE: Sprawdź czy dogrywka nie jest aktywna - jeśli tak, nie pokazuj pytania z literą
                if (currentGameState && currentGameState.playoff && currentGameState.playoff.active) {
                    console.log('🔤 ✅ Dogrywka aktywna podczas showVotingScreen dla LETTER - pomijam renderowanie, wywołuję showPlayoffScreen');
                    votingScreen.classList.remove('hot-or-not-mode');
                    votingScreen.classList.add('no-image');
                    votingScreen.classList.add('playoff-mode');
                    showPlayoffScreen(currentGameState.playoff);
                    return;
                }
                
                votingScreen.classList.remove('hot-or-not-mode');
                let imgSrc = (question.imageSmall && question.imageSmall.trim() !== '') ? question.imageSmall : (question.image && question.image.trim() !== '') ? question.image : (question.media && question.media.trim() !== '') ? question.media : '';
                if (imgSrc && imgSrc.trim() !== '') {
                    if (!imgSrc.startsWith('/') && !imgSrc.startsWith('http')) imgSrc = '/uploads/' + imgSrc;
                    heroContainer.style.display = 'block';
                    heroImg.src = imgSrc;
                    votingScreen.classList.remove('no-image');
                } else {
                    heroContainer.style.display = 'none';
                    heroImg.src = '';
                    votingScreen.classList.add('no-image');
                }
                
                const qTextEl = document.getElementById('question-text');
                const isPlayoffActive = currentGameState && currentGameState.playoff && currentGameState.playoff.active;
                const hasPlayoffAttr = qTextEl && qTextEl.getAttribute('data-playoff-active') === 'true';
                if (!isPlayoffActive && !hasPlayoffAttr) {
                    qTextEl.innerHTML = (question.question || 'Wpisz wyraz zaczynający się na literę...').replace(/\n/g, '<br>');
                    qTextEl.classList.remove('multi-line', 'two-lines', 'three-lines');
                    qTextEl.removeAttribute('data-playoff-active');
                }
                
                // Pobierz litery dla tego gracza z gameState
                const letterGame = (currentGameState && currentGameState.letterGame && currentGameState.letterGame.questionId === question.id)
                    ? currentGameState.letterGame : null;
                const letterCount = letterGame ? (letterGame.letterCount || 1) : 1;
                const playerLetters = (letterGame && letterGame.playerLetters)
                    ? letterGame.playerLetters[socket.id] : [];

                // Logi: połączenie 1/2 litery -> vote (czego brakuje)
                if (question.type === 'LETTER') {
                    if (letterGame && letterGame.gameStarted && playerLetters && playerLetters.length > 0) {
                        console.log('🔤 [LETTER vote] OK: letterGame otrzymany, gameStarted=true, playerLetters=', playerLetters);
                    } else {
                        const missing = [];
                        if (!currentGameState) missing.push('brak currentGameState');
                        else if (!currentGameState.letterGame) missing.push('brak state.letterGame');
                        else if (currentGameState.letterGame.questionId !== question.id) missing.push('letterGame.questionId!==question.id');
                        else if (!letterGame.gameStarted) missing.push('letterGame.gameStarted=false');
                        else if (!playerLetters || playerLetters.length === 0) missing.push('brak playerLetters dla socket.id');
                        console.log('🔤 [LETTER vote] Oczekiwanie na litery – czego brakuje:', missing.join(', '), '| state.letterGame=', currentGameState?.letterGame);
                    }
                }

                // WAŻNE: Sprawdź czy dogrywka jest aktywna - jeśli tak, nie pokazuj pytania z literą
                // isPlayoffActive jest już zadeklarowane wyżej (linia 5315)
                if (isPlayoffActive) {
                    console.log('🎤 Pytanie z literą - dogrywka aktywna, pomijam renderowanie pytania z literą');
                    return; // showPlayoffScreen zostanie wywołane gdzie indziej
                }
                
                // Jeśli gra jeszcze się nie rozpoczęła (brak liter), pokaż komunikat oczekiwania
                if (!letterGame || !letterGame.gameStarted || !playerLetters || playerLetters.length === 0) {
                    grid.classList.remove('list-mode', 'hot-or-not-grid', 'playoff-mode');
                    grid.innerHTML = `
                        <div class="letter-question-ui" style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 1.5em; color: #9c27b0; margin-bottom: 20px; font-weight: bold;">🔤 Oczekiwanie na litery...</div>
                            <div style="color: rgba(255,255,255,0.7);">Za chwilę otrzymasz literę(y), na którą(e) musisz wpisać wyraz</div>
                        </div>
                    `;
                    return;
                }
                
                grid.classList.remove('list-mode', 'hot-or-not-grid', 'playoff-mode');
                
                if (letterCount === 1) {
                    // 1 litera - jedno pole tekstowe
                    const letter = playerLetters[0].toUpperCase();
                    grid.innerHTML = `
                        <div class="letter-question-ui" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; max-width: 100%; margin: 0 auto; gap: 15px;">
                            <div style="position: relative; width: 100%; max-width: 400px;">
                                <div style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 1.5em; font-weight: bold; color: #9c27b0; pointer-events: none; z-index: 10;">${letter}</div>
                                <input type="text" id="letter-answer-input-1" placeholder="wpisz wyraz..." maxlength="80" autocomplete="off" style="padding-left: 50px; width: 100%;">
                                <div id="letter-answer-warning-1" class="profanity-warning" style="display: none;">Niedozwolone słowo</div>
                            </div>
                            <button type="button" class="answer-btn letter-submit-btn" id="letter-submit" style="text-align: center;">Wyślij</button>
                            <div id="letter-sent-msg" class="letter-sent-msg">Wysłano</div>
                        </div>
                    `;
                    
                    const letterInput1 = document.getElementById('letter-answer-input-1');
                    const letterSubmit = document.getElementById('letter-submit');
                    const letterWarning1 = document.getElementById('letter-answer-warning-1');
                    
                    // WAŻNE: Upewnij się że pola nie są zablokowane
                    if (letterInput1) {
                        letterInput1.removeAttribute('readonly');
                        letterInput1.disabled = false;
                        letterInput1.style.pointerEvents = '';
                    }
                    if (letterSubmit) {
                        letterSubmit.classList.remove('answer-locked');
                        letterSubmit.disabled = false;
                        letterSubmit.style.pointerEvents = '';
                        letterSubmit.style.cursor = 'pointer';
                        letterSubmit.textContent = 'Wyślij';
                    }
                    
                    // Cenzura
                    if (letterInput1) {
                        const initLetterFilter = () => {
                            if (window.ProfanityFilter) {
                                window.ProfanityFilter.setupProfanityFilter(
                                    letterInput1,
                                    () => {
                                        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                                    },
                                    letterWarning1,
                                    'Niedozwolone słowo'
                                );
                            } else {
                                setTimeout(initLetterFilter, 100);
                            }
                        };
                        initLetterFilter();
                    }
                    
                    // Walidacja: słowo musi zaczynać się na właściwą literę
                    letterInput1.addEventListener('input', function() {
                        const value = this.value.trim().toLowerCase();
                        const requiredLetter = playerLetters[0].toLowerCase();
                        if (value && !value.startsWith(requiredLetter)) {
                            this.style.borderColor = '#f44336';
                            this.style.color = '#f44336';
                        } else {
                            this.style.borderColor = '';
                            this.style.color = '';
                        }
                    });
                    
                    letterSubmit.onclick = () => {
                        const t = (letterInput1 && letterInput1.value) ? letterInput1.value.trim() : '';
                        if (t) {
                            const lowerT = t.toLowerCase();
                            const requiredLetter = playerLetters[0].toLowerCase();
                            if (lowerT.startsWith(requiredLetter)) {
                                sendLetterAnswer(t);
                            } else {
                                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                                alert(`Wyraz musi zaczynać się na literę ${playerLetters[0].toUpperCase()}`);
                            }
                        }
                    };
                    letterInput1.addEventListener('keydown', (e) => { if (e.key === 'Enter') letterSubmit.click(); });
                } else {
                    // 2 litery - dwa pola tekstowe
                    const letter1 = playerLetters[0].toUpperCase();
                    const letter2 = playerLetters[1].toUpperCase();
                    grid.innerHTML = `
                        <div class="letter-question-ui" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; max-width: 100%; margin: 0 auto; gap: 15px;">
                            <div style="position: relative; width: 100%; max-width: 400px;">
                                <div style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 1.5em; font-weight: bold; color: #9c27b0; pointer-events: none; z-index: 10;">${letter1}</div>
                                <input type="text" id="letter-answer-input-1" placeholder="wpisz wyraz..." maxlength="80" autocomplete="off" style="padding-left: 50px; width: 100%;">
                                <div id="letter-answer-warning-1" class="profanity-warning" style="display: none;">Niedozwolone słowo</div>
                            </div>
                            <div style="position: relative; width: 100%; max-width: 400px;">
                                <div style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 1.5em; font-weight: bold; color: #9c27b0; pointer-events: none; z-index: 10;">${letter2}</div>
                                <input type="text" id="letter-answer-input-2" placeholder="wpisz wyraz..." maxlength="80" autocomplete="off" style="padding-left: 50px; width: 100%;">
                                <div id="letter-answer-warning-2" class="profanity-warning" style="display: none;">Niedozwolone słowo</div>
                            </div>
                            <button type="button" class="answer-btn letter-submit-btn" id="letter-submit" style="text-align: center;">Wyślij</button>
                            <div id="letter-sent-msg" class="letter-sent-msg">Wysłano</div>
                        </div>
                    `;
                    
                    const letterInput1 = document.getElementById('letter-answer-input-1');
                    const letterInput2 = document.getElementById('letter-answer-input-2');
                    const letterSubmit = document.getElementById('letter-submit');
                    const letterWarning1 = document.getElementById('letter-answer-warning-1');
                    const letterWarning2 = document.getElementById('letter-answer-warning-2');
                    
                    // WAŻNE: Upewnij się że pola nie są zablokowane
                    if (letterInput1) {
                        letterInput1.removeAttribute('readonly');
                        letterInput1.disabled = false;
                        letterInput1.style.pointerEvents = '';
                    }
                    if (letterInput2) {
                        letterInput2.removeAttribute('readonly');
                        letterInput2.disabled = false;
                        letterInput2.style.pointerEvents = '';
                    }
                    if (letterSubmit) {
                        letterSubmit.classList.remove('answer-locked');
                        letterSubmit.disabled = false;
                        letterSubmit.style.pointerEvents = '';
                        letterSubmit.style.cursor = 'pointer';
                        letterSubmit.textContent = 'Wyślij';
                    }
                    
                    // Cenzura dla obu pól
                    [letterInput1, letterInput2].forEach((input, idx) => {
                        if (input) {
                            const initLetterFilter = () => {
                                if (window.ProfanityFilter) {
                                    window.ProfanityFilter.setupProfanityFilter(
                                        input,
                                        () => {
                                            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                                        },
                                        idx === 0 ? letterWarning1 : letterWarning2,
                                        'Niedozwolone słowo'
                                    );
                                } else {
                                    setTimeout(initLetterFilter, 100);
                                }
                            };
                            initLetterFilter();
                            
                            // Walidacja
                            input.addEventListener('input', function() {
                                const value = this.value.trim().toLowerCase();
                                const requiredLetter = playerLetters[idx].toLowerCase();
                                if (value && !value.startsWith(requiredLetter)) {
                                    this.style.borderColor = '#f44336';
                                    this.style.color = '#f44336';
                                } else {
                                    this.style.borderColor = '';
                                    this.style.color = '';
                                }
                            });
                        }
                    });
                    
                    letterSubmit.onclick = () => {
                        const t1 = (letterInput1 && letterInput1.value) ? letterInput1.value.trim() : '';
                        const t2 = (letterInput2 && letterInput2.value) ? letterInput2.value.trim() : '';
                        if (t1 && t2) {
                            const lowerT1 = t1.toLowerCase();
                            const lowerT2 = t2.toLowerCase();
                            const requiredLetter1 = playerLetters[0].toLowerCase();
                            const requiredLetter2 = playerLetters[1].toLowerCase();
                            if (lowerT1.startsWith(requiredLetter1) && lowerT2.startsWith(requiredLetter2)) {
                                sendLetterAnswer([t1, t2]);
                            } else {
                                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                                let msg = '';
                                if (!lowerT1.startsWith(requiredLetter1)) msg += `Pierwszy wyraz musi zaczynać się na literę ${playerLetters[0].toUpperCase()}. `;
                                if (!lowerT2.startsWith(requiredLetter2)) msg += `Drugi wyraz musi zaczynać się na literę ${playerLetters[1].toUpperCase()}.`;
                                alert(msg.trim());
                            }
                        }
                    };
                    letterInput1.addEventListener('keydown', (e) => { if (e.key === 'Enter') letterInput2.focus(); });
                    letterInput2.addEventListener('keydown', (e) => { if (e.key === 'Enter') letterSubmit.click(); });
                }
            } else if (question.type === 'SHIPS') {
                // Gra w Statki
                heroContainer.style.display = 'none';
                votingScreen.classList.remove('hot-or-not-mode', 'no-image');
                votingScreen.classList.add('ships-mode');
                
                const qTextEl = document.getElementById('question-text');
                qTextEl.innerHTML = (question.question || '⚓ Statki').replace(/\n/g, '<br>');
                qTextEl.classList.remove('multi-line', 'two-lines', 'three-lines');
                
                const boardSize = question.boardSize || 8;
                const ships = question.ships || [];
                
                grid.classList.remove('list-mode', 'hot-or-not-grid', 'playoff-mode');
                const questionId = question.id || Date.now();
                grid.innerHTML = `
                    <div class="ships-game-container" style="width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; padding: 10px; box-sizing: border-box;">
                        <div class="ships-round-info" style="text-align: center; margin-bottom: 15px; color: #00aaff; font-size: clamp(1.2rem, 4vw, 1.8rem); font-weight: bold; text-shadow: 0 0 20px rgba(0, 170, 255, 0.8); padding: 12px 20px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; border: 2px solid #00aaff; width: 100%; max-width: 400px; box-sizing: border-box;">Runda 1</div>
                        <div id="ships-board-container-${questionId}" class="ships-board-container" style="width: 100%; display: flex; justify-content: center; align-items: center; flex-shrink: 0;"></div>
                        <div id="ships-stats-container-${questionId}" class="ships-stats-container" style="display: none; width: 100%; max-width: 600px; margin: 0 auto; overflow-y: auto; max-height: 50vh;"></div>
                    </div>
                `;
                
                initShipsGame(question.id || Date.now(), boardSize, ships, question);
            } else {
                // Standardowy układ dla innych typów pytań
                votingScreen.classList.remove('hot-or-not-mode');
                
                // Dla pytań muzycznych dodaj specjalną klasę
                if(question.type === 'MUSIC') {
                    votingScreen.classList.add('music-mode');
                } else {
                    votingScreen.classList.remove('music-mode');
                }
                
                // Użyj imageSmall dla telefonu, fallback do image, potem media
                // Dla pytań muzycznych sprawdź też image/imageSmall (okładka albumu)
                let imgSrc = '';
                if(question.imageSmall && question.imageSmall.trim() !== '') {
                    imgSrc = question.imageSmall;
                } else if(question.image && question.image.trim() !== '') {
                    imgSrc = question.image;
                } else if(question.media && question.media.trim() !== '') {
                    // Dla pytań muzycznych media to audio, ale może być też obrazek
                    // Sprawdź czy to obrazek (rozszerzenie graficzne)
                    const mediaLower = question.media.toLowerCase();
                    if(question.type === 'MUSIC' && (mediaLower.endsWith('.jpg') || mediaLower.endsWith('.jpeg') || 
                        mediaLower.endsWith('.png') || mediaLower.endsWith('.webp') || mediaLower.endsWith('.gif'))) {
                        imgSrc = question.media;
                    } else if(question.type !== 'MUSIC') {
                        imgSrc = question.media;
                    }
                }
                
                console.log('🖼️ vote.html - imgSrc:', imgSrc, 'question.image:', question.image, 'question.media:', question.media);

                if (imgSrc && imgSrc.trim() !== '') {
                    // Popraw ścieżkę jeśli potrzeba
                    if (!imgSrc.startsWith('/') && !imgSrc.startsWith('http')) {
                        imgSrc = '/uploads/' + imgSrc;
                    }
                    
                    heroContainer.style.display = 'block';
                    heroImg.src = imgSrc;
                    votingScreen.classList.remove('no-image');
                    triggerHeroReveal();
                    console.log('✅ vote.html - wyświetlam obrazek:', imgSrc);
                } else {
                    heroContainer.style.display = 'none';
                    heroImg.src = '';
                    votingScreen.classList.add('no-image');
                    console.log('❌ vote.html - brak obrazka');
                }
                
                // Formatowanie pytania (ta sama logika co wyżej)
                const qTextEl = document.getElementById('question-text');
                const rawText = question.question || 'Pytanie...';
                
                qTextEl.classList.remove('multi-line', 'two-lines', 'three-lines');
                
                if(rawText.length > 0 && !rawText.includes('<br>')) {
                    const textLength = rawText.length;
                    let formattedText = rawText;
                    
                    if(textLength > 100) {
                        const third1 = Math.floor(textLength / 3);
                        const third2 = Math.floor(textLength * 2 / 3);
                        const space1 = rawText.lastIndexOf(' ', third1);
                        const space2 = rawText.lastIndexOf(' ', third2);
                        const space3 = rawText.indexOf(' ', third2);
                        let split1 = space1 > 0 ? space1 : third1;
                        let split2 = space2 > split1 ? space2 : (space3 > split1 ? space3 : third2);
                        
                        if(split1 > 0 && split2 > split1) {
                            formattedText = rawText.substring(0, split1) + '<br>' + 
                                           rawText.substring(split1 + 1, split2) + '<br>' + 
                                           rawText.substring(split2 + 1);
                            qTextEl.classList.add('multi-line', 'three-lines');
                        } else if(split1 > 0) {
                            formattedText = rawText.substring(0, split1) + '<br>' + rawText.substring(split1 + 1);
                            qTextEl.classList.add('multi-line', 'two-lines');
                        }
                    } else if(textLength > 60) {
                        const mid = Math.floor(textLength / 2);
                        const leftSpace = rawText.lastIndexOf(' ', mid);
                        const rightSpace = rawText.indexOf(' ', mid);
                        let splitIdx = -1;
                        if(leftSpace === -1) splitIdx = rightSpace;
                        else if(rightSpace === -1) splitIdx = leftSpace;
                        else splitIdx = (mid - leftSpace < rightSpace - mid) ? leftSpace : rightSpace;
                        if(splitIdx !== -1 && splitIdx > 0) {
                            formattedText = rawText.substring(0, splitIdx) + '<br>' + rawText.substring(splitIdx + 1);
                            qTextEl.classList.add('multi-line', 'two-lines');
                        }
                    }
                    qTextEl.innerHTML = formattedText;
                } else if(rawText.includes('<br>')) {
                    qTextEl.innerHTML = rawText;
                    const lineCount = (rawText.match(/<br>/g) || []).length + 1;
                    if(lineCount >= 3) qTextEl.classList.add('multi-line', 'three-lines');
                    else if(lineCount === 2) qTextEl.classList.add('multi-line', 'two-lines');
                } else {
                    qTextEl.innerText = rawText;
                }
                triggerQuestionReveal();
                
                const letters = ['A', 'B', 'C', 'D', 'E'];
                const colors = ['ans-a', 'ans-b', 'ans-c', 'ans-d', 'ans-e'];
                const answers = question.answers || [];
                
                // Tryb listy dla więcej niż 4 odpowiedzi (ale nie dla pytań muzycznych)
                if(answers.length > 4 && question.type !== 'MUSIC') {
                    grid.classList.add('list-mode');
                } else {
                    grid.classList.remove('list-mode');
                    // Dla pytań muzycznych zawsze układ 2 kolumny (jak QUIZ)
                    if(question.type === 'MUSIC') {
                        grid.style.gridTemplateColumns = '1fr 1fr';
                        grid.style.gridTemplateRows = '';
                    } else {
                        // Zawsze układ poziomy (2 kolumny) dla 2-4 odpowiedzi
                        grid.style.gridTemplateColumns = '1fr 1fr';
                    }
                }
                
                const limit = (question.type === 'VOTE' || question.type === 'VOTE_IMG') ? 2 : answers.length;
                
                for (let i = 0; i < limit && i < 5; i++) {
                    if (!answers[i]) continue;
                    
                    const btn = document.createElement('button');
                    btn.className = `answer-btn ${colors[i]}`;
                    // WAŻNE: Upewnij się że przycisk nie jest zablokowany
                    btn.classList.remove('answer-locked');
                    btn.style.pointerEvents = '';
                    btn.style.cursor = 'pointer';
                    btn.disabled = false;
                    btn.innerHTML = `
                        <div class="answer-letter">${letters[i]}</div>
                        <div class="answer-text">${answers[i]}</div>
                    `;
                    btn.onclick = () => sendAnswer(i, btn);
                    grid.appendChild(btn);
                }
                // Wymuszenie przeliczenia layoutu po zmianie treści – zapobiega „starej wersji” kafelków do obrotu ekranu
                requestAnimationFrame(() => { void grid.offsetHeight; });
            }

            // Start timera - NIE dla pytań typu SHIPS (gra w statki nie ma limitu czasu)
            if (question.type !== 'SHIPS') {
                startTimer(timeLeft);
            } else {
                // Dla pytań SHIPS ukryj timer i zatrzymaj wszystkie dźwięki
                stopTimer();
                const timerBadge = document.getElementById('timer-badge');
                if (timerBadge) timerBadge.style.display = 'none';
            }
            updateEliminatedOverlay();
        }

        // === OVERLAY WYELIMINOWANEGO ===
        function updateEliminatedOverlay() {
            const overlay = document.getElementById('eliminated-overlay');
            const grid = document.getElementById('answers-grid');
            if (!overlay) return;
            
            // WAŻNE: W dogrywce nie blokuj przycisków nawet jeśli gracz jest wyeliminowany
            const isPlayoff = currentGameState && currentGameState.playoff && currentGameState.playoff.active;
            
            if (playerEliminated && !isPlayoff) {
                overlay.style.display = 'flex';
                if (grid) grid.style.pointerEvents = 'none';
                document.querySelectorAll('.answer-btn, .hot-image-card').forEach(el => { 
                    // Nie blokuj przycisków dogrywki
                    if (!el.closest('.playoff-ui')) {
                        el.style.pointerEvents = 'none'; 
                        el.classList.add('answer-locked'); 
                    }
                });
            } else {
                overlay.style.display = 'none';
                if (grid) grid.style.pointerEvents = '';
                // Upewnij się że przyciski dogrywki są klikalne
                document.querySelectorAll('.playoff-ui .answer-btn').forEach(el => { 
                    el.style.pointerEvents = 'auto';
                    el.style.cursor = 'pointer';
                });
                document.querySelectorAll('.answer-btn, .hot-image-card').forEach(el => { 
                    if (!el.closest('.playoff-ui')) {
                        el.style.pointerEvents = ''; 
                    }
                });
            }
        }

        // === GRA W STATKI ===
        let shipsGameState = {
            questionId: null,
            boardSize: 8,
            ships: [],
            shots: {}, // { "r_c": { hit: bool, players: [] } }
            currentTurn: 0,
            hasShotThisTurn: false,
            gameEnded: false
        };
        
        // Globalny handler dla aktualizacji stanu statków (działa dla wszystkich pytań)
        socket.on('ships_game_update', (data) => {
            if (shipsGameState.questionId === data.questionId) {
                console.log('🎯 ships_game_update:', { 
                    questionId: data.questionId, 
                    currentTurn: data.currentTurn, 
                    hasShotThisTurn: data.hasShotThisTurn,
                    showStats: data.showStats,
                    showCorrect: data.showCorrect,
                    shotsCount: Object.keys(data.shots || {}).length
                });
                
                shipsGameState.shots = data.shots || {};
                shipsGameState.currentTurn = data.currentTurn || 0;
                shipsGameState.hasShotThisTurn = data.hasShotThisTurn || false;
                shipsGameState.gameEnded = data.gameEnded || false;
                
                // WAŻNE: Aktualizuj również currentGameState jeśli showStats/showCorrect są w danych
                // To zapewnia że klient wie o stanie rundy nawet przed otrzymaniem update_state
                if (currentGameState) {
                    if (data.showStats !== undefined) {
                        currentGameState.showStats = data.showStats;
                    }
                    if (data.showCorrect !== undefined) {
                        currentGameState.showCorrect = data.showCorrect;
                    }
                }
                
                // Aktualizuj planszę tylko jeśli jest aktywna
                if (shipsGameState.questionId) {
                    // WAŻNE: Re-renderuj planszę aby zaktualizować stan strzałów
                    updateShipsBoard(shipsGameState.questionId);
                    // Aktualizuj też numer rundy w nagłówku
                    updateShipsRoundInfo(shipsGameState.questionId);
                    
                    // Jeśli showStats zmieniło się na false, ukryj statystyki
                    if (data.showStats === false) {
                        const statsContainer = document.getElementById(`ships-stats-container-${shipsGameState.questionId}`);
                        if (statsContainer) statsContainer.style.display = 'none';
                    }
                }
            }
        });
        
        function updateShipsRoundInfo(questionId) {
            const roundInfo = document.querySelector(`#ships-board-container-${questionId}`)?.parentElement?.querySelector('.ships-round-info');
            if (roundInfo) {
                const roundNumber = (shipsGameState.currentTurn || 0) + 1;
                const showStatsValue = currentGameState ? currentGameState.showStats : false;
                console.log('🎯 updateShipsRoundInfo:', {
                    questionId: questionId,
                    currentTurn: shipsGameState.currentTurn,
                    roundNumber: roundNumber,
                    showStats: showStatsValue
                });
                const roundColor = showStatsValue ? '#ffcc00' : '#00aaff';
                roundInfo.style.color = roundColor;
                roundInfo.style.borderColor = roundColor;
                roundInfo.textContent = showStatsValue ? `Runda ${roundNumber} zakończona` : `Runda ${roundNumber}`;
            }
        }

        function initShipsGame(questionId, boardSize, ships, question) {
            shipsGameState = {
                questionId: questionId,
                boardSize: boardSize,
                ships: ships,
                shots: {},
                currentTurn: 0,
                hasShotThisTurn: false,
                gameEnded: false
            };
            
            renderShipsBoard(questionId);
            
            // Nasłuchuj aktualizacji stanu gry tylko dla tego pytania SHIPS
            const stateUpdateHandler = (state) => {
                if (state.activeQuestion && state.activeQuestion.type === 'SHIPS' && state.activeQuestion.id === questionId) {
                    console.log('🎯 vote.html stateUpdateHandler dla SHIPS:', {
                        questionId: questionId,
                        hasShipsGame: !!state.shipsGame,
                        currentTurn: state.shipsGame?.currentTurn,
                        showStats: state.showStats
                    });
                    if (state.shipsGame && state.shipsGame.questionId === questionId) {
                        const oldTurn = shipsGameState.currentTurn;
                        shipsGameState.shots = state.shipsGame.shots || {};
                        shipsGameState.currentTurn = state.shipsGame.currentTurn !== undefined ? state.shipsGame.currentTurn : 0;
                        // Sprawdź czy gracz już strzelił w tej turze (z Array playersShot)
                        shipsGameState.hasShotThisTurn = state.shipsGame.playersShot && Array.isArray(state.shipsGame.playersShot) && state.shipsGame.playersShot.includes(socket.id);
                        shipsGameState.gameEnded = state.shipsGame.gameEnded || false;
                        
                        console.log('🎯 vote.html - zaktualizowano shipsGameState:', {
                            oldTurn: oldTurn,
                            newTurn: shipsGameState.currentTurn,
                            showStats: state.showStats,
                            showCorrect: state.showCorrect,
                            hasShotThisTurn: shipsGameState.hasShotThisTurn
                        });
                        
                        // WAŻNE: Aktualizuj currentGameState.showStats/showCorrect
                        if (currentGameState) {
                            currentGameState.showStats = state.showStats || false;
                            currentGameState.showCorrect = state.showCorrect || false;
                        }
                        
                        // Zawsze aktualizuj planszę i numer rundy
                        updateShipsBoard(questionId);
                        updateShipsRoundInfo(questionId);
                        
                        if (state.showStats) {
                            renderShipsStats(questionId, state);
                        } else {
                            // Ukryj statystyki jeśli showStats = false
                            const statsContainer = document.getElementById(`ships-stats-container-${questionId}`);
                            if (statsContainer) statsContainer.style.display = 'none';
                        }
                        if (state.showCorrect) {
                            renderShipsAnswer(questionId, state);
                        }
                    } else {
                        console.warn('⚠️ vote.html stateUpdateHandler - brak state.shipsGame lub złe questionId');
                    }
                }
            };
            
            // Usuń stare listenery jeśli istnieją (aby uniknąć duplikatów)
            socket.off('update_state', stateUpdateHandler);
            socket.on('update_state', stateUpdateHandler);
            
            // Wywołaj od razu jeśli stan jest już dostępny
            if (currentGameState && currentGameState.activeQuestion && currentGameState.activeQuestion.type === 'SHIPS' && currentGameState.activeQuestion.id === questionId) {
                stateUpdateHandler(currentGameState);
            }
        }

        function renderShipsBoard(questionId) {
            const container = document.getElementById(`ships-board-container-${questionId}`);
            if (!container) return;
            
            const LETTERS = ['A','B','C','D','E','F','G','H','I','J'];
            const boardSize = shipsGameState.boardSize;
            
            // Poprawione skalowanie - dopasuj do dostępnej szerokości ekranu telefonu
            const containerWidth = container.offsetWidth || window.innerWidth - 40; // Uwzględnij padding
            const maxCellSize = Math.min(Math.floor(containerWidth / (boardSize + 1)), 35);
            const cellSize = Math.max(20, maxCellSize); // Minimalny rozmiar 20px
            
            const currentTurn = shipsGameState.currentTurn || 0;
            const roundNumber = currentTurn + 1; // Runda 1, 2, 3...
            
            console.log('🎯 renderShipsBoard vote.html - currentTurn:', currentTurn, 'roundNumber:', roundNumber, 'shipsGameState:', shipsGameState);
            
            // Dodaj nagłówek z numerem rundy (tylko jeśli nie ma już w kontenerze)
            const roundInfo = container.parentElement?.querySelector('.ships-round-info');
            if (roundInfo) {
                const showStatsValue = currentGameState ? currentGameState.showStats : false;
                const roundColor = showStatsValue ? '#ffcc00' : '#00aaff';
                roundInfo.textContent = showStatsValue ? `Runda ${roundNumber} zakończona` : `Runda ${roundNumber}`;
                roundInfo.style.color = roundColor;
                roundInfo.style.borderColor = roundColor;
            }
            
            let html = '';
            html += `<table class="ships-board-table" style="border-collapse: collapse; border: 2px solid #0066cc; background: #000; margin: 0 auto; width: ${(boardSize + 1) * cellSize}px;">`;
            
            // Nagłówek kolumn
            html += `<tr><th style="width: ${cellSize}px; height: ${cellSize}px; border: 1px solid #0066cc; color: #00aaff; font-size: ${Math.max(10, cellSize * 0.5)}px; font-weight: bold;"></th>`;
            for(let c = 0; c < boardSize; c++) {
                html += `<th style="width: ${cellSize}px; height: ${cellSize}px; border: 1px solid #0066cc; color: #00aaff; font-size: ${Math.max(10, cellSize * 0.5)}px; font-weight: bold;">${LETTERS[c]}</th>`;
            }
            html += `</tr>`;
            
            // Wiersze
            for(let r = 0; r < boardSize; r++) {
                html += `<tr>`;
                html += `<th style="width: ${cellSize}px; height: ${cellSize}px; border: 1px solid #0066cc; color: #00aaff; font-size: ${Math.max(10, cellSize * 0.5)}px; font-weight: bold;">${r + 1}</th>`;
                for(let c = 0; c < boardSize; c++) {
                    const key = `${r}_${c}`;
                    const shot = shipsGameState.shots[key];
                    let cellClass = 'ships-cell';
                    let cellStyle = `width: ${cellSize}px; height: ${cellSize}px; border: 1px solid #0066cc; background: #001122; cursor: pointer; text-align: center; color: #fff; font-size: ${Math.max(8, cellSize * 0.4)}px; font-weight: bold;`;
                    
                    // Dla trafienia – znajdź statek (ile masztów) do wyświetlenia cyfry
                    let shipSize = 0;
                    if (shot && shot.hit && shipsGameState.ships) {
                        for (const ship of shipsGameState.ships) {
                            for (let i = 0; i < ship.size; i++) {
                                const sr = ship.row + (ship.vertical ? i : 0);
                                const sc = ship.col + (ship.vertical ? 0 : i);
                                if (sr === r && sc === c) {
                                    shipSize = ship.size;
                                    break;
                                }
                            }
                            if (shipSize) break;
                        }
                    }
                    
                    if (shot) {
                        if (shot.hit) {
                            cellClass += ' ships-hit';
                            cellStyle += 'background: #22aa44; box-shadow: 0 0 15px #22aa44;';
                        } else {
                            cellClass += ' ships-miss';
                            cellStyle += 'background: #667788; opacity: 0.7;';
                        }
                    }
                    
                    let cellContent = '';
                    if (shot) {
                        if (shot.hit) {
                            cellContent = shipSize ? String(shipSize) : '🔥';
                        } else {
                            cellContent = '○'; // Pudło - zawsze pokazuj
                        }
                    }
                    html += `<td class="${cellClass}" data-r="${r}" data-c="${c}" style="${cellStyle}">${cellContent}</td>`;
                }
                html += `</tr>`;
            }
            html += `</table>`;
            
            container.innerHTML = html;
            
            // Dodaj event listenery tylko jeśli gracz jeszcze nie strzelił w tej rundzie i gra nie zakończona
            // Również sprawdź czy showStats nie jest true (gdy admin kliknął "Statystyki" lub "Następna runda")
            const showStatsValue = currentGameState ? currentGameState.showStats : false;
            const canShoot = !shipsGameState.hasShotThisTurn && 
                            !shipsGameState.gameEnded && 
                            !showStatsValue;
            
            console.log('🎯 renderShipsBoard - canShoot:', {
                hasShotThisTurn: shipsGameState.hasShotThisTurn,
                gameEnded: shipsGameState.gameEnded,
                showStats: showStatsValue,
                currentTurn: shipsGameState.currentTurn,
                canShoot: canShoot
            });
            
            if (canShoot) {
                container.querySelectorAll('.ships-cell').forEach(cell => {
                    if (!cell.classList.contains('ships-hit') && !cell.classList.contains('ships-miss')) {
                        cell.addEventListener('click', (e) => {
                            const r = parseInt(e.target.dataset.r);
                            const c = parseInt(e.target.dataset.c);
                            handleShipsShot(questionId, r, c);
                        });
                    }
                });
            } else {
                // Runda zakończona - pokaż komunikat
                if (currentGameState && currentGameState.showStats) {
                    const roundInfo = container.parentElement.querySelector('.ships-round-info');
                    if (roundInfo) {
                        roundInfo.style.color = '#ffcc00';
                        roundInfo.textContent = `Runda ${roundNumber} zakończona`;
                    }
                }
            }
        }

        function updateShipsBoard(questionId) {
            renderShipsBoard(questionId);
        }

        function handleShipsShot(questionId, r, c) {
            console.log('🎯 handleShipsShot:', { 
                questionId, 
                r, 
                c, 
                hasShotThisTurn: shipsGameState.hasShotThisTurn, 
                gameEnded: shipsGameState.gameEnded,
                currentTurn: shipsGameState.currentTurn,
                showStats: currentGameState && currentGameState.showStats
            });
            
            // Sprawdź czy runda nie została zakończona (showStats = true oznacza zakończoną rundę)
            if (currentGameState && currentGameState.showStats) {
                console.log('❌ Runda zakończona - nie można strzelać');
                return;
            }
            
            if (shipsGameState.hasShotThisTurn || shipsGameState.gameEnded) {
                console.log('❌ Nie można strzelać:', { hasShotThisTurn: shipsGameState.hasShotThisTurn, gameEnded: shipsGameState.gameEnded });
                return;
            }
            
            const key = `${r}_${c}`;
            if (shipsGameState.shots[key]) {
                console.log('❌ Już strzelano w to miejsce');
                return; // Już strzelano tutaj
            }
            
            // Sprawdź czy trafienie (lokalnie dla szybkiej wizualizacji, serwer zweryfikuje)
            let hit = false;
            for (const ship of shipsGameState.ships) {
                for(let i = 0; i < ship.size; i++) {
                    const sr = ship.row + (ship.vertical ? i : 0);
                    const sc = ship.col + (ship.vertical ? 0 : i);
                    if (sr === r && sc === c) {
                        hit = true;
                        break;
                    }
                }
                if (hit) break;
            }
            
            sendShipsShot(questionId, r, c, hit);
        }

        function sendShipsShot(questionId, r, c, hit) {
            const key = `${r}_${c}`;
            
            // Lokalnie zaktualizuj planszę przed wysłaniem do serwera (dla szybkiej wizualizacji)
            if (!shipsGameState.shots[key]) {
                shipsGameState.shots[key] = {
                    hit: hit,
                    players: [socket.id]
                };
            }
            
            // Tymczasowo ustaw hasShotThisTurn aby zapobiec wielokrotnym kliknięciom
            shipsGameState.hasShotThisTurn = true;
            updateShipsBoard(questionId);
            
            socket.emit('ships_shot', {
                questionId: questionId,
                row: r,
                col: c,
                hit: hit,
                playerNick: playerNick,
                team: playerTeam
            });
            
            // Serwer zweryfikuje i wyśle aktualizację przez ships_game_update
        }

        function setupShipsControls(questionId) {
            // Funkcja jest wywoływana przy każdej aktualizacji planszy
            // Statystyki i odpowiedź są obsługiwane przez stateUpdateHandler wyżej
        }

        function renderShipsStats(questionId, state) {
            const statsContainer = document.getElementById(`ships-stats-container-${questionId}`);
            if (!statsContainer || !state.shipsGame) {
                console.warn('⚠️ renderShipsStats - brak kontenera lub state.shipsGame:', {
                    hasContainer: !!statsContainer,
                    hasShipsGame: !!state.shipsGame
                });
                return;
            }
            
            statsContainer.style.display = 'block';
            
            // Użyj statystyk z serwera
            const playerStats = state.shipsGame.playerStats || {};
            
            let html = '<div class="ships-stats-table" style="width: 100%; padding: 15px; background: rgba(0,0,0,0.5); border-radius: 8px; border: 2px solid #00aaff; box-sizing: border-box;">';
            html += '<h3 style="color: #00aaff; margin: 0 0 15px 0; text-align: center; font-size: 1.2em;">📊 Statystyki trafień</h3>';
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.95em;">';
            html += '<tr style="border-bottom: 2px solid #00aaff;"><th style="text-align: left; padding: 10px 8px; color: #00aaff; font-size: 1.1em; font-weight: bold;">Gracz</th><th style="text-align: center; padding: 10px 8px; color: #00aaff; font-size: 1.1em; font-weight: bold;">Trafienia</th><th style="text-align: center; padding: 10px 8px; color: #00aaff; font-size: 1.1em; font-weight: bold;">Pudła</th><th style="text-align: center; padding: 10px 8px; color: #00aaff; font-size: 1.1em; font-weight: bold;">Razem</th></tr>';
            
            const statsArray = Object.values(playerStats).sort((a, b) => (b.hits + b.misses) - (a.hits + a.misses));
            
            if (statsArray.length === 0) {
                html += '<tr><td colspan="4" style="padding: 12px; color: rgba(255,255,255,0.5); text-align: center;">Brak trafień</td></tr>';
            } else {
                statsArray.forEach(stats => {
                    html += `<tr style="border-bottom: 1px solid rgba(0,170,255,0.3);"><td style="padding: 10px 8px; color: #fff; word-break: break-word;">${stats.nick}</td><td style="text-align: center; padding: 10px 8px; color: #00ff00; font-weight: bold;">${stats.hits}</td><td style="text-align: center; padding: 10px 8px; color: #ff0044;">${stats.misses}</td><td style="text-align: center; padding: 10px 8px; color: #fff; font-weight: bold;">${stats.hits + stats.misses}</td></tr>`;
                });
            }
            
            html += '</table></div>';
            statsContainer.innerHTML = html;
        }

        function renderShipsAnswer(questionId, state) {
            // Zaktualizuj planszę pokazując statki
            if (!state.activeQuestion || !state.activeQuestion.ships) return;
            
            const container = document.getElementById(`ships-board-container-${questionId}`);
            if (!container) return;
            
            // Dodaj klasy pokazujące statki na planszy
            state.activeQuestion.ships.forEach(ship => {
                for(let i = 0; i < ship.size; i++) {
                    const r = ship.row + (ship.vertical ? i : 0);
                    const c = ship.col + (ship.vertical ? 0 : i);
                    const cell = container.querySelector(`.ships-cell[data-r="${r}"][data-c="${c}"]`);
                    if (cell) {
                        if (!cell.classList.contains('ships-hit')) {
                            cell.style.background = '#0066cc';
                            cell.style.border = '2px solid #00aaff';
                            cell.textContent = ship.size;
                        } else {
                            // Jeśli trafiony, pokaż statek i trafienie
                            cell.style.background = '#22aa44';
                            cell.style.border = '2px solid #ffaaaa';
                            cell.textContent = `${ship.size}🔥`;
                        }
                    }
                }
            });
        }

        function sendEstimationAnswer(value) {
            console.log('🔍 DEBUG sendEstimationAnswer - START:', {
                value: value,
                currentQuestionId: currentQuestionId,
                hasAnswered: hasAnswered,
                playerEliminated: playerEliminated,
                answeredKey: currentQuestionId ? `voteBattle_answered_${currentQuestionId}` : 'BRAK currentQuestionId'
            });
            
            if (playerEliminated) {
                console.log('❌ sendEstimationAnswer - gracz wyeliminowany, pomijam');
                return;
            }
            if (hasAnswered) {
                console.log('⚠️ sendEstimationAnswer - już odpowiedziałeś, hasAnswered:', hasAnswered);
                return;
            }
            hasAnswered = true;
            // Zapisz informację o zagłosowaniu w localStorage
            const answeredKey = `voteBattle_answered_${currentQuestionId}`;
            try {
                localStorage.setItem(answeredKey, 'true');
                console.log('✅ sendEstimationAnswer - zapisano do localStorage:', answeredKey);
            } catch (e) {
                console.warn('Nie można zapisać do localStorage:', e);
            }
            socket.emit('send_answer', { value: Number(value), team: playerTeam });
            document.getElementById('estimation-submit')?.classList.add('answer-locked');
            document.getElementById('estimation-slider')?.setAttribute('disabled', 'true');
            document.getElementById('estimation-number')?.setAttribute('readonly', 'true');
        }

        function sendOpenAnswer(text) {
            console.log('🔍 DEBUG sendOpenAnswer - START:', {
                text: text,
                currentQuestionId: currentQuestionId,
                hasAnswered: hasAnswered,
                playerEliminated: playerEliminated,
                answeredKey: currentQuestionId ? `voteBattle_answered_${currentQuestionId}` : 'BRAK currentQuestionId'
            });
            
            if (playerEliminated) {
                console.log('❌ sendOpenAnswer - gracz wyeliminowany, pomijam');
                return;
            }
            if (hasAnswered) {
                console.log('⚠️ sendOpenAnswer - już odpowiedziałeś, hasAnswered:', hasAnswered);
                return;
            }
            
            const trimmedText = String(text).trim();
            
            // Sprawdź czy odpowiedź zawiera niecenzuralne słowa
            if (window.ProfanityFilter?.containsProfanity(trimmedText)) {
                alert('⚠️ Odpowiedź zawiera nieodpowiednie słowa. Zmień odpowiedź.');
                const openInput = document.getElementById('open-answer-input');
                if (openInput) {
                    openInput.value = '';
                    openInput.focus();
                }
                hasAnswered = false; // Pozwól spróbować ponownie
                return;
            }
            
            hasAnswered = true;
            // Zapisz informację o zagłosowaniu w localStorage
            const answeredKey = `voteBattle_answered_${currentQuestionId}`;
            try {
                localStorage.setItem(answeredKey, 'true');
            } catch (e) {
                console.warn('Nie można zapisać do localStorage:', e);
            }
            socket.emit('send_answer', { text: trimmedText, team: playerTeam });
            document.getElementById('open-submit')?.classList.add('answer-locked');
            document.getElementById('open-answer-input')?.setAttribute('readonly', 'true');
        }
        
        function sendLetterAnswer(textOrArray) {
            console.log('🔍 DEBUG sendLetterAnswer - START:', {
                textOrArray: textOrArray,
                currentQuestionId: currentQuestionId,
                hasAnswered: hasAnswered,
                playerEliminated: playerEliminated,
                answeredKey: currentQuestionId ? `voteBattle_answered_${currentQuestionId}` : 'BRAK currentQuestionId'
            });
            
            if (playerEliminated) {
                console.log('❌ sendLetterAnswer - gracz wyeliminowany, pomijam');
                return;
            }
            if (hasAnswered) {
                console.log('⚠️ sendLetterAnswer - już odpowiedziałeś, hasAnswered:', hasAnswered);
                return;
            }
            
            let words = [];
            if (Array.isArray(textOrArray)) {
                words = textOrArray.map(w => String(w).trim()).filter(w => w);
            } else {
                const trimmedText = String(textOrArray).trim();
                if (!trimmedText) return;
                words = [trimmedText];
            }
            
            // Sprawdź czy odpowiedź zawiera niecenzuralne słowa
            for (const word of words) {
                if (window.ProfanityFilter?.containsProfanity(word)) {
                    alert('⚠️ Odpowiedź zawiera nieodpowiednie słowa. Zmień odpowiedź.');
                    const letterInput1 = document.getElementById('letter-answer-input-1');
                    const letterInput2 = document.getElementById('letter-answer-input-2');
                    if (letterInput1) letterInput1.value = '';
                    if (letterInput2) letterInput2.value = '';
                    if (letterInput1) letterInput1.focus();
                    hasAnswered = false; // Pozwól spróbować ponownie
                    return;
                }
            }
            
            hasAnswered = true;
            // Zapisz informację o zagłosowaniu w localStorage
            const answeredKey = `voteBattle_answered_${currentQuestionId}`;
            try {
                localStorage.setItem(answeredKey, 'true');
            } catch (e) {
                console.warn('Nie można zapisać do localStorage:', e);
            }
            const letterCount = (currentGameState && currentGameState.letterGame && currentGameState.letterGame.letterCount) || 1;
            // Dla 2 liter zawsze wyślij tablicę z 2 elementami (nawet jeśli jeden jest pusty - serwer zwaliduje)
            const answerData = letterCount === 2 ? (words.length >= 2 ? [words[0], words[1]] : [words[0] || '', '']) : (words[0] || '');
            console.log('🔤 [vote] Wysyłam odpowiedź LETTER:', { letterCount, words, answerData, answerDataType: typeof answerData, isArray: Array.isArray(answerData) });
            // answeredKey jest już zadeklarowane i zapisane wcześniej (linia 5995) - nie trzeba zapisywać ponownie
            socket.emit('send_answer', { text: answerData, team: playerTeam });
            const letterSubmitBtn = document.getElementById('letter-submit');
            const letterSentMsg = document.getElementById('letter-sent-msg');
            if (letterSubmitBtn) {
                letterSubmitBtn.classList.add('answer-locked');
                letterSubmitBtn.textContent = 'Wysłano';
                letterSubmitBtn.disabled = true;
            }
            if (letterSentMsg) letterSentMsg.style.display = 'block';
            const letterInput1 = document.getElementById('letter-answer-input-1');
            const letterInput2 = document.getElementById('letter-answer-input-2');
            if (letterInput1) letterInput1.setAttribute('readonly', 'true');
            if (letterInput2) letterInput2.setAttribute('readonly', 'true');
        }

        // === WYSYŁANIE ODPOWIEDZI ===
        function sendAnswer(index, btn) {
            console.log('🔍 DEBUG sendAnswer - START:', {
                index: index,
                currentQuestionId: currentQuestionId,
                hasAnswered: hasAnswered,
                playerEliminated: playerEliminated,
                answeredKey: currentQuestionId ? `voteBattle_answered_${currentQuestionId}` : 'BRAK currentQuestionId',
                localStorageValue: currentQuestionId ? localStorage.getItem(`voteBattle_answered_${currentQuestionId}`) : null
            });
            
            if (playerEliminated) {
                console.log('❌ sendAnswer - gracz wyeliminowany, pomijam');
                return;
            }
            if (hasAnswered) {
                console.log('⚠️ Już odpowiedziałeś na to pytanie - hasAnswered:', hasAnswered, 'currentQuestionId:', currentQuestionId);
                // DEBUG: Sprawdź localStorage
                if (currentQuestionId) {
                    const answeredKey = `voteBattle_answered_${currentQuestionId}`;
                    console.log('🔍 DEBUG - localStorage check:', {
                        answeredKey: answeredKey,
                        value: localStorage.getItem(answeredKey),
                        allKeys: Array.from({ length: localStorage.length }, (_, i) => localStorage.key(i)).filter(k => k && k.startsWith('voteBattle_answered_'))
                    });
                }
                return;
            }
            
            hasAnswered = true;
            playerAnswerIndex = index; // Zapisz indeks odpowiedzi gracza
            // Zapisz informację o zagłosowaniu w localStorage
            const answeredKey = `voteBattle_answered_${currentQuestionId}`;
            try {
                localStorage.setItem(answeredKey, 'true');
                localStorage.setItem(`${answeredKey}_index`, index.toString());
                console.log('✅ sendAnswer - zapisano do localStorage:', {
                    answeredKey: answeredKey,
                    indexKey: `${answeredKey}_index`,
                    indexValue: index.toString()
                });
            } catch (e) {
                console.warn('Nie można zapisać do localStorage:', e);
            }
            socket.emit('send_answer', { index, team: playerTeam });
            
            console.log('✅ Wysłano odpowiedź:', index);
            
            // Zaznacz wybraną odpowiedź
            if(btn.classList.contains('hot-image-card')) {
                // HOT_OR_NOT - zaznacz kartę obrazka
                document.querySelectorAll('.hot-image-card').forEach(c => {
                    c.classList.remove('answer-selected');
                    c.classList.add('answer-locked');
                });
                btn.classList.add('answer-selected');
                btn.classList.remove('answer-locked');
            } else {
                // Standardowe przyciski
                document.querySelectorAll('.answer-btn').forEach(b => {
                    b.classList.remove('answer-selected');
                    b.classList.add('answer-locked');
                });
                btn.classList.add('answer-selected');
                btn.classList.remove('answer-locked');
            }
        }

        // === WYBÓR DRUŻYNY ===
        function selectTeam(team) {
            console.log('🏆 Wybrano drużynę:', team);
            playerTeam = team;
            socket.emit('player_join_team', team);
            
            // Po wyborze drużyny przejdź do ekranu oczekiwania
            showScreen('waiting');
            updatePlayerInfo();
        }
        
        // Obsługa potwierdzenia wyboru drużyny
        socket.on('update_team_scores', (teams) => {
            if (currentGameState && currentGameState.teamBattleMode && teams) {
                const scoreA = (teams.A && teams.A.score != null) ? teams.A.score : 0;
                const scoreB = (teams.B && teams.B.score != null) ? teams.B.score : 0;
                
                const elScoreA = document.getElementById('vote-team-score-a');
                const elScoreB = document.getElementById('vote-team-score-b');
                
                if (elScoreA) elScoreA.textContent = scoreA;
                if (elScoreB) elScoreB.textContent = scoreB;
                
                // Aktualizuj też w currentGameState
                if (currentGameState.teams) {
                    if (currentGameState.teams.A) currentGameState.teams.A.score = scoreA;
                    if (currentGameState.teams.B) currentGameState.teams.B.score = scoreB;
                }
            }
        });

        socket.on('team_selected', (team) => {
            playerTeam = team;
            console.log('✅ Serwer potwierdził wybór drużyny:', team);
            
            // Zapisz drużynę w localStorage
            try {
                localStorage.setItem('voteBattle_team', team);
            } catch (e) {
                console.warn('Nie można zapisać drużyny do localStorage:', e);
            }
        });
        
        // Event resetu trybu drużynowego - wyczyść localStorage i wymuś ponowny wybór
        socket.on('team_mode_reset', (data) => {
            console.log('🔄 Otrzymano team_mode_reset - resetuję drużynę gracza');
            playerTeam = null;
            try {
                localStorage.removeItem('voteBattle_team');
                console.log('✅ Usunięto drużynę z localStorage');
            } catch (e) {
                console.warn('Nie można usunąć drużyny z localStorage:', e);
            }
            
            // Jeśli gracz jest zarejestrowany, pokaż ekran wyboru drużyny
            if (playerNick) {
                console.log('🎯 Pokazuję ekran wyboru drużyny po resecie');
                // Poproś serwer o aktualny stan
                socket.emit('request_state');
            }
        });
        
        // Event pełnego resetu gry - wyczyść nick, drużynę i pokaż ekran logowania
        socket.on('game_reset', () => {
            console.log('🔄 PEŁNY RESET GRY - czyszczenie nicka, drużyny i wszystkich odpowiedzi');
            playerNick = '';
            playerTeam = null;
            playerScore = 0;
            hasAnswered = false;
            playerAnswerIndex = null;
            currentQuestionId = null;
            
            // WAŻNE: Resetuj stan gry w statki
            shipsGameState = {
                questionId: null,
                boardSize: 8,
                ships: [],
                shots: {},
                currentTurn: 0,
                hasShotThisTurn: false,
                gameEnded: false
            };
            
            // WAŻNE: Wyłącz tryb drużynowy lokalnie (żeby gra nie odpalała się jako team battle)
            if (currentGameState) {
                currentGameState.teamBattleMode = false;
            }
            
            // Wyczyść localStorage - usuń WSZYSTKIE wpisy związane z drużynami i odpowiedziami
            try {
                // WAŻNE: Najpierw zbierz WSZYSTKIE klucze do tablicy (przed jakimkolwiek usuwaniem)
                const allKeysSnapshot = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key) {
                        allKeysSnapshot.push(key);
                    }
                }
                
                console.log('🔍 DEBUG game_reset - wszystkie klucze w localStorage przed czyszczeniem:', {
                    totalKeys: allKeysSnapshot.length,
                    allKeys: allKeysSnapshot
                });
                
                // WAŻNE: Usuń WSZYSTKIE klucze związane z odpowiedziami (voteBattle_answered_*)
                // Użyj snapshotu kluczy, aby uniknąć problemów z iteracją podczas usuwania
                const keysToRemove = allKeysSnapshot.filter(key => key.startsWith('voteBattle_answered_'));
                
                console.log('🔍 DEBUG game_reset - znalezione klucze odpowiedzi do usunięcia:', {
                    answerKeys: keysToRemove,
                    answerKeysCount: keysToRemove.length
                });
                
                // Usuń wszystkie klucze odpowiedzi (włącznie z _index)
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    console.log('🗑️ Usunięto klucz:', key);
                });
                
                // Usuń podstawowe klucze
                localStorage.removeItem('voteBattle_nick');
                localStorage.removeItem('voteBattle_team');
                localStorage.removeItem('team');
                localStorage.removeItem('playerTeam');
                localStorage.removeItem('teamBattleMode');
                
                // WAŻNE: Sprawdź czy wszystkie klucze zostały usunięte (ponownie przejdź przez localStorage)
                const remainingAnswerKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('voteBattle_answered_')) {
                        remainingAnswerKeys.push({ key, value: localStorage.getItem(key) });
                    }
                }
                
                console.log('✅ Wyczyszczono localStorage (nick, drużyna, tryb drużynowy, odpowiedzi):', {
                    removedAnswerKeys: keysToRemove.length,
                    keys: keysToRemove,
                    remainingAnswerKeys: remainingAnswerKeys.length > 0 ? remainingAnswerKeys : 'BRAK'
                });
                
                if (remainingAnswerKeys.length > 0) {
                    console.error('❌ BŁĄD: Pozostały klucze odpowiedzi w localStorage po resecie!', remainingAnswerKeys);
                    // WAŻNE: Spróbuj usunąć ponownie (może być problem z synchronizacją)
                    remainingAnswerKeys.forEach(item => {
                        localStorage.removeItem(item.key);
                        console.log('🗑️ Ponowne usunięcie klucza:', item.key);
                    });
                    
                    // Sprawdź jeszcze raz po ponownym usunięciu
                    const finalCheck = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('voteBattle_answered_')) {
                            finalCheck.push(key);
                        }
                    }
                    if (finalCheck.length > 0) {
                        console.error('❌ KRYTYCZNY BŁĄD: Nadal pozostały klucze po ponownym usunięciu!', finalCheck);
                        // Ostateczność: usuń wszystkie klucze voteBattle_* ręcznie
                        finalCheck.forEach(key => {
                            try {
                                localStorage.removeItem(key);
                                console.log('🗑️ Ostateczne usunięcie klucza:', key);
                            } catch (e) {
                                console.error('❌ Nie można usunąć klucza:', key, e);
                            }
                        });
                    }
                }
            } catch (e) {
                console.error('❌ Błąd przy czyszczeniu localStorage:', e);
                // WAŻNE: W przypadku błędu spróbuj użyć alternatywnej metody
                try {
                    console.warn('⚠️ Próbuję alternatywnej metody czyszczenia...');
                    const keysToClear = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.startsWith('voteBattle_') || key === 'team' || key === 'playerTeam' || key === 'teamBattleMode')) {
                            keysToClear.push(key);
                        }
                    }
                    keysToClear.forEach(key => {
                        try {
                            localStorage.removeItem(key);
                        } catch (e2) {
                            console.error('❌ Nie można usunąć klucza:', key, e2);
                        }
                    });
                    console.log('✅ Alternatywne czyszczenie zakończone, usunięto:', keysToClear.length, 'kluczy');
                } catch (e2) {
                    console.error('❌ Alternatywne czyszczenie też nie powiodło się:', e2);
                }
            }
            
            // Pokaż ekran logowania
            const loginScreen = document.getElementById('login-screen');
            const waitingScreen = document.getElementById('waiting-screen');
            const votingScreen = document.getElementById('voting-screen');
            const teamSelectionScreen = document.getElementById('team-selection-screen');
            const leaderboardScreen = document.getElementById('leaderboard-screen');
            const podiumScreen = document.getElementById('podium-screen');
            
            if (loginScreen) loginScreen.style.display = 'block';
            if (waitingScreen) waitingScreen.style.display = 'none';
            if (votingScreen) votingScreen.style.display = 'none';
            if (teamSelectionScreen) teamSelectionScreen.style.display = 'none';
            if (leaderboardScreen) leaderboardScreen.style.display = 'none';
            if (podiumScreen) podiumScreen.style.display = 'none';
            
            // Wyczyść pole nicka
            const nickInput = document.getElementById('nick-input');
            if (nickInput) {
                nickInput.value = '';
                nickInput.focus();
            }
            
            // Ukryj wyświetlanie wyników drużyn
            const teamScoreDisplay = document.getElementById('vote-team-score-display');
            if (teamScoreDisplay) {
                teamScoreDisplay.style.display = 'none';
            }
            
            console.log('✅ Ekran logowania pokazany po pełnym resecie, tryb drużynowy wyłączony');
            
            // WAŻNE: Po resecie upewnij się że hasAnswered jest false i currentQuestionId jest null
            // To zapewni że przy następnym pytaniu nie będzie problemu z localStorage
            setTimeout(() => {
                console.log('🔍 DEBUG game_reset - finalne sprawdzenie po resecie:', {
                    hasAnswered: hasAnswered,
                    currentQuestionId: currentQuestionId,
                    playerAnswerIndex: playerAnswerIndex,
                    remainingKeys: Array.from({ length: localStorage.length }, (_, i) => {
                        const key = localStorage.key(i);
                        return key && key.startsWith('voteBattle_answered_') ? key : null;
                    }).filter(Boolean)
                });
                
                // Jeśli nadal są klucze odpowiedzi, usuń je ponownie
                const finalRemainingKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('voteBattle_answered_')) {
                        finalRemainingKeys.push(key);
                    }
                }
                
                if (finalRemainingKeys.length > 0) {
                    console.warn('⚠️ Po resecie nadal są klucze odpowiedzi - usuwam ponownie:', finalRemainingKeys);
                    finalRemainingKeys.forEach(key => {
                        localStorage.removeItem(key);
                        // Usuń też klucz _index jeśli istnieje
                        const indexKey = key + '_index';
                        if (localStorage.getItem(indexKey)) {
                            localStorage.removeItem(indexKey);
                        }
                    });
                }
                
                // Upewnij się że zmienne są zresetowane
                hasAnswered = false;
                currentQuestionId = null;
                playerAnswerIndex = null;
            }, 500);
        });
        
        // Aktualizacja indywidualnego wyniku gracza (zachowaj nawet w trybie drużynowym)
        socket.on('player_score_update', (data) => {
            if (data && data.score != null) {
                playerScore = data.score;
                updatePlayerInfo();
            }
        });
        
        // === POKAZANIE EKRANU WYBORU DRUŻYNY ===
        function showTeamSelectionScreen() {
            console.log('🏆 showTeamSelectionScreen wywołane, currentGameState:', currentGameState);
            
            if (!currentGameState) {
                console.log('⚠️ Brak currentGameState - nie można pokazać wyboru drużyny');
                // Spróbuj poczekać na stan
                setTimeout(() => {
                    if (currentGameState) {
                        showTeamSelectionScreen();
                    }
                }, 500);
                return;
            }
            
            const teamA = currentGameState.teams && currentGameState.teams.A ? currentGameState.teams.A.name : null;
            const teamB = currentGameState.teams && currentGameState.teams.B ? currentGameState.teams.B.name : null;
            
            const teamAName = teamA && teamA.trim() !== '' ? teamA : 'Drużyna A';
            const teamBName = teamB && teamB.trim() !== '' ? teamB : 'Drużyna B';
            
            const btnA = document.getElementById('team-a-btn');
            const btnB = document.getElementById('team-b-btn');
            
            if (btnA) btnA.textContent = teamAName;
            if (btnB) btnB.textContent = teamBName;
            
            console.log('🏆 Pokazuję ekran wyboru drużyn:', teamAName, 'vs', teamBName);
            showScreen('team-selection');
            
            // Debug - sprawdź czy ekran jest widoczny
            setTimeout(() => {
                const screen = document.getElementById('team-selection-screen');
                console.log('🔍 Ekran team-selection:', screen ? screen.style.display : 'nie znaleziono');
            }, 100);
        }

        // === RANKING ===
        function showLeaderboard(leaderboard) {
            showScreen('leaderboard');
            
            const list = document.getElementById('leaderboard-list');
            const teamBox = document.getElementById('vote-team-score-display');
            const title = document.querySelector('#leaderboard-screen .leaderboard-title');
            
            // Sprawdź czy tryb drużynowy jest aktywny - użyj currentGameState który jest aktualizowany w update_state
            if (currentGameState && currentGameState.teamBattleMode && currentGameState.teams) {
                // Tryb drużynowy - pokaż wyniki drużyn (zamiast TOP 10)
                if (title) title.textContent = '🏆 WYNIK DRUŻYN';
                if (list) {
                    list.style.display = 'none';
                    list.innerHTML = ''; // Wyczyść listę TOP 10
                }
                if (teamBox) teamBox.style.display = 'flex';
                
                const nameA = (currentGameState.teams.A && currentGameState.teams.A.name) ? currentGameState.teams.A.name : 'Team A';
                const nameB = (currentGameState.teams.B && currentGameState.teams.B.name) ? currentGameState.teams.B.name : 'Team B';
                const scoreA = (currentGameState.teams.A && currentGameState.teams.A.score != null) ? currentGameState.teams.A.score : 0;
                const scoreB = (currentGameState.teams.B && currentGameState.teams.B.score != null) ? currentGameState.teams.B.score : 0;
                const countA = (currentGameState.teams.A && currentGameState.teams.A.playerCount != null) ? currentGameState.teams.A.playerCount : 0;
                const countB = (currentGameState.teams.B && currentGameState.teams.B.playerCount != null) ? currentGameState.teams.B.playerCount : 0;
                
                const elNameA = document.getElementById('vote-team-name-a');
                const elNameB = document.getElementById('vote-team-name-b');
                const elScoreA = document.getElementById('vote-team-score-a');
                const elScoreB = document.getElementById('vote-team-score-b');
                
                if (elNameA) elNameA.textContent = nameA;
                if (elNameB) elNameB.textContent = nameB;
                if (elScoreA) elScoreA.textContent = scoreA;
                if (elScoreB) elScoreB.textContent = scoreB;
            } else {
                // Tryb indywidualny - pokaż TOP 10
                if (title) title.textContent = '🏆 TOP 10';
                if (list) list.style.display = 'block';
                if (teamBox) teamBox.style.display = 'none';
                
                list.innerHTML = '';
                
                if (!leaderboard || leaderboard.length === 0) {
                    list.innerHTML = '<div style="text-align:center; padding:20px; color:rgba(255,255,255,0.5);">Brak wyników</div>';
                    return;
                }
                
                leaderboard.forEach((player, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    
                    let rankClass = '';
                    if (index === 0) rankClass = 'rank-1';
                    else if (index === 1) rankClass = 'rank-2';
                    else if (index === 2) rankClass = 'rank-3';
                    
                    item.innerHTML = `
                        <div class="rank ${rankClass}">${index + 1}</div>
                        <div class="player-nick">${player.nick}</div>
                        <div class="player-score-lb">${player.score}</div>
                    `;
                    
                    list.appendChild(item);
                    
                    // Aktualizuj swój wynik jeśli to Ty
                    if (player.nick === playerNick) {
                        playerScore = player.score;
                    }
                });
            }
            
            document.getElementById('lb-nick').textContent = playerNick;
            document.getElementById('lb-score').textContent = playerScore + ' pkt';
        }

        // === EKRAN PODZIĘKOWAŃ ===
        function showThanksScreen(thanksScreen, quizTitle) {
            showScreen('thanks');
            
            const titleEl = document.getElementById('thanks-title');
            const contentEl = document.getElementById('thanks-content');
            const imageContainer = document.getElementById('thanks-image-container');
            const imageEl = document.getElementById('thanks-image');
            
            if (thanksScreen && (thanksScreen.text || thanksScreen.image)) {
                // Użyj niestandardowego ekranu końcowego
                if (thanksScreen.text) {
                    contentEl.textContent = thanksScreen.text;
                    contentEl.style.display = 'block';
                } else {
                    contentEl.style.display = 'none';
                }
                
                if (thanksScreen.image) {
                    const imgSrc = thanksScreen.image.startsWith('/') || thanksScreen.image.startsWith('http') 
                        ? thanksScreen.image 
                        : '/uploads/' + thanksScreen.image;
                    imageEl.src = imgSrc;
                    imageContainer.style.display = 'block';
                } else {
                    imageContainer.style.display = 'none';
                }
                
                // Tytuł to tytuł quizu
                if (titleEl) {
                    titleEl.textContent = quizTitle || 'Imprezja Quiz';
                }
            } else {
                // Domyślny ekran końcowy
                if (titleEl) {
                    titleEl.textContent = quizTitle || 'Imprezja Quiz';
                }
                contentEl.textContent = 'Dziękuję za udział w zabawie';
                contentEl.style.display = 'block';
                imageContainer.style.display = 'none';
            }
        }

        // === PODIUM ===
        function showPodiumScreen(winners, step) {
            console.log('🥇 showPodiumScreen wywołane - winners:', winners, 'step:', step, 'currentPodiumStep:', currentPodiumStep, 'teamBattleMode:', currentGameState?.teamBattleMode);
            
            showScreen('podium');
            
            const isTeamBattle = currentGameState?.teamBattleMode;
            const p1 = document.getElementById('podium-1');
            const p2 = document.getElementById('podium-2');
            const p3 = document.getElementById('podium-3');
            const waiting = document.getElementById('podium-waiting');
            const podiumTitle = document.getElementById('podium-title-header') || document.querySelector('#podium-screen .podium-title');
            
            // Upewnij się że nagłówek PODIUM jest zawsze widoczny (szczególnie w trybie drużynowym)
            if (podiumTitle) {
                podiumTitle.style.setProperty('display', 'block', 'important');
                podiumTitle.style.setProperty('visibility', 'visible', 'important');
                podiumTitle.style.setProperty('opacity', '1', 'important');
                podiumTitle.style.setProperty('text-align', 'center', 'important');
                podiumTitle.style.setProperty('font-size', 'clamp(1.3rem, 5vw, 2rem)', 'important');
                podiumTitle.style.setProperty('font-weight', '900', 'important');
                podiumTitle.style.setProperty('margin-bottom', '20px', 'important');
                podiumTitle.style.setProperty('background', '-webkit-linear-gradient(#f1c40f, #e67e22)', 'important');
                podiumTitle.style.setProperty('-webkit-background-clip', 'text', 'important');
                podiumTitle.style.setProperty('-webkit-text-fill-color', 'transparent', 'important');
                console.log('✅ Ustawiono widoczność nagłówka PODIUM:', {
                    display: podiumTitle.style.display,
                    visibility: podiumTitle.style.visibility,
                    opacity: podiumTitle.style.opacity,
                    computedDisplay: window.getComputedStyle(podiumTitle).display
                });
            } else {
                console.error('❌ Nie znaleziono nagłówka PODIUM!');
            }
            
            // Ukryj 3 miejsce w trybie drużynowym
            if (p3) {
                if (isTeamBattle) {
                    p3.style.display = 'none';
                } else {
                    p3.style.display = '';
                }
            }
            
            if (isTeamBattle) {
                // Tryb drużynowy - pokaż wyniki drużyn
                // WAŻNE: Upewnij się że nagłówek PODIUM jest widoczny w trybie drużynowym
                const titleEl = document.getElementById('podium-title-header') || document.querySelector('#podium-screen .podium-title');
                if (titleEl) {
                    titleEl.style.setProperty('display', 'block', 'important');
                    titleEl.style.setProperty('visibility', 'visible', 'important');
                    titleEl.style.setProperty('opacity', '1', 'important');
                    titleEl.style.setProperty('text-align', 'center', 'important');
                    titleEl.style.setProperty('font-size', 'clamp(1.3rem, 5vw, 2rem)', 'important');
                    titleEl.style.setProperty('font-weight', '900', 'important');
                    titleEl.style.setProperty('margin-bottom', '20px', 'important');
                    console.log('✅ Tryb drużynowy - ustawiono widoczność nagłówka PODIUM:', {
                        display: titleEl.style.display,
                        computedDisplay: window.getComputedStyle(titleEl).display
                    });
                }
                
                // Użyj danych z winners jeśli są dostępne (jak w Screen.html), w przeciwnym razie użyj teams
                let winnerTeam, secondTeam;
                if (winners && winners.length >= 2) {
                    // Winners zawiera drużyny posortowane według wyniku
                    winnerTeam = winners[0] || { name: '---', score: 0 };
                    secondTeam = winners[1] || { name: '---', score: 0 };
                    console.log('🏆 Używam danych z winners array:', { winnerTeam, secondTeam });
                } else {
                    // Fallback: użyj teams z currentGameState
                    const teams = currentGameState?.teams || {};
                    const teamA = teams.A || { name: 'Team A', score: 0 };
                    const teamB = teams.B || { name: 'Team B', score: 0 };
                    
                    // Posortuj drużyny według wyniku (wyższy wynik = wyższe miejsce)
                    const sortedTeams = [teamA, teamB].sort((a, b) => (b.score || 0) - (a.score || 0));
                    winnerTeam = sortedTeams[0];
                    secondTeam = sortedTeams[1];
                    console.log('🏆 Używam danych z teams (fallback):', { winnerTeam, secondTeam });
                }
                
                // Pokaż indywidualny wynik gracza
                document.getElementById('podium-my-nick').textContent = playerNick;
                document.getElementById('podium-my-score').textContent = playerScore + ' pkt';
                
                // Miejsce 2 (drugie miejsce)
                const nick2El = document.getElementById('nick-2');
                const score2El = document.getElementById('score-2');
                if (nick2El) nick2El.textContent = secondTeam.name || '---';
                if (score2El) score2El.textContent = (secondTeam.score || 0) + ' pkt';
                
                // Miejsce 1 (pierwsze miejsce)
                const nick1El = document.getElementById('nick-1');
                const score1El = document.getElementById('score-1');
                if (nick1El) nick1El.textContent = winnerTeam.name || '---';
                if (score1El) score1El.textContent = (winnerTeam.score || 0) + ' pkt';
                
                console.log('🏆 Dane podjum drużynowego ustawione:', {
                    miejsce1: { nick: nick1El?.textContent, score: score1El?.textContent },
                    miejsce2: { nick: nick2El?.textContent, score: score2El?.textContent }
                });
                
                if (step === 0) {
                    console.log('🔄 RESET PODIUM TEAM - ukrywam wszystkie miejsca');
                    if (p1) {
                        p1.classList.remove('revealed');
                        p1.style.setProperty('display', 'none', 'important');
                    }
                    if (p2) {
                        p2.classList.remove('revealed');
                        p2.style.setProperty('display', 'none', 'important');
                    }
                    waiting.style.display = 'block';
                    currentPodiumStep = 0;
                    return;
                }
                
                if (step >= 2) {
                    waiting.style.display = 'none';
                }
                
                // W trybie drużynowym: step 2 = miejsce 2, step 1 = miejsce 1
                if (step === 2) {
                    console.log('🥈 POKAZUJĘ 2. MIEJSCE DRUŻYNY (step=2)', {
                        p2: !!p2,
                        p2Element: p2,
                        winners: winners,
                        secondTeam: secondTeam
                    });
                    if (p2) {
                        // Upewnij się że kontener podium-screen jest widoczny
                        const podiumScreen = document.getElementById('podium-screen');
                        if (podiumScreen) {
                            podiumScreen.style.setProperty('display', 'flex', 'important');
                            podiumScreen.style.setProperty('flex-direction', 'column', 'important');
                            podiumScreen.style.setProperty('visibility', 'visible', 'important');
                            podiumScreen.style.setProperty('opacity', '1', 'important');
                            console.log('✅ Kontener podium-screen ustawiony na flex');
                        }
                        
                        // Upewnij się że dane są ustawione
                        const nick2El = document.getElementById('nick-2');
                        const score2El = document.getElementById('score-2');
                        if (nick2El && secondTeam) {
                            nick2El.textContent = secondTeam.name || '---';
                            console.log('✅ Ustawiono nick-2:', nick2El.textContent);
                        }
                        if (score2El && secondTeam) {
                            score2El.textContent = (secondTeam.score || 0) + ' pkt';
                            console.log('✅ Ustawiono score-2:', score2El.textContent);
                        }
                        
                        // Wymuś widoczność przed dodaniem klasy revealed
                        p2.style.setProperty('display', 'block', 'important');
                        p2.style.setProperty('visibility', 'visible', 'important');
                        p2.style.setProperty('opacity', '1', 'important');
                        p2.style.setProperty('position', 'relative', 'important');
                        p2.style.setProperty('z-index', '10', 'important');
                        p2.style.setProperty('min-height', '100px', 'important');
                        p2.style.setProperty('width', '100%', 'important');
                        p2.style.setProperty('max-width', '90%', 'important');
                        if (!p2.classList.contains('revealed')) {
                            p2.classList.add('revealed');
                        }
                        
                        console.log('✅ Miejsce 2 - ustawiono style:', {
                            display: p2.style.display,
                            visibility: p2.style.visibility,
                            opacity: p2.style.opacity,
                            hasRevealed: p2.classList.contains('revealed'),
                            innerHTML: p2.innerHTML.substring(0, 100)
                        });
                        
                        // Dodatkowe sprawdzenie po chwili
                        setTimeout(() => {
                            const computed = window.getComputedStyle(p2);
                            const parentComputed = p2.parentElement ? window.getComputedStyle(p2.parentElement) : null;
                            console.log('✅ Miejsce 2 - szczegółowy stan po 100ms:', {
                                inlineDisplay: p2.style.display,
                                computedDisplay: computed.display,
                                computedVisibility: computed.visibility,
                                computedOpacity: computed.opacity,
                                hasRevealed: p2.classList.contains('revealed'),
                                offsetWidth: p2.offsetWidth,
                                offsetHeight: p2.offsetHeight,
                                clientWidth: p2.clientWidth,
                                clientHeight: p2.clientHeight,
                                parentDisplay: parentComputed ? parentComputed.display : 'brak',
                                parentVisibility: parentComputed ? parentComputed.visibility : 'brak',
                                parentOpacity: parentComputed ? parentComputed.opacity : 'brak',
                                parentId: p2.parentElement ? p2.parentElement.id : 'brak',
                                nick2Text: nick2El ? nick2El.textContent : 'brak',
                                score2Text: score2El ? score2El.textContent : 'brak'
                            });
                            
                            // Jeśli nadal nie jest widoczne, wymuś jeszcze raz
                            if (computed.display === 'none' || p2.offsetWidth === 0 || computed.visibility === 'hidden') {
                                console.warn('⚠️ Miejsce 2 nadal niewidoczne - wymuszam ponownie');
                                p2.style.setProperty('display', 'block', 'important');
                                p2.style.setProperty('visibility', 'visible', 'important');
                                p2.style.setProperty('opacity', '1', 'important');
                                p2.classList.add('revealed');
                                
                                // Sprawdź jeszcze raz po wymuszeniu
                                setTimeout(() => {
                                    const recomputed = window.getComputedStyle(p2);
                                    console.log('🔄 Po wymuszeniu - miejsce 2:', {
                                        display: recomputed.display,
                                        visibility: recomputed.visibility,
                                        opacity: recomputed.opacity,
                                        offsetWidth: p2.offsetWidth,
                                        offsetHeight: p2.offsetHeight
                                    });
                                }, 50);
                            }
                        }, 100);
                    } else {
                        console.error('❌ Nie znaleziono elementu podium-2!');
                    }
                }
                
                if (step === 1) {
                    console.log('🥇 POKAZUJĘ 1. MIEJSCE DRUŻYNY (step=1)', {
                        p1: !!p1,
                        p1Element: p1,
                        p2: !!p2,
                        winners: winners,
                        winnerTeam: winnerTeam
                    });
                    if (p1) {
                        // Upewnij się że kontener podium-screen jest widoczny
                        const podiumScreen = document.getElementById('podium-screen');
                        if (podiumScreen) {
                            podiumScreen.style.setProperty('display', 'flex', 'important');
                            podiumScreen.style.setProperty('flex-direction', 'column', 'important');
                            podiumScreen.style.setProperty('visibility', 'visible', 'important');
                            podiumScreen.style.setProperty('opacity', '1', 'important');
                            console.log('✅ Kontener podium-screen ustawiony na flex');
                        }
                        
                        // Upewnij się że dane są ustawione
                        const nick1El = document.getElementById('nick-1');
                        const score1El = document.getElementById('score-1');
                        if (nick1El && winnerTeam) {
                            nick1El.textContent = winnerTeam.name || '---';
                            console.log('✅ Ustawiono nick-1:', nick1El.textContent);
                        }
                        if (score1El && winnerTeam) {
                            score1El.textContent = (winnerTeam.score || 0) + ' pkt';
                            console.log('✅ Ustawiono score-1:', score1El.textContent);
                        }
                        
                        // Wymuś widoczność przed dodaniem klasy revealed
                        p1.style.setProperty('display', 'block', 'important');
                        p1.style.setProperty('visibility', 'visible', 'important');
                        p1.style.setProperty('opacity', '1', 'important');
                        p1.style.setProperty('position', 'relative', 'important');
                        p1.style.setProperty('z-index', '10', 'important');
                        p1.style.setProperty('min-height', '100px', 'important');
                        p1.style.setProperty('width', '100%', 'important');
                        p1.style.setProperty('max-width', '90%', 'important');
                        if (!p1.classList.contains('revealed')) {
                            p1.classList.add('revealed');
                        }
                        
                        // Upewnij się że miejsce 2 też jest widoczne
                        if (p2 && step === 1) {
                            const nick2El = document.getElementById('nick-2');
                            const score2El = document.getElementById('score-2');
                            if (nick2El && secondTeam) {
                                nick2El.textContent = secondTeam.name || '---';
                            }
                            if (score2El && secondTeam) {
                                score2El.textContent = (secondTeam.score || 0) + ' pkt';
                            }
                            
                            p2.style.setProperty('display', 'block', 'important');
                            p2.style.setProperty('visibility', 'visible', 'important');
                            p2.style.setProperty('opacity', '1', 'important');
                            p2.style.setProperty('position', 'relative', 'important');
                            p2.style.setProperty('z-index', '10', 'important');
                            p2.style.setProperty('min-height', '100px', 'important');
                            p2.style.setProperty('width', '100%', 'important');
                            p2.style.setProperty('max-width', '90%', 'important');
                            if (!p2.classList.contains('revealed')) {
                                p2.classList.add('revealed');
                            }
                            console.log('✅ Miejsce 2 również ustawione jako widoczne');
                        }
                        
                        console.log('✅ Miejsce 1 - ustawiono style:', {
                            display: p1.style.display,
                            visibility: p1.style.visibility,
                            opacity: p1.style.opacity,
                            hasRevealed: p1.classList.contains('revealed'),
                            innerHTML: p1.innerHTML.substring(0, 100)
                        });
                        
                        // Dodatkowe sprawdzenie po chwili
                        setTimeout(() => {
                            const computed = window.getComputedStyle(p1);
                            const parentComputed = p1.parentElement ? window.getComputedStyle(p1.parentElement) : null;
                            console.log('✅ Miejsce 1 - szczegółowy stan po 100ms:', {
                                inlineDisplay: p1.style.display,
                                computedDisplay: computed.display,
                                computedVisibility: computed.visibility,
                                computedOpacity: computed.opacity,
                                hasRevealed: p1.classList.contains('revealed'),
                                offsetWidth: p1.offsetWidth,
                                offsetHeight: p1.offsetHeight,
                                clientWidth: p1.clientWidth,
                                clientHeight: p1.clientHeight,
                                parentDisplay: parentComputed ? parentComputed.display : 'brak',
                                parentVisibility: parentComputed ? parentComputed.visibility : 'brak',
                                parentOpacity: parentComputed ? parentComputed.opacity : 'brak',
                                parentId: p1.parentElement ? p1.parentElement.id : 'brak',
                                nick1Text: nick1El ? nick1El.textContent : 'brak',
                                score1Text: score1El ? score1El.textContent : 'brak'
                            });
                            
                            // Jeśli nadal nie jest widoczne, wymuś jeszcze raz
                            if (computed.display === 'none' || p1.offsetWidth === 0 || computed.visibility === 'hidden') {
                                console.warn('⚠️ Miejsce 1 nadal niewidoczne - wymuszam ponownie');
                                p1.style.setProperty('display', 'block', 'important');
                                p1.style.setProperty('visibility', 'visible', 'important');
                                p1.style.setProperty('opacity', '1', 'important');
                                p1.classList.add('revealed');
                                
                                // Sprawdź jeszcze raz po wymuszeniu
                                setTimeout(() => {
                                    const recomputed = window.getComputedStyle(p1);
                                    console.log('🔄 Po wymuszeniu - miejsce 1:', {
                                        display: recomputed.display,
                                        visibility: recomputed.visibility,
                                        opacity: recomputed.opacity,
                                        offsetWidth: p1.offsetWidth,
                                        offsetHeight: p1.offsetHeight
                                    });
                                }, 50);
                            }
                        }, 100);
                    } else {
                        console.error('❌ Nie znaleziono elementu podium-1!');
                    }
                }
            } else {
                // Tryb indywidualny - standardowe podium
                const safeWinners = [
                    winners[0] || { nick: '---', score: 0 },
                    winners[1] || { nick: '---', score: 0 },
                    winners[2] || { nick: '---', score: 0 }
                ];
                
                if (winners && winners.length > 0) {
                    winners.forEach(winner => {
                        if (winner.nick === playerNick) {
                            playerScore = winner.score;
                        }
                    });
                }
                
                document.getElementById('podium-my-nick').textContent = playerNick;
                document.getElementById('podium-my-score').textContent = playerScore + ' pkt';
                
                document.getElementById('nick-1').textContent = safeWinners[0].nick; 
                document.getElementById('score-1').textContent = safeWinners[0].score + ' pkt';
                
                document.getElementById('nick-2').textContent = safeWinners[1].nick; 
                document.getElementById('score-2').textContent = safeWinners[1].score + ' pkt';
                
                document.getElementById('nick-3').textContent = safeWinners[2].nick; 
                document.getElementById('score-3').textContent = safeWinners[2].score + ' pkt';
                
                if (step === 0) {
                    console.log('🔄 RESET PODIUM - ukrywam wszystkie miejsca');
                    p1.classList.remove('revealed');
                    p2.classList.remove('revealed');
                    p3.classList.remove('revealed');
                    waiting.style.display = 'block';
                    currentPodiumStep = 0;
                    return;
                }
                
                if (step >= 1) {
                    waiting.style.display = 'none';
                }
                
                if (step === 3 && !p3.classList.contains('revealed')) {
                    console.log('🥉 POKAZUJĘ 3. MIEJSCE (step=3)');
                    p3.classList.add('revealed');
                }
                
                if (step === 2 && !p2.classList.contains('revealed')) {
                    console.log('🥈 POKAZUJĘ 2. MIEJSCE (step=2)');
                    p2.classList.add('revealed');
                }
                
                if (step === 1 && !p1.classList.contains('revealed')) {
                    console.log('🥇 POKAZUJĘ 1. MIEJSCE (step=1)');
                    p1.classList.add('revealed');
                }
            }
        }
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js', { scope: '/' }).catch(function() {});
        }
    </script>
</body>
</html>
    

