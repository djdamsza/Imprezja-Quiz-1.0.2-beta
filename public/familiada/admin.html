<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Familiada ‚Äì Pilot</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/familiada/suchary.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; padding: 10px; margin: 0; }
        .section { background: #1a1a1a; padding: 15px; margin-bottom: 20px; border-radius: 8px; border: 2px solid #444; }
        h3 { margin: 0 0 15px 0; color: #ffd700; font-size: 16px; font-weight: bold; text-transform: uppercase; border-bottom: 2px solid #555; padding-bottom: 8px; }

        .audio-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .btn-audio { padding: 15px; font-weight: bold; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; color: #000; }

        .btn-reset { background: #c0392b; color: #fff; padding: 16px 24px; font-size: 18px; font-weight: bold; border: 2px solid #e74c3c; border-radius: 8px; cursor: pointer; width: 100%; margin-bottom: 15px; transition: background 0.2s, border-color 0.2s; }
        .btn-reset:hover { background: #e74c3c; }
        .btn-reset.blink-yellow { animation: blinkYellow 0.4s ease-in-out 3; }
        @keyframes blinkYellow { 0%, 100% { background: #c0392b; border-color: #e74c3c; } 50% { background: #f1c40f; border-color: #f39c12; color: #000; } }

        .q-list { display: flex; flex-direction: column; gap: 6px; }
        .q-item { display: flex; flex-direction: column; gap: 0; }
        .q-btn { background: #333; color: #fff; padding: 14px 16px; border-radius: 6px; font-size: 15px; font-weight: bold; border: 2px solid #555; cursor: pointer; text-align: left; }
        .q-btn:hover { background: #444; border-color: #666; }
        .q-btn.active { background: #0055aa; border-color: #00aaff; }
        .q-btn.asked { display: none; }
        .q-panel { display: none; margin-top: 8px; padding: 15px; background: #111; border-radius: 8px; border: 2px solid #444; border-top: 2px solid #00aaff; }
        .q-panel.visible { display: block; }

        .ans-list { display: flex; flex-direction: column; gap: 8px; margin: 12px 0; }
        .ans-item { background: #1a1a1a; padding: 12px 14px; border-radius: 6px; border: 2px solid #444; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .ans-item:hover { border-color: #555; }
        .ans-item.revealed { border-color: #0a0; background: #0a1a0a; cursor: default; }
        .ans-item .ans-pts { color: #ffd700; font-weight: bold; }

        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 12px 0; }
        .team-col { display: flex; flex-direction: column; gap: 6px; background: #111; padding: 10px; border-radius: 8px; }
        .team-title { text-align: center; font-weight: 900; font-size: 13px; margin-bottom: 2px; }
        .team-blue { color: #00aaff; border: 1px solid #003366; }
        .team-red { color: #ff4444; border: 1px solid #660000; }
        .btn-x { padding: 12px; font-size: 16px; font-weight: 900; border: none; border-radius: 6px; color: #fff; cursor: pointer; }
        .blue { background: #004488; } .red { background: #aa0000; }
        .btn-score { padding: 10px; font-size: 12px; font-weight: bold; border: none; border-radius: 6px; color: #fff; cursor: pointer; }
        .btn-score.blue { background: #0055aa; border: 2px solid #00aaff; }
        .btn-score.red { background: #cc0000; border: 2px solid #ff4444; }
        .btn-x-center { width: 100%; background: #333; padding: 10px; margin-top: 6px; }

        .btn-next { width: 100%; padding: 14px; background: #27ae60; color: #fff; font-size: 15px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin-top: 12px; }
        .btn-next:hover { background: #2ecc71; }

        .btn-purple { background: #660099; padding: 20px; font-size: 18px; font-weight: bold; width: 100%; color: #fff; border: none; border-radius: 8px; margin-top: 20px; cursor: pointer; }
        .team-names-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .team-names-row input { padding: 10px 12px; border-radius: 6px; border: 2px solid #555; background: #222; color: #fff; font-size: 14px; }
        .btn-apply-teams { padding: 10px; background: #27ae60; color: #fff; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; }
        .btn-apply-teams:hover { background: #2ecc71; }
        .btn-primary { padding: 10px 16px; background: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { padding: 10px 16px; background: #27ae60; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-flex; align-items: center; }
        .btn-success:hover { background: #2ecc71; }
        .license-input { width: 100%; padding: 12px; border-radius: 6px; border: 2px solid #555; background: #222; color: #fff; font-size: 14px; font-family: monospace; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div class="section" id="license-section" style="border-color: #555;">
        <h3>üîê Licencja</h3>
        <div id="license-status" style="margin-bottom: 15px; padding: 12px; border-radius: 6px; font-size: 0.95rem;">
            <span id="license-status-text">Sprawdzanie...</span>
        </div>
        <div id="license-activation" style="display: none;">
            <input type="text" id="license-key-input" class="license-input" placeholder="IMPREZJA-RSA-... lub IMPREZJA-XXXX-XXXX-XXXX-XXXX" autocomplete="off" style="margin-bottom: 10px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                <button onclick="activateLicense()" class="btn-primary">Aktywuj licencjƒô</button>
            </div>
            <div id="license-error" style="margin-top: 10px; color: #e74c3c; display: none; font-size: 0.9rem;"></div>
        </div>
        <div id="license-info" style="margin-top: 15px; font-size: 0.85rem; color: #888; display: none;">
            <div><strong>ID komputera:</strong> <code id="machine-id-display" style="font-family: monospace; background: #222; padding: 2px 6px; border-radius: 3px;"></code></div>
        </div>
        <div style="margin-top: 15px;">
            <a href="https://nowajakoscrozrywki.pl/produkt/imprezja-quiz/" target="_blank" rel="noopener noreferrer" class="btn-success">üõí Kup licencjƒô</a>
        </div>
    </div>

    <div class="section">
        <button class="btn-reset" id="btn-reset">üîÑ ZERUJ PUNKTY (0:0)</button>

        <h3>üìÇ WCZYTAJ LISTƒò PYTA≈É</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
            <select id="familiada-files-list" style="flex: 1; min-width: 180px; padding: 12px; border-radius: 6px; border: 2px solid #555; background: #222; color: #fff; font-size: 14px;">
                <option value="">-- Wybierz plik --</option>
            </select>
            <button class="btn-apply-teams" onclick="loadFamiliadaFile()" style="margin: 0;">Za≈Çaduj</button>
        </div>
        <p style="color:#888; font-size:12px; margin-top: -8px; margin-bottom: 15px;">Wybierz zapisanƒÖ listƒô pyta≈Ñ i za≈Çaduj jƒÖ do gry.</p>

        <h3>üë• NAZWY DRU≈ªYN</h3>
        <div class="team-names-row">
            <input type="text" id="fam-team-1" placeholder="Niebiescy" value="Niebiescy">
            <input type="text" id="fam-team-2" placeholder="Czerwoni" value="Czerwoni">
        </div>
        <button class="btn-apply-teams" onclick="applyTeamNames()">Zastosuj nazwy</button>
        <h3>üéõÔ∏è PANEL AUDIO</h3>
        <div class="audio-panel">
            <button class="btn-audio" id="btn-intro" style="background: #ffaa00;" onclick="toggleIntro()">üéµ INTRO START/STOP</button>
            <button class="btn-audio" style="background: #00bcd4;" onclick="playJingle()">üîî D≈ªINGIEL</button>
        </div>

        <h3>üòÑ SUCHARY</h3>
        <button class="btn-audio" style="background: #9b59b6; width: 100%; padding: 18px; margin-bottom: 10px;" onclick="dajSuchara()">üé≠ DAJ SUCHARA</button>
        <div id="suchar-display" style="display:none; margin-top:12px; padding:15px; background:#222; border-radius:8px; border:2px solid #9b59b6; font-size:17px; line-height:1.5; color:#ffd700; margin-bottom: 15px;">
            <div id="suchar-content"></div>
            <div id="suchar-meta" style="margin-top:10px; font-size:15px; color:#9b59b6;"></div>
            <button id="suchar-usun" onclick="usunSuchara()" style="margin-top:10px; padding:8px 16px; background:#c0392b; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">Usu≈Ñ</button>
        </div>

        <h3>üìã PYTANIA (z pliku JSON)</h3>
        <p style="color:#888; font-size:13px; margin-bottom:10px;">Wybierz plik powy≈ºej i za≈Çaduj. Kliknij pytanie ‚Üí wy≈õwietla na tablicy.</p>
        <div id="questions-container" class="q-list"></div>
    </div>

    <div class="section" style="border-color: #b8860b;">
        <h3>‚≠ê Z≈ÅOTA LISTA (na dole)</h3>
        <p style="color:#888; font-size:13px; margin-bottom:10px;">Zawsze za≈Çadowana ‚Äì ulubione pytania gotowe do zadania. Mo≈ºna korzystaƒá r√≥wnolegle z g≈Ç√≥wnej listy. Punkty jak zwykle.</p>
        <div id="golden-questions-list" class="q-list"></div>
        <button class="btn-purple" onclick="socket.emit('show_final')" style="margin-top: 20px;">üèÜ EKRAN KO≈ÉCOWY (OUTRO)</button>
    </div>

    <script>
        const socket = io();
        let goldenList = [];
        function registerAdmin() {
            socket.emit('register_familiada', { role: 'admin' });
            socket.emit('familiada_get_files');
        }
        if (socket.connected) registerAdmin();
        else socket.once('connect', registerAdmin);

        checkLicenseStatus();

        async function checkLicenseStatus() {
            try {
                const response = await fetch('/api/license/status');
                const status = await response.json();
                updateLicenseUI(status);
                const machineIdResponse = await fetch('/api/license/machine-id');
                const machineData = await machineIdResponse.json();
                document.getElementById('machine-id-display').textContent = machineData.machineId;
                document.getElementById('license-info').style.display = 'block';
            } catch (err) {
                console.error('B≈ÇƒÖd sprawdzania licencji:', err);
                document.getElementById('license-status-text').textContent = '‚ùå B≈ÇƒÖd sprawdzania licencji';
            }
        }

        function updateLicenseUI(status) {
            const statusEl = document.getElementById('license-status');
            const statusTextEl = document.getElementById('license-status-text');
            const activationEl = document.getElementById('license-activation');
            if (status.valid) {
                if (status.type === 'trial') {
                    statusEl.style.background = 'rgba(241, 196, 15, 0.15)';
                    statusEl.style.border = '1px solid rgba(241, 196, 15, 0.3)';
                    statusTextEl.innerHTML = `‚úÖ <strong>Okres testowy aktywny</strong><br>Pozosta≈Ço dni: <strong>${status.daysLeft}</strong>`;
                    activationEl.style.display = 'block';
                } else if (status.type === 'test') {
                    statusEl.style.background = 'rgba(155, 89, 182, 0.15)';
                    statusEl.style.border = '1px solid rgba(155, 89, 182, 0.3)';
                    statusTextEl.innerHTML = `‚úÖ <strong>Licencja testowa</strong> (klucz deweloperski)`;
                    activationEl.style.display = 'block';
                } else {
                    statusEl.style.background = 'rgba(46, 204, 113, 0.15)';
                    statusEl.style.border = '1px solid rgba(46, 204, 113, 0.3)';
                    const typeLabel = status.typeLabel || 'pe≈Çna';
                    if (status.expires) {
                        const expiresDate = new Date(status.expires);
                        statusTextEl.innerHTML = `‚úÖ <strong>Licencja aktywna</strong> (${typeLabel})<br>Wygasa: ${expiresDate.toLocaleDateString()}`;
                    } else {
                        statusTextEl.innerHTML = `‚úÖ <strong>Licencja aktywna</strong> (${typeLabel})<br>${typeLabel === 'do≈ºywotnia' ? 'Licencja bezterminowa' : ''}`;
                    }
                    activationEl.style.display = 'none';
                }
            } else {
                statusEl.style.background = 'rgba(231, 76, 60, 0.15)';
                statusEl.style.border = '1px solid rgba(231, 76, 60, 0.3)';
                statusTextEl.innerHTML = `‚ùå <strong>Licencja niewa≈ºna</strong><br>${status.reason || (status.trial && status.trial.reason) || 'Nieznany b≈ÇƒÖd'}`;
                activationEl.style.display = 'block';
            }
        }

        async function activateLicense() {
            const keyInput = document.getElementById('license-key-input');
            const key = keyInput.value.trim();
            const errorEl = document.getElementById('license-error');
            if (!key) {
                errorEl.textContent = 'Wprowad≈∫ klucz licencyjny';
                errorEl.style.display = 'block';
                return;
            }
            try {
                const response = await fetch('/api/license/activate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key })
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    errorEl.style.display = 'none';
                    keyInput.value = '';
                    await checkLicenseStatus();
                } else {
                    errorEl.textContent = result.error || 'B≈ÇƒÖd aktywacji licencji';
                    errorEl.style.display = 'block';
                }
            } catch (err) {
                errorEl.textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia z serwerem';
                errorEl.style.display = 'block';
            }
        }

        function populateFileList(files) {
            const sel = document.getElementById('familiada-files-list');
            const curr = sel.value;
            sel.innerHTML = '<option value="">-- Wybierz plik --</option>';
            (files || []).forEach(f => {
                const opt = document.createElement('option');
                opt.value = f;
                opt.textContent = f.replace('.json', '');
                sel.appendChild(opt);
            });
            if (files && files.includes(curr)) sel.value = curr;
        }
        fetch('/api/familiada/files').then(r => r.json()).then(populateFileList).catch(() => {});

        function loadGoldenList() {
            renderGoldenList();
        }
        loadGoldenList();
        fetch('/api/familiada/data').then(r => r.json()).then(data => {
            allQuestions = Array.isArray(data) ? data : [];
            renderQuestions();
        }).catch(() => {});

        socket.on('familiada_files_list', populateFileList);
        socket.on('familiada_load_ok', () => {});
        socket.on('familiada_load_error', (msg) => {
            alert('B≈ÇƒÖd: ' + (msg || 'Nieznany'));
        });
        socket.on('familiada_golden_list', (list) => {
            goldenList = list || [];
            renderGoldenList();
        });
        socket.on('familiada_golden_updated', (list) => {
            goldenList = list || [];
            renderGoldenList();
        });
        let activeGoldenIdx = null;
        function renderGoldenList() {
            const container = document.getElementById('golden-questions-list');
            container.innerHTML = '';
            if (!goldenList.length) {
                container.innerHTML = '<div style="padding:12px; color:#888; font-size:14px;">Brak pyta≈Ñ w z≈Çotej li≈õcie. Dodaj w edytorze (‚òÜ).</div>';
                return;
            }
            goldenList.forEach((q, idx) => {
                const item = document.createElement('div');
                item.className = 'q-item';
                const btn = document.createElement('button');
                btn.className = 'q-btn' + (activeGoldenIdx === idx ? ' active' : '');
                btn.textContent = (idx + 1) + '. ' + (q.question || '(bez tre≈õci)');
                btn.onclick = () => selectGoldenQuestion(idx);
                const panel = document.createElement('div');
                panel.className = 'q-panel' + (activeGoldenIdx === idx ? ' visible' : '');
                panel.id = 'golden-panel-' + idx;
                item.appendChild(btn);
                item.appendChild(panel);
                container.appendChild(item);
            });
            if (activeGoldenIdx !== null) renderGoldenPanel();
        }
        function selectGoldenQuestion(idx) {
            socket.emit('select_golden_question', idx);
            activeGoldenIdx = idx;
            activeQuestionIdx = null;
            renderQuestions();
            renderGoldenList();
            renderGoldenPanel();
        }
        function renderGoldenPanel() {
            const panel = document.getElementById('golden-panel-' + activeGoldenIdx);
            const q = goldenList[activeGoldenIdx];
            if (!panel || !q) return;
            panel.classList.add('visible');
            panel.innerHTML = `
                <h4 style="margin:0 0 12px 0; color:#ffd700; font-size:15px;">${escapeHtml(q.question)}</h4>
                <div class="ans-list" id="golden-ans-list"></div>
                <div class="controls-grid">
                    <div class="team-col team-blue">
                        <div class="team-title">NIEBIESCY</div>
                        <button class="btn-x blue" onclick="sendError(1,1)">X</button>
                        <button class="btn-x blue" onclick="sendError(1,2)">XX</button>
                        <button class="btn-x blue" onclick="sendError(1,3)">XXX</button>
                        <button class="btn-score blue" onclick="addPoints(1)">üí∞ PRZEKA≈ª</button>
                    </div>
                    <div class="team-col team-red">
                        <div class="team-title">CZERWONI</div>
                        <button class="btn-x red" onclick="sendError(2,1)">X</button>
                        <button class="btn-x red" onclick="sendError(2,2)">XX</button>
                        <button class="btn-x red" onclick="sendError(2,3)">XXX</button>
                        <button class="btn-score red" onclick="addPoints(2)">üí∞ PRZEKA≈ª</button>
                    </div>
                </div>
                <button class="btn-x btn-x-center" onclick="sendError(0,1)">X (≈öRODEK)</button>
                <button class="btn-next" onclick="closeGoldenPanel()">‚Üê ZAMKNIJ / DZINGIEL</button>
            `;
            const ansList = document.getElementById('golden-ans-list');
            q.answers.forEach((ans, ai) => {
                const aDiv = document.createElement('div');
                aDiv.className = 'ans-item';
                aDiv.dataset.points = ans.points;
                aDiv.innerHTML = `<span>${ai + 1}. ${escapeHtml(ans.text)}</span><span class="ans-pts">${ans.points}</span>`;
                aDiv.onclick = () => revealAnswer(ai + 1, aDiv);
                ansList.appendChild(aDiv);
            });
        }
        function closeGoldenPanel() {
            if (activeGoldenIdx !== null) {
                const p = document.getElementById('golden-panel-' + activeGoldenIdx);
                if (p) { p.classList.remove('visible'); p.innerHTML = ''; }
                activeGoldenIdx = null;
            }
            renderGoldenList();
            socket.emit('play_sound', 'jingle');
        }

        async function loadFamiliadaFile() {
            const filename = document.getElementById('familiada-files-list').value;
            if (!filename) return alert('Wybierz plik!');
            try {
                const res = await fetch('/api/familiada/data?file=' + encodeURIComponent(filename) + '&_=' + Date.now());
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'B≈ÇƒÖd ≈Çadowania');
                allQuestions = Array.isArray(data) ? data : [];
                renderQuestions();
                socket.emit('familiada_load_file', filename);
                alert('Za≈Çadowano ' + allQuestions.length + ' pyta≈Ñ.');
            } catch (err) {
                alert('B≈ÇƒÖd: ' + (err.message || 'Nieznany'));
            }
        }

        let currentScores = { t1: 0, t2: 0 };

        const SUCHARY_REMOVED_KEY = 'familiada_suchary_removed';
        function getRemovedSucharyIds() {
            try {
                const s = localStorage.getItem(SUCHARY_REMOVED_KEY);
                return s ? JSON.parse(s) : [];
            } catch (e) { return []; }
        }
        function setRemovedSucharyId(id) {
            const r = getRemovedSucharyIds();
            if (!r.includes(id)) { r.push(id); localStorage.setItem(SUCHARY_REMOVED_KEY, JSON.stringify(r)); }
        }
        function getAvailableSucharyIndices() {
            const removed = getRemovedSucharyIds();
            return (typeof SUCHARY_DATA !== 'undefined' ? SUCHARY_DATA : []).map((_, i) => i).filter(i => !removed.includes(i));
        }
        function updateResetButton() {
            const btn = document.getElementById('btn-reset');
            if (btn) btn.textContent = 'üîÑ ZERUJ PUNKTY (' + currentScores.t1 + ':' + currentScores.t2 + ')';
        }
        function doReset() {
            const btn = document.getElementById('btn-reset');
            const hasPoints = currentScores.t1 > 0 || currentScores.t2 > 0;
            if (hasPoints && btn) {
                btn.classList.add('blink-yellow');
                btn.addEventListener('animationend', function h() { btn.classList.remove('blink-yellow'); btn.removeEventListener('animationend', h); }, { once: true });
            }
            socket.emit('reset_game');
            currentScores = { t1: 0, t2: 0 };
            setTimeout(updateResetButton, 100);
        }
        document.getElementById('btn-reset').onclick = doReset;

        function toggleIntro() {
            socket.emit('play_sound', 'intro');
        }
        function playJingle() {
            socket.emit('play_sound', 'jingle');
        }
        function dajSuchara() {
            const avail = getAvailableSucharyIndices();
            if (!avail.length) {
                document.getElementById('suchar-content').innerHTML = 'Brak dostƒôpnych suchar√≥w (wszystkie usuniƒôte). <a href="#" onclick="przywrocSuchary(); return false;" style="color:#9b59b6;">Przywr√≥ƒá bazƒô</a>';
                document.getElementById('suchar-meta').textContent = '';
                document.getElementById('suchar-usun').style.display = 'none';
                document.getElementById('suchar-display').style.display = 'block';
                return;
            }
            const idx = avail[Math.floor(Math.random() * avail.length)];
            const s = SUCHARY_DATA[idx];
            document.getElementById('suchar-content').textContent = s.text;
            document.getElementById('suchar-meta').textContent = s.date ? 'Data emisji: ' + s.date : '';
            document.getElementById('suchar-usun').style.display = 'block';
            document.getElementById('suchar-usun').dataset.idx = String(idx);
            document.getElementById('suchar-display').style.display = 'block';
        }
        function usunSuchara() {
            const btn = document.getElementById('suchar-usun');
            const idx = btn && btn.dataset.idx;
            if (idx !== undefined) {
                setRemovedSucharyId(parseInt(idx, 10));
                document.getElementById('suchar-display').style.display = 'none';
            }
        }
        function przywrocSuchary() {
            localStorage.removeItem(SUCHARY_REMOVED_KEY);
            dajSuchara();
        }

        let allQuestions = [];
        let askedIndices = new Set();
        let activeQuestionIdx = null;

        function refreshQuestions(data) {
            allQuestions = data || [];
            renderQuestions();
        }
        socket.on('init_admin', refreshQuestions);
        socket.on('familiada_data_updated', refreshQuestions);

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            if (!container) return;
            container.innerHTML = '';
            if (!allQuestions.length) {
                container.innerHTML = '<div style="padding:15px; color:#e74c3c;">Brak pyta≈Ñ! U≈ºyj edytora.</div>';
                return;
            }
            const remaining = allQuestions.filter((_, i) => !askedIndices.has(i));
            if (remaining.length === 0) {
                container.innerHTML = '<div style="padding:15px; color:#888;">Wszystkie pytania zadane.</div>';
                return;
            }
            allQuestions.forEach((q, idx) => {
                if (askedIndices.has(idx)) return;
                const item = document.createElement('div');
                item.className = 'q-item';
                item.dataset.index = idx;
                const btn = document.createElement('button');
                btn.className = 'q-btn' + (activeQuestionIdx === idx ? ' active' : '');
                btn.dataset.index = idx;
                btn.textContent = (idx + 1) + '. ' + q.question;
                btn.onclick = () => selectQuestion(idx);
                const panel = document.createElement('div');
                panel.className = 'q-panel' + (activeQuestionIdx === idx ? ' visible' : '');
                panel.id = 'q-panel-' + idx;
                item.appendChild(btn);
                item.appendChild(panel);
                container.appendChild(item);
            });
            if (activeQuestionIdx !== null) renderActivePanel();
        }

        function selectQuestion(idx) {
            if (askedIndices.has(idx)) return;
            socket.emit('select_question', idx);
            activeQuestionIdx = idx;
            renderQuestions();
            renderActivePanel();
        }

        function renderActivePanel() {
            const panel = document.getElementById('q-panel-' + activeQuestionIdx);
            const q = allQuestions[activeQuestionIdx];
            if (!panel || !q) return;
            panel.classList.add('visible');
            panel.innerHTML = `
                <h4 style="margin:0 0 12px 0; color:#ffd700; font-size:15px;">${escapeHtml(q.question)}</h4>
                <div class="ans-list" id="active-ans-list"></div>
                <div class="controls-grid">
                    <div class="team-col team-blue">
                        <div class="team-title">NIEBIESCY</div>
                        <button class="btn-x blue" onclick="sendError(1,1)">X</button>
                        <button class="btn-x blue" onclick="sendError(1,2)">XX</button>
                        <button class="btn-x blue" onclick="sendError(1,3)">XXX</button>
                        <button class="btn-score blue" onclick="addPoints(1)">üí∞ PRZEKA≈ª</button>
                    </div>
                    <div class="team-col team-red">
                        <div class="team-title">CZERWONI</div>
                        <button class="btn-x red" onclick="sendError(2,1)">X</button>
                        <button class="btn-x red" onclick="sendError(2,2)">XX</button>
                        <button class="btn-x red" onclick="sendError(2,3)">XXX</button>
                        <button class="btn-score red" onclick="addPoints(2)">üí∞ PRZEKA≈ª</button>
                    </div>
                </div>
                <button class="btn-x btn-x-center" onclick="sendError(0,1)">X (≈öRODEK)</button>
                <button class="btn-next" onclick="closeActivePanel()">‚Üê ZAMKNIJ / DZINGIEL</button>
            `;
            const ansList = document.getElementById('active-ans-list');
            q.answers.forEach((ans, ai) => {
                const aDiv = document.createElement('div');
                aDiv.className = 'ans-item';
                aDiv.dataset.points = ans.points;
                aDiv.innerHTML = `<span>${ai + 1}. ${escapeHtml(ans.text)}</span><span class="ans-pts">${ans.points}</span>`;
                aDiv.onclick = () => revealAnswer(ai + 1, aDiv);
                ansList.appendChild(aDiv);
            });
        }

        function escapeHtml(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        function closeActivePanel() {
            if (activeQuestionIdx !== null) {
                const p = document.getElementById('q-panel-' + activeQuestionIdx);
                if (p) { p.classList.remove('visible'); p.innerHTML = ''; }
                askedIndices.add(activeQuestionIdx);
                activeQuestionIdx = null;
            }
            renderQuestions();
            socket.emit('play_sound', 'jingle');
        }

        function sendToBoard(idx) {
            if (askedIndices.has(idx)) return;
            socket.emit('select_question', idx);
        }

        function revealAnswer(index, el) {
            if (el.classList.contains('revealed')) return;
            socket.emit('reveal_answer', index);
            el.classList.add('revealed');
        }

        socket.on('update_scores', (data) => {
            if (data && typeof data.t1 === 'number' && typeof data.t2 === 'number') {
                currentScores = { t1: data.t1, t2: data.t2 };
                updateResetButton();
            }
            if (navigator.vibrate) navigator.vibrate(50);
        });
        socket.on('familiada_team_names', (data) => {
            const i1 = document.getElementById('fam-team-1');
            const i2 = document.getElementById('fam-team-2');
            if (i1 && data.team1) i1.value = data.team1;
            if (i2 && data.team2) i2.value = data.team2;
        });

        function applyTeamNames() {
            const t1 = document.getElementById('fam-team-1').value.trim() || 'Niebiescy';
            const t2 = document.getElementById('fam-team-2').value.trim() || 'Czerwoni';
            socket.emit('familiada_set_team_names', { team1: t1, team2: t2 });
        }

        function sendError(team, count) { socket.emit('send_error', { team, count }); }

        function addPoints(team) {
            if (activeQuestionIdx === null) return;
            const revealed = document.querySelectorAll('#active-ans-list .ans-item.revealed');
            const pot = Array.from(revealed).reduce((s, el) => s + parseInt(el.dataset.points || 0), 0);
            if (pot === 0 && !confirm('Pula wynosi 0. Zatwierdziƒá rundƒô?')) return;
            socket.emit('add_points', { team, points: pot, playSound: true });
        }

        socket.on('board_update', (msg) => {
            if (msg.type === 'FULL_RESET') {
                askedIndices.clear();
                activeQuestionIdx = null;
                if (activeGoldenIdx !== null) {
                    const p = document.getElementById('golden-panel-' + activeGoldenIdx);
                    if (p) { p.classList.remove('visible'); p.innerHTML = ''; }
                    activeGoldenIdx = null;
                }
                document.querySelectorAll('.q-panel').forEach(p => { p.classList.remove('visible'); p.innerHTML = ''; });
                renderQuestions();
            }
        });
    </script>
</body>
</html>
