<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zaawansowany Edytor Quiz√≥w - Imprezja Quiz</title>
    <meta name="copyright" content="¬© Damian Nowaczyk. Wszelkie prawa zastrze≈ºone.">
    <link rel="icon" href="data:,">
    <link rel="manifest" href="/manifest.json">
    <script src="/socket.io/socket.io.js"></script>
    <!-- Fonty systemowe ‚Äì dzia≈Çanie offline. Kolorystyka sp√≥jna z vote/Screen. -->
    <style>
        :root {
            --bg-dark: radial-gradient(circle at center, #1a1a2e, #000);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-gold: #f1c40f;
            --accent-orange: #e67e22;
            --text-white: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.75);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-dark); padding: 20px; margin: 0; color: var(--text-white); min-height: 100vh; }
        .container { max-width: 1100px; margin: 0 auto; background: var(--glass-bg); padding: 30px; border-radius: 15px; border: 1px solid var(--glass-border); backdrop-filter: blur(10px); }
        h1 { text-align: center; color: var(--accent-gold); margin-bottom: 30px; font-weight: 700; }
        .control-panel { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); margin-bottom: 25px; }
        .panel-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 15px; }
        .panel-row:last-child { margin-bottom: 0; }
        .form-group { flex: 1; min-width: 200px; }
        label { font-weight: 600; display: block; margin-bottom: 6px; font-size: 0.9em; color: var(--text-muted); }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid var(--glass-border); border-radius: 6px; font-size: 14px; box-sizing: border-box; background: rgba(0,0,0,0.3); color: var(--text-white); }
        input::placeholder { color: var(--text-muted); }
        .checkbox-card { display: flex; align-items: center; gap: 10px; background: var(--glass-bg); padding: 8px 15px; border: 1px solid var(--glass-border); border-radius: 6px; height: 38px; box-sizing: border-box; cursor: pointer; color: var(--text-white); }
        .checkbox-card input { width: 18px; height: 18px; margin: 0; cursor: pointer; }
        .checkbox-card:hover { background: rgba(255,255,255,0.12); border-color: var(--accent-gold); }
        .question-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; padding: 20px; margin-bottom: 25px; position: relative; transition: all 0.2s; border-left: 5px solid var(--accent-gold); }
        .question-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.3); transform: translateY(-2px); }
        .question-card.validation-error { border-color: #e74c3c; box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.5); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
        .q-number { font-weight: 700; font-size: 1.1em; color: var(--accent-gold); }
        .media-section { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px dashed var(--glass-border); }
        .media-preview { max-width: 100%; max-height: 150px; margin-top: 10px; display: block; border-radius: 4px; object-fit: contain; }
        .loader { border: 3px solid var(--glass-border); border-top: 3px solid var(--accent-gold); border-radius: 50%; width: 15px; height: 15px; animation: spin 1s linear infinite; display: inline-block; margin-left: 10px; vertical-align: middle; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .answers-section { margin-top: 20px; }
        .answer-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; background: var(--glass-bg); border-radius: 6px; }
        .ans-badge { width: 30px; font-weight: bold; text-align: center; color: var(--text-muted); }
        .ans-correct-check { width: 20px; height: 20px; cursor: pointer; accent-color: #2ecc71; }
        .ans-img-btn { padding: 5px 10px; font-size: 12px; background: var(--glass-bg); color: var(--text-white); border: 1px solid var(--glass-border); border-radius: 4px; cursor: pointer; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-gold), var(--accent-orange)); color: #000; }
        .btn-success { background: #2ecc71; color: #000; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f1c40f; color: #000; }
        .btn-info { background: #3498db; color: white; }
        .btn-dark { background: rgba(0,0,0,0.5); color: var(--text-white); border: 1px solid var(--glass-border); }
        .btn-secondary { background: var(--glass-bg); color: var(--text-white); border: 1px solid var(--glass-border); }
        .btn-full { width: 100%; margin-top: 10px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: rgba(26, 26, 46, 0.98); padding: 25px; border-radius: 12px; border: 1px solid var(--glass-border); width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; color: var(--text-white); }
        .modal h3 { margin-top: 0; color: var(--accent-gold); }
        textarea.json-paste { width: 100%; height: 300px; font-family: monospace; padding: 10px; border: 1px solid var(--glass-border); border-radius: 6px; resize: vertical; margin: 15px 0; background: rgba(0,0,0,0.3); color: var(--text-white); }
        
        /* Odznaki typ√≥w pyta≈Ñ (jak w admin.html) */
        .type-badges { display: flex; gap: 4px; flex-wrap: wrap; align-items: center; margin-right: 8px; flex-shrink: 0; }
        .type-badge { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; font-weight: 800; font-size: 0.85rem; border-radius: 4px; color: #fff; }
        .type-badge-S { background: #e67e22; }
        .type-badge-E { background: #c62828; }
        .type-badge-H { background: #e91e63; }
        .type-badge-Q { background: #2196f3; }
        .type-badge-M { background: #9c27b0; }
        .type-badge-V { background: #ff9800; }
        .type-badge-F { background: #00bcd4; }
        .type-badge-Z { background: #5c6bc0; }
        .type-badge-O { background: #2e7d32; }
        .legend-section { background: var(--glass-bg); padding: 15px 20px; margin: 20px 0; border-radius: 8px; border: 1px solid var(--glass-border); }
        .legend-section h3 { margin: 0 0 10px 0; font-size: 1rem; color: var(--accent-gold); }
        .legend-grid { display: flex; flex-direction: column; gap: 8px; font-size: 0.9rem; color: var(--text-muted); }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        /* Legenda w jednej kolumnie - nadpisuje domy≈õlny uk≈Çad */
        .legend-section .legend-grid.legend-single-column { display: flex; flex-direction: column; gap: 8px; }
        .legend-type-badge { display: inline-flex; align-items: center; padding: 4px 10px; min-height: 28px; font-weight: 700; font-size: 0.8rem; border-radius: 6px; color: #fff; white-space: nowrap; background: #9c27b0; }
        .btn-move { padding: 8px 10px; min-width: 36px; min-height: 36px; }
        .btn-move svg { width: 20px; height: 20px; display: block; }
        .btn-move:hover { background: rgba(241, 196, 15, 0.25); border-color: var(--accent-gold); }
    </style>
</head>
<body>

<div class="container">
    <h1>üéõÔ∏è Zaawansowany Edytor Quiz√≥w (Auto-Optymalizacja)</h1>

    <div class="control-panel">
        <div class="panel-row">
            <div class="form-group" style="flex: 2;">
                <label>üìÇ Pliki na serwerze:</label>
                <div style="display: flex; gap: 10px;">
                    <select id="server-files-list">
                        <option value="">-- Wybierz plik --</option>
                    </select>
                    <button class="btn btn-info" onclick="loadFromServer()">üì• Wczytaj</button>
                    <button class="btn btn-danger" onclick="openDeleteModal()" id="delete-btn" disabled>üóëÔ∏è Usu≈Ñ</button>
                </div>
            </div>
            <div class="form-group">
                <label>Szybkie akcje:</label>
                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                    <button class="btn btn-dark" onclick="openPasteModal()">üìã Wklej JSON</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()">üìÇ Z dysku</button>
                    <button class="btn btn-info" onclick="document.getElementById('package-input').click()">üì¶ Importuj pakiet (ZIP)</button>
                    <input type="file" id="file-input" accept=".json" style="display: none;" onchange="loadFromFile(this)">
                    <input type="file" id="package-input" accept=".zip" style="display: none;" onchange="loadFromPackage(this)">
                </div>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <div class="panel-row">
            <div class="form-group">
                <label>Nazwa pliku (ID)</label>
                <input type="text" id="filename" placeholder="np. quiz_muzyczny">
            </div>
            <div class="form-group">
                <label>Opcje gry</label>
                <div class="checkbox-card" onclick="document.getElementById('disableTimePoints').click()">
                    <input type="checkbox" id="disableTimePoints" onclick="event.stopPropagation()">
                    <span>üö´ Wy≈ÇƒÖcz punkty za czas (tylko poprawno≈õƒá)</span>
                </div>
            </div>
        </div>
        <div class="panel-row">
            <div class="form-group" style="flex: 1;">
                <label>üéâ Ekran ko≈Ñcowy (opcjonalny)</label>
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px dashed var(--glass-border); margin-top: 10px;">
                    <p style="font-size: 0.85em; color: var(--text-muted); margin-bottom: 15px;">
                        Je≈õli nie wype≈Çnisz ekranu ko≈Ñcowego, zostanie wy≈õwietlony domy≈õlny tekst: "Dziƒôkujƒô za udzia≈Ç w zabawie" wraz z tytu≈Çem quizu.
                    </p>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 0.9em;">Tekst podziƒôkowania:</label>
                        <textarea id="thanks-text" placeholder="np. Dziƒôkujemy za udzia≈Ç w quizie! Do zobaczenia nastƒôpnym razem!" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid var(--glass-border); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--text-white); font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                    </div>
                    <div>
                        <label style="font-size: 0.9em;">Obrazek (opcjonalny):</label>
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <input type="text" id="thanks-image" placeholder="/uploads/obrazek.webp" class="media-input" style="flex: 1;">
                            <button type="button" class="btn btn-info" onclick="document.getElementById('thanks-image-file').click()">üìÅ Wybierz</button>
                            <input type="file" id="thanks-image-file" accept="image/*" style="display: none;" onchange="handleThanksImageUpload(this)">
                        </div>
                        <div id="thanks-image-preview" style="margin-top: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="questions-container"></div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr; gap: 10px; margin: 20px 0;">
        <button class="btn btn-primary btn-full" onclick="addQuestion('QUIZ')" style="margin:0;">QUIZ (Wielokrotny)</button>
        <button class="btn btn-warning btn-full" onclick="addQuestion('VOTE')" style="margin:0;">G≈Çosowanie</button>
        <button class="btn btn-success btn-full" onclick="addQuestion('MUSIC')" style="margin:0;">Muzyka</button>
        <button class="btn btn-info btn-full" onclick="addQuestion('VOTE_IMG')" style="margin:0;">Foto G≈Ços</button>
        <button class="btn" onclick="addQuestion('HOT_OR_NOT')" style="margin:0; background: #e91e63; color: white;">HOT OR NOT</button>
        <button class="btn" onclick="addQuestion('ESTIMATION')" style="margin:0; background: #5c6bc0; color: white;">Szacowanie</button>
        <button class="btn" onclick="addQuestion('OPEN')" style="margin:0; background: #2e7d32; color: white;">Pytanie otwarte</button>
        <button class="btn" onclick="addQuestion('LETTER')" style="margin:0; background: #9c27b0; color: white;">üî§ Pytanie z literƒÖ</button>
        <button class="btn" onclick="addQuestion('SHIPS')" style="margin:0; background: #0066cc; color: white;">‚öì Statki</button>
    </div>

    <!-- LEGENDA TYP√ìW PYTA≈É -->
    <div class="legend-section">
        <h3>üìã Legenda typ√≥w pyta≈Ñ</h3>
        <div class="legend-grid legend-single-column">
            <div class="legend-item"><strong>Speedrun</strong> ‚Äì punkty tylko dla 10 pierwszych (1000‚Üí100)</div>
            <div class="legend-item"><strong>Eliminacja</strong> ‚Äì z≈Ça odpowied≈∫ = odpadasz, wynik zerowany</div>
            <div class="legend-item"><strong>Szacowanie</strong> ‚Äì gracze wpisujƒÖ liczbƒô, wygrywa najbli≈ºszy</div>
            <div class="legend-item"><strong>Hot or Not</strong> ‚Äì dwa obrazki, wyb√≥r A lub B</div>
            <div class="legend-item"><strong>Quiz</strong> ‚Äì pytanie z poprawnƒÖ odpowiedziƒÖ (wielokrotny wyb√≥r)</div>
            <div class="legend-item"><strong>G≈Çosowanie</strong> ‚Äì wyb√≥r A lub B (bez poprawnej odpowiedzi)</div>
            <div class="legend-item"><strong>Foto g≈Ços</strong> ‚Äì g≈Çosowanie z obrazkiem</div>
            <div class="legend-item"><strong>Pytanie otwarte</strong> ‚Äì chmura s≈Ç√≥w, dogrywka TAK/NIE (bez punkt√≥w)</div>
            <div class="legend-item"><strong>Pytanie z literƒÖ</strong> ‚Äì gracze wpisujƒÖ wyraz na przypisanƒÖ literƒô, chmura s≈Ç√≥w, dogrywka TAK/NIE</div>
            <div class="legend-item"><strong>Muzyka</strong> ‚Äì pytanie z d≈∫wiƒôkiem</div>
            <div class="legend-item"><strong>Statki</strong> ‚Äì gra w statki, strza≈Çy po kolei, trafienie = 100 pkt</div>
        </div>
    </div>

    <div class="panel-row" style="margin-top: 40px; border-top: 2px solid var(--glass-border); padding-top: 20px;">
        <button class="btn btn-dark btn-full" onclick="downloadQuiz()" style="font-size: 1.1em; padding: 15px;">üíæ Pobierz Plik (.json)</button>
        <button class="btn btn-info btn-full" onclick="downloadPackage()" style="font-size: 1.1em; padding: 15px;">üì¶ Pobierz Pakiet (JSON + pliki)</button>
        <button class="btn btn-primary btn-full" onclick="saveToServer()" style="font-size: 1.1em; padding: 15px;">‚òÅÔ∏è Zapisz na Serwerze</button>
    </div>
</div>

<p style="text-align: center; font-size: 0.75rem; color: var(--text-muted); margin: 20px 0;">¬© Damian Nowaczyk. Wszelkie prawa zastrze≈ºone.</p>

<div class="modal-overlay" id="pasteModal">
    <div class="modal">
        <h3>Wklej kod JSON</h3>
        <p style="font-size: 0.9em; color: #666;">Wklej tre≈õƒá pliku JSON. Dla quizu z obrazkami/audio u≈ºyj ‚ÄûImportuj pakiet‚Äù ‚Äì wgraj plik .zip (quiz + pliki).</p>
        <textarea id="pasteArea" class="json-paste"></textarea>
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button class="btn btn-secondary" onclick="document.getElementById('pasteModal').style.display='none'">Anuluj</button>
            <button class="btn btn-success" onclick="loadFromPaste()">Za≈Çaduj</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="deleteModal">
    <div class="modal" style="max-height: 90vh; overflow-y: auto;">
        <h3>üóëÔ∏è Usuwanie quizu</h3>
        <p style="font-size: 0.9em; color: #666;">Wybierz opcjƒô usuwania dla pliku: <strong id="delete-filename"></strong></p>
        <div id="delete-related-files" style="margin: 15px 0; padding: 15px; background: rgba(241, 196, 15, 0.15); border-radius: 8px; border: 1px solid var(--accent-gold);">
            <p style="margin: 0 0 10px 0; font-weight: 600;">Znalezione powiƒÖzane pliki:</p>
            <ul id="delete-files-list" style="margin: 0; padding-left: 20px; font-size: 0.9em;">
                <li>≈Åadowanie...</li>
            </ul>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border: 2px solid #dc3545; border-radius: 8px;">
                <input type="radio" name="delete-option" value="all" checked>
                <div>
                    <strong>Usu≈Ñ wszystko</strong>
                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Usu≈Ñ plik JSON + wszystkie powiƒÖzane pliki graficzne, d≈∫wiƒôkowe i miniatury</div>
                </div>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border: 2px solid #6c757d; border-radius: 8px;">
                <input type="radio" name="delete-option" value="json-only">
                <div>
                    <strong>Usu≈Ñ tylko plik JSON</strong>
                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Zachowaj wszystkie pliki graficzne i d≈∫wiƒôkowe</div>
                </div>
            </label>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button class="btn btn-secondary" onclick="document.getElementById('deleteModal').style.display='none'">Anuluj</button>
            <button class="btn btn-danger" onclick="confirmDelete()">üóëÔ∏è Usu≈Ñ</button>
        </div>
    </div>
</div>

<!-- Modal walidacji przed zapisem -->
<div class="modal-overlay" id="validationModal" style="display: none;">
    <div class="modal" style="max-width: 520px;">
        <h3>‚ö†Ô∏è Sprawd≈∫ quiz przed zapisem</h3>
        <p id="validation-intro" style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 12px;"></p>
        <div id="validation-errors" style="margin: 12px 0; max-height: 220px; overflow-y: auto;"></div>
        <div id="validation-warnings" style="margin: 12px 0; max-height: 160px; overflow-y: auto;"></div>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 16px; flex-wrap: wrap;">
            <button class="btn btn-secondary" id="validation-cancel-btn">Anuluj</button>
            <button class="btn btn-primary" id="validation-save-anyway-btn" style="display: none;">Zapisz mimo to</button>
            <button class="btn btn-success" id="validation-download-anyway-btn" style="display: none;">Pobierz mimo to</button>
        </div>
    </div>
</div>

<script>
    const socket = io();

    // === OPTYMALIZATOR GRAFIKI (FUNKCJE POMOCNICZE) ===
    /**
     * Optymalizuje obrazek: zmniejsza do maxWidth (zachowujƒÖc proporcje) i kompresuje.
     * @param {File} file - Plik obrazka
     * @param {number} maxWidth - Maksymalna szeroko≈õƒá (px)
     * @param {number} quality - Jako≈õƒá kompresji 0-1 (domy≈õlnie 0.85)
     * @param {string} format - Format wyj≈õciowy: 'webp' lub 'jpeg' (domy≈õlnie 'webp')
     * @returns {Promise<Blob>}
     */
    function resizeImage(file, maxWidth, quality = 0.85, format = 'webp') {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Zmniejsz tylko je≈õli wiƒôksze ni≈º maxWidth
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    
                    // Lepsza jako≈õƒá renderowania
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Kompresja do WebP lub JPEG
                    const mimeType = format === 'jpeg' ? 'image/jpeg' : 'image/webp';
                    canvas.toBlob((blob) => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error('B≈ÇƒÖd kompresji obrazka'));
                        }
                    }, mimeType, quality);
                };
                img.onerror = () => reject(new Error('B≈ÇƒÖd ≈Çadowania obrazka'));
                img.src = event.target.result;
            };
            reader.onerror = () => reject(new Error('B≈ÇƒÖd odczytu pliku'));
            reader.readAsDataURL(file);
        });
    }

    // === KOMUNIKACJA Z SERWEREM ===
    socket.on('connect', () => socket.emit('editor_get_files'));
    
    socket.on('editor_files_list', (files) => {
        const sel = document.getElementById('server-files-list');
        const curr = sel.value;
        sel.innerHTML = '<option value="">-- Wybierz plik --</option>';
        files.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f;
            opt.innerText = f;
            sel.appendChild(opt);
        });
        if(files.includes(curr)) sel.value = curr;
        // W≈ÇƒÖcz/wy≈ÇƒÖcz przycisk usuwania
        document.getElementById('delete-btn').disabled = !sel.value;
    });

    // Obs≈Çuga zmiany wyboru pliku (po za≈Çadowaniu DOM)
    socket.on('connect', () => {
        const fileSelect = document.getElementById('server-files-list');
        if(fileSelect) {
            fileSelect.addEventListener('change', function() {
                const deleteBtn = document.getElementById('delete-btn');
                if(deleteBtn) deleteBtn.disabled = !this.value;
            });
        }
    });

    socket.on('editor_delete_status', (status) => {
        console.log('üì• Otrzymano status usuwania:', status);
        alert(status.message);
        if(status.success) {
            socket.emit('editor_get_files');
            const deleteModalEl = document.getElementById('deleteModal');
            if(deleteModalEl) deleteModalEl.style.display = 'none';
            // Wyczy≈õƒá wyb√≥r pliku
            const fileSelect = document.getElementById('server-files-list');
            if(fileSelect) fileSelect.value = '';
            const deleteBtn = document.getElementById('delete-btn');
            if(deleteBtn) deleteBtn.disabled = true;
        }
    });

    socket.on('editor_related_files', (data) => {
        const listEl = document.getElementById('delete-files-list');
        if(data.files && data.files.length > 0) {
            listEl.innerHTML = data.files.map(f => `<li>${f}</li>`).join('');
        } else {
            listEl.innerHTML = '<li style="color: #666;">Brak powiƒÖzanych plik√≥w</li>';
        }
    });

    socket.on('editor_file_content', (data) => {
        if(confirm('Wczytanie pliku nadpisze obecny widok. Kontynuowaƒá?')) {
            document.getElementById('filename').value = data.filename.replace('.json', '');
            processData(data);
        }
    });

    socket.on('editor_save_status', (status) => alert(status.message));

    // === LOGIKA EDYTORA ===

    /** Dla ≈õcie≈ºek /uploads/... zwraca pe≈Çny URL (origin + path), ≈ºeby obrazki ≈Çadowa≈Çy siƒô po wczytaniu quizu */
    function resolveMediaUrl(path) {
        if (!path || typeof path !== 'string') return '';
        const p = path.trim();
        if (!p) return '';
        if (/^https?:\/\//i.test(p)) return p;
        const origin = window.location.origin;
        if (origin && origin !== 'null' && /^https?:/.test(origin)) {
            return origin + (p.startsWith('/') ? p : '/' + p);
        }
        return p.startsWith('/') ? p : '/' + p;
    }

    /** Znaki " & < > w tre≈õci zamykajƒÖ atrybuty HTML ‚Äì escapowanie pozwala u≈ºywaƒá ich w pytaniach i odpowiedziach */
    function escapeHtmlAttr(s) {
        if (s == null || s === undefined) return '';
        return String(s)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    function addQuestion(type = 'QUIZ', data = null) {
        const qId = Date.now() + Math.random().toString(36).substr(2, 5);
        
        let answersHtml = '';
        const defaultAnswersCount = (type === 'MUSIC') ? 5 : 4;
        const answers = data ? data.answers : new Array(defaultAnswersCount).fill('');
        while (answers.length < defaultAnswersCount) { answers.push(''); }

        let correctArr = [];
        if (data && data.correct !== undefined) {
            if (Array.isArray(data.correct)) {
                correctArr = data.correct;
            } else if (data.correct !== -1) {
                correctArr = [data.correct];
            }
        }

        // Dla typu LETTER domy≈õlnie 45 sekund, dla innych 30
        const defaultTime = (type === 'LETTER') ? 45 : 30;
        const time = data ? (data.time || defaultTime) : defaultTime;
        const questionText = data ? (data.question || '') : '';
        const mediaUrl = data ? (data.media || '') : ''; // URL du≈ºego
        const mediaSmallUrl = data ? (data.imageSmall || '') : ''; // URL ma≈Çego (nowe pole)
        
        if (type === 'QUIZ' || type === 'MUSIC') {
            for(let i=0; i < defaultAnswersCount; i++) {
                const isChecked = correctArr.includes(i) ? 'checked' : '';
                answersHtml += `
                <div class="answer-row">
                    <span class="ans-badge">${String.fromCharCode(65+i)}</span>
                    <input type="text" class="ans-input" value="${escapeHtmlAttr(answers[i])}" placeholder="Odpowied≈∫ ${String.fromCharCode(65+i)}">
                    <input type="checkbox" name="correct-${qId}" class="ans-correct-check" value="${i}" ${isChecked} title="Zaznacz je≈õli poprawna">
                </div>`;
            }
        } else if (type === 'VOTE' || type === 'VOTE_IMG') {
            answersHtml += `
            <div class="answer-row"><span class="ans-badge">A</span><input type="text" class="ans-input" value="${escapeHtmlAttr(answers[0] || 'Tak')}" placeholder="Opcja A"></div>
            <div class="answer-row"><span class="ans-badge">B</span><input type="text" class="ans-input" value="${escapeHtmlAttr(answers[1] || 'Nie')}" placeholder="Opcja B"></div>
            <div style="margin-top: 10px; padding: 10px; background: rgba(255, 193, 7, 0.12); border-radius: 6px; border: 1px solid rgba(255, 193, 7, 0.4);">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Poprawna odpowied≈∫ <span style="font-weight: normal; color: #888;">(opcjonalnie)</span></label>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" name="correct-vote-${qId}" class="ans-correct-check" value="0" ${correctArr.includes(0) ? 'checked' : ''}>
                        <span>Tylko A</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" name="correct-vote-${qId}" class="ans-correct-check" value="1" ${correctArr.includes(1) ? 'checked' : ''}>
                        <span>Tylko B</span>
                    </label>
                </div>
                <small style="color: #666; display: block; margin-top: 5px;">Je≈õli nie zaznaczysz ‚Äì wszyscy dostajƒÖ 100 pkt za udzia≈Ç. Je≈õli zaznaczysz ‚Äì punkty tylko za prawid≈ÇowƒÖ odpowied≈∫ (z bonusem za czas).</small>
            </div>
            `;
        } else if (type === 'HOT_OR_NOT') {
            // HOT_OR_NOT ma tylko dwie odpowiedzi A i B
            answersHtml += `
            <div class="answer-row"><span class="ans-badge">A</span><input type="text" class="ans-input" value="${escapeHtmlAttr(answers[0] || 'Opcja A')}" placeholder="Opcja A"></div>
            <div class="answer-row"><span class="ans-badge">B</span><input type="text" class="ans-input" value="${escapeHtmlAttr(answers[1] || 'Opcja B')}" placeholder="Opcja B"></div>
            <div style="margin-top: 10px; padding: 10px; background: rgba(241, 196, 15, 0.12); border-radius: 6px; border: 1px solid var(--accent-gold);">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Poprawna odpowied≈∫ (opcjonalnie):</label>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" name="correct-hot-${qId}" class="ans-correct-check" value="0" ${correctArr.includes(0) ? 'checked' : ''}>
                        <span>Tylko A</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" name="correct-hot-${qId}" class="ans-correct-check" value="1" ${correctArr.includes(1) ? 'checked' : ''}>
                        <span>Tylko B</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" name="correct-hot-both-${qId}" class="ans-correct-check" value="both" ${correctArr.length === 2 ? 'checked' : ''}>
                        <span>Oba (A i B)</span>
                    </label>
                </div>
                <small style="color: #666; display: block; margin-top: 5px;">Je≈õli nie zaznaczysz ≈ºadnej opcji, gracze dostanƒÖ punkty za g≈Çosowanie (jak ankieta).</small>
            </div>
            `;
        } else if (type === 'ESTIMATION') {
            const correctValue = data ? (data.correctValue ?? data.correct ?? 0) : 0;
            const minVal = data ? (data.min ?? 0) : 0;
            const maxVal = data ? (data.max ?? 100) : 100;
            answersHtml = `
            <div style="padding: 15px; background: rgba(92, 107, 192, 0.15); border-radius: 8px; border: 1px solid rgba(92, 107, 192, 0.4);">
                <label style="font-weight: 600; display: block; margin-bottom: 10px; color: var(--text-white);">üìê Warto≈õci dla szacowania (gracze wpisujƒÖ liczbƒô)</label>
                <div class="answer-row"><span class="ans-badge">‚úì</span><label style="min-width: 140px;">Poprawna warto≈õƒá:</label><input type="number" class="est-correct-value" value="${correctValue}" placeholder="np. 43"></div>
                <div class="answer-row"><span class="ans-badge">Min</span><label style="min-width: 140px;">Zakres od:</label><input type="number" class="est-min" value="${minVal}" placeholder="np. 30"></div>
                <div class="answer-row"><span class="ans-badge">Max</span><label style="min-width: 140px;">Zakres do:</label><input type="number" class="est-max" value="${maxVal}" placeholder="np. 50"></div>
                <small style="color: var(--text-muted); display: block; margin-top: 8px;">Punkty: najwiƒôcej za dok≈ÇadnƒÖ odpowied≈∫, mniej w zale≈ºno≈õci od odleg≈Ço≈õci od poprawnej liczby.</small>
            </div>
            `;
        } else if (type === 'OPEN') {
            answersHtml = `
            <div style="padding: 15px; background: rgba(46, 125, 50, 0.15); border-radius: 8px; border: 1px solid rgba(46, 125, 50, 0.4);">
                <label style="font-weight: 600; display: block; margin-bottom: 8px; color: var(--text-white);">üí¨ Pytanie otwarte</label>
                <p style="margin: 0; color: var(--text-muted); font-size: 0.9em;">Gracze wpisujƒÖ dowolnƒÖ odpowied≈∫ (np. gatunek muzyki: rock, techno). Wyniki wy≈õwietlajƒÖ siƒô jako chmura s≈Ç√≥w ‚Äì im czƒô≈õciej podana odpowied≈∫, tym wiƒôksza czcionka. Brak poprawnej odpowiedzi (100 pkt za udzia≈Ç). Z odpowiedzi mo≈ºna uruchomiƒá dogrywkƒô TAK/NIE (bez punkt√≥w).</p>
            </div>
            `;
        } else if (type === 'LETTER') {
            answersHtml = `
            <div style="padding: 15px; background: rgba(156, 39, 176, 0.15); border-radius: 8px; border: 1px solid rgba(156, 39, 176, 0.4);">
                <label style="font-weight: 600; display: block; margin-bottom: 8px; color: var(--text-white);">üî§ Pytanie z literƒÖ</label>
                <p style="margin: 0; color: var(--text-muted); font-size: 0.9em;">Gracze wpisujƒÖ wyraz zaczynajƒÖcy siƒô na wylosowanƒÖ literƒô. Ka≈ºdy gracz dostaje innƒÖ literƒô (lub 2 litery je≈õli ma≈Ço graczy). Liczbƒô liter mo≈ºna wybraƒá w panelu administracyjnym przy starcie pytania. Po klikniƒôciu "Statystyki" automatycznie uruchamia siƒô dogrywka TAK/NIE z chmurƒÖ s≈Ç√≥w.</p>
            </div>
            `;
        } else if (type === 'SHIPS') {
            const boardSize = data ? (data.boardSize || 8) : 8;
            const shipsData = data ? (data.ships || []) : [];
            answersHtml = `
            <div style="padding: 15px; background: #001122; border-radius: 8px; border: 2px solid #0066cc;">
                <label style="font-weight: 600; display: block; margin-bottom: 10px; color: #00aaff;">‚öì Gra w Statki</label>
                <div id="ships-editor-${qId}" style="margin-top: 15px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #fff;">Rozmiar planszy:</label>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="ships-size-btn" data-size="6" style="flex: 1; padding: 8px; background: ${boardSize === 6 ? '#0066cc' : '#003366'}; color: #fff; border: 1px solid #0066cc; border-radius: 4px; cursor: pointer;">6x6</button>
                            <button type="button" class="ships-size-btn" data-size="8" style="flex: 1; padding: 8px; background: ${boardSize === 8 ? '#0066cc' : '#003366'}; color: #fff; border: 1px solid #0066cc; border-radius: 4px; cursor: pointer;">8x8</button>
                            <button type="button" class="ships-size-btn" data-size="10" style="flex: 1; padding: 8px; background: ${boardSize === 10 ? '#0066cc' : '#003366'}; color: #fff; border: 1px solid #0066cc; border-radius: 4px; cursor: pointer;">10x10</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                        <button type="button" class="ships-ship-btn" data-size="2" style="padding: 8px 12px; background: #003366; color: #00aaff; border: 1px solid #0066cc; border-radius: 4px; cursor: pointer;">2 Maszty</button>
                        <button type="button" class="ships-ship-btn" data-size="3" style="padding: 8px 12px; background: #003366; color: #00aaff; border: 1px solid #0066cc; border-radius: 4px; cursor: pointer;">3 Maszty</button>
                        <button type="button" class="ships-ship-btn" data-size="4" style="padding: 8px 12px; background: #003366; color: #00aaff; border: 1px solid #0066cc; border-radius: 4px; cursor: pointer;">4 Maszty</button>
                        <button type="button" class="ships-ship-btn" data-size="5" style="padding: 8px 12px; background: #003366; color: #00aaff; border: 1px solid #0066cc; border-radius: 4px; cursor: pointer;">5 Maszt√≥w</button>
                        <button type="button" class="ships-rotate-btn" style="padding: 8px 12px; background: #003366; color: #00aaff; border: 1px solid #0066cc; border-radius: 4px; cursor: pointer;">Obr√≥t: PIONOWO</button>
                    </div>
                    <div id="ships-board-${qId}" style="display: inline-block; border: 2px solid #0066cc; background: #000;"></div>
                    <div style="margin-top: 10px; color: #00aaff; font-size: 0.9em;">
                        <span id="ships-status-${qId}">Wybierz statek i kliknij na planszƒô</span>
                    </div>
                    <input type="hidden" class="ships-data-input" value='${JSON.stringify({boardSize: boardSize, ships: shipsData})}'>
                </div>
            </div>
            `;
        }

        let mediaHtml = '';
        let mediaLabel = 'Obrazek';
        let mediaType = 'image';
        let mediaPlaceholder = 'http://... lub plik.jpg';

        if (type === 'MUSIC') {
            mediaLabel = 'Plik Muzyczny';
            mediaType = 'audio';
            mediaPlaceholder = 'http://... lub plik.mp3';
        }
        if (type === 'ESTIMATION') {
            mediaLabel = 'Obrazek (opcjonalnie)';
        }
        if (type === 'OPEN') {
            mediaLabel = 'Obrazek (opcjonalnie)';
        }
        if (type === 'VOTE') {
            mediaLabel = 'Obrazek (opcjonalnie)';
        }

        if (type === 'MUSIC' || type === 'VOTE' || type === 'VOTE_IMG' || type === 'QUIZ' || type === 'ESTIMATION' || type === 'OPEN') {
            mediaHtml = `
            <div class="media-section">
                <label>üñºÔ∏è / üéµ ${mediaLabel}${type === 'ESTIMATION' ? ' ‚Äì np. zdjƒôcie do oszacowania' : type === 'OPEN' ? ' ‚Äì nie przeszkadza w chmurze odpowiedzi' : type === 'VOTE' ? ' ‚Äì wy≈õwietlane przy g≈Çosowaniu' : ' (Media)'}</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <div style="flex: 1;">
                        <input type="text" class="media-input" value="${escapeHtmlAttr(mediaUrl)}" placeholder="${mediaPlaceholder} (Online/Lokalnie)">
                        <!-- NOWE: Ukryte pole na miniaturƒô -->
                        <input type="hidden" class="media-thumb-input" value="${escapeHtmlAttr(mediaSmallUrl)}">
                        <small style="color:#666">Wklej link URL lub wgraj plik przyciskiem obok.</small>
                    </div>
                    <div style="display:flex; gap:5px; align-items: flex-start;">
                        <button class="btn btn-secondary" onclick="triggerUpload('${qId}', '${mediaType}')">üìÇ Wgraj z dysku</button>
                        <div id="loader-${qId}" class="loader"></div>
                    </div>
                </div>
                ${mediaUrl && mediaType === 'image' ? `<img src="${escapeHtmlAttr(resolveMediaUrl(mediaUrl))}" class="media-preview" id="preview-${qId}">` : `<img src="" class="media-preview" id="preview-${qId}" style="display:none">`}
                <input type="file" id="upload-${qId}" style="display: none;" onchange="uploadFile(this, '${qId}', '${mediaType}')">
            </div>`;
        } else if (type === 'HOT_OR_NOT') {
            // HOT_OR_NOT ma dwa obrazki: A i B
            const imageA = data ? (data.imageA || '') : '';
            const imageB = data ? (data.imageB || '') : '';
            const imageSmallA = data ? (data.imageSmallA || '') : '';
            const imageSmallB = data ? (data.imageSmallB || '') : '';
            
            mediaHtml = `
            <div class="media-section">
                <label>üñºÔ∏è Obrazek A</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <input type="text" class="hot-image-a-input" value="${escapeHtmlAttr(imageA)}" placeholder="http://... lub plik.jpg (du≈ºy obrazek)">
                        <input type="hidden" class="hot-image-small-a-input" value="${escapeHtmlAttr(imageSmallA)}">
                        <small style="color:#666">Du≈ºy obrazek dla ekranu g≈Ç√≥wnego</small>
                    </div>
                    <div style="display:flex; gap:5px; align-items: flex-start;">
                        <button class="btn btn-secondary" onclick="triggerUploadHot('${qId}', 'imageA')">üìÇ Wgraj A</button>
                        <div id="loader-hot-a-${qId}" class="loader"></div>
                    </div>
                </div>
                ${imageA ? `<img src="${escapeHtmlAttr(resolveMediaUrl(imageA))}" class="media-preview" id="preview-hot-a-${qId}" style="max-width: 200px;">` : `<img src="" class="media-preview" id="preview-hot-a-${qId}" style="display:none">`}
                <input type="file" id="upload-hot-a-${qId}" style="display: none;" onchange="uploadFileHot(this, '${qId}', 'imageA')">
            </div>
            <div class="media-section">
                <label>üñºÔ∏è Obrazek B</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <input type="text" class="hot-image-b-input" value="${escapeHtmlAttr(imageB)}" placeholder="http://... lub plik.jpg (du≈ºy obrazek)">
                        <input type="hidden" class="hot-image-small-b-input" value="${escapeHtmlAttr(imageSmallB)}">
                        <small style="color:#666">Du≈ºy obrazek dla ekranu g≈Ç√≥wnego</small>
                    </div>
                    <div style="display:flex; gap:5px; align-items: flex-start;">
                        <button class="btn btn-secondary" onclick="triggerUploadHot('${qId}', 'imageB')">üìÇ Wgraj B</button>
                        <div id="loader-hot-b-${qId}" class="loader"></div>
                    </div>
                </div>
                ${imageB ? `<img src="${escapeHtmlAttr(resolveMediaUrl(imageB))}" class="media-preview" id="preview-hot-b-${qId}" style="max-width: 200px;">` : `<img src="" class="media-preview" id="preview-hot-b-${qId}" style="display:none">`}
                <input type="file" id="upload-hot-b-${qId}" style="display: none;" onchange="uploadFileHot(this, '${qId}', 'imageB')">
            </div>`;
        }

        // Oblicz numer pytania (indeks + 1) - bƒôdzie zaktualizowany przez updateQuestionNumbers
        const questionNumber = document.querySelectorAll('.question-card').length + 1;
        
        const cardHtml = `
        <div class="question-card" id="card-${qId}" data-type="${type}" data-question-number="${questionNumber}">
            <div class="card-header">
                <span class="q-number">Pytanie ${questionNumber}: ${type} ${type === 'MUSIC' ? '(5 odp)' : ''}</span>
                <div style="display: flex; gap: 6px; align-items: center;">
                    <button class="btn btn-secondary btn-move" onclick="moveQuestionUp('${qId}')" title="Przesu≈Ñ w g√≥rƒô"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l5-5 5 5z"/></svg></button>
                    <button class="btn btn-secondary btn-move" onclick="moveQuestionDown('${qId}')" title="Przesu≈Ñ w d√≥≈Ç"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg></button>
                    <button class="btn btn-danger btn-sm" onclick="removeQuestion('${qId}')">Usu≈Ñ</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Tre≈õƒá pytania / Tytu≈Ç</label>
                <input type="text" class="q-text" value="${escapeHtmlAttr(questionText)}" placeholder="Wpisz pytanie...">
            </div>

            <div style="display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap; align-items: center;">
                ${type !== 'SHIPS' ? `
                <div class="form-group" style="max-width: 150px;">
                    <label>Czas (sekundy)</label>
                    <input type="number" class="q-time" value="${time}">
                </div>
                ` : ''}
                ${type !== 'SHIPS' && type !== 'LETTER' ? `
                <div class="checkbox-card" style="margin-top: 0;" onclick="document.querySelector('#card-${qId} .q-speedrun').click()">
                    <input type="checkbox" class="q-speedrun" id="speedrun-${qId}" ${(data && data.speedrun) ? 'checked' : ''} onclick="event.stopPropagation()">
                    <span>‚è±Ô∏è Speedrun (punkty tylko dla 10 pierwszych: 1000‚Üí100)</span>
                </div>
                <div class="checkbox-card" style="margin-top: 0;" onclick="document.querySelector('#card-${qId} .q-elimination').click()">
                    <input type="checkbox" class="q-elimination" id="elimination-${qId}" ${(data && data.elimination) ? 'checked' : ''} onclick="event.stopPropagation()">
                    <span>üíÄ Eliminacja (z≈Ça odp. = odpadasz, wynik zerowany)</span>
                </div>
                ` : ''}
                ${type === 'LETTER' ? `
                <div style="padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 6px; border: 1px solid rgba(156, 39, 176, 0.3);">
                    <small style="color: var(--text-muted);">‚ö†Ô∏è Speedrun i Eliminacja sƒÖ niedostƒôpne dla pyta≈Ñ z literƒÖ</small>
                </div>
                ` : ''}
            </div>

            ${mediaHtml}

            <div class="answers-section">
                <label>${type === 'ESTIMATION' ? '' : 'Odpowiedzi (zaznacz poprawne):'}</label>
                ${answersHtml}
            </div>
        </div>
        `;

        document.getElementById('questions-container').insertAdjacentHTML('beforeend', cardHtml);
        
        // Aktualizuj numeracjƒô po dodaniu pytania
        updateQuestionNumbers();
        return qId;
    }

    function removeQuestion(id) { 
        document.getElementById(`card-${id}`).remove();
        updateQuestionNumbers();
    }

    function moveQuestionUp(id) {
        const card = document.getElementById(`card-${id}`);
        if (!card) return;
        const prev = card.previousElementSibling;
        if (!prev || !prev.classList.contains('question-card')) return;
        card.parentNode.insertBefore(card, prev);
        updateQuestionNumbers();
    }

    function moveQuestionDown(id) {
        const card = document.getElementById(`card-${id}`);
        if (!card) return;
        const next = card.nextElementSibling;
        if (!next || !next.classList.contains('question-card')) return;
        card.parentNode.insertBefore(next, card);
        updateQuestionNumbers();
    }
    
    // Aktualizuj numeracjƒô pyta≈Ñ po zmianach
    function updateQuestionNumbers() {
        const cards = document.querySelectorAll('.question-card');
        cards.forEach((card, index) => {
            const number = index + 1;
            card.setAttribute('data-question-number', number);
            const qNumberEl = card.querySelector('.q-number');
            if (qNumberEl) {
                const type = card.dataset.type || '';
                const typeText = type === 'MUSIC' ? `${type} (5 odp)` : type;
                qNumberEl.textContent = `Pytanie ${number}: ${typeText}`;
            }
        });
    }

    // --- UPLOAD PLIK√ìW (Z AUTOMATYCZNƒÑ MINIATURƒÑ) ---
    function triggerUpload(id, type) {
        const input = document.getElementById(`upload-${id}`);
        input.accept = type === 'audio' ? 'audio/*' : 'image/*';
        input.click();
    }

    async function uploadFile(input, id, type) {
        const file = input.files[0];
        if (!file) return;

        const loader = document.getElementById(`loader-${id}`);
        if(loader) loader.style.display = 'inline-block';

        const formData = new FormData();

        // Je≈õli to obrazek, optymalizujemy g≈Ç√≥wny obrazek (1920px dla Screen.html) + miniatura (500px dla telefon√≥w)
        if (type === 'image') {
            try {
                console.log("üñºÔ∏è Optymalizacja obrazka dla Screen.html (1920px)...");
                // G≈Ç√≥wny obrazek: maksymalnie 1920px szeroko≈õci, jako≈õƒá 0.85, WebP
                const optimizedBlob = await resizeImage(file, 1920, 0.85, 'webp');
                formData.append('file', optimizedBlob, file.name.replace(/\.[^.]+$/, '.webp'));
                
                console.log("üì± Generowanie miniatury dla telefon√≥w (500px)...");
                // Miniatura: 500px szeroko≈õci, jako≈õƒá 0.8, WebP
                const thumbBlob = await resizeImage(file, 500, 0.8, 'webp');
                formData.append('thumbnail', thumbBlob, 'thumb.webp');
                
                console.log(`‚úÖ Obrazek zoptymalizowany: ${(file.size / 1024 / 1024).toFixed(2)}MB ‚Üí ~${(optimizedBlob.size / 1024 / 1024).toFixed(2)}MB`);
            } catch (err) {
                console.error("‚ùå B≈ÇƒÖd optymalizacji obrazka:", err);
                // Fallback: wy≈õlij orygina≈Ç je≈õli optymalizacja siƒô nie powiod≈Ça
                formData.append('file', file);
            }
        } else {
            // Dla audio: wy≈õlij orygina≈Ç
            formData.append('file', file);
        }

        fetch('/upload', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.filepath) {
                    const card = document.getElementById(`card-${id}`);
                    card.querySelector('.media-input').value = data.filepath; // Du≈ºy
                    
                    if (data.thumbnailpath) {
                         card.querySelector('.media-thumb-input').value = data.thumbnailpath; // Ma≈Çy
                         console.log("Miniatura zapisana:", data.thumbnailpath);
                    }

                    const preview = document.getElementById(`preview-${id}`);
                    if(preview) {
                        preview.src = data.filepath;
                        preview.style.display = 'block';
                    }
                } else {
                    alert('B≈ÇƒÖd uploadu');
                }
            })
            .catch(err => alert('B≈ÇƒÖd: ' + err))
            .finally(() => {
                if(loader) loader.style.display = 'none';
            });
    }

    // Upload dla HOT_OR_NOT (dwa obrazki)
    function triggerUploadHot(id, imageType) {
        const input = document.getElementById(`upload-hot-${imageType === 'imageA' ? 'a' : 'b'}-${id}`);
        input.accept = 'image/*';
        input.click();
    }

    async function uploadFileHot(input, id, imageType) {
        const file = input.files[0];
        if (!file) return;

        const suffix = imageType === 'imageA' ? 'a' : 'b';
        const loader = document.getElementById(`loader-hot-${suffix}-${id}`);
        if(loader) loader.style.display = 'inline-block';

        const formData = new FormData();

        // Optymalizujemy g≈Ç√≥wny obrazek (1920px dla Screen.html) + miniatura (500px dla telefon√≥w)
        try {
            console.log(`üñºÔ∏è HOT_OR_NOT - optymalizacja obrazka ${imageType} (1920px)...`);
            // G≈Ç√≥wny obrazek: maksymalnie 1920px szeroko≈õci, jako≈õƒá 0.85, WebP
            const optimizedBlob = await resizeImage(file, 1920, 0.85, 'webp');
            formData.append('file', optimizedBlob, file.name.replace(/\.[^.]+$/, '.webp'));
            
            console.log(`üì± HOT_OR_NOT - generowanie miniatury ${imageType} (500px)...`);
            // Miniatura: 500px szeroko≈õci, jako≈õƒá 0.8, WebP
            const thumbBlob = await resizeImage(file, 500, 0.8, 'webp');
            formData.append('thumbnail', thumbBlob, 'thumb.webp');
            
            console.log(`‚úÖ HOT_OR_NOT ${imageType} zoptymalizowany: ${(file.size / 1024 / 1024).toFixed(2)}MB ‚Üí ~${(optimizedBlob.size / 1024 / 1024).toFixed(2)}MB`);
        } catch (err) {
            console.error(`‚ùå HOT_OR_NOT - b≈ÇƒÖd optymalizacji ${imageType}:`, err);
            // Fallback: wy≈õlij orygina≈Ç je≈õli optymalizacja siƒô nie powiod≈Ça
            formData.append('file', file);
        }

        fetch('/upload', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.filepath) {
                    const card = document.getElementById(`card-${id}`);
                    // Popraw selektor - imageType to 'imageA' lub 'imageB', wiƒôc potrzebujemy 'a' lub 'b'
                    const suffix = imageType === 'imageA' ? 'a' : 'b';
                    const imageInput = card.querySelector(`.hot-image-${suffix}-input`);
                    const imageSmallInput = card.querySelector(`.hot-image-small-${suffix}-input`);
                    
                    if(imageInput) {
                        imageInput.value = data.filepath;
                        // Wywo≈Çaj zdarzenie input aby upewniƒá siƒô ≈ºe warto≈õƒá jest zapisana
                        imageInput.dispatchEvent(new Event('input', { bubbles: true }));
                        console.log(`‚úÖ HOT_OR_NOT - zapisano ${imageType} do input:`, data.filepath, 'input.value po zapisie:', imageInput.value);
                    } else {
                        console.error(`‚ùå HOT_OR_NOT - nie znaleziono input dla ${imageType}`, {
                            'card.id': `card-${id}`,
                            'imageType': imageType,
                            'selector': `.hot-image-${imageType.toLowerCase()}-input`,
                            'card exists': !!card
                        });
                    }
                    
                    if(imageSmallInput && data.thumbnailpath) {
                        imageSmallInput.value = data.thumbnailpath;
                        console.log(`‚úÖ HOT_OR_NOT - zapisano ${imageType} miniatura do input:`, data.thumbnailpath);
                    }

                    const preview = document.getElementById(`preview-hot-${suffix}-${id}`);
                    if(preview) {
                        preview.src = data.filepath;
                        preview.style.display = 'block';
                        console.log(`‚úÖ HOT_OR_NOT - zaktualizowano preview dla ${imageType}`);
                    }
                } else {
                    alert('B≈ÇƒÖd uploadu');
                }
            })
            .catch(err => alert('B≈ÇƒÖd: ' + err))
            .finally(() => {
                if(loader) loader.style.display = 'none';
            });
    }

    // --- ZBIERANIE DANYCH ---
    function collectData() {
        const filename = document.getElementById('filename').value.trim();
        if (!filename) { alert('Podaj nazwƒô pliku!'); return null; }

        const questions = [];
        document.querySelectorAll('.question-card').forEach(card => {
            const type = card.dataset.type;
            const qId = card.id.replace('card-', '');
            
            // Pobieranie ≈õcie≈ºek
            const mediaInput = card.querySelector('.media-input');
            const mediaThumbInput = card.querySelector('.media-thumb-input');

            const timeInput = card.querySelector('.q-time');
            const qData = {
                id: `q_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                type: type,
                question: card.querySelector('.q-text').value,
                time: (type === 'SHIPS') ? 0 : (type === 'LETTER') ? (timeInput ? parseInt(timeInput.value) || 45 : 45) : (timeInput ? parseInt(timeInput.value) || 30 : 30),
                speedrun: (type === 'LETTER' || type === 'SHIPS') ? false : (card.querySelector('.q-speedrun') && card.querySelector('.q-speedrun').offsetParent !== null) ? card.querySelector('.q-speedrun').checked : false,
                elimination: (type === 'LETTER' || type === 'SHIPS') ? false : (card.querySelector('.q-elimination') && card.querySelector('.q-elimination').offsetParent !== null) ? card.querySelector('.q-elimination').checked : false,
                answers: [],
                // Zapisujemy media:
                media: mediaInput ? mediaInput.value : '',
                // Je≈õli istnieje, to image = media (kompatybilno≈õƒá)
                image: (mediaInput && type !== 'MUSIC') ? mediaInput.value : undefined,
                // Nowe pole dla telefonu:
                imageSmall: (mediaThumbInput && type !== 'MUSIC') ? mediaThumbInput.value : undefined,
                // Muzyka:
                audio: (type === 'MUSIC' && mediaInput) ? mediaInput.value : undefined
            };

            // HOT_OR_NOT - specjalna obs≈Çuga obrazk√≥w
            if (type === 'HOT_OR_NOT') {
                // Szukaj input√≥w - sprawd≈∫ r√≥≈ºne mo≈ºliwe selektory
                const imageAInput = card.querySelector('.hot-image-a-input') || card.querySelector('input[class*="hot-image-a"]');
                const imageBInput = card.querySelector('.hot-image-b-input') || card.querySelector('input[class*="hot-image-b"]');
                const imageSmallAInput = card.querySelector('.hot-image-small-a-input') || card.querySelector('input[class*="hot-image-small-a"]');
                const imageSmallBInput = card.querySelector('.hot-image-small-b-input') || card.querySelector('input[class*="hot-image-small-b"]');
                
                console.log('üìù HOT_OR_NOT - zbieranie danych:', {
                    'card.id': card.id,
                    'card.type': card.dataset.type,
                    'imageAInput found': !!imageAInput,
                    'imageAInput value': imageAInput ? imageAInput.value : 'BRAK INPUT',
                    'imageBInput found': !!imageBInput,
                    'imageBInput value': imageBInput ? imageBInput.value : 'BRAK INPUT',
                    'imageSmallAInput found': !!imageSmallAInput,
                    'imageSmallAInput value': imageSmallAInput ? imageSmallAInput.value : 'BRAK INPUT',
                    'imageSmallBInput found': !!imageSmallBInput,
                    'imageSmallBInput value': imageSmallBInput ? imageSmallBInput.value : 'BRAK INPUT',
                    'all inputs in card': card.querySelectorAll('input').length
                });
                
                // Debug - sprawd≈∫ wszystkie inputy w karcie
                const allInputs = card.querySelectorAll('input');
                console.log('üìù Wszystkie inputy w karcie HOT_OR_NOT:', Array.from(allInputs).map(inp => ({
                    'class': inp.className,
                    'type': inp.type,
                    'value': inp.value.substring(0, 50) + (inp.value.length > 50 ? '...' : '')
                })));
                
                qData.imageA = imageAInput ? imageAInput.value.trim() : '';
                qData.imageB = imageBInput ? imageBInput.value.trim() : '';
                qData.imageSmallA = imageSmallAInput ? imageSmallAInput.value.trim() : '';
                qData.imageSmallB = imageSmallBInput ? imageSmallBInput.value.trim() : '';
                
                console.log('üìù HOT_OR_NOT - zapisane do qData:', {
                    imageA: qData.imageA,
                    imageB: qData.imageB,
                    imageSmallA: qData.imageSmallA,
                    imageSmallB: qData.imageSmallB,
                    'imageA length': qData.imageA.length,
                    'imageB length': qData.imageB.length
                });
            }

            // ESTIMATION - warto≈õci szacowania
            if (type === 'ESTIMATION') {
                const correctInput = card.querySelector('.est-correct-value');
                const minInput = card.querySelector('.est-min');
                const maxInput = card.querySelector('.est-max');
                qData.correctValue = correctInput ? parseFloat(correctInput.value) || 0 : 0;
                qData.min = minInput ? parseFloat(minInput.value) || 0 : 0;
                qData.max = maxInput ? parseFloat(maxInput.value) || 100 : 100;
            }

            // LETTER - brak letterCount w edytorze (wyb√≥r w admin.html)
            if (type === 'LETTER') {
                // Dla LETTER domy≈õlnie 45 sekund, ale mo≈ºna zmieniƒá
                qData.time = timeInput ? parseInt(timeInput.value) || 45 : 45;
                // Wy≈ÇƒÖcz speedrun i elimination dla LETTER
                qData.speedrun = false;
                qData.elimination = false;
                // letterCount bƒôdzie ustawiane w admin.html przy starcie pytania
            }
            
            // SHIPS - dane statk√≥w (tylko statki mieszczƒÖce siƒô w ca≈Ço≈õci na planszy)
            if (type === 'SHIPS') {
                qData.time = 0;
                const shipsDataInput = card.querySelector('.ships-data-input');
                if (shipsDataInput && shipsDataInput.value) {
                    try {
                        const shipsData = JSON.parse(shipsDataInput.value);
                        const boardSz = shipsData.boardSize || 8;
                        qData.boardSize = boardSz;
                        qData.ships = (shipsData.ships || []).filter(s => isValidShip(s, boardSz));
                    } catch(e) {
                        console.error('B≈ÇƒÖd parsowania danych statk√≥w:', e);
                        qData.boardSize = 8;
                        qData.ships = [];
                    }
                } else {
                    qData.boardSize = 8;
                    qData.ships = [];
                }
            }

            // Zbieranie odpowiedzi
            const ansInputs = card.querySelectorAll('.ans-input');
            ansInputs.forEach(inp => qData.answers.push(inp.value));

            // Zbieranie poprawnych (checkboxy)
            if (type === 'QUIZ' || type === 'MUSIC') {
                const checkedBoxes = card.querySelectorAll(`input[name="correct-${qId}"]:checked`);
                let correctIndices = [];
                checkedBoxes.forEach(cb => correctIndices.push(parseInt(cb.value)));
                qData.correct = correctIndices.length === 1 ? correctIndices[0] : correctIndices;
                if(correctIndices.length === 0) qData.correct = -1;
            } else if (type === 'HOT_OR_NOT') {
                // HOT_OR_NOT - sprawd≈∫ poprawne odpowiedzi
                const checkedBoxes = card.querySelectorAll(`input[name="correct-hot-${qId}"]:checked`);
                const bothChecked = card.querySelector(`input[name="correct-hot-both-${qId}"]:checked`);
                
                let correctIndices = [];
                if (bothChecked) {
                    correctIndices = [0, 1]; // Oba poprawne
                } else {
                    checkedBoxes.forEach(cb => correctIndices.push(parseInt(cb.value)));
                }
                
                if(correctIndices.length === 0) {
                    qData.correct = -1; // Brak poprawnej odpowiedzi - jak ankieta
                } else if(correctIndices.length === 1) {
                    qData.correct = correctIndices[0];
                } else {
                    qData.correct = correctIndices; // Tablica z obiema odpowiedziami
                }
            } else if (type === 'VOTE' || type === 'VOTE_IMG') {
                const checkedBoxes = card.querySelectorAll(`input[name="correct-vote-${qId}"]:checked`);
                let correctIndices = [];
                checkedBoxes.forEach(cb => correctIndices.push(parseInt(cb.value)));
                if (correctIndices.length === 0) {
                    qData.correct = -1; // Opcjonalne ‚Äì brak poprawnej = 100 pkt za udzia≈Ç
                } else if (correctIndices.length === 1) {
                    qData.correct = correctIndices[0];
                } else {
                    qData.correct = correctIndices;
                }
            } else if (type !== 'ESTIMATION' && type !== 'OPEN' && type !== 'SHIPS' && type !== 'LETTER') {
                qData.correct = -1; 
            }
            
            // LETTER - brak poprawnej odpowiedzi (100 pkt za udzia≈Ç)
            if (type === 'LETTER') {
                qData.correct = -1; // Brak poprawnej odpowiedzi
            }

            questions.push(qData);
        });

        // Zbierz dane ekranu ko≈Ñcowego
        const thanksText = document.getElementById('thanks-text').value.trim();
        const thanksImage = document.getElementById('thanks-image').value.trim();
        const thanksScreen = (thanksText || thanksImage) ? {
            text: thanksText || null,
            image: thanksImage || null
        } : null;

        return {
            disableTimePoints: document.getElementById('disableTimePoints').checked,
            questions: questions,
            thanksScreen: thanksScreen
        };
    }

    /** Walidacja quizu przed zapisem. Zwraca { errors: [], warnings: [] }, ka≈ºdy element: { index, title, message }. */
    function validateQuizData(data) {
        const errors = [];
        const warnings = [];
        if (!data || !data.questions || data.questions.length === 0) {
            errors.push({ index: -1, title: 'Quiz', message: 'Brak pyta≈Ñ w quizie.' });
            return { errors, warnings };
        }
        data.questions.forEach((q, index) => {
            const num = index + 1;
            const title = (q.question && q.question.trim()) ? (q.question.trim().substring(0, 40) + (q.question.trim().length > 40 ? '‚Ä¶' : '')) : `Pytanie ${num}`;
            const shortTitle = `Pytanie ${num}`;

            if (!q.question || !String(q.question).trim()) {
                errors.push({ index, title: shortTitle, message: 'Brak tre≈õci pytania.' });
            }
            // Pomijaj sprawdzanie czasu dla pyta≈Ñ typu SHIPS (gra ko≈Ñczy siƒô rƒôcznie)
            if (q.type !== 'SHIPS') {
                const time = parseInt(q.time, 10);
                if (isNaN(time) || time <= 0) {
                    warnings.push({ index, title: shortTitle, message: 'Czas powinien byƒá wiƒôkszy od 0.' });
                }
            }
            const answers = q.answers || [];
            const nonEmptyAnswers = answers.map(a => String(a).trim()).filter(Boolean);

            switch (q.type) {
                case 'QUIZ':
                case 'MUSIC':
                    if (nonEmptyAnswers.length < 2) {
                        errors.push({ index, title: shortTitle, message: 'Dodaj co najmniej 2 odpowiedzi.' });
                    }
                    answers.slice(0, q.type === 'MUSIC' ? 5 : 4).forEach((a, i) => {
                        if (!String(a).trim()) warnings.push({ index, title: shortTitle, message: `Odpowied≈∫ ${String.fromCharCode(65 + i)} jest pusta.` });
                    });
                    const correct = q.correct;
                    const hasCorrect = correct !== undefined && correct !== null && correct !== -1 &&
                        (Array.isArray(correct) ? correct.length > 0 : true);
                    if (!hasCorrect) {
                        errors.push({ index, title: shortTitle, message: 'Zaznacz prawid≈ÇowƒÖ odpowied≈∫.' });
                    }
                    if (q.type === 'MUSIC') {
                        if (!q.audio || !String(q.audio).trim()) {
                            errors.push({ index, title: shortTitle, message: 'Brak pliku muzycznego (audio).' });
                        }
                    } else if (!q.media && !q.image) {
                        warnings.push({ index, title: shortTitle, message: 'Brak obrazka (opcjonalnie).' });
                    }
                    break;
                case 'VOTE':
                case 'VOTE_IMG':
                    if (nonEmptyAnswers.length < 2) {
                        errors.push({ index, title: shortTitle, message: 'G≈Çosowanie wymaga dw√≥ch odpowiedzi (np. Tak / Nie).' });
                    }
                    if (answers[0] !== undefined && !String(answers[0]).trim()) errors.push({ index, title: shortTitle, message: 'Odpowied≈∫ A jest pusta.' });
                    if (answers[1] !== undefined && !String(answers[1]).trim()) errors.push({ index, title: shortTitle, message: 'Odpowied≈∫ B jest pusta.' });
                    if (q.type === 'VOTE_IMG' && !q.media && !q.image) {
                        warnings.push({ index, title: shortTitle, message: 'Brak obrazka dla pytania (Foto g≈Ços).' });
                    }
                    break;
                case 'HOT_OR_NOT':
                    if (!q.imageA || !String(q.imageA).trim()) {
                        errors.push({ index, title: shortTitle, message: 'Brak obrazka A.' });
                    }
                    if (!q.imageB || !String(q.imageB).trim()) {
                        errors.push({ index, title: shortTitle, message: 'Brak obrazka B.' });
                    }
                    if (nonEmptyAnswers.length < 2) {
                        warnings.push({ index, title: shortTitle, message: 'Uzupe≈Çnij etykiety odpowiedzi A i B.' });
                    }
                    break;
                case 'ESTIMATION':
                    const min = parseFloat(q.min);
                    const max = parseFloat(q.max);
                    const correctValue = parseFloat(q.correctValue);
                    if (!Number.isNaN(min) && !Number.isNaN(max) && min >= max) {
                        errors.push({ index, title: shortTitle, message: 'Zakres: warto≈õƒá Min musi byƒá mniejsza od Max.' });
                    }
                    if (!Number.isNaN(correctValue) && !Number.isNaN(min) && !Number.isNaN(max) && (correctValue < min || correctValue > max)) {
                        warnings.push({ index, title: shortTitle, message: 'Poprawna warto≈õƒá powinna mie≈õciƒá siƒô w zakresie Min‚ÄìMax.' });
                    }
                    if (!q.media && !q.image) {
                        warnings.push({ index, title: shortTitle, message: 'Brak obrazka do oszacowania (opcjonalnie).' });
                    }
                    break;
                case 'OPEN':
                    break;
                case 'SHIPS':
                    const shipsList = q.ships || [];
                    if (!shipsList.length) {
                        errors.push({ index, title: shortTitle, message: 'Na mapƒô nie naniesiono ≈ºadnego statku. Dodaj co najmniej jeden statek na planszƒô.' });
                    }
                    break;
                case 'LETTER':
                    const time = parseInt(q.time, 10);
                    if (isNaN(time) || time <= 0) {
                        warnings.push({ index, title: shortTitle, message: 'Czas powinien byƒá wiƒôkszy od 0.' });
                    }
                    break;
            }
        });
        return { errors, warnings };
    }

    function showValidationModal(data, onConfirmSave, onConfirmDownload) {
        const result = validateQuizData(data);
        const modal = document.getElementById('validationModal');
        const intro = document.getElementById('validation-intro');
        const errBlock = document.getElementById('validation-errors');
        const warnBlock = document.getElementById('validation-warnings');
        const cancelBtn = document.getElementById('validation-cancel-btn');
        const saveAnywayBtn = document.getElementById('validation-save-anyway-btn');
        const downloadAnywayBtn = document.getElementById('validation-download-anyway-btn');

        errBlock.innerHTML = '';
        warnBlock.innerHTML = '';
        saveAnywayBtn.style.display = 'none';
        downloadAnywayBtn.style.display = 'none';

        if (result.errors.length === 0 && result.warnings.length === 0) {
            if (onConfirmSave) onConfirmSave();
            else if (onConfirmDownload) onConfirmDownload();
            return;
        }
        intro.textContent = '';

        intro.textContent = result.errors.length > 0
            ? 'Wykryto b≈Çƒôdy ‚Äì warto je poprawiƒá przed zapisem. Mo≈ºesz zapisaƒá mimo to.'
            : 'SƒÖ drobne ostrze≈ºenia. Sprawd≈∫ je lub zapisz/pobierz.';
        if (result.errors.length > 0) {
            result.errors.forEach(e => {
                const p = document.createElement('p');
                p.style.cssText = 'margin: 6px 0; padding: 6px 10px; background: rgba(231, 76, 60, 0.2); border-radius: 6px; border-left: 3px solid #e74c3c; font-size: 0.9em;';
                p.textContent = `${e.title}: ${e.message}`;
                p.dataset.index = e.index;
                errBlock.appendChild(p);
            });
            saveAnywayBtn.style.display = onConfirmSave ? 'inline-flex' : 'none';
            downloadAnywayBtn.style.display = onConfirmDownload ? 'inline-flex' : 'none';
        }
        if (result.warnings.length > 0) {
            result.warnings.forEach(w => {
                const p = document.createElement('p');
                p.style.cssText = 'margin: 6px 0; padding: 6px 10px; background: rgba(241, 196, 15, 0.15); border-radius: 6px; border-left: 3px solid var(--accent-gold); font-size: 0.9em;';
                p.textContent = `${w.title}: ${w.message}`;
                warnBlock.appendChild(p);
            });
            if (result.errors.length === 0) {
                saveAnywayBtn.style.display = onConfirmSave ? 'inline-flex' : 'none';
                downloadAnywayBtn.style.display = onConfirmDownload ? 'inline-flex' : 'none';
            }
        }

        cancelBtn.onclick = () => {
            modal.style.display = 'none';
            const cards = document.querySelectorAll('.question-card');
            cards.forEach(c => c.classList.remove('validation-error'));
        };
        saveAnywayBtn.onclick = () => {
            modal.style.display = 'none';
            if (onConfirmSave) onConfirmSave();
            document.querySelectorAll('.question-card').forEach(c => c.classList.remove('validation-error'));
        };
        downloadAnywayBtn.onclick = () => {
            modal.style.display = 'none';
            if (onConfirmDownload) onConfirmDownload();
            document.querySelectorAll('.question-card').forEach(c => c.classList.remove('validation-error'));
        };
        modal.style.display = 'flex';
        const firstErrorIndex = result.errors.length > 0 ? result.errors[0].index : (result.warnings.length > 0 ? result.warnings[0].index : -1);
        if (firstErrorIndex >= 0) {
            const cards = document.querySelectorAll('.question-card');
            if (cards[firstErrorIndex]) {
                cards[firstErrorIndex].classList.add('validation-error');
                cards[firstErrorIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    }

    // --- ZAPIS / ODCZYT ---
    function loadFromServer() {
        const name = document.getElementById('server-files-list').value;
        if(name) socket.emit('editor_load_file', name);
    }

    function saveToServer() {
        const data = collectData();
        if (!data) return;
        showValidationModal(data, () => {
            const payload = collectData();
            if (payload) {
                socket.emit('editor_save_file', {
                    filename: document.getElementById('filename').value,
                    content: payload
                });
            }
        }, null);
    }

    function downloadQuiz() {
        const data = collectData();
        if (!data) return;
        showValidationModal(data, null, () => {
            const payload = collectData();
            if (!payload) return;
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = document.getElementById('filename').value + '.json';
            a.click();
        });
    }

    function downloadPackage() {
        const data = collectData();
        if (!data) return;
        showValidationModal(data, null, async () => {
            const payload = collectData();
            if (!payload) return;
            try {
                const res = await fetch('/api/editor/export-package', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(await res.text());
                const blob = await res.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = (document.getElementById('filename').value || 'quiz') + '-pakiet.zip';
                a.click();
            } catch (e) {
                alert('B≈ÇƒÖd pobierania pakietu: ' + e.message);
            }
        });
    }

    async function loadFromPackage(input) {
        const file = input.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('file', file);
        try {
            const res = await fetch('/api/editor/import-package', { method: 'POST', body: formData });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'B≈ÇƒÖd importu');
            processData(data.data);
            input.value = '';
        } catch (e) {
            alert('B≈ÇƒÖd importu pakietu: ' + e.message);
        }
    }

    function handleThanksImageUpload(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.filepath) {
                document.getElementById('thanks-image').value = data.filepath;
                const preview = document.getElementById('thanks-image-preview');
                preview.innerHTML = `<img src="${escapeHtmlAttr(data.filepath)}" style="max-width: 200px; max-height: 150px; border-radius: 4px; margin-top: 10px;" alt="PodglƒÖd">`;
            }
        })
        .catch(err => {
            console.error('B≈ÇƒÖd uploadu:', err);
            alert('B≈ÇƒÖd podczas przesy≈Çania obrazka');
        });
    }

    function processData(data) {
        const qList = Array.isArray(data) ? data : (data.questions || []);
        const disableTimePoints = !Array.isArray(data) && (
            (data.options && data.options.disableTimePoints) || data.disableTimePoints === true
        );
        document.getElementById('disableTimePoints').checked = !!disableTimePoints;
        
        // Wczytaj ekran ko≈Ñcowy je≈õli istnieje
        if (data.thanksScreen) {
            document.getElementById('thanks-text').value = data.thanksScreen.text || '';
            document.getElementById('thanks-image').value = data.thanksScreen.image || '';
            const preview = document.getElementById('thanks-image-preview');
            if (data.thanksScreen.image) {
                preview.innerHTML = `<img src="${escapeHtmlAttr(resolveMediaUrl(data.thanksScreen.image))}" style="max-width: 200px; max-height: 150px; border-radius: 4px; margin-top: 10px;" alt="PodglƒÖd">`;
            }
        } else {
            document.getElementById('thanks-text').value = '';
            document.getElementById('thanks-image').value = '';
            document.getElementById('thanks-image-preview').innerHTML = '';
        }
        
        document.getElementById('questions-container').innerHTML = '';
        
        qList.forEach(q => {
            // Mapowanie starych p√≥l na nowe dla edytora
            if(q.image && !q.media) q.media = q.image;
            if(q.audio && !q.media) q.media = q.audio;
            // HOT_OR_NOT - upewnij siƒô ≈ºe mamy odpowiedzi
            if(q.type === 'HOT_OR_NOT' && (!q.answers || q.answers.length < 2)) {
                q.answers = q.answers || [];
                while(q.answers.length < 2) q.answers.push('');
            }
            addQuestion(q.type || 'QUIZ', q);
        });
        // Aktualizuj numeracjƒô po za≈Çadowaniu wszystkich pyta≈Ñ
        updateQuestionNumbers();
    }

    function loadFromFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                document.getElementById('filename').value = file.name.replace('.json', '');
                processData(JSON.parse(e.target.result));
            } catch(e) { alert('B≈ÇƒÖd pliku'); }
        };
        reader.readAsText(file);
    }

    // --- MODAL WKLEJANIA ---
    function openPasteModal() {
        document.getElementById('pasteModal').style.display = 'flex';
        document.getElementById('pasteArea').value = '';
    }

    function loadFromPaste() {
        try {
            const txt = document.getElementById('pasteArea').value;
            if(txt) processData(JSON.parse(txt));
            document.getElementById('pasteModal').style.display = 'none';
        } catch(e) { alert('B≈ÇƒÖd JSON'); }
    }

    // === LOGIKA EDYTORA STATK√ìW ===
    const shipsEditors = {}; // Przechowuje stan edytor√≥w statk√≥w dla ka≈ºdego pytania

    /** Sprawdza czy statek w ca≈Ço≈õci mie≈õci siƒô na planszy (nie mo≈ºe wystawaƒá) */
    function isValidShip(ship, boardSize) {
        if (!ship || typeof ship.size !== 'number' || ship.size < 2 || ship.size > 5) return false;
        const vertical = !!ship.vertical;
        for (let i = 0; i < ship.size; i++) {
            const r = ship.row + (vertical ? i : 0);
            const c = ship.col + (vertical ? 0 : i);
            if (r < 0 || r >= boardSize || c < 0 || c >= boardSize) return false;
        }
        return true;
    }

    function initShipsEditor(qId, boardSize, shipsData) {
        const boardSz = boardSize || 8;
        const editor = {
            qId: qId,
            boardSize: boardSz,
            grid: Array(boardSz).fill().map(() => Array(boardSz).fill(0)),
            currentShipSize: 0,
            isVertical: true,
            ships: []
        };
        
        // Przywr√≥ƒá tylko statki, kt√≥re w ca≈Ço≈õci mieszczƒÖ siƒô na planszy
        if (shipsData && shipsData.length > 0) {
            shipsData.forEach(ship => {
                if (!isValidShip(ship, boardSz)) return;
                for (let i = 0; i < ship.size; i++) {
                    const r = ship.row + (ship.vertical ? i : 0);
                    const c = ship.col + (ship.vertical ? 0 : i);
                    editor.grid[r][c] = ship.size;
                }
                editor.ships.push(ship);
            });
        }
        
        shipsEditors[qId] = editor;
        
        // Najpierw ustaw przyciski, potem renderuj planszƒô
        setupShipsButtons(qId);
        renderShipsBoard(qId);
    }

    function renderShipsBoard(qId) {
        const editor = shipsEditors[qId];
        if (!editor) return;
        
        const boardEl = document.getElementById(`ships-board-${qId}`);
        if (!boardEl) return;
        
        const LETTERS = ['A','B','C','D','E','F','G','H','I','J'];
        const cellSize = Math.min(300 / editor.boardSize, 30);
        
        let html = `<table style="border-collapse: collapse; border: 1px solid #0066cc; background: #000;">`;
        
        // Nag≈Ç√≥wek kolumn
        html += `<tr><th style="width: ${cellSize}px; height: ${cellSize}px; border: 1px solid #0066cc; color: #00aaff; font-size: ${Math.max(10, cellSize * 0.5)}px;"></th>`;
        for(let c = 0; c < editor.boardSize; c++) {
            html += `<th style="width: ${cellSize}px; height: ${cellSize}px; border: 1px solid #0066cc; color: #00aaff; font-size: ${Math.max(10, cellSize * 0.5)}px;">${LETTERS[c]}</th>`;
        }
        html += `</tr>`;
        
        // Wiersze
        for(let r = 0; r < editor.boardSize; r++) {
            html += `<tr>`;
            html += `<th style="width: ${cellSize}px; height: ${cellSize}px; border: 1px solid #0066cc; color: #00aaff; font-size: ${Math.max(10, cellSize * 0.5)}px;">${r + 1}</th>`;
            for(let c = 0; c < editor.boardSize; c++) {
                const cellValue = editor.grid[r][c];
                const bgColor = cellValue > 0 ? '#0066cc' : '#001122';
                html += `<td class="ships-cell" data-r="${r}" data-c="${c}" style="width: ${cellSize}px; height: ${cellSize}px; border: 1px solid #0066cc; background: ${bgColor}; cursor: pointer; text-align: center; color: #fff; font-size: ${Math.max(8, cellSize * 0.4)}px;">${cellValue > 0 ? cellValue : ''}</td>`;
            }
            html += `</tr>`;
        }
        html += `</table>`;
        
        boardEl.innerHTML = html;
        
        // Dodaj event listenery
        boardEl.querySelectorAll('.ships-cell').forEach(cell => {
            cell.addEventListener('click', (e) => {
                const r = parseInt(e.target.dataset.r);
                const c = parseInt(e.target.dataset.c);
                handleShipsCellClick(qId, r, c);
            });
            cell.addEventListener('mouseenter', (e) => {
                const r = parseInt(e.target.dataset.r);
                const c = parseInt(e.target.dataset.c);
                handleShipsCellHover(qId, r, c, true);
            });
            cell.addEventListener('mouseleave', () => {
                clearShipsPreview(qId);
            });
        });
    }

    function setupShipsButtons(qId) {
        const editor = shipsEditors[qId];
        if (!editor) return;
        
        // Usu≈Ñ stare event listenery (je≈õli istniejƒÖ)
        const editorEl = document.getElementById(`ships-editor-${qId}`);
        if (!editorEl) return;
        
        // Przyciski rozmiaru planszy - u≈ºyj event delegation
        editorEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('ships-size-btn')) {
                const newSize = parseInt(e.target.dataset.size);
                if (isNaN(newSize)) return;
                
                editor.boardSize = newSize;
                editor.grid = Array(newSize).fill().map(() => Array(newSize).fill(0));
                editor.ships = [];
                
                // Zaktualizuj style przycisk√≥w
                document.querySelectorAll(`#ships-editor-${qId} .ships-size-btn`).forEach(b => {
                    b.style.background = '#003366';
                });
                e.target.style.background = '#0066cc';
                
                renderShipsBoard(qId);
                updateShipsData(qId);
            } else if (e.target.classList.contains('ships-ship-btn')) {
                editor.currentShipSize = parseInt(e.target.dataset.size);
                document.querySelectorAll(`#ships-editor-${qId} .ships-ship-btn`).forEach(b => {
                    b.style.background = '#003366';
                });
                e.target.style.background = '#0066cc';
                updateShipsStatus(qId);
            } else if (e.target.classList.contains('ships-rotate-btn')) {
                editor.isVertical = !editor.isVertical;
                e.target.textContent = editor.isVertical ? 'Obr√≥t: PIONOWO' : 'Obr√≥t: POZIOMO';
            }
        });
        
    }

    function handleShipsCellClick(qId, r, c) {
        const editor = shipsEditors[qId];
        if (!editor || editor.currentShipSize === 0) return;
        
        if (canPlaceShip(editor, r, c, editor.currentShipSize, editor.isVertical)) {
            // Dodaj statek
            const ship = {
                row: r,
                col: c,
                size: editor.currentShipSize,
                vertical: editor.isVertical
            };
            
            for(let i = 0; i < editor.currentShipSize; i++) {
                const tr = r + (editor.isVertical ? i : 0);
                const tc = c + (editor.isVertical ? 0 : i);
                editor.grid[tr][tc] = editor.currentShipSize;
            }
            
            editor.ships.push(ship);
            renderShipsBoard(qId);
            updateShipsData(qId);
            updateShipsStatus(qId, `Dodano statek ${editor.currentShipSize}-masztowy`);
        } else {
            updateShipsStatus(qId, 'Nie mo≈ºna umie≈õciƒá statku w tym miejscu!');
        }
    }

    function handleShipsCellHover(qId, r, c, enter) {
        const editor = shipsEditors[qId];
        if (!editor || editor.currentShipSize === 0) return;
        
        clearShipsPreview(qId);
        
        if (enter && canPlaceShip(editor, r, c, editor.currentShipSize, editor.isVertical)) {
            for(let i = 0; i < editor.currentShipSize; i++) {
                const tr = r + (editor.isVertical ? i : 0);
                const tc = c + (editor.isVertical ? 0 : i);
                const cell = document.querySelector(`#ships-board-${qId} .ships-cell[data-r="${tr}"][data-c="${tc}"]`);
                if (cell) cell.style.background = '#00aaff';
            }
        } else if (enter) {
            for(let i = 0; i < editor.currentShipSize; i++) {
                const tr = r + (editor.isVertical ? i : 0);
                const tc = c + (editor.isVertical ? 0 : i);
                if (tr < editor.boardSize && tc < editor.boardSize) {
                    const cell = document.querySelector(`#ships-board-${qId} .ships-cell[data-r="${tr}"][data-c="${tc}"]`);
                    if (cell) cell.style.background = '#cc0000';
                }
            }
        }
    }

    function clearShipsPreview(qId) {
        document.querySelectorAll(`#ships-board-${qId} .ships-cell`).forEach(cell => {
            const r = parseInt(cell.dataset.r);
            const c = parseInt(cell.dataset.c);
            const editor = shipsEditors[qId];
            if (editor && editor.grid[r][c] > 0) {
                cell.style.background = '#0066cc';
            } else {
                cell.style.background = '#001122';
            }
        });
    }

    function canPlaceShip(editor, r, c, size, vertical) {
        for(let i = 0; i < size; i++) {
            const tr = r + (vertical ? i : 0);
            const tc = c + (vertical ? 0 : i);
            if (tr >= editor.boardSize || tc >= editor.boardSize) return false;
            if (editor.grid[tr][tc] !== 0) return false;
        }
        return true;
    }

    function updateShipsStatus(qId, msg) {
        const statusEl = document.getElementById(`ships-status-${qId}`);
        if (statusEl) {
            if (msg) {
                statusEl.textContent = msg;
            } else {
                const editor = shipsEditors[qId];
                if (editor && editor.currentShipSize > 0) {
                    statusEl.textContent = `Wybrano: ${editor.currentShipSize}-masztowiec (${editor.isVertical ? 'PIONOWO' : 'POZIOMO'})`;
                } else {
                    statusEl.textContent = 'Wybierz statek i kliknij na planszƒô';
                }
            }
        }
    }

    function updateShipsData(qId) {
        const editor = shipsEditors[qId];
        if (!editor) return;
        
        const input = document.querySelector(`#ships-editor-${qId} .ships-data-input`);
        if (input) {
            input.value = JSON.stringify({
                boardSize: editor.boardSize,
                ships: editor.ships
            });
        }
    }

    // Wywo≈Çaj initShipsEditor po dodaniu pytania typu SHIPS
    const originalAddQuestion = addQuestion;
    window.addQuestion = function(type, data) {
        const qId = originalAddQuestion(type, data);
        if (type === 'SHIPS') {
            // U≈ºyj d≈Çu≈ºszego timeout aby upewniƒá siƒô ≈ºe DOM jest gotowy
            setTimeout(() => {
                const boardSize = data ? (data.boardSize || 8) : 8;
                const shipsData = data ? (data.ships || []) : [];
                initShipsEditor(qId, boardSize, shipsData);
            }, 200);
        }
        return qId;
    };

    // --- USUWANIE QUIZU ---
    function openDeleteModal() {
        const filename = document.getElementById('server-files-list').value;
        if(!filename) {
            alert('Wybierz plik do usuniƒôcia!');
            return;
        }
        const deleteFilenameEl = document.getElementById('delete-filename');
        const deleteModalEl = document.getElementById('deleteModal');
        if(!deleteFilenameEl || !deleteModalEl) {
            console.error('‚ùå Nie znaleziono element√≥w modala usuwania');
            alert('B≈ÇƒÖd: Nie znaleziono element√≥w modala. Od≈õwie≈º stronƒô.');
            return;
        }
        deleteFilenameEl.textContent = filename;
        deleteModalEl.style.display = 'flex';
        // Pobierz listƒô powiƒÖzanych plik√≥w
        socket.emit('editor_get_related_files', filename);
        console.log('üì§ Wys≈Çano ≈ºƒÖdanie powiƒÖzanych plik√≥w dla:', filename);
    }

    function confirmDelete() {
        const filename = document.getElementById('server-files-list').value;
        if(!filename) {
            alert('B≈ÇƒÖd: Nie wybrano pliku!');
            return;
        }
        
        const checkedOption = document.querySelector('input[name="delete-option"]:checked');
        if(!checkedOption) {
            alert('B≈ÇƒÖd: Nie wybrano opcji usuwania!');
            return;
        }
        
        const deleteRelated = checkedOption.value === 'all';
        
        if(confirm(`Czy na pewno chcesz usunƒÖƒá "${filename}"${deleteRelated ? ' wraz z wszystkimi powiƒÖzanymi plikami' : ''}?`)) {
            console.log('üì§ Wysy≈Çanie ≈ºƒÖdania usuniƒôcia:', { filename, deleteRelated });
            socket.emit('editor_delete_file', { filename, deleteRelated });
        }
    }
</script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js', { scope: '/' }).catch(function() {});
        }
    </script>
</body>
</html>
